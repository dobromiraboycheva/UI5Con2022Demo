/*!
 * SAPUI5
 * (c) Copyright 2009-2022 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/viz/ui5/data/DimensionDefinition","sap/viz/ui5/data/MeasureDefinition","sap/viz/ui5/controls/common/feeds/FeedItem","sap/viz/ui5/controls/common/feeds/AnalysisObject","sap/chart/TimeUnitType","sap/chart/data/TimeDimension","sap/chart/utils/DateFormatUtil","sap/chart/utils/ChartUtils","sap/chart/utils/RoleMapper","sap/chart/ChartLog","sap/ui/model/type/String","sap/ui/thirdparty/jquery"],function(e,t,i,n,a,r,s,o,u,c,l,f){"use strict";var d=function(){return sap.viz.vizservices.BVRService.suggestFeeds.apply(null,arguments)};var m=function(e,t){var i=sap.viz.vizservices.FeedService.validate(e,t);if(!i.valid){var n=i.results?i.results.bindings:null;if(n&&Object.keys(n).every(function(e){return n[e].allowMND&&(!n[e].missing||n[e].missing===1)&&!n[e].incorrect})){return{valid:true}}}return i};var p=[{types:"*",toViz:{"category|category2":"categoryAxis",series:"color","axis1|axis2|axis3|axis4":"valueAxis"}},{types:"column|bar|stacked_bar|stacked_column|line|combination|100_stacked_bar|100_stacked_column|stacked_combination|horizontal_stacked_combination",toViz:{}},{types:"scatter|bubble|time_bubble|timeseries_scatter|timeseries_bubble",toViz:{"category|category2":"@context",axis1:"valueAxis",axis2:"valueAxis2"}},{types:"bubble|time_bubble",toViz:{axis3:"bubbleWidth"}},{types:"pie|donut|100_donut",toViz:{"category|series|category2":"color","axis1|axis2|axis3|axis4":"size"}},{types:"bullet|vertical_bullet",toViz:{"axis1|axis2|axis3|axis4":"@semanticBulletMsrs"}},{types:"dual_combination|dual_horizontal_combination|dual_stacked_bar|100_dual_stacked_bar|dual_stacked_column|100_dual_stacked_column|dual_bar|dual_column|dual_line|dual_stacked_combination|dual_horizontal_stacked_combination",toViz:{axis1:"valueAxis","axis2|axis3|axis4":"valueAxis2"}},{types:"timeseries_line|timeseries_column|timeseries_combination|timeseries_stacked_column|timeseries_100_stacked_column",toViz:{category:"timeAxis"}},{types:"timeseries_scatter",toViz:{category:u,"axis2|axis3":false}},{types:"timeseries_bubble",toViz:{category:u,axis2:false,axis3:"bubbleWidth"}},{types:"dual_timeseries_combination",toViz:{category:"timeAxis",axis1:"valueAxis","axis2|axis3|axis4":"valueAxis2"}},{types:"heatmap",toViz:{category:"categoryAxis","category2|series":"categoryAxis2","axis1|axis2|axis3|axis4":"color"}},{types:"waterfall|horizontal_waterfall",toViz:{series:"waterfallType"}},{types:"timeseries_bullet",toViz:{"category|series":"timeAxis","axis1|axis2|axis3|axis4":"@semanticBulletMsrs"}},{types:"timeseries_waterfall",toViz:{"category|series":"timeAxis"}}].reduce(function(e,t){var i=Object.keys(t.toViz).reduce(function(e,i){i.split("|").forEach(function(n){e[n]=t.toViz[i];return e});return e},{});t.types.split("|").forEach(function(t){if(!e.hasOwnProperty(t)){e[t]=[]}e[t].push(i)});return e},{});var v=Object.keys(p).reduce(function(e,t){if(t!=="*"){e[t]=f.extend.apply(null,[true,{}].concat(p["*"].concat(p[t])))}return e},{});function _(e,t,i){var n=typeof t==="function"?t:function(e){return e[t]};return e.reduce(function(e,t){var a=n(t),r=typeof i==="function"?i(t):t;if(a&&!e[a]){e[a]=[r]}else if(a){e[a].push(r)}return e},{})}function g(e,t){var i={},n;t.forEach(function(t){var a=t._sFixedRole||t.getRole();if(e.hasOwnProperty(a)){var r=e[a];if(r){if(typeof r==="function"){if(!n){n=new r}r=n.toFeedingId(t)}if(!i[r]){i[r]=[]}i[r].push(t)}}});return i}var y={from:i.fromLightWeightFmt,build:function(e){var t=[];f.each(e.dims,function(e,i){t.push({id:e,type:"Dimension",values:i.map(b("Dimension"))})});f.each(e.msrs,function(e,i){t.push({id:e,type:"Measure",values:i.map(b("Measure"))})});return t}};function b(e){return function(t){var i=t.getName();if(i==="MND"){return{id:"MND",type:"MND"}}var n={id:i,name:i,type:e};if(t instanceof r){n.dataType="Date"}return n}}function x(t,i){var n=t.getName(),a=t.getLabel(),o=t.getTextProperty(),u=t.getTextFormatter(),c=t.getDisplayText();var f={identity:n,name:a||n,value:"{"+n+"}"};if(typeof u==="function"){f.displayValue={formatter:u,parts:[{path:n,type:new l}]};if(o){f.displayValue.parts.push({path:o,type:new l})}}else if(c&&o){f.displayValue="{"+o+"}"}var d=new e(f);if(i&&t instanceof r){var m=s.getInstance(t.getTimeUnit());if(m){var p=m.parse.bind(m);d.getBindingInfo("value").formatter=function(e){return p(e)}}d.setDataType("Date");d._setTimeUnit(t.getTimeUnit())}return d}function h(e){var i=e.getName();var n=new t({identity:i,name:e.getLabel()||i,value:"{"+i+"}"});n._setUnitBinding(e.getUnitBinding());return n}function z(e,t){var i=sap.viz.api.metadata.Viz.get("info/"+e),n=_(i.bindings,"role"),a=_(t,"id"),r=n["layout.category"]||[],s=n["mark.color"]||[];if(r.length===0){return[]}else{var o=[];f.each(r.concat(s),function(e,t){var i=a[t.id];if(i&&i.length>0){f.each(i[0].values,function(e,t){o.push(t.id)})}});return o}}function k(e){return o.CONFIG.timeChartTypes.indexOf(e)>-1}function T(e){return e&&e.indexOf("bullet")>-1}function D(e){f.each(e,function(e,t){if(t&&(t.getSemantics&&t.getSemantics()!=="actual"||t.getSemanticallyRelatedMeasures&&!f.isEmptyObject(t.getSemanticallyRelatedMeasures()))){new c("error","Semantic Pattern"," Semantic pattern rule defined in invisible measures doesn't work.").display()}})}function V(e,t,i,n,a){var r=v[e];var s={dims:g(r,t),msrs:g(r,i)};if(T(e)){s.invisibleMsrs=a}else{D(a)}var l=null,f=null;if(s.dims["@context"]){l=s.dims["@context"];delete s.dims["@context"]}var d=false;if(!n){if(u.semantics.hasSemanticMeasures(s)){var m;if(o.CONFIG.nonSemanticPatternChartType.indexOf(e)===-1){m=new c("error","Semantic Pattern","Semantic pattern doesn't work when there is dataPointStyle or seriesStyle defined.");d=true}else{m=new c("error","Semantic Pattern",e+" doesn't support semantic pattern feature.");d=true}m.display()}}f=u.semantics.semanticPatternMsrs(s,e,d);l=(l||[]).concat(f.contexts);var p=y.build(s);p.contexts=l;p.semanticTuples=f.semanticTuples;return p}var w=[{chartTypes:"bar,column,line,combination,heatmap,bullet,vertical_bullet,stacked_bar,stacked_column,stacked_combination,horizontal_stacked_combination,dual_bar,dual_column,dual_line,dual_stacked_bar,dual_stacked_column,dual_combination,dual_horizontal_combination,dual_stacked_combination,dual_horizontal_stacked_combination,100_stacked_bar,100_stacked_column,100_dual_stacked_bar,100_dual_stacked_column,waterfall,horizontal_waterfall".split(","),feed:"categoryAxis"},{chartTypes:"donut,100_donut,pie,scatter,bubble".split(","),feed:"color"}];function N(e,t,i){var n,a;for(n=0;n<w.length;n++){if(w[n].chartTypes.indexOf(e)!==-1){a=w[n].feed;break}}var r=t.some(function(e){return e.id===a});if(!r){var s=d("info/"+e,t,[{id:"MND",type:"MND"}]).feedItems;t.splice(0,t.length);s.forEach(function(e){if(e.values.length>0){t.push(e)}});t=E(e,t)}for(n=0;n<t.length;n++){if(t[n].id===a&&t[n].type==="Dimension"){t[n].values=t[n].values.concat(i.map(function(e){return{id:e.getName(),name:e.getName(),type:"Dimension",inResult:true}}))}}return m("info/"+e,t)}function M(e){e.forEach(function(e){e._sFixedRole=e.getRole()})}function O(e,t,i){t.forEach(function(t){t.values.forEach(function(n){var a=i.filter(function(e){return e.getName()===n.id})[0];if(a){f.each(v[e],function(e,i){if(i===t.id){a._sFixedRole=e;return false}})}})})}function A(e,t){var i=true;if(e.indexOf("timeseries_bullet")>-1){i=t.length>1&&t.every(function(e){return e.actual&&e.reference||e.projected&&e.reference})}else if(e.indexOf("timeseries_combination")>-1){i=t.length>0&&t.some(function(e){return e.projected||e.reference})}return i}function S(e,t,i,n,a,r,s){var o=t.concat(i).concat(n);M(o);var u=V(e,t,i,a,r);e=e.indexOf("donut")>-1?"donut":e;var c=m("info/"+e,u);var l=u.contexts,f=u.semanticTuples,d=[];if(!c.valid){if(e.indexOf("dual_timeseries_combination")>-1){u.contexts=[]}u=F(e,c,u,t,i);c=m("info/"+e,u);O(e,u,o);if(a){if(A(e,f)){u=V(e,t,i,a,r);l=u.contexts;f=u.semanticTuples}}}else{O(e,u,o)}if(f){d=f.filter(function(e){return e.projectedValueStartTime})}if(c.valid&&n&&n.length>0){var p=_(t,function(e){return e.getName()});N(e,u,n.filter(function(e){return!p[e.getName()]}))}var v=u.reduce(function(e,t){t.values.forEach(function(t){e[t.id]=true});return e},{});var g=y.from(u);if(l){l.forEach(function(e){v[e.getName()]=true});g._context=l.map(function(e){var t=e.getName();var i=true;for(var n=0;n<d.length;n++){if(t===d[n].actual||t===d[n].projected){i=false;break}}return{id:t,showInTooltip:i}})}g._unused=I(u,t,i).filter(function(e){return!v[e]});g._def=R(t,c.valid?n:[],i,v,f,k(e));if(s){g._def.dim.forEach(function(e){e.setBindingContext(null)});g._def.msr.forEach(function(e){e.setBindingContext(null)})}g._order=z(e,u);g._valid=c.valid;g._semanticTuples=f;return g}function j(e){return _(sap.viz.api.metadata.Viz.get("info/"+e).bindings,"id")}function E(e,t,i){i=i||j(e);t.forEach(function(e){e.type=i[e.id][0].type});return t}function F(e,t,i,n,a){var r=j(e),s=false,o=false;var u=t.results.bindings;Object.keys(u).forEach(function(e){if(!r[e]){return}if(r[e][0].type==="Measure"){o=true}if(r[e][0].type==="Dimension"&&!(u[e].allowMND&&(!u[e].missing||u[e].missing===1))){s=true}});var c=i.filter(function(e){return!(e.type==="Dimension"?s:o)}),l=c.reduce(function(e,t){(t.values||[]).forEach(function(t){e[t.id]=true});return e},{});if(i.contexts){i.contexts.forEach(function(e){l[e.getName()]=true})}var f=n.map(b("Dimension")),m=a.map(b("Measure"));var p=d("info/"+e,c,f.concat(m).filter(function(e){return!l[e.id]})).feedItems;E(e,p,r);return p}function I(e,t,i){var n=e.reduce(function(e,t){t.values.forEach(function(t){e[t.id]=true});return e},{});return t.concat(i).filter(function(e){return!n[e.getName()]}).map(function(e){return e.getName()})}function R(e,i,n,a,o,u){var c;if(u){var l;for(var f=0;f<e.length;f++){if(e[f]instanceof r){l=e[f];break}}c=s.getInstance(l.getTimeUnit())}return{dim:e.reduce(function(e,t){if(a[t.getName()]){e.push(x(t,u))}return e},[]).concat(i.map(function(e){var t=x(e);t._setInResult(true);return t})),msr:n.reduce(function(e,t){if(a[t.getName()]){e.push(h(t))}return e},[]).concat((o||[]).reduce(function(e,i){if(i.timeAxis&&i.projectedValueStartTime){e.push(new t({identity:i.actual+"-"+i.projected,name:(i.labels&&i.labels.actual||i.actual)+"-"+(i.labels&&i.labels.projected||i.projected),value:{parts:[i.timeAxis,i.actual,i.projected],formatter:function(e){var t=e,n;if(e&&e.length>1){var a=e[0];if(a){if(c){var r=c.parse(a);if(r){n=r.getTime()}}else{n=new Date(a).getTime()}if(n&&n<i.projectedValueStartTime){t=e[1]}else{t=e[2]}}}return t}}}))}return e},[]))}}return{fit:S,compatible:function(e,t,i){var n="info/"+e,a={used:{},error:null,compatible:true};var r=V(e,t,i),s=m(n,r);if(!s.valid){r=F(e,s,r,t,i);s=m(n,r);a.needFix=true}if(s.valid){a.used=_(r,function(e){return e.type},function(e){return e.values.filter(function(e){return e.type==="Dimension"||e.type==="Measure"}).map(function(e){return e.id})});f.each(a.used,function(e,t){a.used[e]=t.reduce(function(e,t){return e.concat(t)},[])})}else{a.compatible=false;var o=sap.viz.api.metadata.Viz.get(n).bindings,u=_(o,"type",function(e){return e.id}),c={dim:0,msr:0,time:0};f.each(s.results.bindings,function(e,t){if(!t.missing){return}if(u.Dimension.indexOf(e)!==-1&&!(t.allowMND&&t.missing===1)){c[e==="timeAxis"?"time":"dim"]+=t.missing}else if(u.Measure.indexOf(e)!==-1){c.msr+=t.missing}});a.error={missing:c}}return a}}});