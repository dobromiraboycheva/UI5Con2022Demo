/*!
 * SAPUI5
 * (c) Copyright 2009-2022 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/chart/data/TimeDimension","sap/chart/utils/MeasureSemanticsUtils","sap/chart/utils/ChartUtils","sap/chart/utils/DateFormatUtil","sap/chart/data/MeasureSemantics","sap/chart/ChartLog","sap/ui/thirdparty/jquery"],function(e,t,a,r,i,s,n){"use strict";function u(e){this._bTimeFed=false}u.prototype.toFeedingId=function(t){if(t instanceof e&&!this._bTimeFed){this._bTimeFed=true;return"timeAxis"}else{return"@context"}};function c(e){return a.CONFIG.timeChartTypes.indexOf(e)>-1}function l(e,t,a){var r={actualValues:[],targetValues:[]};n.each(e,function(e,a){if(a.actual){r.actualValues.push(t[a.actual]);a.valueAxisID="actualValues"}if(a.projected){r.actualValues.push(t[a.projected]);a.valueAxisID="actualValues"}if(a.reference){if(a.actual||a.projected){r.targetValues.push(t[a.reference]);a.valueAxisID="targetValues"}else{r.actualValues.push(t[a.reference]);a.valueAxisID="actualValues"}}});delete a["@semanticBulletMsrs"];n.extend(a,r)}function o(e,t){var a=t["@semanticBulletMsrs"];if(a){var r={actualValues:[]};for(var i=0;i<a.length;i++){r.actualValues.push(a[i])}for(var i=0;i<e.length;i++){e[i].valueAxisID="actualValues"}delete t["@semanticBulletMsrs"];n.extend(t,r)}}u.semantics={hasSemanticMeasures:function(e){return Object.keys(e.msrs).some(function(t){var a=false;var r=e.msrs[t];a=r.some(function(e){if(e.getSemantics){var t=e.getSemantics();return t&&t!=="actual"}});return a})},semanticPatternMsrs:function(e,a,i){var u=[],f=[],m={},d,h;var p=c(a)&&(e.dims.timeAxis&&e.dims.timeAxis.length===1);var v;var g;if(p){var x=e.dims.timeAxis[0];v=x.getProjectedValueStartTime&&x.getProjectedValueStartTime();if(v){var j=x.getTimeUnit();if(j==="fiscalyearperiod"||j==="fiscalyear"){g=v}else{var O=r.getInstance(j);if(O){if(O.parse(v)){g=O.parse(v).getTime()}}else{g=new Date(v).getTime()}}}}var y=["valueAxis","valueAxis2"];var S=Object.keys(e.msrs).sort(function(e,t){return y.indexOf(e)-y.indexOf(t)});var w=this.hasSemanticMeasures(e);S.forEach(function(r){var c=e.msrs[r],l;h=null;n.extend(true,m,c.reduce(function(e,t){e[t.getName()]=t;return e},{}));if(a&&a.indexOf("bullet")>-1&&e.invisibleMsrs){l=e.invisibleMsrs.filter(function(e){return e.getSemantics()==="actual"&&e.getSemanticallyRelatedMeasures()})}if(n.isEmptyObject(e.dims)){h=new s("error","Semantic Pattern","Semantic Pattern doesn't work when there is no dimension.");i=i||true}else if(e.dims.color&&e.dims.color.length>0){h=new s("error","Semantic Pattern","Semantic pattern doesn't work when there is series dimension.");i=i||true}var o;o=t.getTuples(c,l,i);if(a&&(a.indexOf("stacked_column")>-1||a.indexOf("stacked_bar")>-1)){var f=false;if(p&&v){if(!g){h=new s("error","Semantic Pattern","The value of projectedValueStartTime is invalid.");h.display();f=true}for(var d=0;d<o.length;d++){if(o[d].hasOwnProperty("actual")){if(!o[d].hasOwnProperty("projected")){f=true;break}if(o[d].hasOwnProperty("reference")){f=true;break}}else{f=true;break}}}else{var x="";if(o[0].hasOwnProperty("actual")){x="actual"}else if(o[0].hasOwnProperty("projected")){x="projected"}else if(o[0].hasOwnProperty("reference")){x="reference"}if(x==="projected"||x==="reference"){for(var d=0;d<o.length;d++){if(!o[d].hasOwnProperty(x)){f=true;break}}}else{for(var d=0;d<o.length;d++){if(o[d].hasOwnProperty("projected")||o[d].hasOwnProperty("reference")){f=true;break}}}}if(a.indexOf("dual")>-1&&S.length<=1){f=false}if(f){h=new s("error","Semantic Pattern","Actual, forecast or target can't be stacked in one bar or column.");i=true;o=t.getTuples(c,l,i)}}o.forEach(function(e){e.valueAxisID=r});if(w&&i&&h){h.display()}u=u.concat(o)});if(a&&a.indexOf("bullet")>-1){p=p&&u.some(function(e){return e.actual&&e.projected});d=u.some(function(e){return e.actual&&e.projected||e.actual&&e.reference||e.projected&&e.reference});if(d&&!p){l(u,m,e.msrs)}else{o(u,e.msrs)}}if(!i&&p){h=null;var b=[];var P=function(e){var t=b.indexOf(e.getName())===-1;if(!t){f.push(e)}return t};for(var T=0;T<u.length;T++){var V=u[T];if(v){if(g){var A=e.msrs[V.valueAxisID];if(V.actual&&V.projected){V.timeAxis=e.dims.timeAxis[0].getName();V.projectedValueStartTime=g;V.semanticMsrName=V.actual+"-"+V.projected;b.push(V.actual);b.push(V.projected);A.push(m[V.actual].clone().setName(V.semanticMsrName));if(u.length===1&&a.indexOf("combination")>-1){h=new s("error","Semantic Pattern","Do not satisfy the minimum number of measure to work "+"with Projected Value Start Time in Time Series Combination.")}}e.msrs[V.valueAxisID]=A.filter(P)}else{h=new s("error","Semantic Pattern","The value of projectedValueStartTime is invalid.")}}}if(h){h.display()}}if(u.length>0&&!i){var M=[];var k=["actual","projected","semanticMsrName","reference"];u.forEach(function(e){for(var t=0;t<k.length;t++){if(e[k[t]]){M.push(e[k[t]])}}});n.each(e.msrs,function(t){e.msrs[t].sort(function(e,t){return M.indexOf(e.getName())-M.indexOf(t.getName())})})}return{semanticTuples:u,contexts:f}}};return u});