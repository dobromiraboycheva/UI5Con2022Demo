/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/base/Object","sap/ui/core/Core","sap/ui/core/CustomData","sap/ui/core/Configuration","sap/ui/base/ManagedObjectObserver","./AnchorBar","sap/m/Button","sap/m/MenuButton","sap/m/Menu","sap/m/MenuItem","sap/ui/core/IconPool","sap/ui/core/InvisibleText"],function(t,e,n,o,i,a,r,s,u,c,g,h,l){"use strict";var f=e.extend("sap.uxap._helpers.AB",{constructor:function(t){this._oObjectPageLayout=t;this._oObserver=new a(this._proxyStateChanges.bind(this));this._aMenusWithAttachPressHandler=[]},getInterface:function(){return this}});f._focusSection=function(t,e){var n=t.getDomRef();if(n){n.focus(e)}};f.prototype.getObjectPageLayout=function(){return this._oObjectPageLayout};f.prototype._proxyStateChanges=function(t){var e=t.object,n=this._findExistingClone(e),o=t.name,i=t.current,a="set"+d(o);if(n){n[a].call(n,i)}};f.prototype._findExistingClone=function(t){var e,n=t.getId()+"-__clone",o=this._getAnchorBar(),i=o.getContent();i.some(function(t){if(t.getId().indexOf(n)===0){e=t;return true}});return e};f.prototype._getAnchorBar=function(){var t=this.getObjectPageLayout(),e=t.getAggregation("_anchorBar");if(!e){e=new r({id:t.getId()+"-anchBar",showPopover:t.getShowAnchorBarPopover(),backgroundDesign:t.getBackgroundDesignAnchorBar()});e.attachEvent("_anchorPress",t.onAnchorBarTabPress,t);this.getObjectPageLayout().setAggregation("_anchorBar",e,true)}return e};f.prototype._setCustomData=function(t,e,n,i){n._oSectionInfo[e.getId()].buttonId=t.getId();t.addCustomData(new o({key:"sectionId",value:e.getId()}));t.addCustomData(new o({key:"bTitleVisible",value:e._getInternalTitleVisible()}));if(!i){t.addCustomData(new o({key:"secondLevel",value:true}))}};f.prototype._buildAnchorBar=function(){var e=this.getObjectPageLayout(),n=e.getSections()||[],i=this._getAnchorBar(),a=t.proxy(i.onButtonPress,i),r,s,h,f,d=l.getStaticId("sap.m","SPLIT_BUTTON_DESCRIPTION");if(i&&this.getObjectPageLayout().getShowAnchorBar()){i._resetControl();this._oObserver.disconnect();n.forEach(function(t){if(!t.getVisible()||!t._getInternalVisible()){return}var n,l=t.getSubSections()||[];n=this._buildAnchorBarButton(t,true);if(n){i.addContent(n);if(n instanceof u){var _=new c({});n.enhanceAccessibilityState=function(t,e){var n=i.getContent(),o=n.indexOf(t.getParent());if(o!==-1){e.role="option";e.setsize=n.length;e.posinset=o+1;e.labelledby=e.labelledby.split(" ").filter(function(t){return t!==d}).join(" ")}};_._setCustomEnhanceAccStateFunction(function(t,e){e.controls=t.data("sectionId")});n.setMenu(_)}l.forEach(function(t){if(!t.getVisible()||!t._getInternalVisible()){return}var c=this._buildAnchorBarButton(t,false),l=i.getId()+"-"+t.getId()+"-anchor";if(c){i.addContent(c)}if(n instanceof u){f=t.getCustomAnchorBarButton();if(f){r=f.getText();s=f.getIcon()}else{r=t._getInternalTitle()||t.getTitle();s=""}h=new g(l,{text:r,icon:s});h.addCustomData(new o({key:"sectionId",value:t.getId()}));h.attachPress(a);this._setCustomData(h,t,e,false);n.getMenu().addItem(h)}},this)}},this)}};f.prototype._moveFocusOnSection=function(t){var e=t.data(),n=sap.ui.getCore().byId(e.sectionId),o={preventScroll:true},i;if(n){if(n.isActive()){f._focusSection(n,o)}else{i={onAfterRendering:function(){n.removeEventDelegate(i);f._focusSection(n,o)}};n.addEventDelegate(i)}}};f.prototype._instantiateAnchorBarButton=function(t,e,n){var o,i;if(t){o=u;i={type:"Transparent",buttonMode:"Split",useDefaultActionOnly:true,ariaDescribedBy:e}}else{o=s;i={ariaDescribedBy:e}}if(n){i.id=n}return new o(i)};f.prototype._buildAnchorBarButton=function(e,n){var i=null,a=this.getObjectPageLayout(),r,s=this._getAnchorBar(),u,c,g,h,l=e.getAggregation("subSections"),f=t.proxy(s.onButtonPress,s);if(e.getVisible()&&e._getInternalVisible()){r=e.getCustomAnchorBarButton();if(!r){u=s.getId()+"-"+e.getId()+"-anchor";if(n){if(l&&l.length>1){h=l.filter(function(t){return t.getVisible()&&t._getInternalVisible()}).length}}g=n&&h>1&&s.getShowPopover();if(g){i=this._instantiateAnchorBarButton(true,e,u);i.attachDefaultAction(f);i._getButtonControl().attachPress(function(){this.getParent().focus()});i._getButtonControl().attachArrowPress(function(){var t=i._getButtonControl();if(this._aMenusWithAttachPressHandler[t.getId()]){return}i.getMenu().attachItemSelected(function(t){this._moveFocusOnSection(t.getParameter("item"))},this);this._aMenusWithAttachPressHandler[t.getId()]=true},this);i.addCustomData(new o({key:"bHasSubMenu",value:true}))}else if(n){i=this._instantiateAnchorBarButton(false,e,u);i.attachPress(function(t){this._moveFocusOnSection(t.getSource())},this);i.attachPress(f)}else{c=s.getId()+"-"+e.getId()+"-sub-anchor";i=this._instantiateAnchorBarButton(false,e,c)}var d=e._getInternalTitle()!=""?e._getInternalTitle():e.getTitle();i.setText(d)}else{i=r.clone();i.attachPress(function(t){this._moveFocusOnSection(t.getSource())},this);i.attachPress(f);this._oObserver.observe(r,{properties:true})}this._setCustomData(i,e,a,n)}return i};function d(t){return t.substring(0,1).toUpperCase()+t.substring(1)}return f});