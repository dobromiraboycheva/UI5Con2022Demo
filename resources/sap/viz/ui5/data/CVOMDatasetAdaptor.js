/*!
 * SAPUI5
 * (c) Copyright 2009-2022 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/viz/ui5/controls/common/utils/Constants","sap/ui/model/Sorter","sap/ui/thirdparty/jquery","sap/base/util/deepEqual"],function(t,e,a,n){"use strict";function i(t){return Object.prototype.toString.call(t)==="[object Array]"}function r(t,e,i,r,s){var o={dataset:null,context:null};if(!i||i.length===0){return o}var u=[],d=[],f=[],l=[],p=[];a.each(t,function(t,e){if(e.getAxis()===1){u.push({def:e,adapter:e._getAdapter()})}else if(e.getAxis()===2){d.push({def:e,adapter:e._getAdapter()})}else{throw new Error("currently, only axis 1 and 2 are supported")}});a.each(e,function(t,e){f.push({def:e,adapter:e._getAdapter()});l.push([])});function h(t,e,a){var i=t.length,r,s;if(i===0){return 0}r=[];for(s=0;s<i;s++){r.push(t[s].adapter(a))}for(s=0,i=e.length;s<i;s++){if(n(e[s],r)){return s}}e.push(r);return e.length-1}var g=[];var v=[];a.each(i,function(t,e){var a=h(u,g,e);var n=h(d,v,e);for(var i=0;i<f.length;i++){var r=f[i].adapter(e);if(u.length===0&&d.length===0){if(l[i][0]===undefined){l[i][0]=[]}l[i][0].push(r)}else{(l[i][n]=l[i][n]||[])[a]=r}}if(u.length===0&&d.length===0){a=t}(p[n]||(p[n]=[]))[a]=e});var m=g.length;var c=Math.max(v.length,1);for(var _=0;_<c;_++){for(var y=0;y<f.length;y++){var T=l[y][_];if(!T){T=l[y][_]=[]}if(T.length<m){T[m-1]=undefined}}if(!p[_]){p[_]=[]}if(!p[_].length<m){p[_][m]=undefined}}var A={};if(u.length>0){if(A.analysisAxis===undefined){A.analysisAxis=[]}var x={index:1,data:[]};for(var y=0;y<u.length;y++){var D=[];for(var _=0;_<g.length;_++){D[_]=g[_][y]}x.data.push({name:u[y].def.getName(),values:D})}A.analysisAxis.push(x)}if(d.length>0){if(A.analysisAxis===undefined){A.analysisAxis=[]}var x={index:2,data:[]};for(var y=0;y<d.length;y++){var D=[];for(var _=0;_<v.length;_++){D[_]=v[_][y]}x.data.push({name:d[y].def.getName(),values:D})}A.analysisAxis.push(x)}if(f.length>0){A.measureValuesGroup=[];for(var y=0;y<f.length;y++){if(!A.measureValuesGroup[f[y].def.getGroup()-1]){A.measureValuesGroup[f[y].def.getGroup()-1]={index:f[y].def.getGroup(),data:[]}}A.measureValuesGroup[f[y].def.getGroup()-1].data.push({name:f[y].def.getName(),values:l[y]})}for(var y=0,C=A.measureValuesGroup.length;y<C;y++){if(A.measureValuesGroup[y]===undefined){throw new Error("Measure Group "+(y+1)+" is missing.")}}}o.dataset=s?new sap.viz.data.CrosstableDataset:new sap.viz.api.data.CrosstableDataset;o.dataset.data(A);if(r){o.dataset.info(r)}o.context=p;return o}function s(t,a){var n=t&&t.value||t,i=a&&a.value||a;return e.defaultComparator(n,i)}function o(e,n,r,o,u,d){var f={dataset:null,context:null};var l=["_context_row_number"];if(r){if(!i(r)){r=[r]}for(var p=0;p<r.length;++p){var h=r[p];var g=!(h.showInTooltip===false);if(h.id){h=h.id}l.push({id:h,showInTooltip:g})}}var v=[],m=[],c=[],_={metadata:{fields:[]},context:l,data:[]},y=[];a.each(e,function(t,e){v.push({def:e,vAdapter:e._getAdapter(),dAdapter:e._getDisplayValueAdapter()});var a=e.getDataType();var n=e.getSorter();var i={id:e.getIdentity()||e.getName(),name:e.getName()||e.getIdentity(),semanticType:"Dimension",dataType:a,inResult:e._getInResult(),timeUnitType:e._getTimeUnit()};if(n&&typeof n==="object"){var r={bDescending:n.bDescending};r.fnComparator=function(t,e){var a={value:t&&t.v||t,displayValue:t&&t.d},i={value:e&&e.v||e,displayValue:e&&e.d};var r=n.fnComparator&&typeof n.fnComparator==="function"?n.fnComparator:s;return r(a,i)};i["sorter"]=r}_.metadata.fields.push(i)});a.each(n,function(t,e){m.push({def:e,adapter:e._getAdapter()});var a={id:e.getIdentity()||e.getName(),name:e.getName()||e.getIdentity(),semanticType:"Measure"};a.formatString=e.getFormat();if(e.getUnit()){a.unit=e.getUnit()}a.unitBinding=e._getUnitBinding();var n=e.getRange();if(n&&n.length){a.min=n[0];a.max=n[1]}_.metadata.fields.push(a)});if(u){if(u.bEnabled){_.metadata.options={pagination:{mode:u.sMode,ratio:u.thumbRatio}}}}if(!o||o.length===0){f.dataset=new sap.viz.api.data.FlatTableDataset(_);return f}if(u&&(!d||u.sMode==="reset")){d=[]}a.each(o,function(e,a){if(!_.data[e]){_.data[e]=[]}for(var n=0;n<v.length;n++){var i=v[n].vAdapter(a);if(i instanceof Date){i=i.getTime()}var r=v[n].dAdapter(a);_.data[e].push(r.enableDisplayValue?{v:i,d:r.value}:i)}for(var s=0;s<m.length;s++){var i=m[s].adapter(a);_.data[e].push(i);var o=m[s].def._getUnitBinding();if(o){var f=a.getProperty(o);f=f&&f.trim&&f.trim();if(f){if(c[s]){if(c[s]==="*"||c[s]!==f||u&&d[s]!==f){throw t.ERROR_MESSAGE.MULTIPLEUNITS}}else{c[s]=f;if(u&&!d[s]){d[s]=f}}}}}y[e]=a});f.context=y;_.metadata.fields.filter(function(t){return t.semanticType==="Measure"}).forEach(function(t,e){if(t.unitBinding&&c[e]){t.unit=c[e];delete t.unitBinding}});f.dataset=new sap.viz.api.data.FlatTableDataset(_);return f}var u=function(){this._oCVOMDataset=null;this._aContext=null;this._sDatasetType=null;this._pagingUnit=null};u.prototype.getDataset=function(e){if(this._sDatasetType===e.type&&this._oCVOMDataset){return this._oCVOMDataset}this.invalidate();this._sDatasetType=e.type;var a=null;if(this._sDatasetType===t.DATASET_TYPES.FLATTABLEDATASET){a=o(e.dimensions,e.measures,e.contexts,e.dataContexts,e.pagingOption,this._pagingUnit)}else{a=r(e.dimensions,e.measures,e.dataContexts,e.additionalInfo,this._sDatasetType==t.DATASET_TYPES.CROSSTABLEDATASET?false:true)}this._oCVOMDataset=a.dataset;this._aContext=a.context;return this._oCVOMDataset};u.prototype.findContext=function(e){if(this._sDatasetType===t.DATASET_TYPES.FLATTABLEDATASET){if(this._aContext&&typeof e==="object"&&e._context_row_number!==undefined){return this._aContext[e._context_row_number]}}else{if(this._aContext&&typeof e==="object"){return this._aContext[e.dii_a2]&&this._aContext[e.dii_a2][e.dii_a1]}}return null};u.prototype.invalidate=function(){this._oCVOMDataset=null;this._aContext=null};return u},true);