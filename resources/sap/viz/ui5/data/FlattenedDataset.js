/*!
 * SAPUI5
 * (c) Copyright 2009-2022 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/viz/library","sap/ui/model/ChangeReason","./Dataset","./CVOMDatasetAdaptor","sap/viz/ui5/controls/common/utils/Constants","sap/base/Log","sap/ui/thirdparty/jquery"],function(t,e,a,i,n,o,s){"use strict";var r=a.extend("sap.viz.ui5.data.FlattenedDataset",{metadata:{library:"sap.viz",designtime:"sap/viz/designtime/FlattenedDataset.designtime",properties:{context:{type:"any",multiple:false,singularName:"context"}},aggregations:{dimensions:{type:"sap.viz.ui5.data.DimensionDefinition",multiple:true,singularName:"dimension"},measures:{type:"sap.viz.ui5.data.MeasureDefinition",multiple:true,singularName:"measure"},data:{type:"sap.ui.core.Element",multiple:true,singularName:"data",bindable:"bindable"}},events:{dataChange:{},dataRefresh:{},dataError:{}}}});r.getMetadata().getAllAggregations()["data"]._doesNotRequireFactory=true;r.prototype.init=function(){this._oCVOMDatasetAdaptor=new i;this._iStartIndex=-1;this._iLength=-1;this._bReady=true;this._bInitializeBinding=true};r.prototype._bindAggregation=function(){this._bInitializeBinding=true;this._bUpdateAnalyticalInfo=false;a.prototype._bindAggregation.apply(this,arguments);this._bInitializeBinding=false;var t=this.getBinding("data");if(t){t.attachDataReceived(this._dataReceivedListener,this)}};r.prototype._dataReceivedListener=function(t){if(t&&t.getParameter&&t.getParameter("__simulateAsyncAnalyticalBinding")){return}if(t.getParameter("data")===undefined){this._bDataReceiveError=true;this.fireEvent("dataError")}};r.prototype.refreshData=function(t){this._bDataReceiveError=false;this._bReady=false;if(this._bInitializeBinding){var e=this.getBinding("data");if(e&&e.getTotalSize&&e.isRelative()){this._bUpdateAnalyticalInfo=true}}var a={reason:t};if(!this._bInitializeBinding&&this._bUpdateAnalyticalInfo&&t==="refresh"){a.updateAnalyticalInfo=true}this.fireEvent("dataRefresh",a);this._getDataContexts()};r.prototype.updateData=function(t){var e=sap.ui.require("sap/ui/model/odata/v4/ODataModel");var a=e&&this.getBinding("data").getModel()instanceof e;if(!this._bInitializeBinding||!a){this._bDataReceiveError=false;this._bReady=true;this.fireEvent("dataChange",{reason:t});this.invalidate()}};s.each("add get indexOf insert remove removeAll".split(" "),function(t,e){var a="FlattenedDataset manages the 'data' aggregation only via data binding. The method '"+e+"Data' therefore cannot be used programmatically!";r.prototype[e+"Data"]=function(){o.error(a)}});r.prototype.getVIZFlatDataset=function(){return this._getCVOMDataset(n.DATASET_TYPES.FLATTABLEDATASET)};r.prototype.getVIZCrossDataset=function(){return this._getCVOMDataset(n.DATASET_TYPES.CROSSTABLEDATASET)};r.prototype.getVIZDataset=function(){return this._getCVOMDataset(n.DATASET_TYPES.LEGACYCROSSTABLEDATASET)};r.prototype._getCVOMDataset=function(t){var e=this._getDataContexts()&&this._getDataContexts().filter(function(t){return!!t});return this._oCVOMDatasetAdaptor.getDataset({type:t,dataContexts:e,dimensions:this.getDimensions(),measures:this.getMeasures(),additionalInfo:this._info||this._defaultSelectionInfo,contexts:this.getContext(),pagingOption:this._oPagingOption})};r.prototype.invalidate=function(t){if(this._oCVOMDatasetAdaptor){this._oCVOMDatasetAdaptor.invalidate()}a.prototype.invalidate.apply(this,arguments)};r.prototype.setDefaultSelection=function(t){this._defaultSelectionInfo={type:"defaultSelection",value:t}};r.prototype.info=function(t){if(t instanceof Array){this._info=t}};r.prototype.findContext=function(t){if(this._oCVOMDatasetAdaptor){return this._oCVOMDatasetAdaptor.findContext(t)}};r.prototype.setPagingOption=function(t){this._oPagingOption=t};r.prototype.getRenderedPageNo=function(){if(this._oCVOMDatasetAdaptor){return this._oCVOMDatasetAdaptor.getRenderedPageNo()}};r.prototype.setRange=function(t,e){this._iStartIndex=t;this._iLength=e};r.prototype.getRange=function(t,e){return{iStartIndex:this._iStartIndex,iLength:this._iLength}};r.prototype.isReady=function(){if(this._bDataReceiveError){return true}return this._bReady};r.prototype._getDataContexts=function(){var t=this._iStartIndex,e=this._iLength,a=this.getBinding("data"),i=sap.ui.require("sap/ui/model/odata/v4/ODataModel");if(!a){return null}var n;if(t==-1){n=this.getBindingInfo("data");t=n&&n.startIndex!==undefined?n.startIndex:0}var o=!this._oPagingOption;if(e==-1){n=n||this.getBindingInfo("data");if(n&&n.length!==undefined){e=n.length;o=false}else{e=a.getTotalSize?a.getTotalSize():a.getLength()}}if(this._bDataReceiveError){return[]}else if(i&&a.getModel()instanceof i){return o?a.getContexts(t,e,Infinity):a.getContexts(t,e)}else{return a.getContexts(t,e)}};return r});