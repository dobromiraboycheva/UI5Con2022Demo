/*
 * ! OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/Device","sap/ui/core/InvisibleText","sap/ui/core/Item","sap/ui/core/Control","sap/ui/layout/HorizontalLayout","sap/m/SearchField","sap/m/Page","sap/m/Toolbar","sap/m/ToggleButton","sap/m/Title","sap/m/ResponsivePopover","sap/m/SelectList","sap/ui/events/KeyCodes","sap/m/library","sap/ui/model/base/ManagedObjectModel","sap/ui/base/ManagedObjectObserver"],function(e,t,i,o,s,r,n,a,l,h,c,p,d,u,g,v,m,f){"use strict";var y=v.ButtonType;var S=v.PlacementType;var T=r.extend("sap.ui.mdc.filterbar.vh.CollectiveSearchSelect",{metadata:{library:"sap.ui.mdc",properties:{title:{type:"string",group:"Misc",defaultValue:null},selectedItemKey:{type:"string",group:"Misc",defaultValue:null},_currentItemText:{type:"string",group:"Misc",defaultValue:null,hidden:true}},aggregations:{items:{type:"sap.ui.core.Item",multiple:true,singularName:"item"}},events:{select:{parameters:{key:{type:"string"}}}}},renderer:{apiVersion:2,render:function(e,t){e.openStart("div",t).class("sapUiMdcCollectiveSearchSelect").attr("title",t.oRb.getText("COL_SEARCH_TRIGGER_TT")).openEnd();e.renderControl(t.oLayout);e.close("div")}}});T.prototype.init=function(){this._oManagedObjectModel=new m(this);this.setModel(this._oManagedObjectModel,"$mdcColSearch");this._oObserver=new f(this._observeChanges.bind(this));this._oObserver.observe(this,{properties:["selectedItemKey"],aggregations:["items"]});this.oRb=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");this.oInvisibleText=new o;this.oText=new p(this.getId()+"-text",{text:"{$mdcColSearch>/_currentItemText}"}).addStyleClass("sapUiMdcCollectiveSearchSelectClickable").addStyleClass("sapUiMdcCollectiveSearchSelectTitle");if(i.system.phone){this.oText.addStyleClass("sapUiMdcCollectiveSearchSelectTextPhoneMaxWidth")}else{this.oText.addStyleClass("sapUiMdcCollectiveSearchSelectTextMaxWidth")}this.oPopoverTrigger=new c(this.getId()+"-trigger",{icon:"sap-icon://slim-arrow-down",type:y.Transparent,tooltip:this.oRb.getText("COL_SEARCH_TRIGGER_TT")}).addAriaLabelledBy(this.oInvisibleText).addStyleClass("sapUiMdcCollectiveSearchSelectTriggerBtn").addStyleClass("sapMTitleStyleH4");this.oLayout=new n({content:[this.oText,this.oPopoverTrigger]}).addStyleClass("sapUiMdcCollectiveSearchSelectLayout");this.oInvisibleText.toStatic();this.addDependent(this.oLayout)};T.prototype._observeChanges=function(e){if(["selectedItemKey","items"].indexOf(e.name)>=-1){this._updateCurrentItemText()}};T.prototype._updateCurrentItemText=function(){var e=this.getSelectedItemKey();var t=this._getItemByKey(e);var i=t?t.getText():e;this.oInvisibleText.setText(this.oRb.getText("COL_SEARCH_SEL_INVISIBLETXT",[i]));this.setProperty("_currentItemText",i)};T.prototype._getItemByKey=function(e){var t=null;var i=this.getItems();i.some(function(i){if(i.getKey()===e){t=i}return t!==null});return t};T.prototype.handleOpenClosePopover=function(){if(!this.bPopoverOpen){this._openList()}else if(this.oPopover&&this.oPopover.isOpen()){this.oPopover.close()}};T.prototype.getFocusDomRef=function(){if(this.oPopoverTrigger){return this.oPopoverTrigger.getFocusDomRef()}};T.prototype.onclick=function(){if(this.oPopoverTrigger&&!this.bPopoverOpen){this.oPopoverTrigger.focus()}this.handleOpenClosePopover()};T.prototype.onkeyup=function(e){if(e.which===g.F4||e.which===g.SPACE||e.altKey===true&&e.which===g.ARROW_UP||e.altKey===true&&e.which===g.ARROW_DOWN){this._openList()}};T.prototype.onAfterRendering=function(){this.oText.$().off("mouseover").on("mouseover",function(){this.oPopoverTrigger.addStyleClass("sapUiMdcCollectiveSearchSelectTriggerBtnHover")}.bind(this));this.oText.$().off("mouseout").on("mouseout",function(){this.oPopoverTrigger.removeStyleClass("sapUiMdcCollectiveSearchSelectTriggerBtnHover")}.bind(this))};T.prototype._createList=function(){if(this.oPopover){return}this.oList=new u(this.getId()+"-list",{selectedKey:{path:"$mdcColSearch>/selectedItemKey"},itemPress:function(e){var t=null;if(e&&e.getParameter("item")){var i=e.getParameter("item");if(i){t=i.getKey()}}this.oPopover.close();if(this.getSelectedItemKey()!==t){this.setSelectedItemKey(t);this.fireSelect({key:t})}}.bind(this)});this.oList.bindAggregation("items",{path:"/items",model:"$mdcColSearch",template:new s({key:"{$mdcColSearch>key}",text:"{$mdcColSearch>text}"})});this.oSearchField=new a(this.getId()+"-search");this.oSearchField.attachLiveChange(function(e){var t=e.getParameter("newValue")||"";this._triggerSearch(t,this.oList)}.bind(this));this.oPage=new l(this.getId()+"-selpage",{subHeader:new h({content:[this.oSearchField]}),content:[this.oList],showNavButton:false,showHeader:false});this.oPopover=new d(this.getId()+"-popover",{title:{path:"$mdcColSearch>/title"},titleAlignment:"Auto",contentWidth:"400px",placement:S.VerticalPreferredBottom,content:[this.oPage],afterOpen:function(){this.bPopoverOpen=true;this.oPopoverTrigger.setPressed(true)}.bind(this),afterClose:function(){this.oPopoverTrigger.setPressed(false);if(this.bPopoverOpen){setTimeout(function(){this.bPopoverOpen=false}.bind(this),200)}}.bind(this),contentHeight:"300px"});this.oPopover.addStyleClass("sapUiMdcCollectiveSearchSelectPopover");if(this.oLayout.$().closest(".sapUiSizeCompact").length>0){this.oPopover.addStyleClass("sapUiSizeCompact")}this.addDependent(this.oPopover)};T.prototype._openList=function(){if(this.bPopoverOpen){return}this._createList();this.oSearchField.setValue("");this._triggerSearch("",this.oList);this.oPage.setShowSubHeader(this.oList.getItems().length>9);this.oPopover.openBy(this.oPopoverTrigger)};T.prototype._triggerSearch=function(i,o){var s=[];if(i){var r=new e({path:"text",operator:t.Contains,value1:i});s.push(r)}o.getBinding("items").filter(s)};T.prototype.exit=function(){if(this.oInvisibleText){this.oInvisibleText.destroy(true);this.oInvisibleText=undefined}this.oRb=undefined;this.oList=undefined;this.oPage=undefined;this.oLayout=undefined;this.oText=undefined;this.oPopoverTrigger=undefined;this.oSearchField=undefined;this._oManagedObjectModel.destroy();this._oManagedObjectModel=undefined;this._oObserver.disconnect();this._oObserver=undefined};return T});