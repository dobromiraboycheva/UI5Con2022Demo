/*
 * ! OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/mdc/filterbar/p13n/GroupContainer","sap/ui/mdc/filterbar/p13n/FilterColumnLayout","sap/ui/mdc/filterbar/p13n/FilterGroupLayout","sap/ui/mdc/filterbar/p13n/TableContainer","sap/ui/mdc/filterbar/FilterBarBase","sap/ui/mdc/filterbar/FilterBarBaseRenderer","sap/base/util/merge","sap/base/util/UriParameters","sap/ui/core/Core","sap/ui/mdc/enum/PersistenceMode"],function(t,e,i,n,o,r,a,s,l,p){"use strict";var h=o.extend("sap.ui.mdc.filterbar.p13n.AdaptationFilterBar",{metadata:{library:"sap.ui.mdc",associations:{adaptationControl:{type:"sap.ui.mdc.Control",multiple:false}},events:{change:{}}},renderer:r});h.prototype.init=function(){o.prototype.init.apply(this,arguments);this.addStyleClass("sapUIAdaptationFilterBar");this._bPersistValues=true;this.getEngine().defaultProviderRegistry.attach(this,p.Transient);this._fnResolveAdaptationControlPromise=null;this._oAdaptationControlPromise=new Promise(function(t,e){this._fnResolveAdaptationControlPromise=t}.bind(this))};h.prototype.applySettings=function(){o.prototype._applySettings.apply(this,arguments);this._waitForAdaptControlAndPropertyHelper().then(function(){this._initControlDelegate()}.bind(this))};h.prototype._getPropertyByName=function(t){var e=this.getPropertyHelper();if(e){var i=e.getProperties().find(function(e){return e.path===t});if(!i){i=e.getPropertyMap()[t]||null}return i}};h.prototype._waitForAdaptControlAndPropertyHelper=function(){return this._oAdaptationControlPromise.then(function(){return this._getAdaptationControlInstance().awaitPropertyHelper().then(function(t){this._oPropertyHelper=t}.bind(this))}.bind(this))};h.prototype._initControlDelegate=function(){return this.initControlDelegate().then(function(){if(!this._bIsBeingDestroyed){this._applyInitialFilterConditions()}}.bind(this))};h.prototype.getControlDelegate=function(){return this._getAdaptationControlInstance().getControlDelegate()};h.prototype.initControlDelegate=function(){return this._oAdaptationControlPromise.then(function(){return this._getAdaptationControlInstance().initControlDelegate()}.bind(this))};h.prototype.initPropertyHelper=function(){return this._oAdaptationControlPromise.then(function(){return this._getAdaptationControlInstance().initPropertyHelper()}.bind(this))};h.prototype.getTypeUtil=function(){if(!this._getAdaptationControlInstance()){throw new Error("No adaptation control assigned yet.")}return this._getAdaptationControlInstance().getTypeUtil()};h.prototype.setMessageStrip=function(t){this._oFilterBarLayout.setMessageStrip(t)};h.prototype.setLiveMode=function(t,e){o.prototype.setLiveMode.apply(this,arguments);this._oConditionModel.attachPropertyChange(function(t){var e=t.getParameter("path").substring(12);if(this.oAdaptationData){var i=this.oAdaptationData.items;var n=i.find(function(t){return t.name==e});if(n){n.active=this._getConditionModel().getConditions(e).length>0?true:false}}}.bind(this));return this};h.prototype._retrieveMetadata=function(){return this._oAdaptationControlPromise.then(function(){return this._getAdaptationControlInstance().awaitPropertyHelper().then(function(t){this._oMetadataAppliedPromise=Promise.resolve();if(!this._getAdaptationControlInstance().isPropertyHelperFinal()){return this.finalizePropertyHelper()}return o.prototype._retrieveMetadata.apply(this,arguments)}.bind(this))}.bind(this))};h.prototype.createConditionChanges=function(){return Promise.all([this._oAdaptationControlPromise,this._getAdaptationControlInstance().awaitControlDelegate()]).then(function(){var t=this._getModelConditions(this._getConditionModel(),false,true);if(this._bPersistValues){return this.getEngine().createChanges({control:this._getAdaptationControlInstance(),key:"Filter",state:t,suppressAppliance:true})}else{this._getAdaptationControlInstance()._setXConditions(t,true);return Promise.resolve(null)}}.bind(this))};h.prototype.setP13nData=function(t){this.oAdaptationData=t;this._oFilterBarLayout.update(t)};h.prototype.getP13nData=function(){return this.oAdaptationData};h.prototype._handleFilterItemSubmit=function(){return};h.prototype._getWaitForChangesPromise=function(){return this.getEngine().waitForChanges(this._getAdaptationControlInstance())};h.prototype.applyConditionsAfterChangesApplied=function(t){o.prototype.applyConditionsAfterChangesApplied.apply(this,arguments);if(t===this._getAdaptationControlInstance()){this.triggerSearch()}};h.prototype.createFilterFields=function(){return this.initialized().then(function(){var t=this._bPersistValues?this._getAdaptationControlInstance().getFilterConditions():this._getAdaptationControlInstance()._getXConditions();this.setFilterConditions(t);this._setXConditions(t,true);if(this._bFilterFieldsCreated){this._oFilterBarLayout.setP13nData(this.oAdaptationData);return this}var e=this._getAdaptationControlInstance();var i=e.getControlDelegate();var n=this._checkAdvancedParent(e)?i:i.getFilterDelegate();this._mOriginalsForClone={};var o=[];this.oAdaptationData.items.forEach(function(t,i){var r;r=this._checkExisting(t,n);r.then(function(i){var n;if(this._checkAdvancedParent(e)){if(i._bTemporaryOriginal){delete r._bTemporaryOriginal;this._mOriginalsForClone[i.getFieldPath()]=i}n=i.clone()}else{n=i}t.filterfield=n}.bind(this));o.push(r)}.bind(this));return Promise.all(o).then(function(){this.oAdaptationData.items.forEach(function(t){this.addAggregation("filterItems",t.filterfield);delete t.filterfield}.bind(this));this._oFilterBarLayout.setP13nData(this.oAdaptationData);this._bFilterFieldsCreated=true;return this}.bind(this))}.bind(this))};h.prototype._checkExisting=function(t,e){var i;var n=this._getAdaptationControlInstance();var o=this._checkAdvancedParent(n)?n.getFilterItems():[];var r=o.reduce(function(t,e){t[e.getFieldPath()]=e;return t},{});if(r[t.name]){i=Promise.resolve(r[t.name])}else{i=e.addItem(t.name,this._getAdaptationControlInstance());i=i.then(function(e){if(!e){throw new Error("No FilterField could be created for property: '"+t.name+"'.")}e._bTemporaryOriginal=true;return e})}return i};h.prototype.executeRemoves=function(){var t=this._oFilterBarLayout.getInner().getSelectedFields();var e=[];Object.keys(this._mOriginalsForClone).forEach(function(i){var n=this._getAdaptationControlInstance().getControlDelegate();if(t.indexOf(i)<0){var o=n.removeItem.call(n,i,this._getAdaptationControlInstance()).then(function(t){if(t&&this._mOriginalsForClone[i]){this._mOriginalsForClone[i].destroy();delete this._mOriginalsForClone[i]}}.bind(this));e.push(o)}}.bind(this));return Promise.all(e)};h.prototype._checkAdvancedParent=function(t){if(!t.isA("sap.ui.mdc.IFilterSource")&&!t.isA("sap.ui.mdc.IFilter")){throw new Error("The 'adaptationControl' needs to implement the IFilterSource or IFilter interface")}return t.isA("sap.ui.mdc.IFilter")};h.prototype.setAdaptationControl=function(o,r){if(this._fnResolveAdaptationControlPromise){this._fnResolveAdaptationControlPromise();this._fnResolveAdaptationControlPromise=null}this.setAssociation("adaptationControl",o,r);var l=new s(window.location.search).getAll("sap-ui-xx-filterQueryPanel")[0]==="true";this._cLayoutItem=l||this._checkAdvancedParent(o)?i:e;this._oFilterBarLayout=this._checkAdvancedParent(o)?new t:new n;this._oFilterBarLayout.getInner().setParent(this);this.setAggregation("layout",this._oFilterBarLayout,true);if(this._oFilterBarLayout.getInner().attachChange){this._oFilterBarLayout.getInner().attachChange(function(t){if(t.getParameter("reason")==="Remove"){var e=t.getParameter("item");var i=this._bPersistValues?a({},this._getAdaptationControlInstance().getFilterConditions()):this._getAdaptationControlInstance()._getXConditions();i[e.name]=[];this._setXConditions(i,true)}this.fireChange()}.bind(this))}return this};h.prototype._getAdaptationControlInstance=function(){var t=this.getAdaptationControl();return t&&l.byId(t)};h.prototype.exit=function(){this.getEngine().defaultProviderRegistry.detach(this);o.prototype.exit.apply(this,arguments);for(var t in this._mOriginalsForClone){this._mOriginalsForClone[t].destroy()}this._mOriginalsForClone=null;this.oAdaptationData=null;this._fnResolveAdaptationControlPromise=null;this._oAdaptationControlPromise=null};return h});