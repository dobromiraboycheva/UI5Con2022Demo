/*
 * ! OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/mdc/p13n/AdaptationProvider","sap/base/util/merge","sap/base/Log","sap/ui/mdc/util/PropertyHelper","sap/ui/mdc/p13n/modification/FlexModificationHandler","sap/m/MessageStrip","sap/ui/core/library","sap/ui/core/Element","sap/ui/mdc/p13n/modules/DefaultProviderRegistry","sap/ui/mdc/p13n/UIManager","sap/ui/mdc/p13n/modules/StateHandlerRegistry","sap/ui/mdc/p13n/modules/xConfigAPI"],function(t,e,r,n,i,o,a,s,l,c,u,f){"use strict";var d="Engine: This class is a singleton. Please use the getInstance() method instead.";var p=a.MessageType;var h=new WeakMap;var g;var y=t.extend("sap.ui.mdc.p13n.Engine",{constructor:function(){t.call(this);if(g){throw Error(d)}this._aRegistry=[];this._aStateHandlers=[];this.defaultProviderRegistry=l.getInstance(this);this.uimanager=c.getInstance(this);this.stateHandlerRegistry=u.getInstance()}});y.prototype.registerAdaptation=function(t,e){if(!e.hasOwnProperty("controller")){throw new Error("Please provide atleast a configuration 'controller' containing a map of key-value pairs (key + Controller class) in order to register adaptation.")}if(this._getRegistryEntry(t)){this.deregisterAdaptation(t)}var r=Object.keys(e.controller);r.forEach(function(r){var n=e.controller[r];if(!this.getController(t,r)){if(this._aRegistry.indexOf(t.getId())<0){this._aRegistry.push(t.getId())}var i=new n(t);this.addController(i,r)}}.bind(this))};y.prototype.deregisterAdaptation=function(t){var e=this._getRegistryEntry(t);Object.keys(e.controller).forEach(function(t){var r=e.controller[t];r.destroy();delete e.controller[t]});h.delete(t);var r=this._aRegistry.indexOf(t.getId());this._aRegistry.splice(r,1)};y.prototype._setModificationHandler=function(t,e){if(!e.isA("sap.ui.mdc.p13n.modification.ModificationHandler")){throw new Error("Only sap.ui.mdc.p13n.modification.ModificationHandler derivations are allowed for modification")}var r=this._determineModification(t);r.handler=e;this._getRegistryEntry(t).modification=r};var v=function(t,e){var r=function(e){if(t._pModificationQueue===e){delete t._pModificationQueue}};t._pModificationQueue=t._pModificationQueue instanceof Promise?t._pModificationQueue.then(e):e();t._pModificationQueue.then(r.bind(null,t._pModificationQueue));return t._pModificationQueue};y.prototype.createChanges=function(t){var r=t.key;var n=t.state;var i=!!t.applyAbsolute;var o=!!t.suppressAppliance;var a=!!t.applySequentially;if(!r||!t.control||!n){throw new Error("To create changes via Engine, atleast a 1)Control 2)Key and 3)State needs to be provided.")}var s=y.getControlInstance(t.control);var l=function(){return this.initAdaptation(s,r).then(function(){var a=this.getController(s,r);var l=a.getChangeOperations();var c=this._getRegistryEntry(s);var u=a.getCurrentState();var f=e(u instanceof Array?[]:{},u);var d={existingState:t.stateBefore||f,applyAbsolute:i,changedState:n,control:a.getAdaptationControl(),changeOperations:l,deltaAttributes:["name"],propertyInfo:c.helper.getProperties().map(function(t){return{name:t.name}})};var p=a.getDelta(d);if(!o){return this._processChanges(s,p)}return p||[]}.bind(this))}.bind(this);if(a){return v(s,l)}else{return l.apply(this)}};y.prototype.reset=function(t,e){e=e instanceof Array?e:[e];var r=[];e.forEach(function(e){r=r.concat(this.getController(t,e).getSelectorForReset())}.bind(this));var n={selectors:r,selector:t};var i=this._determineModification(t);return i.handler.reset(n,i.payload).then(function(){this.stateHandlerRegistry.fireChange(t);return this.initAdaptation(t,e).then(function(r){e.forEach(function(e){var n=this.getController(t,e);n.update(r)}.bind(this))}.bind(this))}.bind(this))};y.prototype.waitForChanges=function(t){var e=this._determineModification(t);return e.handler.waitForChanges({element:t},e.payload)};y.prototype.isModificationSupported=function(t){var e=this._determineModification(t);return e.handler.isModificationSupported({element:t},e.payload)};y.prototype._processChanges=function(t,e){if(e instanceof Array&&e.length>0){var r=this._determineModification(t);return r.handler.processChanges(e,r.payload).then(function(e){var r=y.getControlInstance(t);this.stateHandlerRegistry.fireChange(r);return e}.bind(this))}else{return Promise.resolve([])}};y.prototype.getRTASettingsActionHandler=function(t,e,r){var n;var o=y.hasForReference(t,"sap.ui.mdc.p13n.PersistenceProvider");if(o.length>0&&!t.isA("sap.ui.mdc.link.Panel")){return Promise.reject("Please do not use a PeristenceProvider in RTA.")}var a=this.getModificationHandler(t);var s=new i;var l=new Promise(function(t,e){n=t});s.processChanges=function(t){n(t);return Promise.resolve(t)};this._setModificationHandler(t,s);this.uimanager.show(t,r).then(function(t){var r=t.getCustomHeader();if(r){r.getContentRight()[0].setVisible(false)}t.addStyleClass(e.styleClass);if(e.fnAfterClose instanceof Function){t.attachAfterClose(e.fnAfterClose)}});l.then(function(){this._setModificationHandler(t,a);s.destroy()}.bind(this));return l};y.prototype.enhanceXConfig=function(t,e){var r=y.getControlInstance(t);var n=this._getRegistryEntry(t);return Promise.resolve().then(function(){return f.enhanceConfig(r,e).then(function(t){if(n){n.xConfig=t}})})};y.prototype.readXConfig=function(t,e){var r=y.getControlInstance(t);return f.readConfig(r,e)||{}};y.prototype.externalizeKeys=function(t,e){var r={};Object.keys(e).forEach(function(n){var i=this.getController(y.getControlInstance(t),n);if(i){r[i.getStateKey()]=e[n]}}.bind(this));return r};y.prototype.internalizeKeys=function(t,e){var r=this.getRegisteredControllers(t),n={};r.forEach(function(r){var i=this.getController(t,r).getStateKey();if(e.hasOwnProperty(i)){n[r]=e[i]}}.bind(this));return n};y.prototype.applyState=function(t,e,n){return this.retrieveState(t).then(function(i){var o=[],a=[],s={};if(t.validateState instanceof Function){s=t.validateState(this.externalizeKeys(t,e))}if(s.validation===p.Error){r.error(s.message)}Object.keys(e).forEach(function(r){var i=this.getController(t,r);if(!i){return}var a=this.createChanges({control:t,key:r,state:i.sanityCheck(e[r]),suppressAppliance:true,applyAbsolute:n});o.push(a)}.bind(this));return Promise.all(o).then(function(e){e.forEach(function(t){if(t&&t.length>0){a=a.concat(t)}});return this._processChanges(t,a)}.bind(this))}.bind(this))};y.prototype.diffState=function(t,r,n){var i=[],o={};r=e({},r);n=e({},n);this.getRegisteredControllers(t).forEach(function(e){i.push(this.createChanges({control:t,stateBefore:r[e],state:n[e],applyAbsolute:true,key:e,suppressAppliance:true}))}.bind(this));return Promise.all(i).then(function(e){this.getRegisteredControllers(t).forEach(function(i,a){var s=this.getController(t,i).changesToState(e[a],r[i],n[i]);o[i]=s}.bind(this));return o}.bind(this))};y.prototype.retrieveState=function(t){var r=this.checkXStateInterface(t);if(!r){throw new Error("The control needs to implement the interface IxState.")}return t.initialized().then(function(){return y.getInstance().waitForChanges(t).then(function(){var r={};y.getInstance().getRegisteredControllers(t).forEach(function(e){r[e]=y.getInstance().getController(t,e).getCurrentState()});return e({},r)})})};y.prototype.checkXStateInterface=function(t){if(!t){return false}if(!this.isModificationSupported(t)){return false}if(!t.isA("sap.ui.mdc.IxState")){return false}return true};y.prototype.initAdaptation=function(t,e,r){this.verifyController(t,e);return this._retrievePropertyHelper(t,r)};y.prototype.addController=function(t,e,r){var n=this._createRegistryEntry(t.getAdaptationControl(),r);n.controller[e]=t};y.prototype.getController=function(t,e){var r=this._getRegistryEntry(t);if(r&&r.controller.hasOwnProperty(e)){return r.controller[e]}};y.prototype.verifyController=function(t,e){var r=e instanceof Array?e:[e];r.forEach(function(e){if(!this.getController(t,e)){var r=y.getControlInstance(t);throw new Error("No controller registered yet for "+r.getId()+" and key: "+e)}}.bind(this))};y.prototype.getUISettings=function(t,e){var r=Array.isArray(e)?e:[e];this.verifyController(t,r);var n=this._getRegistryEntry(t).helper;var i={};r.forEach(function(e){var r=this.getController(t,e);var o=r.getAdaptationUI(n);if(o instanceof Promise){i[e]={};i[e]={resetEnabled:r.getResetEnabled(),containerSettings:r.getUISettings(),adaptationUI:o}}}.bind(this));return i};y.prototype.isRegisteredForModification=function(t){var e=this._getRegistryEntry(t);return e&&!!e.modification};y.prototype.getRegisteredControllers=function(t){var e=this._getRegistryEntry(t);return Object.keys(e.controller)};y.prototype._getRegistryEntry=function(t){var e=y.getControlInstance(t);return h.get(e)};y.prototype.getModificationHandler=function(t){var e=this._determineModification(t);return e.handler};y.prototype._createRegistryEntry=function(t,e){var r=y.getControlInstance(t);if(!h.has(r)){h.set(r,{modification:e&&e.modification?e.modification:null,controller:{},activeP13n:null,helper:null,xConfig:null})}return h.get(r)};y.prototype._determineModification=function(t){var e=this._getRegistryEntry(t);if(e&&e.modification){return e.modification}var r=y.hasForReference(t,"sap.ui.mdc.p13n.PersistenceProvider");var n=y.hasForReference(t,"sap.ui.fl.variants.VariantManagement");var o=r.length?r:undefined;var a=o?o[0].getMode():"Standard";var s={undefined:i,Global:i,Transient:i,Standard:i,Auto:i};var l=s[a];if(!l){throw new Error("Please provide a valid ModificationHandler! - valid Modification handlers are:"+Object.keys(s))}var c={handler:l.getInstance(),payload:{hasVM:n&&n.length>0,hasPP:r&&r.length>0,mode:a}};if(e&&!e.modification){e.modification=c}return c};y.hasForReference=function(t,e){var r=t&&t.getId?t.getId():t;var n=s.registry.filter(function(t){if(!t.isA(e)){return false}var n=t.getFor();for(var i=0;i<n.length;i++){if(n[i]===r||y.hasControlAncestorWithId(r,n[i])){return true}}return false});return n};y.hasControlAncestorWithId=function(t,e){var r;if(t===e){return true}r=sap.ui.getCore().byId(t);while(r){if(r.getId()===e){return true}if(typeof r.getParent==="function"){r=r.getParent()}else{return false}}return false};y.getControlInstance=function(t){return typeof t=="string"?sap.ui.getCore().byId(t):t};y.prototype.hasActiveP13n=function(t){return!!this._getRegistryEntry(t).activeP13n};y.prototype.setActiveP13n=function(t,e){this._getRegistryEntry(t).activeP13n=e};y.prototype.validateP13n=function(t,e,n){var i=this.getController(t,e);var a=y.getControlInstance(t);var s=this._getRegistryEntry(t).controller;var l={};Object.keys(s).forEach(function(t){l[t]=s[t].getCurrentState()});if(i&&i.model2State instanceof Function){l[e]=i.model2State();var c=a.validateState(this.externalizeKeys(a,l),e);var u;if(c.validation!==p.None){u=new o({type:c.validation,text:c.message})}if(n.setMessageStrip instanceof Function){n.setMessageStrip(u)}else{r.warning("message strip could not be provided - the adaptation UI needs to implement 'setMessageStrip'")}return c}else{return undefined}};y.prototype.handleP13n=function(t,e){var r=[];e.forEach(function(e){var n=this.getController(t,e);var i=this.createChanges({control:t,key:e,state:n.getP13nData(),suppressAppliance:true,applyAbsolute:true}).then(function(t){return n.getBeforeApply().then(function(e){var r=e?e.concat(t):t;return r})});r.push(i)}.bind(this));return Promise.all(r).then(function(e){var r=[];e.forEach(function(t){r=r.concat(t)});if(r.length>0){y.getInstance()._processChanges(t,r)}})};y.prototype._retrievePropertyHelper=function(t,e){var r=this._getRegistryEntry(t);var i=y.getControlInstance(t);if(e){if(r.helper){r.helper.destroy()}r.helper=new n(e);return Promise.resolve(r.helper)}if(r.helper){return Promise.resolve(r.helper)}return i.initPropertyHelper().then(function(t){r.helper=t;return t},function(t){throw new Error(t)})};y.getInstance=function(){if(!g){g=new y}return g};y.prototype._getRegistry=function(){var t={stateHandlerRegistry:this.stateHandlerRegistry,defaultProviderRegistry:this.defaultProviderRegistry,controlRegistry:{}};this._aRegistry.forEach(function(e){var r=sap.ui.getCore().byId(e);t.controlRegistry[e]=h.get(r)});return t};y.prototype.destroy=function(){t.prototype.destroy.apply(this,arguments);g=null;this._aRegistry=null;h.delete(this);this.defaultProviderRegistry.destroy();this.defaultProviderRegistry=null;this.stateHandlerRegistry.destroy();this.stateHandlerRegistry=null;this.uimanager.destroy();this.uimanager=null};return y});