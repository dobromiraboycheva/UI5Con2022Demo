/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/ManagedObjectObserver","sap/ui/mdc/field/FieldBase","sap/ui/mdc/field/FieldBaseRenderer","sap/ui/mdc/enum/FieldDisplay","sap/ui/mdc/condition/Condition","sap/ui/mdc/condition/FilterOperatorUtil","sap/ui/mdc/enum/BaseType","sap/ui/mdc/enum/ConditionValidated","sap/base/util/deepEqual","sap/base/util/merge","sap/ui/model/BindingMode","sap/ui/model/Context"],function(t,e,i,a,n,o,s,r,l,d,p,h){"use strict";var u=e.extend("sap.ui.mdc.Field",{metadata:{library:"sap.ui.mdc",designtime:"sap/ui/mdc/designtime/field/Field.designtime",properties:{value:{type:"any",defaultValue:null},additionalValue:{type:"any",defaultValue:null}},events:{change:{parameters:{value:{type:"string"},valid:{type:"boolean"},promise:{type:"Promise"}}}},defaultProperty:"value"},renderer:i});u.prototype.init=function(){this._vValue=null;this._vAdditionalValue=null;e.prototype.init.apply(this,arguments);this.setMaxConditions(1);this._oObserver.observe(this,{properties:["value","additionalValue"]})};u.prototype.exit=function(){e.prototype.exit.apply(this,arguments);if(this._iConditionUpdateTimer){clearTimeout(this._iConditionUpdateTimer);delete this._iConditionUpdateTimer;delete this._bPendingConditionUpdate}this._oBindingContext=undefined};u.prototype.bindProperty=function(t,i){if(t==="value"&&!i.formatter){i.targetType="raw";var a=this._oContentFactory.getDataType();if(i.type&&(!a||a.getMetadata().getName()!==i.type.getMetadata().getName()||!l(a.getFormatOptions(),i.type.getFormatOptions())||!l(a.getConstraints(),i.type.getConstraints())||a._bCreatedByOperator!==i.type._bCreatedByOperator)){this._oContentFactory.setDataType(i.type);if(i.type.isA("sap.ui.model.CompositeType")&&i.parts){var n=[];for(var o=0;o<i.parts.length;o++){n.push(i.parts[o].type)}this._oContentFactory.setCompositeTypes(n)}this._oContentFactory.updateConditionType();this.invalidate()}}e.prototype.bindProperty.apply(this,arguments)};u.prototype._handleModelContextChange=function(t){e.prototype._handleModelContextChange.apply(this,arguments);var i=this.getBinding("value");if(i){var a=i.isA("sap.ui.model.CompositeBinding")?i.getBindings()[0].getContext():i.getContext();if(h.hasChanged(this._oBindingContext,a)){this._oBindingContext=a;this._oContentFactory.updateConditionType();if(this._bParseError||this.getFieldHelp()){if(this._oManagedObjectModel){this._oManagedObjectModel.checkUpdate(true,true)}this._bParseError=false}}if(!this._oContentFactory.getDataType()){this._oContentFactory.setDataType(i.getType());this.invalidate()}}};u.prototype._initDataType=function(){e.prototype._initDataType.apply(this,arguments);var t=this.getBinding("value");if(t){this._oContentFactory.setDataType(t.getType())}};u.prototype.setProperty=function(t,i,a){if(t==="value"&&this._bParseError&&l(this.getValue(),this.validateProperty(t,i))){if(this._oManagedObjectModel){this._oManagedObjectModel.checkUpdate(true,true)}this._bParseError=false}return e.prototype.setProperty.apply(this,arguments)};u.prototype.setMaxConditions=function(t){if(t!==1){throw new Error("Only one condition allowed for Field "+this)}return this.setProperty("maxConditions",t,true)};u.prototype._observeChanges=function(t){e.prototype._observeChanges.apply(this,arguments);if(t.name==="value"){var i=_.call(this,t.current,t.old);if(this._vAdditionalValue!==null&&T.call(this)&&!C.call(this,i,this._vValue,true)){this._vAdditionalValue=this.getAdditionalValue()}this._vValue=i;v.call(this,t.current);c.call(this)}if(t.name==="additionalValue"){this._vAdditionalValue=t.current;c.call(this)}if(t.name==="conditions"){if(this._getContent().length<=1){m.call(this,t.current)}}};function y(){return this._vValue}function g(){return this._vAdditionalValue}function c(){if(!this.bDelegateInitialized){this.awaitControlDelegate().then(function(){if(!this.bIsDestroyed){c.call(this)}}.bind(this));return}if(this.getDisplay()===a.Value){f.call(this,y.call(this),g.call(this))}else if(!this._iConditionUpdateTimer){this._iConditionUpdateTimer=setTimeout(function(){f.call(this,y.call(this),g.call(this));this._iConditionUpdateTimer=undefined;this._bPendingConditionUpdate=false}.bind(this),0);this._bPendingConditionUpdate=true}}function f(t,e){var i=this.getConditions();if(this._checkValueInitial(t)&&!e){if(i.length>0){this.setConditions([])}}else{var a=i[0]&&i[0].values[0];var o=i[0]&&i[0].values[1]?i[0].values[1]:null;if(!i[0]||i[0].operator!=="EQ"||!C.call(this,a,t)||o!==e){var s=n.createItemCondition(t,e);s.validated=r.Validated;this.setConditions([s])}}}function _(t,e){var i=this._oContentFactory.getDataType()?this._oContentFactory.getDataType().getMetadata().getName():this.getDataType();if(t&&e&&(i==="sap.ui.model.odata.type.Unit"||i==="sap.ui.model.odata.type.Currency")&&!t[2]&&e[2]!==undefined){t=d([],t);t[2]=e[2];if(this._bPendingChange){var a=this.getConditions()[0];if(a){if(t[0]===e[0]&&t[0]!==a.values[0][0]){t[0]=a.values[0][0]}if(t[1]===e[1]&&t[1]!==a.values[0][1]){t[1]=a.values[0][1]}}}}return t}function C(t,e,i){var a=t===e;var n=this._oContentFactory.getDataType()?this._oContentFactory.getDataType().getMetadata().getName():this.getDataType();if(!a&&this.getTypeUtil().getBaseType(n)===s.Unit&&Array.isArray(t)&&Array.isArray(e)){var o=t[0];var r=t[1];var d=t.length>=3?t[2]:null;var p=e[0];var h=e[1];var u=e.length>=3?e[2]:null;if(o===p&&r===h&&((this._bUnitSet||i)&&(!d||!u)||l(d,u))){a=true}if((d||u)&&!i){this._bUnitSet=true}}return a}function v(t){if(!this._bTypeInitialized){if(!this.bDelegateInitialized){this.awaitControlDelegate().then(function(){if(!this.bIsDestroyed){v.call(this,t)}}.bind(this));return}var e=this.getBinding("value");var i=e?e.getType():this._oContentFactory.getDataType();this._oTypeInitialization=this.getControlDelegate().initializeTypeFromBinding(this.getPayload(),i,t);this._bTypeInitialized=this._oTypeInitialization.bTypeInitialized;if(this._bTypeInitialized&&this._oContentFactory.getUnitOriginalType()){this.getControlDelegate().initializeInternalUnitType(this.getPayload(),this._oContentFactory.getDataType(),this._oTypeInitialization);this.getControlDelegate().initializeInternalUnitType(this.getPayload(),this._oContentFactory.getUnitType(),this._oTypeInitialization)}}}u.prototype._fireChange=function(t,e,i,a){var n;if(t){if(e){n=this._getResultForPromise(t)}else{n=i}}if(this._getContent().length>1){if(t){m.call(this,this.getConditions())}else if(a){a=a.then(function(t){m.call(this,this.getConditions());return t}.bind(this))}}this.fireChange({value:n,valid:e,promise:a})};u.prototype._getResultForPromise=function(t){var e;if(t.length===0&&this._oContentFactory.getDataType()){e=this._oContentFactory.getDataType().parseValue("","string",[])}else if(t.length===1){e=t[0].values[0]}return e};function m(t){if(!this.bDelegateInitialized){this.awaitControlDelegate().then(function(){if(!this.bIsDestroyed){m.call(this,t)}}.bind(this));return}var e=null;var i=null;var a=this.getValue();var n=this.getAdditionalValue();if(t.length===0&&a===null&&n===null){return}e=this._getResultForPromise(t);if(t.length===0&&!n){i=n}else if(t.length===1&&t[0].values.length>1){i=t[0].values[1]}this._vValue=e;this._vAdditionalValue=i;if(!C.call(this,e,a,true)){this.setProperty("value",e,true)}if(i!==n&&!T.call(this)){this.setProperty("additionalValue",i,true)}}u.prototype._getOperators=function(){return["EQ"]};function T(){var t=this.getBinding("additionalValue");if(t&&t.getBindingMode()===p.OneWay){return true}return false}u.prototype._checkCreateInternalContent=function(){if(!this.bIsDestroyed&&this._oContentFactory.getDataType()&&!this._isPropertyInitial("editMode")&&!this._isPropertyInitial("multipleLines")){e.prototype._checkCreateInternalContent.apply(this,arguments)}};return u});