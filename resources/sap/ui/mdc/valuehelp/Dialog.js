/*
 * ! OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/mdc/valuehelp/base/Container","sap/ui/mdc/valuehelp/base/DialogTab","sap/ui/mdc/util/loadModules","sap/ui/Device","sap/m/VBox","sap/m/FlexItemData","sap/ui/model/resource/ResourceModel","sap/ui/mdc/util/Common","sap/ui/mdc/enum/SelectType","sap/base/strings/formatMessage"],function(e,t,n,o,i,r,a,s,l,u){"use strict";var d,p,c,h,g,f;var v,y,C,_;var m=e.extend("sap.ui.mdc.valuehelp.Dialog",{metadata:{library:"sap.ui.mdc",interfaces:["sap.ui.mdc.valuehelp.IDialogContainer"],properties:{_selectedContentKey:{type:"string",visibility:"hidden"},_quickSelectEnabled:{type:"boolean",visibility:"hidden",defaultValue:false},_selectableContents:{type:"object[]",visibility:"hidden",defaultValue:[]},groupConfig:{type:"object",defaultValue:{}}},defaultAggregation:"content"}});function b(){if(o.system.desktop){return"700px"}if(o.system.tablet){return o.orientation.landscape?"600px":"600px"}}function S(){if(o.system.desktop){return"1080px"}if(o.system.tablet){return o.orientation.landscape?"920px":"600px"}}function T(e){var t=this.getContent();return t.filter(function(t){return!!t.getVisible()&&t.getGroup&&t.getGroup()===e}).length>1}m.prototype._handleContentSelectionChange=function(e){this.fireRequestDelegateContent({container:this.getId(),contentId:e});this._getRetrieveDelegateContentPromise().then(function(){var t=this.getProperty("_selectedContentKey");var n=this.getContent();var o=t&&n&&n.find(function(e){return e.getId()===t});if(o){o.onHide()}this._renderSelectedContent(e)}.bind(this))};m.prototype._onTabBarSelect=function(e){var t=e&&e.getParameter("key");this._handleContentSelectionChange(t)};m.prototype.invalidate=function(t){if(t){var n=this.getContent();var o=n.indexOf(t);if(this._oIconTabBar&&o!==-1&&!this._bIsBeingDestroyed){var i=this._oIconTabBar.getItems();if(i[o]){i[o].invalidate(t)}}else{e.prototype.invalidate.apply(this,arguments)}}};m.prototype._getUIAreaForContent=function(){var t=this.getAggregation("_container");if(t){return t.getUIArea()}return e.prototype._getUIAreaForContent.apply(this,arguments)};m.prototype._handleConfirmed=function(e){this.fireConfirm({close:true})};m.prototype._handleClosed=function(t){var n=this.getSelectedContent();if(n){n.onHide()}this.setProperty("_selectedContentKey",this._sInitialContentKey);e.prototype._handleClosed.apply(this,arguments)};m.prototype._getContainer=function(){if(!this.getModel("$i18n")){this.setModel(new a({bundleName:"sap/ui/mdc/messagebundle",async:false}),"$i18n")}var e=this.getAggregation("_container");if(!e){return this._retrievePromise("dialog",function(){return n(["sap/m/Dialog","sap/m/Button","sap/ui/model/base/ManagedObjectModel","sap/m/library"]).then(function(e){d=e[0];c=e[1];h=e[2];p=e[3];var t=p.ButtonType;if(!this._oResourceBundle){this._oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc")}this.oButtonOK=new c(this.getId()+"-ok",{text:this._oResourceBundle.getText("valuehelp.OK"),enabled:"{$valueHelp>/_valid}",type:t.Emphasized,press:this._handleConfirmed.bind(this),visible:{parts:["$valueHelp>/_config/maxConditions","$help>/_quickSelectEnabled"],formatter:function(e,t){return e!==1||!t}}});this.oButtonCancel=new c(this.getId()+"-cancel",{text:this._oResourceBundle.getText("valuehelp.CANCEL"),press:this._handleCanceled.bind(this)});this._oManagedObjectModel=new h(this);var n=new d(this.getId()+"-dialog",{contentHeight:b(),contentWidth:S(),horizontalScrolling:false,verticalScrolling:false,title:{parts:["$help>/title","$help>/_selectableContents"],formatter:function(e,t){if(t&&t.length==1){var n=t[0];var o=n.getFormattedShortTitle()?n.getFormattedShortTitle():n.getTitle();if(o){e=this._oResourceBundle.getText("valuehelp.DIALOGSHORTTITLECOLONTITLE",[o,e])}}return e}.bind(this)},stretch:o.system.phone,resizable:true,draggable:true,afterOpen:this._handleOpened.bind(this),afterClose:this._handleClosed.bind(this),buttons:[this.oButtonOK,this.oButtonCancel]});n.setModel(this._oManagedObjectModel,"$help");this.setAggregation("_container",n,true);n.isPopupAdaptationAllowed=function(){return false};n.addStyleClass("sapMdcValueHelp");n.addStyleClass("sapMdcValueHelpTitle");n.addStyleClass("sapMdcValueHelpTitleShadow");var r=new i(this.getId()+"-Content",{fitContainer:true});r.addStyleClass("sapMdcValueHelpPanel");n.addContent(r);var a=[];a.push(this._getIconTabBar(n));if(I(this.getMaxConditions(),this.getContent())){a.push(this._getTokenizerPanel())}return Promise.all(a).then(function(e){e.forEach(function(e){r.addItem(e)});return n})}.bind(this))}.bind(this))}return e};m.prototype._handleSelect=function(t){e.prototype._handleSelect.apply(this,arguments);if(this.getProperty("_quickSelectEnabled")&&this._isSingleSelect()){this.fireConfirm({close:true})}};m.prototype._observeChanges=function(t){if(t.name==="content"){var n=this.getContent();this.setProperty("_quickSelectEnabled",n&&n.every(function(e){return e.isQuickSelectSupported()}));this._updateInitialContentKey();if(t.mutation==="insert"&&!this.getProperty("_selectedContentKey")){this.setProperty("_selectedContentKey",this._sInitialContentKey)}this.setProperty("_selectableContents",this._getSelectableContents());if(I(this.getMaxConditions(),this.getContent())){var o=this.getAggregation("_container");if(o&&o.getContent()[0].getItems().length===1){Promise.all([this._getTokenizerPanel()]).then(function(e){e.forEach(function(e){o.getContent()[0].addItem(e)})})}}}e.prototype._observeChanges.apply(this,arguments)};m.prototype._updateInitialContentKey=function(){var e=this.getContent().find(function(e){return!!e.getVisible()});this._sInitialContentKey=e&&e.getId()};m.prototype.getSelectedContent=function(){var e=this.getProperty("_selectedContentKey");return this.getContent().find(function(t){return t.getId()===e})};m.prototype._getSelectableContents=function(){var e=this.getSelectedContent();var t=e&&e.getGroup&&e.getGroup();var n=e?t:"";var o=[n];return this.getContent().filter(function(t){if(!t.getVisible()){return false}var n=t.getGroup&&t.getGroup();var i=n&&T.call(this,n);if(i&&t!==e){if(o.indexOf(n)>=0){return false}else{o.push(n)}}return true}.bind(this))};m.prototype._updateGroupSelectModel=function(){if(this._oGroupSelectModel){var e=this.getSelectedContent();var t=e&&e.getGroup&&e.getGroup();var n=t?this.getContent().filter(function(e){return!!e.getVisible()&&e.getGroup&&e.getGroup()===t}):[];this._oGroupSelectModel.setData(n.reduce(function(e,t){e.entries.push({key:t.getId(),text:t.getFormattedTitle()});return e},{entries:[]}));if(this._oGroupSelect){var o=this._oGroupSelect.getSelectedItemKey();var i=n.map(function(e){return e.getId()});var r=this.getProperty("_selectedContentKey");if(i.indexOf(o)==-1||o!==r){this._oGroupSelect.setSelectedItemKey(n[0].getId())}}}};m.prototype._retrieveGroupSelect=function(){return this._retrievePromise("collectiveSearchSelect",function(){return n(["sap/ui/mdc/filterbar/vh/CollectiveSearchSelect","sap/ui/core/Item","sap/ui/model/json/JSONModel"]).then(function(e){var t=e[0];var n=e[1];var o=e[2];if(!this._oGroupSelectModel){this._oGroupSelectModel=new o}if(!this._oGroupSelect){var i=new n(this.getId()+"-collSearchItem",{key:"{$select>key}",text:"{$select>text}",enabled:true});this._oGroupSelect=new t(this.getId()+"--Select",{title:"{$i18n>COL_SEARCH_SEL_TITLE}",items:{path:"$select>/entries",template:i},select:function(e){this._handleContentSelectionChange(e.getParameter("key"))}.bind(this),selectedItemKey:this.getSelectedContent().getId()});this._oGroupSelect.setModel(this._oGroupSelectModel,"$select")}return this._oGroupSelect}.bind(this))}.bind(this))};m.prototype._getIconTabBar=function(e){if(!this._oIconTabBar){return n(["sap/m/IconTabBar","sap/m/IconTabFilter"]).then(function(n){g=n[0];f=n[1];var o=p.IconTabHeaderMode;this._oIconTabBar=new g(this.getId()+"-ITB",{expandable:false,upperCase:false,stretchContentHeight:true,headerMode:o.Inline,select:this._onTabBarSelect.bind(this),layoutData:new r({growFactor:1}),selectedKey:"{path: '$help>/_selectedContentKey', mode: 'OneWay'}",visible:{parts:["$help>/_selectableContents"],formatter:function(t){if(t&&t.length==1){this.addStyleClass("sapMdcNoHeader");e.removeStyleClass("sapMdcValueHelpTitleShadow")}else{this.removeStyleClass("sapMdcNoHeader");e.addStyleClass("sapMdcValueHelpTitleShadow")}return true}}});this._oIconTabBar.addStyleClass("sapUiNoContentPadding");var i=new f(this.getId()+"-ITF",{key:{path:"$help>id"},content:new t(this.getId()+"-DT",{content:{path:"$help>displayContent"}}),text:{parts:["$help>","$valueHelp>/conditions"],formatter:function(e,t){var n="none";if(e){var o=e.getGroup&&e.getGroup();var i=e.getCount(t,o);n=o?this._getFormattedContentGroupLabel(o,i):e.getFormattedTitle(i)}return n}.bind(this)}});this._oIconTabBar.bindAggregation("items",{path:"/_selectableContents",model:"$help",templateShareable:false,template:i});return this._oIconTabBar}.bind(this))}return this._oIconTabBar};m.prototype._getFormattedContentGroupLabel=function(e,t){var n=this.getGroupConfig();var o=n&&n[e];var i=o&&(t?o.label:o.nnLabel);i=i&&u(i,t?t:"");i=i||this._oResourceBundle.getText(t?"valuehelp.SELECTFROMLIST":"valuehelp.SELECTFROMLISTNONUMBER",t);return i};m.prototype._getTokenizerPanel=function(e){if(!this.oTokenizerPanel){return n(["sap/m/Panel","sap/m/HBox","sap/m/VBox","sap/m/Tokenizer","sap/m/Token","sap/ui/model/Filter","sap/ui/mdc/field/ConditionType"]).then(function(e){v=e[0];y=e[1];i=e[2];C=e[3];_=e[4];var t=e[5];var n=e[6];var o=p.BackgroundDesign;var a=p.ButtonType;this.oTokenizerPanel=new v(this.getId()+"-TokenPanel",{backgroundDesign:o.Transparent,expanded:true,visible:{parts:["$valueHelp>/_config/maxConditions","$help>/content"],formatter:I},headerText:{parts:["$i18n>valuehelp.TOKENIZERTITLE","$valueHelp>/conditions"],formatter:function(e,t){var n=0;for(var o=0;o<t.length;o++){var i=t[o];if(i.isEmpty!==true){n++}}if(n===0){e=this._oResourceBundle.getText("valuehelp.TOKENIZERTITLENONUMBER")}return u(e,n)}.bind(this)}});this.oTokenizerPanel.addStyleClass("sapMdcTokenizerPanel");var s=new y(this.getId()+"-TokenBox",{fitContainer:true,width:"100%"});var d=new t({path:"isEmpty",operator:"NE",value1:true});var h=this.getModel("$valueHelp");var g=h?h.getProperty("/_config"):{};var f=this.getParent();var m={maxConditions:-1,valueType:g.dataType,operators:g.operators,display:g.display,fieldHelpID:f&&f.getId()};var b=new _(this.getId()+"-Token",{text:{path:"$valueHelp>",type:new n(m)}});this.oTokenizer=new C(this.getId()+"-Tokenizer",{width:"100%",tokenDelete:function(e){if(e.getParameter("tokens")){var t=e.getParameter("tokens");var n=this.getModel("$valueHelp").getObject("/conditions");var o=[];t.forEach(function(e,t){var i=e.getBindingContext("$valueHelp").sPath;var r=parseInt(i.slice(i.lastIndexOf("/")+1));o.push(n[r])});this.fireSelect({type:l.Remove,conditions:o})}}.bind(this),tokens:{path:"/conditions",model:"$valueHelp",templateShareable:false,template:b,filters:d},layoutData:new r({growFactor:1,maxWidth:"calc(100% - 2rem)"})});this.oTokenizer.addAriaDescribedBy(this.oTokenizer.getTokensInfoId());this.oTokenizer.addStyleClass("sapMdcTokenizer");this.oRemoveAllBtn=new c(this.getId()+"-TokenRemoveAll",{press:function(e){this.fireSelect({type:l.Set,conditions:[]})}.bind(this),type:a.Transparent,icon:"sap-icon://decline",tooltip:"{$i18n>valuehelp.REMOVEALLTOKEN}",layoutData:new r({growFactor:0,baseSize:"2rem"})});this.oRemoveAllBtn.addStyleClass("sapUiTinyMarginBegin");s.addItem(this.oTokenizer);s.addItem(this.oRemoveAllBtn);this.oTokenizerPanel.addContent(s);return this.oTokenizerPanel}.bind(this))}return this.oTokenizerPanel};function I(e,t){var n=e!==1;if(n&&t&&t.every(function(e){return!e.getRequiresTokenizer()})){n=false}return n}m.prototype._open=function(e){if(e){this._updateInitialContentKey();if(I(this.getMaxConditions(),this.getContent())&&e.getContent()[0].getItems().length===1){Promise.all([this._getTokenizerPanel()]).then(function(t){t.forEach(function(t){e.getContent()[0].addItem(t)});this._renderSelectedContent(this._sInitialContentKey,function(){e.open()})})}else{this._renderSelectedContent(this._sInitialContentKey,function(){e.open()})}}};m.prototype._renderSelectedContent=function(e,t){var n=this.getContent().find(function(t){return t.getId()===e});if(!n){throw new Error("sap.ui.mdc.ValueHelp: No content found.")}var o=[n.getContent(),n.onBeforeShow()];var i=n.getGroup&&n.getGroup();var r;if(i&&T.call(this,i)){r=this._retrieveGroupSelect();o.push(r)}return Promise.all(o).then(function(o){this.setProperty("_selectedContentKey",e);this.setProperty("_selectableContents",this._getSelectableContents());this._oManagedObjectModel.checkUpdate(true,true);if(r){this._updateGroupSelectModel()}if(n.setCollectiveSearchSelect){n.setCollectiveSearchSelect(r?this._oGroupSelect:undefined)}if(t){t()}return this._retrievePromise("open").then(function(){n.onShow();return n})}.bind(this))};m.prototype._close=function(){var e=this.getAggregation("_container");if(e){e.close()}};m.prototype.getValueHelpIcon=function(){return"sap-icon://value-help"};m.prototype.getAriaAttributes=function(e){return{contentId:null,ariaHasPopup:"dialog",role:null,roleDescription:null}};m.prototype.isMultiSelect=function(){return this.getMaxConditions()!==1};m.prototype.exit=function(){s.cleanup(this,["_oManagedObjectModel","_oResourceBundle","oButtonOK","oButtonCancel","oTokenizerPanel","oTokenizer","_oIconTabBar","_oGroupSelect","_oGroupSelectModel","_sInitialContentKey"])};return m});