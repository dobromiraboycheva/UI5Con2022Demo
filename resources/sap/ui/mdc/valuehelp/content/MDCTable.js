/*
 * ! OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/mdc/valuehelp/base/FilterableListContent","sap/ui/mdc/util/loadModules","sap/base/util/deepEqual","sap/ui/mdc/enum/SelectType","sap/ui/mdc/library","sap/m/library","sap/ui/table/library","sap/ui/thirdparty/jquery","sap/ui/mdc/condition/FilterConverter","sap/base/util/restricted/_throttle"],function(e,t,i,n,a,s,o,l,r,h){"use strict";var c=s.ListMode;var d=s.Sticky;var u=a.SelectionMode;var g=o.VisibleRowCountMode;var p=o.SelectionMode;var f=o.SelectionBehavior;var _=function(e){var t,i=t=e&&e.getType();if(!i){t="Table"}else if(typeof i==="object"){if(i.isA("sap.ui.mdc.table.ResponsiveTableType")){t="ResponsiveTable"}else{t="Table"}}return t};var v=function(){var e=this._getTable();var t=e&&e._oTable;var i=e.getRowBinding();var a=function(){return this._oUITableSelectionPlugin||t}.bind(this);var s=function(e,t){var i=t?n.Add:n.Remove;if(!t&&this._isSingleSelect()){i=n.Add}this._fireSelect({type:i,conditions:e})};var o={ResponsiveTable:{getListBindingInfo:function(){return t&&t.getBindingInfo("items")},getItems:function(){return t.getItems()},getSelectedItems:function(){return t.getSelectedItems()},modifySelection:function(e,t){if(e.getSelected()!==t){e.setSelected(t)}},handleItemPress:function(e){var t=e.getParameter("listItem");if(!this.isTypeahead()||!this._isSingleSelect()){t.setSelected(!t.getSelected())}var i=this._getListBindingInfo().model;var n=t.getBindingContext(i);var a=this._getItemFromContext(n);var o=a&&this._createCondition(a.key,a.description,a.payload);s.call(this,[o],t.getSelected())},handleSelectionChange:function(e){if(!this.isTypeahead()||!this._isSingleSelect()){var t=e.getParameters();var i=t.listItems||t.listItem&&[t.listItem];var n=this._getListBindingInfo().model;var a=i.map(function(e){var t=e.getBindingContext(n);var i=this._getItemFromContext(t);return i&&this._createCondition(i.key,i.description,i.payload)}.bind(this));s.call(this,a,t.selected)}},adjustTable:function(){var e=t.getSticky();if(!e||e.length===0){t.setSticky([d.ColumnHeaders])}if(this._isSingleSelect()){t.setMode(c.SingleSelectLeft)}else{t.setMode(c.MultiSelect)}},handleScrolling:function(e){var i=this.getScrollDelegate();if(i){t.scrollToIndex(e).catch(function(e){});return true}},handleListBinding:function(){}},Table:{getListBindingInfo:function(){return t&&t.getBindingInfo("rows")},getItems:function(){return t.getRows().filter(function(e){var t=e.getBindingContext();return t&&t.getObject()})},getSelectedItems:function(){var e=a().getSelectedIndices();var i=e.reduce(function(e,i){var n=t.getContextByIndex(i);return n?e.concat(n):e},[]);return o["Table"].getItems().filter(function(e){return i.indexOf(e.getBindingContext())>=0})},modifySelection:function(e,t){var i=e.getBindingContext();var n=o["Table"].getContexts().indexOf(i);var s=a().getSelectedIndices().indexOf(n)>=0;if(t&&!s){return this._isSingleSelect()?a().setSelectedIndex(n):a().addSelectionInterval(n,n)}else if(!t&&s){return a().removeSelectionInterval(n,n)}},handleItemPress:function(e){},handleSelectionChange:function(e){if(this._bScrolling||this._bBusy){return}var t=e.getParameter("rowIndices");var i=o["Table"].getContexts().filter(function(e,i){return t.indexOf(i)>=0});var n=o["Table"].getItems().filter(function(e,t){return i.indexOf(e.getBindingContext())>=0});var a=[],l=[];var r=o["Table"].getSelectedItems();var h=this.getConditions();n.forEach(function(e,t){var i=this._isItemSelected(e,h);var n=r.indexOf(e)!==-1;if(i!==n){var s=r.indexOf(e)!==-1?a:l;var o=this._getItemFromContext(e.getBindingContext());var c=o&&this._createCondition(o.key,o.description,o.payload);s.push(c)}}.bind(this));var c=this._isSingleSelect();if(a.length){s.call(this,a,true);if(c){return}}if(l.length){s.call(this,l,false)}},adjustTable:function(){var e=t.getRowMode();if(!e){t.setVisibleRowCountMode(g.Auto);t.setMinAutoRowCount(3)}else if(e.isA("sap.ui.table.rowmodes.AutoRowMode")){e.setMinRowCount(3)}var i=this._isSingleSelect()?p.Single:p.MultiToggle;t.setSelectionBehavior(f.Row);a().setSelectionMode(i)},handleScrolling:function(e){var i=t.getFirstVisibleRow();if(typeof e==="undefined"||e<0){e=i-1}if(e>=0&&e!=i){t.setFirstVisibleRow(e);return Promise.resolve()}return false},getContexts:function(){return i&&i.getAllCurrentContexts()},handleListBinding:function(){i.attachEvent("change",this._handleUpdateFinished.bind(this))}}};return o[this._sTableType]};function b(){if(this._oTableHelper&&!this._bSelectionIsUpdating){this._bSelectionIsUpdating=true;var e=this._oTableHelper.getItems();var t=this.getConditions();var i=[];for(var n in e){var a=e[n];var s=this._isItemSelected(a,t);i.push(this._oTableHelper.modifySelection.call(this,a,s))}Promise.all(i).then(function(){this._bSelectionIsUpdating=false}.bind(this))}}var S=h(b,100,{leading:true});var T=e.extend("sap.ui.mdc.valuehelp.content.MDCTable",{metadata:{library:"sap.ui.mdc",interfaces:["sap.ui.mdc.valuehelp.IDialogContent"],properties:{},aggregations:{table:{type:"sap.ui.mdc.Table",multiple:false}},events:{},defaultAggregation:"table"}});T.prototype.init=function(){e.prototype.init.apply(this,arguments);this._oObserver.observe(this,{aggregations:["table"]});this._addPromise("listBinding")};var y=function(){var e=this._getTable().getRowBinding();if(e){this._oTableHelper=v.call(this);this._oTableHelper.handleListBinding.call(this);I.call(this);this._resolvePromise("listBinding",e)}};var m=function(){if(this._oTable&&!this._oTable.getHeader()){this._oTable.setHeader(this._oResourceBundle.getText("valuehelp.TABLETITLENONUMBER"))}};T.prototype._handleConditionsUpdate=function(){S.call(this)};T.prototype._handleUpdateFinished=function(e){this._bScrolling=false;this._bSearchTriggered=false;S.call(this)};T.prototype._handleFirstVisibleRowChanged=function(e){this._bScrolling=true;S.call(this)};T.prototype._handleBusyStateChanged=function(e){this._bBusy=e.getParameter("busy")};var C=function(e,t){if(!e){return}if(t==="remove"){if(this._sTableType==="Table"){e.detachEvent("cellClick",this._handleItemPress,this);e.detachEvent("rowSelectionChange",this._handleSelectionChange,this);e.detachEvent("rowsUpdated",this._handleUpdateFinished,this);e.detachEvent("firstVisibleRowChanged",this._handleFirstVisibleRowChanged,this);e.detachEvent("busyStateChanged",this._handleBusyStateChanged,this);if(this._oUITableSelectionPlugin){this._oUITableSelectionPlugin.detachEvent("selectionChange",this._handleSelectionChange,this)}this._oUITableSelectionPlugin=undefined}else if(this._sTableType==="ResponsiveTable"){e.detachEvent("itemPress",this._handleItemPress,this);e.detachEvent("selectionChange",this._handleSelectionChange,this);e.detachEvent("updateFinished",this._handleUpdateFinished,this)}this._oObserver.unobserve(e)}else{if(this._sTableType==="Table"){this._oObserver.observe(e,{bindings:["rows"],aggregations:["plugins"]});e.attachEvent("cellClick",this._handleItemPress,this);e.attachEvent("rowSelectionChange",this._handleSelectionChange,this);e.attachEvent("rowsUpdated",this._handleUpdateFinished,this);e.attachEvent("firstVisibleRowChanged",this._handleFirstVisibleRowChanged,this);e.attachEvent("busyStateChanged",this._handleBusyStateChanged,this);this._oUITableSelectionPlugin=e.getPlugins().find(function(e){return e.isA("sap.ui.table.plugins.SelectionPlugin")});if(this._oUITableSelectionPlugin){this._oUITableSelectionPlugin.attachEvent("selectionChange",this._handleSelectionChange,this)}}else if(this._sTableType==="ResponsiveTable"){this._oObserver.observe(e,{bindings:["items"]});e.attachEvent("itemPress",this._handleItemPress,this);e.attachEvent("selectionChange",this._handleSelectionChange,this);e.attachEvent("updateFinished",this._handleUpdateFinished,this)}}};T.prototype._handleSearch=function(e){var t=this.getFilterFields();var i=e.getSource();var n=i.getInternalConditions();var a=t&&n[t]&&n[t][0];var s=a&&a.values[0];this.setFilterValue(s)};T.prototype._observeChanges=function(t){if(["_defaultFilterBar","filterBar"].indexOf(t.name)!==-1){B.call(this)}if(t.name==="table"){var i=t.child;if(t.mutation==="remove"){this._oObserver.unobserve(i);this._oTable=null;this._oTableHelper=null;this._addPromise("listBinding")}else{this._oTable=i;this._oObserver.observe(i,{aggregations:["_content"]});this._sTableType=_(i);i.addDelegate({onmouseover:function(e){var t=l(e.target).control(0);if(t&&t.isA("sap.m.ColumnListItem")){t.setType("Active")}}});C.call(this,this._oTable._oTable,"insert");y.call(this);m.call(this);B.call(this)}return}if(t.name==="_content"){C.call(this,t.child,t.mutation);return}if(["rows","items"].indexOf(t.name)!==-1&&t.mutation==="ready"){y.call(this);return}if(t.name==="config"){I.call(this)}if(t.name==="plugins"){this._oUITableSelectionPlugin=t.mutation==="remove"||!t.child.isA("sap.ui.table.plugins.SelectionPlugin")?undefined:t.child;if(this._oUITableSelectionPlugin){this._oUITableSelectionPlugin.attachEvent("selectionChange",this._handleSelectionChange,this)}}e.prototype._observeChanges.apply(this,arguments)};T.prototype._getTable=function(){return this._oTable};function B(){var e=this._getPriorityFilterBar();if(this._oTable&&e&&this._oTable.getFilter()!==e.getId()){this._oTable.setFilter(e)}}function I(){if(this._oTableHelper){this._oTableHelper.adjustTable.call(this)}}T.prototype.getContent=function(){return this._retrievePromise("wrappedContent",function(){return t(["sap/ui/layout/FixFlex","sap/m/VBox","sap/m/ScrollContainer"]).then(function(e){var t=e[0];var i=e[1];var n=e[2];if(!this._oContentLayout){this._oFilterBarVBox=new i(this.getId()+"-FilterBarBox",{visible:"{$this>/_filterBarVisible}"});this._oFilterBarVBox.addStyleClass("sapMdcValueHelpPanelFilterbar");this._oFilterBarVBox._oWrapper=this;this._oFilterBarVBox.getItems=function(){var e=this._oWrapper._getPriorityFilterBar.call(this._oWrapper);var t=e?[e]:[];return t};this._oTableBox=new i(this.getId()+"-TB",{height:"100%"});this._oTableBox.addStyleClass("sapMdcValueHelpPanelTableBox");this._oTableBox._oWrapper=this;this._oTableBox.getItems=function(){var e=this._oWrapper._sTableType==="ResponsiveTable"?this._oWrapper._oScrollContainer:this._oWrapper._oTable;var t=e?[e]:[];return t};this._oContentLayout=new t(this.getId()+"-FF",{minFlexSize:200,fixContent:this._oFilterBarVBox,flexContent:this._oTableBox});this._oScrollContainer=new n(this.getId()+"-SC",{height:"calc(100% - 0.5rem)",width:"100%",vertical:true});this._oScrollContainer._oWrapper=this;this._oScrollContainer.getContent=function(){var e=[];var t=this._oWrapper&&this._oWrapper._oTable;if(t){e.push(t)}return e}}this.setAggregation("displayContent",this._oContentLayout);if(!this._getPriorityFilterBar()){return this._createDefaultFilterBar().then(function(){this._oFilterBarVBox.invalidate();return this._oContentLayout}.bind(this))}return this._oContentLayout}.bind(this))}.bind(this))};T.prototype.getListBinding=function(){var e=this.getTable();return e&&e.getRowBinding()};T.prototype._getListBindingInfo=function(){return this._oTableHelper&&this._oTableHelper.getListBindingInfo()};T.prototype.onShow=function(){if(this._oTable){var t=e.prototype._isSingleSelect.apply(this)?u.Single:u.Multi;if(this._oTable.getSelectionMode()===u.None){this._oTable.setSelectionMode(t)}if(this._oTable.getSelectionMode()!==t){throw new Error("Table selectionMode needs to be "+t)}}e.prototype.onShow.apply(this,arguments)};T.prototype.onHide=function(){this._bSearchTriggered=false;e.prototype.onHide.apply(this,arguments)};T.prototype._createFiltersFromBarConditions=function(e){var t=this._getTypesForConditions(e);var i=e&&t&&r.createFilters(e,t,undefined,this.getCaseSensitive());return i&&[].concat(i)};T.prototype.applyFilters=function(e){var t=this.getTable();var n=this._getPriorityFilterBar();if(t&&n){var a=this.getListBinding();var s=a&&a.isSuspended();if(a&&!s&&!this._bSearchTriggered){var o=n.getSearch()||"";var l=a.mParameters.$search||"";var r=this._createFiltersFromBarConditions(n.getConditions());var h=a.aApplicationFilters.reduce(function(e,t){return e.concat(t._bMultiFilter?t.aFilters:t)},[]);var c=!i(r,h);var d=o!==l;var u=t._oTable&&t._oTable.getShowOverlay&&t._oTable.getShowOverlay();if(c||d||u){this._handleScrolling();n.triggerSearch();this._bSearchTriggered=true}}if(s){a.resume()}if(!a&&t.getAutoBindOnInit()){this._retrievePromise("listBinding").then(function(){this.applyFilters(e)}.bind(this))}}};T.prototype._handleScrolling=function(e){return this._oTableHelper&&this._oTableHelper.handleScrolling.call(this,e)};T.prototype.getScrollDelegate=function(){if(!this.isTypeahead()&&this._oScrollContainer){return this._oScrollContainer.getScrollDelegate()}return e.prototype.getScrollDelegate.apply(this,arguments)};T.prototype._handleItemPress=function(e){this._oTableHelper.handleItemPress.call(this,e)};T.prototype._handleSelectionChange=function(e){if(!this._bSelectionIsUpdating){this._oTableHelper.handleSelectionChange.call(this,e)}};T.prototype.isQuickSelectSupported=function(){return true};T.prototype.setParent=function(t){e.prototype.setParent.apply(this,arguments);I.call(this)};T.prototype._isSingleSelect=function(){if(this._oTable){if(this._oTable.getSelectionMode()===u.Multi){return false}else{return true}}else{return e.prototype._isSingleSelect.apply(this,arguments)}};return T});