/*
 * ! OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/mdc/valuehelp/base/FilterableListContent","sap/ui/mdc/condition/Condition","sap/ui/mdc/condition/FilterConverter","sap/ui/mdc/enum/ConditionValidated","sap/ui/mdc/util/loadModules","sap/m/library","sap/ui/model/FilterType","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/FilterProcessor","sap/ui/mdc/util/Common","sap/base/strings/formatMessage","sap/base/util/merge","sap/ui/mdc/enum/SelectType","sap/base/Log","sap/ui/thirdparty/jquery"],function(e,t,i,a,r,n,s,o,l,h,u,d,p,c,g,f){"use strict";var v=n.ListMode;var _=n.Sticky;var m=e.extend("sap.ui.mdc.valuehelp.content.MTable",{metadata:{library:"sap.ui.mdc",interfaces:["sap.ui.mdc.valuehelp.ITypeaheadContent","sap.ui.mdc.valuehelp.IDialogContent"],properties:{},aggregations:{table:{type:"sap.m.Table",multiple:false}},events:{contentUpdated:{}},defaultAggregation:"table"}});m.prototype.init=function(){e.prototype.init.apply(this,arguments);this._oObserver.observe(this,{aggregations:["table"]});this._addPromise("listBinding");this._oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");this._oMResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.m")};m.prototype.getValueHelpIcon=function(){if(this.getUseAsValueHelp()){return"sap-icon://slim-arrow-down"}else{return null}};function y(){if(this._oTable){var t=this._oTable.getItems();var i=this.getConditions();var a=this._isSingleSelect()&&!e.prototype._isSingleSelect.apply(this);for(var r in t){var n=t[r];var s=a?false:this._isItemSelected(n,i);n.setSelected(s)}}}m.prototype.applyFilters=function(e){var r=this.getListBinding();var n=this._isValueHelpDelegateInitialized();if(!r||!n){Promise.all([this._retrievePromise("listBinding"),this._awaitValueHelpDelegate()]).then(function(){if(!this.bIsDestroyed){this.applyFilters(e)}}.bind(this));return}if(!n||!this.isTypeahead()&&!this.isContainerOpen()&&r.isSuspended()){return}var o=this._getValueHelpDelegate();var l=this._getValueHelpDelegatePayload();var h=this.getFilterFields();var u=this._getPriorityFilterBar();var d=u?u.getInternalConditions():this._oInitialFilterConditions||{};if(!u&&e&&h&&h!=="$search"){var p=t.createCondition("Contains",[e],undefined,undefined,a.NotValidated);d[h]=[p]}var c=d&&this._getTypesForConditions(d);var f=d&&i.createFilters(d,c,undefined,this.getCaseSensitive());var v=f&&[f];var _=this.isTypeahead()?e:u&&u.getSearch();var m=true;var y;try{y=r.getFilterInfo()}catch(e){g.info("ValueHelp-Filter: getFilterInfo threw error")}if(!v){v=[]}if(v.length===0&&!y){m=false}if(h==="$search"&&o&&o.isSearchSupported(l,this,r)){if(!r.isSuspended()&&m){r.suspend()}_=o.adjustSearch(l,this.isTypeahead(),_);o.executeSearch(l,r,_);g.info("ValueHelp-Search: "+_)}if(m){r.filter(v,s.Application);g.info("ValueHelp-Filter: "+this._prettyPrintFilters.call(this,v))}if(r.isSuspended()){r.resume()}};m.prototype._handleSelectionChange=function(e){var t=e.getSource().getBindingInfo("items").model;var i=this.isTypeahead();if(!i||!this._isSingleSelect()){var a=e.getParameters();var r=a.listItems||a.listItem&&[a.listItem];var n=r.map(function(e){var i=e.getBindingContext(t);var a=this._getItemFromContext(i);return a&&this._createCondition(a.key,a.description,a.payload)}.bind(this));this._fireSelect({type:a.selected?c.Add:c.Remove,conditions:n});if(i){this.fireConfirm()}}};m.prototype._handleItemPress=function(e){var t=e.getSource().getBindingInfo("items").model;var i=e.getParameter("listItem");var a=i.getBindingContext(t);var r=this._getItemFromContext(a);var n=this._isSingleSelect();var s=n?true:!i.getSelected();var o=c.Set;if(!n){i.setSelected(s);o=s?c.Add:c.Remove}var l=this._createCondition(r.key,r.description,r.payload);this._fireSelect({type:o,conditions:[l]});if(this.isTypeahead()){this.fireConfirm({close:true})}};m.prototype._handleUpdateFinished=function(){y.apply(this);this.fireContentUpdated()};m.prototype._getTable=function(){return this._oTable};m.prototype.onShow=function(){var t=this._getTable();if(t){if(!t.hasStyleClass("sapMComboBoxList")){t.addStyleClass("sapMComboBoxList")}var i=this.isTypeahead()?v.SingleSelectMaster:v.SingleSelectLeft;if(!e.prototype._isSingleSelect.apply(this)&&t.getMode()!==i){i=v.MultiSelect}if(t.getMode()===v.None){t.setMode(i)}if(t.getMode()!==i){throw new Error("Table selection mode needs to be "+i)}}e.prototype.onShow.apply(this,arguments)};m.prototype.onHide=function(){e.prototype.onHide.apply(this,arguments);var t=this.getTable();if(t){this.removeFocus();if(t.hasStyleClass("sapMComboBoxList")){t.removeStyleClass("sapMComboBoxList")}}};m.prototype._handleConditionsUpdate=function(e){y.call(this)};m.prototype.getContent=function(){if(!this.isTypeahead()){return this._retrievePromise("wrappedContent",function(){return r(["sap/ui/layout/FixFlex","sap/m/VBox","sap/m/Panel","sap/m/ScrollContainer","sap/ui/model/resource/ResourceModel"]).then(function(e){var t=e[0];var i=e[1];var a=e[2];var r=e[3];var n=e[4];if(!this._oContentLayout){this._oFilterBarVBox=new i(this.getId()+"-FilterBarBox");this._oFilterBarVBox.addStyleClass("sapMdcValueHelpPanelFilterbar");this._oFilterBarVBox._oWrapper=this;this._oFilterBarVBox.getItems=function(){return[this._oWrapper._getPriorityFilterBar.call(this._oWrapper)]};this.setModel(new n({bundleName:"sap/ui/mdc/messagebundle",async:false}),"$i18n");var s=function(e){var t=0;if(t===0){e=this.getModel("$i18n").getResourceBundle().getText("valuehelp.TABLETITLENONUMBER")}return d(e,t)};this._oTablePanel=new a(this.getId()+"-TablePanel",{expanded:true,height:"100%",headerText:{parts:["$i18n>valuehelp.TABLETITLE"],formatter:s}});this._oTablePanel.addStyleClass("sapMdcTablePanel");this._oContentLayout=new t(this.getId()+"-FF",{minFlexSize:200,fixContent:this._oFilterBarVBox,flexContent:this._oTablePanel});this._oScrollContainer=new r(this.getId()+"-SC",{height:"100%",width:"100%",vertical:true});this._oScrollContainer._oWrapper=this;this._oScrollContainer.getContent=function(){var e=[];var t=this._oWrapper&&this._oWrapper._oTable;if(t){e.push(t)}return e};this._oTablePanel.addContent(this._oScrollContainer)}this.setAggregation("displayContent",this._oContentLayout);var o=this._getPriorityFilterBar();if(!o){return this._createDefaultFilterBar().then(function(){return this._oContentLayout}.bind(this))}return this._oContentLayout}.bind(this))}.bind(this))}return this._oTable};m.prototype.getItemForValue=function(e){if(!e.checkKey&&e.parsedValue&&!e.checkDescription){return null}if(e.checkKey&&!this.getKeyPath()){throw new Error("MTable: KeyPath missing! "+this.getId())}if(e.checkDescription&&!this.getDescriptionPath()){throw new Error("MTable: DescriptionPath missing! "+this.getId())}e.caseSensitive=e.caseSensitive||this.getCaseSensitive();var t=C.call(this);var i=this._getValueHelpDelegate();var a=this._getValueHelpDelegatePayload();var r=i&&i.getInitialFilterConditions(a,this,e.control);return Promise.all([t,r]).then(function(t){var i=t[0];var a=t[1];var r;if(!i){var n=this.getTable();r=b.call(this,e,n.getItems(),a)}if(!r){r=this._loadItemForValue(e,a)}return r}.bind(this))};function b(e,t,i){if(t.length===0){return}var a=this._getListBindingInfo();var r=a.model;var n=function(e,t){var i=e.isA("sap.ui.model.Context")?e:e.getBindingContext(r);return i.getProperty(t)};var s;var o;var l=S.call(this,e,i);var u=h.apply(t,l,n);if(u.length===1){var d=u[0].getBindingContext(r);var c=this._getItemFromContext(d,{inParameters:s,outParameters:o});return{key:c.key,description:c.description,payload:c.payload}}else if(u.length>1){if(!e.caseSensitive){var g=p({},e);g.caseSensitive=true;return b.call(this,g,t,i)}throw T.call(this,e.exception,true,e.parsedValue||e.value)}}function S(e,t){var a=e.caseSensitive;var r=this.getKeyPath();var n=this.getDescriptionPath();var s=[];if(e.checkKey&&e.hasOwnProperty("parsedValue")){s.push(new o({path:r,operator:l.EQ,value1:e.parsedValue,caseSensitive:a}))}if(e.checkDescription&&e.value){s.push(new o({path:n,operator:l.EQ,value1:e.value,caseSensitive:a}))}var h=s.length>1?new o({filters:s,and:false}):s[0];if(t){var u=this._getTypesForConditions(t);var d=i.createFilters(t,u,undefined,this.getCaseSensitive());if(d){h=new o({filters:[h,d],and:true})}}return h}function C(){return this._retrievePromise("listBinding").then(function(e){var t=this._getValueHelpDelegate();var i=this._getValueHelpDelegatePayload();var a=this._getListBindingInfo();if(e&&t){return t.checkListBindingPending(i,e,a)}else{return true}}.bind(this))}m.prototype.getListBinding=function(){var e=this._getTable();return e&&e.getBinding("items")};m.prototype._getListBindingInfo=function(){var e=this._getTable();return e&&e.getBindingInfo("items")};m.prototype._loadItemForValue=function(e,t){if(!e.checkKey&&e.parsedValue&&!e.checkDescription){return null}var i=this.getKeyPath();var a=this.getDescriptionPath();var r=this.getUseFirstMatch();var n=this._getTable();var s=n&&n.getBinding("items");var o=s&&s.getContext();var l=s&&s.getModel();var h=s&&s.getPath();var u=this._getValueHelpDelegate();var d=this._getValueHelpDelegatePayload();var p=["loadItemForValue",h,i,e.parsedValue||e.value].join("_");return this._retrievePromise(p,function(){var n=S.call(this,e,t);var s=l.bindList(h,o);return u.executeFilter(d,s,n,2).then(function(t){var n=t.getContexts();setTimeout(function(){s.destroy()},0);if(n.length&&(n.length<2||r)){return this._getItemFromContext(n[0],{keyPath:i,descriptionPath:a,inParameters:undefined})}else if(e.checkKey&&e.parsedValue===""&&n.length===0){return null}else{var o=T.call(this,e.exception,n.length>1,e.value);throw o}}.bind(this))}.bind(this))};function T(e,t,i){var a;if(t){a=this._oResourceBundle.getText("valuehelp.VALUE_NOT_UNIQUE",[i])}else{a=this._oResourceBundle.getText("valuehelp.VALUE_NOT_EXIST",[i])}var r=new e(a);r._bNotUnique=t;return r}m.prototype.isValidationSupported=function(e){return true};m.prototype.navigate=function(e){var t=this.getListBinding();if(!t||!t.getLength()){return C.call(this).then(function(i){if(!i&&t.getLength()!==0){return this.navigate(e)}return false}.bind(this))}var i=this._getTable();i.addStyleClass("sapMListFocus");var a=this._oTable.getItems();var r=i.getSelectedItem();var n=a.length;var s=0;var o=false;if(r){s=a.indexOf(r);s=s+e}else if(e>=0){s=e-1}else{s=n+e}if(this._getMaxConditions()!==1){if(this.getParent().isOpen()){i.focus();return}}var l;if(s<0){s=0;l=true;o=true}else if(s>=n-1){s=n-1;l=false}else{l=e>=0}while(a[s]&&a[s].isA("sap.m.GroupHeaderListItem")){if(l){s++}else{s--}}if(s<0||s>n-1){l=!l;o=s<0;s=s<0?0:n-1;while(a[s]&&a[s].isA("sap.m.GroupHeaderListItem")){if(l){s++}else{s--}}}var h=a[s];if(h){var u;if(h!==r){h.setSelected(true);var d=this._getListBindingInfo();var p=d.model;var c=h.getBindingContext(p);var g=this._getItemFromContext(c);u=g&&this._createCondition(g.key,g.description,g.payload);this.setProperty("conditions",[u],true);if(this._bVisible){this._handleScrolling(h)}this.fireNavigated({condition:u,itemId:h.getId(),leaveFocus:false})}else if(o){this.fireNavigated({condition:undefined,itemId:undefined,leaveFocus:o})}}};m.prototype._handleScrolling=function(e){var t=this.getScrollDelegate();if(t){var i=this._getTable();var a=!isNaN(e)?e:i.indexOfItem(e);i.scrollToIndex(a).catch(function(e){});return true}return false};m.prototype.getScrollDelegate=function(){if(this._oScrollContainer){return this._oScrollContainer.getScrollDelegate()}return e.prototype.getScrollDelegate.apply(this,arguments)};m.prototype.removeFocus=function(){var e=this.getTable();if(e){e.removeStyleClass("sapMListFocus")}};m.prototype.getAriaAttributes=function(e){var t=this.getTable();return{contentId:t&&t.getId(),ariaHasPopup:"listbox",roleDescription:null}};m.prototype.getContainerConfig=function(){return{"sap.ui.mdc.valuehelp.Popover":{getContentHeight:function(){var e=this._getTable();var t=e&&e.getDomRef();return t&&Math.round(t.getBoundingClientRect().height)}.bind(this),getFooter:function(){return this._retrievePromise("footer",function(){return this._retrievePromise("listBinding").then(function(e){var t=this._getListBindingInfo();if(t&&t.length){return r(["sap/m/Button","sap/m/Toolbar","sap/m/ToolbarSpacer"]).then(function(e){var t=e[0];var i=e[1];var a=e[2];var r=new t(this.getId()+"-showAllItems",{text:this._oMResourceBundle.getText("INPUT_SUGGESTIONS_SHOW_ALL"),press:function(){this.fireRequestSwitchToDialog()}.bind(this)});var n=[new a(this.getId()+"-Spacer")].concat(r);var s=new i(this.getId()+"-TB",{content:n});return s}.bind(this))}}.bind(this))}.bind(this))}.bind(this)}}};function I(){if(this._oTable&&this.getParent()){var e=this._oTable.getSticky();if(!e||e.length===0){this._oTable.setSticky([_.ColumnHeaders])}}}m.prototype.setParent=function(t){e.prototype.setParent.apply(this,arguments);I.call(this)};m.prototype._handleSearch=function(e){return this.applyFilters(this.getFilterValue())};m.prototype._observeChanges=function(t){if(t.name==="config"){I.call(this)}if(t.name==="items"&&t.mutation==="ready"){this._resolvePromise("listBinding",t.bindingInfo.binding)}if(t.name==="table"){var i=t.child;if(t.mutation==="remove"){this._oObserver.unobserve(i);i.removeDelegate(this._oTableDelegate);this._oTable.detachItemPress(this._handleItemPress,this);this._oTable.detachSelectionChange(this._handleSelectionChange,this);this._oTable.detachUpdateFinished(this._handleUpdateFinished,this);this._oTable=null;this._removePromise("footer");this._addPromise("listBinding")}else{this._oTable=i;I.call(this);this._oTable.attachItemPress(this._handleItemPress,this);this._oTable.attachSelectionChange(this._handleSelectionChange,this);this._oTable.attachUpdateFinished(this._handleUpdateFinished,this);this._oTableDelegate=this._oTableDelegate||{onsapprevious:this._handleTableEvent,onsapnext:this._handleTableEvent,cellClick:this._handleTableEvent};i.addDelegate(this._oTableDelegate,true,this);var a=i.getBinding("items");if(a){this._resolvePromise("listBinding",a)}else{this._oObserver.observe(t.child,{bindings:["items"]})}}}e.prototype._observeChanges.apply(this,arguments)};m.prototype._handleTableEvent=function(e){if(!this.isTypeahead()){return}var t=this._getTable();var i=f(e.target).control(0);switch(e.type){case"sapprevious":if(i.isA("sap.m.ListItemBase")){if(t.indexOfItem(i)===0){this.fireNavigated({condition:undefined,itemId:undefined,leaveFocus:true});e.preventDefault();e.stopPropagation();e.stopImmediatePropagation(true)}}break;default:break}};m.prototype.isQuickSelectSupported=function(){return true};m.prototype.shouldOpenOnNavigate=function(){return true};m.prototype._isSingleSelect=function(){var t=this._getTable();if(t){if(t.getMode()===v.MultiSelect){return false}else{return true}}else{return e.prototype._isSingleSelect.apply(this,arguments)}};m.prototype.exit=function(){u.cleanup(this,["_sTableWidth","_oTable","_oScrollContainer","_oContentLayout","_oTablePanel","_oFilterBarVBox","_oMResourceBundle","_oResourceBundle"]);e.prototype.exit.apply(this,arguments)};return m});