/*
 * ! OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/mdc/util/loadModules","sap/ui/mdc/valuehelp/base/ListContent","sap/ui/mdc/condition/Condition","sap/ui/mdc/enum/ConditionValidated","sap/ui/mdc/util/Common","sap/ui/mdc/enum/PersistenceMode","sap/ui/mdc/p13n/Engine","sap/base/util/merge"],function(e,t,i,r,a,l,o,n){"use strict";var s=t.extend("sap.ui.mdc.valuehelp.base.FilterableListContent",{metadata:{library:"sap.ui.mdc",properties:{filterFields:{type:"string",defaultValue:""},keyPath:{type:"string",defaultValue:""},descriptionPath:{type:"string",defaultValue:""},group:{type:"string",defaultValue:""}},aggregations:{collectiveSearchItems:{type:"sap.ui.core.Item",multiple:true,singularName:"collectiveSearchItem"},filterBar:{type:"sap.ui.mdc.filterbar.vh.FilterBar",multiple:false},_defaultFilterBar:{type:"sap.ui.mdc.filterbar.vh.FilterBar",multiple:false,visibility:"hidden"}},associations:{filters:{type:"sap.ui.mdc.IFilter",multiple:true}},events:{}}});s.prototype.init=function(){t.prototype.init.apply(this,arguments);this._oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");this._oObserver.observe(this,{properties:["filterFields"],aggregations:["_defaultFilterBar","filterBar"]});o.getInstance().defaultProviderRegistry.attach(this,l.Transient)};s.prototype._handleFilterValueUpdate=function(e){p.call(this,this._getPriorityFilterBar(),e.current);if(this.isContainerOpen()){this.applyFilters(e.current)}};s.prototype._reduceIFilterConditions=function(e){var t=this._getValueHelpDelegate();var i=this._getValueHelpDelegatePayload();return t?t.reduceIFilterConditions(i,this,e):e};s.prototype.applyFilters=function(e){this.applyFilterConditions()};s.prototype._prettyPrintFilters=function(e){var t;if(!e){return""}if(Array.isArray(e)){t="";e.forEach(function(e,i,r){t+=this._prettyPrintFilters(e);if(r.length-1!=i){t+=" or "}},this);return"("+t+")"}else if(e._bMultiFilter){t="";var i=e.bAnd;e.aFilters.forEach(function(e,r,a){t+=this._prettyPrintFilters(e);if(a.length-1!=r){t+=i?" and ":" or "}},this);return"("+t+")"}else{t=e.sPath+" "+e.sOperator+" '"+e.oValue1+"'";if(e.sOperator==="BT"){t+="...'"+e.oValue2+"'"}return t}};s.prototype._getItemFromContext=function(e,t){var i=t&&t.keyPath||this.getKeyPath();var r=t&&t.descriptionPath||this.getDescriptionPath();var a;var l;if(!i){throw new Error("KeyPath missing")}if(e){a=i?e.getProperty(i):undefined;l=r?e.getProperty(r):undefined}if(a===null||a===undefined){return false}var o=this._createConditionPayload([a,l],e);return{key:a,description:l,payload:o}};s.prototype._createConditionPayload=function(e,t){var i;var r=this._getValueHelpDelegate();if(r){var a=this._getValueHelpDelegatePayload();i={};i=r.createConditionPayload(a,this,e,t)}return i};s.prototype._isItemSelected=function(e,t){var i=this._isValueHelpDelegateInitialized()&&this._getValueHelpDelegate();return i?i.isFilterableListItemSelected(this._getValueHelpDelegatePayload(),this,e,t):false};s.prototype._createDefaultFilterBar=function(){return e(["sap/ui/mdc/filterbar/vh/FilterBar"]).then(function(e){var t=e[0];var i=new t(this.getId()+"-FB",{liveMode:false,showGoButton:false});h.call(this,i);this.setAggregation("_defaultFilterBar",i,true);return i}.bind(this))};s.prototype._handleSearch=function(e){};function h(t){var i=t.getBasicSearchField();var r=this.getFilterFields();if(!i&&r){if(!this._oSearchField){return e(["sap/ui/mdc/FilterField"]).then(function(e){if(!t.bIsDestroyed){var i=e[0];this._oSearchField=new i(this.getId()+"-search",{conditions:"{$filters>/conditions/"+r+"}",placeholder:"{$i18n>filterbar.SEARCH}",label:"{$i18n>filterbar.SEARCH}",maxConditions:1,width:"50%"});this._oSearchField._bCreatedByValueHelp=true;h.call(this,t)}}.bind(this))}t.setBasicSearchField(this._oSearchField)}else if(i){if(r){i.setConditions([])}else if(i._bCreatedByValueHelp){t.setBasicSearchField()}}}s.prototype.onShow=function(){t.prototype.onShow.apply(this,arguments);var e=this.getListBinding();var i=this._getListBindingInfo();var r=e&&e.isSuspended();var a=!e&&i&&i.suspended;this._applyInitialConditions(this._getPriorityFilterBar());if((r||a)&&!this.isTypeahead()){return}this.applyFilters(this.getFilterValue())};s.prototype.onHide=function(){t.prototype.onHide.apply(this,arguments)};s.prototype._getPriorityFilterBar=function(){return this.getFilterBar()||this.getAggregation("_defaultFilterBar")};s.prototype._observeChanges=function(e){if(e.object==this){var i;if(["_defaultFilterBar","filterBar"].indexOf(e.name)!==-1){i=e.child;var r;if(e.mutation==="insert"){h.call(this,i);this._assignCollectiveSearchSelect();if(e.name!=="_defaultFilterBar"||!this.getFilterBar()){i.attachSearch(this._handleSearch,this)}if(e.name==="filterBar"){r=this.getAggregation("_defaultFilterBar");if(r){r.detachSearch(this._handleSearch,this)}}}else{var a=i.getBasicSearchField();if(a&&a._bCreatedByValueHelp){i.setBasicSearchField()}i.detachSearch(this._handleSearch,this);if(e.name==="filterBar"){r=this.getAggregation("_defaultFilterBar");if(r){r.attachSearch(this._handleSearch,this)}else{this._createDefaultFilterBar()}}}p.call(this,this._getPriorityFilterBar(),this.getFilterValue())}else if(e.name==="filterFields"){i=this._getPriorityFilterBar();if(i){h.call(this,i)}}}t.prototype._observeChanges.apply(this,arguments)};s.prototype.getCollectiveSearchKey=function(){return this._oCollectiveSearchSelect&&this._oCollectiveSearchSelect.getSelectedItemKey()};s.prototype.getListBinding=function(){throw new Error("FilterableListContent: Every filterable listcontent must implement this method.")};s.prototype._getListBindingInfo=function(){throw new Error("FilterableListContent: Every filterable listcontent must implement this method.")};s.prototype._getTypesForConditions=function(e){var t=this._getValueHelpDelegate();var i=this._getValueHelpDelegatePayload();return t?t.getTypesForConditions(i,this,e):{}};function p(e,t){var a=this.getFilterFields();if(e&&a){var l=e.getInternalConditions();if(!l[a]||l[a].length!==1||l[a][0].values[0]!==t){var o=i.createCondition("Contains",[t],undefined,undefined,r.NotValidated);l[a]=[o];e.setInternalConditions(l)}}}s.prototype.getFormattedTitle=function(e){var i=t.prototype.getFormattedTitle.apply(this,arguments);if(!i){i=this._oResourceBundle.getText(e?"valuehelp.SELECTFROMLIST":"valuehelp.SELECTFROMLISTNONUMBER",e)}return i};s.prototype.getFormattedShortTitle=function(){var e=this.getShortTitle();if(!e){e=this._oResourceBundle.getText("valuehelp.SELECTFROMLIST.Shorttitle")}return e};s.prototype.isSearchSupported=function(){var e=this.getFilterFields();var t=!!e;if(e==="$search"){var i=this.getListBinding();var r=this._getValueHelpDelegate();var a=this._getValueHelpDelegatePayload();t=r&&r.isSearchSupported(a,this,i)}return t};s.prototype.setCollectiveSearchSelect=function(e){this._oCollectiveSearchSelect=e;this._assignCollectiveSearchSelect()};s.prototype._assignCollectiveSearchSelect=function(){var e=this._getPriorityFilterBar();if(e.setCollectiveSearch&&this._oCollectiveSearchSelect){e.setCollectiveSearch(this._oCollectiveSearchSelect)}};s.prototype.onBeforeShow=function(){var e=this._getValueHelpDelegate();return Promise.resolve(e&&e.getInitialFilterConditions(this._getValueHelpDelegatePayload(),this,this._getControl())).then(function(e){this._oInitialFilterConditions=e}.bind(this))};s.prototype._applyInitialConditions=function(e){if(e){var t=this.getFilterFields();var i=n({},this._oInitialFilterConditions);if(!i[t]){var r=e.getInternalConditions();if(r[t]){i[t]=r[t]}}e.setInternalConditions(i)}};s.prototype._fireSelect=function(e){var t=this._getValueHelpDelegate();var i=this._getValueHelpDelegatePayload();var r=t&&t.modifySelectionBehaviour?t.modifySelectionBehaviour(i,this,e):e;if(r){this.fireSelect(r)}};s.prototype.exit=function(){o.getInstance().defaultProviderRegistry.detach(this);a.cleanup(this,["_oCollectiveSearchSelect","_oInitialFilterConditions"]);if(this._oSearchField&&!this._oSearchField.getParent()){this._oSearchField.destroy();delete this._oSearchField}t.prototype.exit.apply(this,arguments)};s.prototype.getCount=function(e,i){var r=this._isValueHelpDelegateInitialized()&&this._getValueHelpDelegate();var a=r&&this._getValueHelpDelegatePayload();return r&&r.getCount?r.getCount(a,this,e,i):t.prototype.getCount.apply(this,arguments)};return s});