/*
 * ! OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./ODataMetaModelUtil","sap/ui/mdc/enum/FieldDisplay","sap/ui/fl/Utils","sap/ui/mdc/FilterBarDelegate","sap/base/util/ObjectPath","sap/base/util/merge","sap/ui/mdc/odata/v4/TypeUtil","sap/ui/mdc/condition/FilterOperatorUtil","sap/ui/model/FilterOperator","sap/ui/model/Filter","sap/ui/mdc/util/IdentifierUtil","sap/ui/core/util/reflection/JsControlTreeModifier","sap/base/Log"],function(e,t,r,a,i,n,o,s,l,p,u,f,c){"use strict";var d=Object.assign({},a);var m={"Edm.Boolean":"Bool","Edm.Byte":"Int","Edm.DateTime":"Date","Edm.DateTimeOffset":"DateTimeOffset","Edm.Decimal":"Decimal","Edm.Double":"Float","Edm.Float":"Float","Edm.Guid":"Guid","Edm.Int16":"Int","Edm.Int32":"Int","Edm.Int64":"Int","Edm.SByte":"Int","Edm.Single":"Float","Edm.String":"String","Edm.Time":"TimeOfDay"};var v=new Map;d._fetchPropertiesByMetadata=function(e,t){var r,a,i,n,o;return Promise.resolve().then(function(){if(t){var o=t.modifier;return Promise.resolve().then(o.getProperty.bind(o,e,"delegate")).then(function(e){a=e.payload.modelName===null?undefined:e.payload.modelName;i=e.payload.collectionName;n=t.appComponent.getModel(a)})}r=e.getProperty("delegate");a=r.payload.modelName===null?undefined:r.payload.modelName;i=r.payload.collectionName;n=e.getModel(a)}).then(function(){o=e.getId?e.getId():e.id;var r={getDelegate:function(){return{payload:{modelName:a,collectionName:i}}},getModel:function(e){return n},getId:function(){return o}};return t?this.fetchProperties(r):Promise.resolve(e.getPropertyHelper().getProperties())}.bind(this))};d._ensureSingleRangeEQOperators=function(){var e;if(!s.getOperator("SINGLE_RANGE_EQ")){e=n({},s.getOperator("EQ"));e.name="SINGLE_RANGE_EQ";e.getModelFilter=function(e,t){return new p({filters:[new p(t,l.GE,e.values[0]),new p(t,l.LE,e.values[0])],and:true})};s.addOperator(e)}if(!s.getOperator("SINGLE_RANGE_EQ")){e=n({},s.getOperator("EQ"));e.name="SINGLE_RANGE_EQ";e.getModelFilter=function(e,t){return new p({filters:[new p(t,l.GE,e.values[0]),new p(t,l.LE,e.values[0])],and:true})};s.addOperator(e)}};d._ensureMultiRangeBTEXOperator=function(){if(!s.getOperator("MULTI_RANGE_BTEX")){var e=n({},s.getOperator("BT"));e.name="MULTI_RANGE_BTEX";e.getModelFilter=function(e,t){return new p({filters:[new p(t,l.GT,e.values[0]),new p(t,l.LT,e.values[1])],and:true})};s.addOperator(e)}};d._getFilterOperators=function(e){var t=null,r=null;switch(e){case"SingleValue":case"MultiValue":t="EQ";break;case"SingleRange":t="SINGLE_RANGE_EQ,SINGLE_RANGE_EQ,LE,GE";this._ensureSingleRangeEQOperators();break;case"MultiRange":t="EQ,LE,LT,GE,GT,BT,MULTI_RANGE_BTEX";this._ensureMultiRangeBTEXOperator();break;case"SearchExpression":t="StartsWith,EndsWith,Contains";break;case"MultiRangeOrSearchExpression":t="StartsWith,EndsWith,Contains,EQ,LE,LT,GE,GT,BT,MULTI_RANGE_BTEX";this._ensureMultiRangeBTEXOperator();break;default:break}if(t){r=t.split(",")}return r};d._createFilterField=function(e,t,a){var i=a?a.modifier:f;var n=a?a.appComponent:r.getAppComponentForControl(t);var o=a&&a.view?a.view:r.getViewForControl(t);var s=a?a.viewId:null;var l=e.path||e.name;var p={};if(t.getId){p.id=t.getId()}else{p.id=t.id}var c=i.getControlIdBySelector(p,n);var d=c+"--filter--"+u.replace(l);var m=sap.ui.getCore().byId(d);if(m){return Promise.resolve(m)}return Promise.resolve().then(i.createControl.bind(i,"sap.ui.mdc.FilterField",n,o,d,{dataType:e.typeConfig.className,conditions:"{$filters>/conditions/"+l+"}",required:e.required,label:e.label||e.name,maxConditions:e.maxConditions,delegate:{name:"sap/ui/mdc/odata/v4/FieldBaseDelegate",payload:{}}})).then(function(r){if(e.fieldHelp){var a=e.fieldHelp;if(!s){a=o.createId(e.fieldHelp)}else{a=s+"--"+e.fieldHelp}i.setAssociation(r,"fieldHelp",a)}if(e.filterOperators){if(t.getId){i.setProperty(r,"operators",e.filterOperators)}else{i.setProperty(r,"operators",e.filterOperators.join(","))}}if(e.tooltip){i.setProperty(r,"tooltip",e.tooltip)}if(e.constraints){i.setProperty(r,"dataTypeConstraints",e.constraints)}if(e.formatOptions){i.setProperty(r,"dataTypeFormatOptions",e.formatOptions)}if(e.display){i.setProperty(r,"display",e.display)}return r})};d._createFilter=function(e,t,r){return this._fetchPropertiesByMetadata(t,r).then(function(a){var i=a.find(function(t){return u.getPropertyKey(t)===e});if(!i){return null}return Promise.resolve(this._createFilterField(i,t,r))}.bind(this))};d.addItem=function(e,t,r){return Promise.resolve(this._createFilter(e,t,r))};d._getInstanceCacheEntry=function(e,t){var r=e.getId&&e.getId()||e.id;var a=v.get(r);return a&&a[t]};d._setInstanceCacheEntry=function(e,t,r){var a=e.getId&&e.getId()||e.id;var i=v.get(a)||{};i[t]=r;v.set(a,i)};d._addPropertyInfoEntry=function(e,t,r,a,i){if(a){var n=a.findIndex(function(e){return e.name===t});if(n>=0){r.push({name:t,dataType:a[n].typeConfig.className,maxConditions:a[n].maxConditions,constraints:a[n].constraints,formatOption:a[n].formatOptions,required:a[n].required,caseSensitive:a[n].caseSensitive,display:a[n].display,label:a[n].label,hiddenFilter:a[n].hiddenFilter});i.setProperty(e,"propertyInfo",r)}else{c.error("ConditionFlex-ChangeHandler: no type info for property '"+t+"'")}}};d._updatePropertyInfo=function(e,t,r){if(t.isA&&t.isA("sap.ui.mdc.FilterBar")){return Promise.resolve()}var a=r.modifier;return a.getProperty(t,"propertyInfo").then(function(i){if(!i){return Promise.resolve()}var n=i.findIndex(function(t){return t.name===e});if(n<0){var o=d._getInstanceCacheEntry(t,"fetchedProperties");if(o){d._addPropertyInfoEntry(t,e,i,o,a)}else{return d.fetchProperties(t,r).then(function(r){d._setInstanceCacheEntry(t,"fetchedProperties",r);d._addPropertyInfoEntry(t,e,i,r,a)})}}})};d.addCondition=function(e,t,r){return d._updatePropertyInfo(e,t,r)};d.removeCondition=function(e,t,r){return d._updatePropertyInfo(e,t,r)};d.removeItem=function(e,t,r){return Promise.resolve(true)};d._getFieldGroupsByFilterFacetsAnnotation=function(e,t){};d._getNavigationPropertyForParameter=function(e){var t;for(var r in e){t=e[r];if(t){if(t.$kind==="NavigationProperty"){return r}}}return null};d._fetchPropertyInfo=function(e,r,a,i,n){var s=e.getObject(r+"/"+"@com.sap.vocabularies.UI.v1.TextArrangement");var l=false;if(e.getObject(r+"/"+n+"@com.sap.vocabularies.UI.v1.HiddenFilter")){l=true}var p=false;if(e.getObject(r+"/"+n+"@com.sap.vocabularies.Common.v1.IsDigitSequence")){p=true}var u=null;var f=e.getObject(r+"/"+n+"@com.sap.vocabularies.Common.v1.FilterDefaultValue");if(f){var c=f["$"+m[i.$Type]];switch(i.$Type){case"Edm.DateTimeOffset":u=c;break;default:u=c}}var d=false;if(e.getObject(r+"/"+n+"@com.sap.vocabularies.Common.v1.IsUpperCase")){d=true}var v=e.getObject(r+"/"+n+"@com.sap.vocabularies.Common.v1.Label")||n;var g=e.getObject(r+"/"+n+"@com.sap.vocabularies.Common.v1.QuickInfo")||null;var y={};if(i.$MaxLength||i.$Precision||i.$Scale||p){if(i.$MaxLength){y.maxLength=i.$MaxLength}if(i.$Precision){y.precision=i.$Precision}if(i.$Scale){y.scale=i.$Scale}if(p){y.isDigitSequence=p}}else{y=null}var h,E=e.getObject(r+"/"+n+"@com.sap.vocabularies.Common.v1.Text");if(E){var P=e.getObject(r+"/"+n+"@com.sap.vocabularies.Common.v1.Text@com.sap.vocabularies.UI.v1.TextArrangement")||s;if(P){if(P.$EnumMember==="com.sap.vocabularies.UI.v1.TextArrangementType/TextOnly"){h=t.Description}else if(P.$EnumMember==="com.sap.vocabularies.UI.v1.TextArrangementType/TextLast"){h=t.ValueDescription}else{h=t.DescriptionValue}}else{h=t.DescriptionValue}}var b={name:n,label:v,tooltip:g,hiddenFilter:l,caseSensitive:!d};if(h){b.display=h}if(y){b.constraints=y}if(u){b.defaultFilterConditions=[{fieldPath:n,operator:"EQ",values:[u]}]}b.name=a?a+"/"+n:n;b.typeConfig=o.getTypeConfig(i.$Type,b.formatOptions,b.constraints);return b};d._fetchEntitySet=function(t,r,a,i,o){return Promise.all([t.requestObject(r+"/"),t.requestObject(r+"@")]).then(function(s){var l=s[0];var p=s[1]||{};if(!l){return Promise.resolve([])}var u,f,m=[],v=[],g=[],y=[],h=[],E={},P={},b=false;var O=t.getObject(r);if(O&&O.$NavigationPropertyBinding){P=O.$NavigationPropertyBinding}var I=p["@Org.OData.Capabilities.V1.FilterRestrictions"];if(I){if(I.NonFilterableProperties){g=I.NonFilterableProperties.map(function(e){return e.$PropertyPath})}if(I.RequiredProperties){y=I.RequiredProperties.map(function(e){return e.$PropertyPath})}if(I.FilterExpressionRestrictions){I.FilterExpressionRestrictions.forEach(function(e){E[e.Property.$PropertyPath]=e.AllowedExpressions})}}I=t.getObject(r+"/"+"@com.sap.vocabularies.UI.v1.SelectionFields");if(I){h=I.map(function(e){return e.$PropertyPath})}var _=t.getObject(r+"/@sapui.name");var C=_;var T=t.getObject(r+"@com.sap.vocabularies.Common.v1.Label");if(!T){T=C.split(".")[1]}a.push(_);I=t.getObject(r+"/"+"@com.sap.vocabularies.Common.v1.ResultContext");if(I){b=true;o.parameterNavigationName=d._getNavigationPropertyForParameter(l)}if(!i){var F=_.split(".");o.parameterEntityType=F[F.length-1]}for(var x in l){u=l[x];if(u){if(b&&x==="$Key"){o.parameters=n([],u)}else if(u.$kind==="Property"){if(g.indexOf(x)>=0){continue}if(t.getObject(r+"/"+x+"@com.sap.vocabularies.UI.v1.Hidden")){continue}if(u.$isCollection){c.warning("Complex property with type "+u.$Type+" has been ignored");continue}f=d._fetchPropertyInfo(t,r,i,u,x,o);if(f){f.group=C;f.groupLabel=T;f.required=y.indexOf(x)>=0;f.visible=h.indexOf(x)>=0;if(E[x]){var N=d._getFilterOperators(E[x]);if(N){f.filterOperators=N}}f.maxConditions=e.isMultiValueFilterExpression(E[x])?-1:1;if(b&&o&&o.parameters.indexOf(x)>-1){f.path=null;f.name=x;f.required=true;o.parameterTypes[x]=u.$Type;m.push(f)}else if(!b){m.push(f)}}}else if(!b&&u.$kind==="NavigationProperty"&&!u.$isCollection){var M=P[x];if(M&&a.indexOf(u.$Type)===-1){v.push(d._fetchEntitySet(t,"/"+M,a,x,o))}}}}return Promise.all(v).then(function(e){e.forEach(function(e){m=m.concat(e)});return m})})};d._waitForMetaModel=function(e,t){return new Promise(function(r,a){var i=function(){var a=t===null?undefined:t;var i=e.getModel(a);if(i){r(i)}return i};var n=function(){if(i()){e.detachModelContextChange(n)}};if(!i()){if(!e.attachModelContextChange){a();return}e.attachModelContextChange(n)}})};d.fetchProperties=function(e,t){if(!(e.isA&&e.isA("sap.ui.mdc.FilterBar"))&&t){return d._fetchPropertiesByMetadata(e,t)}var r=e.getDelegate().payload.modelName;var a=e.getDelegate().payload.collectionName;return new Promise(function(t,i){var n;var o=d._getInstanceCacheEntry(e,"fetchedProperties");if(o){t(o);return}this._waitForMetaModel(e,r).then(function(r){if(!r||!a){i("model or entity set name not available");return}n=r.getMetaModel();if(!n){i("metadata model not available")}else{var o=[];var s={parameterNavigationName:null,parameters:[],parameterTypes:{}};d._fetchEntitySet(n,"/"+a,o,null,s).then(function(r){if(s.parameterNavigationName&&s.parameters.length>0){d._setInstanceCacheEntry(e,a+"-Parameters",s);r.sort(function(e,t){var r=e.path||e.name;var a=t.path||t.name;if(!(s.parameters.indexOf(r)>-1)&&!(s.parameters.indexOf(a)>-1)||s.parameters.indexOf(r)>-1&&s.parameters.indexOf(a)>-1){return 0}if(s.parameters.indexOf(r)>-1&&!(s.parameters.indexOf(a)>-1)){return-1}if(!(s.parameters.indexOf(r)>-1)&&s.parameters.indexOf(a)>-1){return 1}})}var i=r.reduce(function(e,t){e[t.name]=t;return e},{});r=Object.keys(i).map(function(e){return i[e]});d._setInstanceCacheEntry(e,"fetchedProperties",r);t(r)})}},function(){i("model not obtained")})}.bind(this))};d.cleanup=function(e){v.delete(e.getId())};d.getTypeUtil=function(e){return o};return d});