/*
 * ! OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["../../TableDelegate","../../table/V4AnalyticsPropertyHelper","../../util/loadModules","../../library","sap/m/ColumnPopoverSelectListItem","sap/m/MessageBox","sap/ui/core/Item","sap/ui/core/Core","sap/ui/core/library","sap/ui/core/format/ListFormat","sap/ui/base/ManagedObjectObserver"],function(e,t,r,n,o,a,i,s,u,g,l){"use strict";var f=n.TableType;var p=n.TableP13nMode;var c=new window.WeakMap;var d=Object.assign({},e);d.getPropertyHelperClass=function(){return t};d.fetchPropertyExtensions=function(e,t){return Promise.resolve(null)};d.fetchPropertiesForBinding=function(e){return this.fetchProperties(e)};d.fetchPropertyExtensionsForBinding=function(e,t){return this.fetchPropertyExtensions(e,t)};d.preInit=function(e){if(!c.has(e)){c.set(e,{})}return G(e).then(function(){y(e)})};d.validateState=function(t,r,n){var o=e.validateState.apply(this,arguments);var a;var i=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");if(n=="Sort"&&r.sorters){if(N(t)&&!E(t,r.items,r.sorters)){a={validation:u.MessageType.Information,message:i.getText("table.PERSONALIZATION_DIALOG_SORT_RESTRICTION")}}}else if(n=="Group"&&r.aggregations){var s=Object.keys(r.aggregations);var l=[];var f=g.getInstance();s.forEach(function(e){var r=t.getPropertyHelper().getProperty(e);if(r&&r.groupable){l.push(e)}});if(l.length){a={validation:u.MessageType.Information,message:i.getText("table.PERSONALIZATION_DIALOG_GROUP_RESTRICTION",[f.format(l)])}}}else if(n=="Column"){var p;var s=r.aggregations&&Object.keys(r.aggregations);if(!E(t,r.items,s)){p=i.getText("table.PERSONALIZATION_DIALOG_TOTAL_RESTRICTION")}if(N(t)&&!E(t,r.items,r.sorters)){p=p?p+"\n"+i.getText("table.PERSONALIZATION_DIALOG_SORT_RESTRICTION"):i.getText("table.PERSONALIZATION_DIALOG_SORT_RESTRICTION")}if(p){a={validation:u.MessageType.Information,message:p}}}return O(o,a)};d.updateBinding=function(e,t,r){if(!r||r.getPath()!=t.path){this.rebind(e,t);return}var n=r.getRootBinding();var o=n&&!n.isSuspended();try{if(o){n.suspend()}y(e,t);r.changeParameters(t.parameters);r.filter(t.filters,"Application");r.sort(t.sorter)}catch(a){this.rebind(e,t);if(n==r){o=false}}finally{if(o&&n.isSuspended()){n.resume()}}};d.rebind=function(t,r){y(t,r);e.rebind(t,r)};d.addColumnMenuItems=function(e,t){var r=e.getPropertyHelper();var n=r.getProperty(t.getDataProperty());var o=[];if(!n){return[]}if(e.isGroupingEnabled()){var a=n.getGroupableProperties();if(a.length>0){o.push(T(a,t))}}if(e.isAggregationEnabled()){var i=n.getAggregatableProperties();if(i.length>0){o.push(m(i,t))}}var u=e._oPopover;if(u){u.getItems().forEach(function(e,t,r){var n=e.getLabel();var o=s.getLibraryResourceBundle("sap.ui.mdc");if(n===o.getText("table.SETTINGS_GROUP")||n===o.getText("table.SETTINGS_TOTALS")){r[t].destroy()}if(r.length==0){u.destroy()}})}return o};d.getSupportedP13nModes=function(t){var r=e.getSupportedP13nModes(t);if(t._getStringType()===f.Table){if(!r.includes(p.Group)){r.push(p.Group)}if(!r.includes(p.Aggregate)){r.push(p.Aggregate)}}return r};function T(e,t){var r=e.map(function(e){return new i({text:e.label,key:e.name})});if(r.length>0){return new o({items:r,label:s.getLibraryResourceBundle("sap.ui.mdc").getText("table.SETTINGS_GROUP"),icon:"sap-icon://group-2",action:[{sName:"Group",oMDCColumn:t},v,this]})}}function m(e,t){var r=e.map(function(e){return new i({text:e.label,key:e.name})});if(r.length>0){return new o({items:r,label:s.getLibraryResourceBundle("sap.ui.mdc").getText("table.SETTINGS_TOTALS"),icon:"sap-icon://sum",action:[{sName:"Aggregate",oMDCColumn:t},v,this]})}}function v(e,t){var r=t.sName,n=t.oMDCColumn.getParent(),o=n.getCurrentState().groupLevels||[],i=n.getCurrentState().aggregations||{},u=Object.keys(i),g=false,l=e.getParameter("property"),f=r==="Aggregate"?o:u,p=f.filter(function(e){return r==="Aggregate"?e.name===l:e===l}).length>0;if(p){var c=s.getLibraryResourceBundle("sap.ui.mdc");var d;var T;var m;if(r==="Aggregate"){d=c.getText("table.SETTINGS_WARNING_TITLE_TOTALS");T=c.getText("table.SETTINGS_MESSAGE2");m=c.getText("table.SETTINGS_WARNING_BUTTON_TOTALS")}else{d=c.getText("table.SETTINGS_WARNING_TITLE_GROUPS");T=c.getText("table.SETTINGS_MESSAGE1");m=c.getText("table.SETTINGS_WARNING_BUTTON_GROUP")}g=true;a.warning(T,{id:n.getId()+"-messageBox",title:d,actions:[m,c.getText("table.SETTINGS_WARNING_BUTTON_CANCEL")],onClose:function(e){if(e===m){P(r,n,l)}}})}if(r==="Aggregate"&&!g){b(r,n,l)}else if(r==="Group"&&!g){b(r,n,l)}}function b(e,t,r){if(e==="Group"){t._onCustomGroup(r)}else{t._onCustomAggregate(r)}}function P(e,t,r){if(e==="Aggregate"){t._onCustomGroup(r);t._onCustomAggregate(r)}else if(e==="Group"){t._onCustomAggregate(r);t._onCustomGroup(r)}}function y(e,t){var r=c.get(e).plugin;if(!r||r.isDestroyed()){return}var n=e._getGroupedProperties().map(function(e){return e.name});var o=Object.keys(e._getAggregatedProperties());var a=t?t.parameters["$search"]:undefined;if(a){delete t.parameters["$search"]}var i={visible:I(e),groupLevels:n,grandTotal:o,subtotals:o,columnState:S(e,o),search:a};r.setAggregationInfo(i)}function I(e){var t=new Set;var r=c.get(e).oPropertyHelperForBinding;e.getColumns().forEach(function(e){var n=r.getProperty(e.getDataProperty());if(!n){return}if(n.isComplex()){n.getReferencedProperties().forEach(function(e){t.add(e.name)})}else{t.add(n.name)}});return Array.from(t)}function S(e,t){var r={};e.getColumns().forEach(function(n){var o=n.getId()+"-innerColumn";var a=_(e,n,t);var i=a.length>0;if(o in r){r[o].subtotals=i||r[o].subtotals;r[o].grandTotal=i||r[o].grandTotal;return}r[o]={subtotals:i,grandTotal:i};A(e,a).forEach(function(e){o=e.getId()+"-innerColumn";if(o in r){r[o].subtotals=i||r[o].subtotals;r[o].grandTotal=i||r[o].grandTotal}else{r[o]={subtotals:i,grandTotal:i}}})});return r}function h(e,t){var r=e.getPropertyHelper().getProperty(t.getDataProperty());if(!r){return[]}else if(r.isComplex()){return r.getReferencedProperties()}else{return[r]}}function _(e,t,r){return h(e,t).filter(function(e){return r.includes(e.name)})}function A(e,t){var r=[];t.forEach(function(e){if(e.unitProperty){r.push(e.unitProperty)}});return e.getColumns().filter(function(t){return h(e,t).some(function(e){return r.includes(e)})})}function E(e,t,r){var n,o=[];t&&t.forEach(function(t){n=e.getPropertyHelper().getProperty(t.name);if(!n.isComplex()){o.push(n.name)}else{n.getReferencedProperties().forEach(function(e){o.push(e.name)})}});var a=r?r.every(function(e){return o.find(function(t){return e.name?e.name===t:e===t})}):true;return a}function O(e,t){var r={Error:1,Warning:2,Information:3,None:4};if(!t||r[t.validation]-r[e.validation]>0){return e}else{return t}}function N(e){return(e.isGroupingEnabled()||e.isAggregationEnabled())&&e._isOfType(f.Table)}function G(e){if(e._isOfType(f.Table)){return(N(e)?C(e):R(e)).then(function(){return x(e)})}return Promise.resolve()}function C(e){var t=c.get(e);var n=t.plugin;if(n&&!n.isDestroyed()){n.activate();return Promise.resolve()}return Promise.all([e.awaitPropertyHelper(),r("sap/ui/table/plugins/V4Aggregation")]).then(function(r){var o=r[1][0];var a=e.getControlDelegate();n=new o({groupHeaderFormatter:function(t,r){return a.formatGroupHeader(e,t,r)}});e._oTable.addDependent(n);t.plugin=n;return L(e)}).then(function(e){n.setPropertyInfos(e.getProperties())})}function R(e){var t=c.get(e);if(t.plugin){t.plugin.deactivate()}return Promise.resolve()}function L(e){var t=c.get(e);if(t.oPropertyHelperForBinding){return Promise.resolve(t.oPropertyHelperForBinding)}var r=e.getControlDelegate();var n;var o;return r.fetchPropertiesForBinding(e).then(function(t){n=t;return r.fetchPropertyExtensionsForBinding(e,n)}).then(function(e){o=e;return r.getPropertyHelperClass()}).then(function(r){t.oPropertyHelperForBinding=new r(n,o,e);return t.oPropertyHelperForBinding})}function x(e){var t=c.get(e);if(!t.observer){t.observer=new l(function(r){if(r.type==="destroy"){if(t.oPropertyHelperForBinding){t.oPropertyHelperForBinding.destroy()}}else{G(e)}});t.observer.observe(e,{properties:["p13nMode"],destroy:true})}}return d});