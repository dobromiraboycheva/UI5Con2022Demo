/*
 * ! OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./Control","./ActionToolbar","./table/TableSettings","./table/GridTableType","./table/ResponsiveTableType","./table/PropertyHelper","./mixin/FilterIntegrationMixin","./library","sap/m/Text","sap/m/Title","sap/m/ColumnHeaderPopover","sap/m/ColumnPopoverSelectListItem","sap/m/ColumnPopoverActionItem","sap/m/OverflowToolbar","sap/m/library","sap/m/table/columnmenu/Menu","sap/ui/core/Core","sap/ui/core/format/NumberFormat","sap/ui/core/dnd/DragDropInfo","sap/ui/core/Item","sap/ui/core/format/ListFormat","sap/ui/core/library","sap/ui/events/KeyCodes","sap/ui/model/Sorter","sap/base/strings/capitalize","sap/base/util/deepEqual","sap/base/util/Deferred","sap/base/util/UriParameters","sap/ui/core/InvisibleMessage","sap/ui/core/InvisibleText","sap/ui/mdc/p13n/subcontroller/ColumnController","sap/ui/mdc/p13n/subcontroller/SortController","sap/ui/mdc/p13n/subcontroller/FilterController","sap/ui/mdc/p13n/subcontroller/GroupController","sap/ui/mdc/p13n/subcontroller/AggregateController","sap/ui/mdc/p13n/subcontroller/ColumnWidthController","sap/ui/mdc/actiontoolbar/ActionToolbarAction","sap/ui/mdc/table/RowActionItem","sap/ui/mdc/table/RowSettings","sap/ui/mdc/table/menu/QuickActionContainer","sap/ui/mdc/table/menu/ItemContainer","sap/ui/base/ManagedObjectMetadata"],function(t,e,i,o,n,r,s,a,l,u,h,p,d,g,c,f,b,_,m,T,y,C,v,P,I,S,x,E,A,w,B,M,R,D,F,N,L,O,z,H,V,k){"use strict";var G=a.SelectionMode;var U=a.TableType;var j=a.TableP13nMode;var W=c.ToolbarDesign;var q=c.ToolbarStyle;var Q=a.MultiSelectMode;var K=C.TitleLevel;var X=C.SortOrder;var $=new window.WeakMap;var J=function(t){if(!$.has(t)){$.set(t,{oFilterInfoBar:null})}return $.get(t)};function Y(t,e){sap.ui.require(["sap/m/MessageToast"],function(i){var o=b.getLibraryResourceBundle("sap.ui.mdc");i.show(o.getText(t,e))})}var Z=t.extend("sap.ui.mdc.Table",{metadata:{library:"sap.ui.mdc",designtime:"sap/ui/mdc/designtime/table/Table.designtime",interfaces:["sap.ui.mdc.IFilterSource","sap.ui.mdc.IxState"],defaultAggregation:"columns",properties:{width:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null,invalidate:true},height:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null,invalidate:true},p13nMode:{type:"sap.ui.mdc.TableP13nMode[]",defaultValue:[]},delegate:{type:"object",defaultValue:{name:"sap/ui/mdc/TableDelegate",payload:{}}},headerLevel:{type:"sap.ui.core.TitleLevel",group:"Appearance",defaultValue:K.Auto},autoBindOnInit:{type:"boolean",group:"Misc",defaultValue:true},header:{type:"string",group:"Misc",defaultValue:null},headerVisible:{type:"boolean",group:"Misc",defaultValue:true},selectionMode:{type:"sap.ui.mdc.SelectionMode",defaultValue:G.None},showRowCount:{type:"boolean",group:"Misc",defaultValue:true},threshold:{type:"int",group:"Appearance",defaultValue:-1},noDataText:{type:"string"},sortConditions:{type:"object"},filterConditions:{type:"object",defaultValue:{}},groupConditions:{type:"object"},aggregateConditions:{type:"object"},enableExport:{type:"boolean",defaultValue:false},busyIndicatorDelay:{type:"int",defaultValue:100},enableColumnResize:{type:"boolean",group:"Behavior",defaultValue:true},showPasteButton:{type:"boolean",group:"Behavior",defaultValue:false},enablePaste:{type:"boolean",group:"Behavior",defaultValue:true},multiSelectMode:{type:"sap.ui.mdc.MultiSelectMode",group:"Behavior",defaultValue:Q.Default},enableAutoColumnWidth:{type:"boolean",group:"Behavior",defaultValue:false}},aggregations:{_content:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"},type:{type:"sap.ui.mdc.table.TableTypeBase",altTypes:["sap.ui.mdc.TableType"],multiple:false},columns:{type:"sap.ui.mdc.table.Column",multiple:true},creationRow:{type:"sap.ui.mdc.table.CreationRow",multiple:false},actions:{type:"sap.ui.core.Control",multiple:true,forwarding:{getter:"_createToolbar",aggregation:"actions"}},variant:{type:"sap.ui.fl.variants.VariantManagement",multiple:false},quickFilter:{type:"sap.ui.core.Control",multiple:false},rowSettings:{type:"sap.ui.mdc.table.RowSettings",multiple:false},dataStateIndicator:{type:"sap.m.plugins.DataStateIndicator",multiple:false}},associations:{filter:{type:"sap.ui.mdc.IFilter",multiple:false}},events:{rowPress:{parameters:{bindingContext:{type:"sap.ui.model.Context"}}},selectionChange:{parameters:{bindingContext:{type:"sap.ui.model.Context"},selected:{type:"boolean"},selectAll:{type:"boolean"}}},beforeExport:{parameters:{exportSettings:{type:"object"},userExportSettings:{type:"object"}}},paste:{parameters:{data:{type:"string[][]"}}}}},constructor:function(){this._oTableReady=new x;this._oFullInitialize=new x;this._bUseColumnMenu=E.fromQuery(window.location.search).get("sap-ui-xx-columnmenu")==="true";t.apply(this,arguments);this.bCreated=true;this._doOneTimeOperations();this._initializeContent()},renderer:{apiVersion:2,render:function(t,e){t.openStart("div",e);t.class("sapUiMdcTable");t.style("height",e.getHeight());t.style("width",e.getWidth());t.openEnd();t.renderControl(e.getAggregation("_content"));t.close("div")}}});var tt=["variant","quickFilter"];s.call(Z.prototype);tt.forEach(function(t){var e=I(t),i="_o"+e,o="get"+e,n="set"+e,r="destroy"+e;Z.prototype[o]=function(){return this[i]};Z.prototype[r]=function(){var t=this[i];this[n]();if(t){t.destroy()}return this};Z.prototype[n]=function(e){this.validateAggregation(t,e,false);var n=this._createToolbar(),r=e!==this[i];if(!e||r){n.removeBetween(this[o]());this[i]=e}if(r&&e){this._setToolbarBetween(n)}return this}});Z.prototype.init=function(){t.prototype.init.apply(this,arguments);this.mSkipPropagation={rowSettings:true};this._bForceRebind=true;this._aSupportedP13nModes=Object.keys(j);this._updateAdaptation()};Z.prototype.applySettings=function(){this._setPropertyHelperClass(r);t.prototype.applySettings.apply(this,arguments);this.initControlDelegate()};Z.prototype._setToolbarBetween=function(t){[this._oVariant,this._oQuickFilter].forEach(function(e){if(e){t.addBetween(e)}})};Z.prototype.initialized=function(){return this._oTableReady.promise};Z.prototype._fullyInitialized=function(){return this._oFullInitialize.promise};Z.prototype.getDataStateIndicatorPluginOwner=function(t){return this._oTable||this._oFullInitialize.promise};Z.prototype.setDataStateIndicator=function(t){this._handleDataStateEvents(this.getDataStateIndicator(),"detach");this.setAggregation("dataStateIndicator",t,true);this._handleDataStateEvents(this.getDataStateIndicator(),"attach");return this};Z.prototype._handleDataStateEvents=function(t,e){if(t){t[e+"ApplyFilter"](this._onApplyMessageFilter,this);t[e+"ClearFilter"](this._onClearMessageFilter,this);t[e+"Event"]("filterInfoPress",pt,this)}};Z.prototype._onApplyMessageFilter=function(t){this._oMessageFilter=t.getParameter("filter");t.preventDefault();this._rebind()};Z.prototype._onClearMessageFilter=function(t){this._oMessageFilter=null;t.preventDefault();this._rebind()};Z.prototype._getStringType=function(t){var e,i=e=t||this.getType();if(!i){e=U.Table}else if(typeof i==="object"){if(i.isA("sap.ui.mdc.table.ResponsiveTableType")){e=U.ResponsiveTable}else{e=U.Table}}return e};Z.prototype._isOfType=function(t){return this._getStringType()===t};Z.prototype._updateTypeSettings=function(){var t=this.getType();if(t&&typeof t==="object"){t.updateTableSettings()}else{if(t==="ResponsiveTable"){t=n}else{t=o}t.updateDefault(this._oTable)}};Z.prototype.scrollToIndex=function(t){return new Promise(function(e,i){if(!this._oTable){return i()}if(typeof t!=="number"){return i("The iIndex parameter has to be a number")}if(this._isOfType(U.ResponsiveTable)){this._oTable.scrollToIndex(t).then(e).catch(i)}else{if(t===-1){t=this._getRowCount(false)}if(this._oTable._setFirstVisibleRowIndex(t)){this._oTable.attachEventOnce("rowsUpdated",function(){e()})}else{e()}}}.bind(this))};Z.prototype.focusRow=function(t,e){return this.scrollToIndex(t).then(function(){return this._oTable._setFocus(t,e)}.bind(this))};Z.prototype.setType=function(t){var e=this._getStringType(t);var i=this._getStringType();this.setAggregation("type",t,true);if(e===i&&this._oTable){this._updateTypeSettings();return this}if(this.bCreated){if(this._oTable){if(i==="ResponsiveTable"){this._oTable.setHeaderToolbar()}else{this._oTable.removeExtension(this._oToolbar)}this._oTable.destroy("KeepDom");this._oTable=null;this._bTableExists=false}else{this._onAfterTableCreated();this._onAfterFullInitialization()}if(this._oTemplate){this._oTemplate.destroy();this._oTemplate=null}this._oTableReady=new x;this._oFullInitialize=new x;this._bFullyInitialized=false;this._initializeContent()}return this};Z.prototype.setRowSettings=function(t){this.setAggregation("rowSettings",t,true);if(this._oTable){this._oRowActions={};if(this._isOfType(U.ResponsiveTable)){n.updateRowSettings(this,t,this._onResponsiveRowActionPress)}else{o.updateRowSettings(this._oTable,t,[this._onRowActionPress,this])}this._bForceRebind=true;this._rebind()}return this};Z.prototype.setHeaderLevel=function(t){if(this.getHeaderLevel()===t){return this}this.setProperty("headerLevel",t,true);this._oTitle&&this._oTitle.setLevel(t);return this};Z.prototype.focus=function(t){if(this._oTable){this._oTable.focus(t)}};Z.prototype.setBusy=function(t){this.setProperty("busy",t,true);if(this._oTable){this._oTable.setBusy(t)}return this};Z.prototype.setBusyIndicatorDelay=function(t){this.setProperty("busyIndicatorDelay",t,true);if(this._oTable){this._oTable.setBusyIndicatorDelay(t)}return this};Z.prototype.setSelectionMode=function(t){var e=this.getSelectionMode();this.setProperty("selectionMode",t,true);if(this._oTable&&e!=this.getSelectionMode()){this._updateSelectionBehavior()}return this};Z.prototype.setMultiSelectMode=function(t){var e=this.getMultiSelectMode();this.setProperty("multiSelectMode",t,true);if(this._oTable&&e!=this.getMultiSelectMode()){this._updateMultiSelectMode()}return this};Z.prototype.setCreationRow=function(t){this.setAggregation("creationRow",t,true);if(t){t.update()}return this};Z.prototype.setEnableColumnResize=function(t){var e=this.getEnableColumnResize();this.setProperty("enableColumnResize",t,true);if(this.getEnableColumnResize()!==e){this._updateColumnResizer();this._updateAdaptation()}return this};Z.prototype._onModifications=function(){this.getColumns().forEach(function(t){t._onModifications()})};Z.prototype.setP13nMode=function(t){var e=this.getP13nMode();var i=[];if(t&&t.length>1){var o=t.reduce(function(t,e,i){t[e]=true;return t},{});if(o.Column){i.push("Column")}if(o.Sort){i.push("Sort")}if(o.Filter){i.push("Filter")}if(o.Group){i.push("Group")}if(o.Aggregate){i.push("Aggregate")}}else{i=t}this.setProperty("p13nMode",i,true);this._updateAdaptation();if(!S(e.sort(),this.getP13nMode().sort())){et(this)}return this};Z.prototype._updateAdaptation=function(){var t={controller:{}};var e={Column:B,Sort:M,Group:D,Filter:R,Aggregate:F,ColumnWidth:N};this.getActiveP13nModes().forEach(function(i){t.controller[i]=e[i]});if(this.getEnableColumnResize()){t.controller["ColumnWidth"]=e["ColumnWidth"]}this.getEngine().registerAdaptation(this,t)};function et(t){if(t._oToolbar){t._oToolbar.destroyEnd();t._getP13nButtons().forEach(function(e){t._oToolbar.addEnd(e)})}if(t._oTable){var e=t._oTable.getDragDropConfig()[0];if(e){e.setEnabled(t.getActiveP13nModes().indexOf("Column")>-1)}}if(t.isFilteringEnabled()){ot(t)}it(t)}Z.prototype.setFilterConditions=function(t){this.setProperty("filterConditions",t,true);var e=this.getInbuiltFilter();if(e){e.setFilterConditions(t)}it(this);return this};function it(t){var e=st(t);var i=at(t);var o=lt(t);if(!e){return}if(o.length===0||!t.isFilteringEnabled()){var n=e.getDomRef();if(n&&n.contains(document.activeElement)){t.focus()}e.setVisible(false);nt(t).setText("");return}t._fullyInitialized().then(function(){var n=t.getPropertyHelper();var r=o.map(function(t){return n.hasProperty(t)?n.getProperty(t).label:""});var s=b.getLibraryResourceBundle("sap.ui.mdc");var a=y.getInstance();var l=s.getText("table.FILTER_INFO",a.format(r));if(!e.getVisible()){e.setVisible(true)}i.setText(l);nt(t).setText(l)})}function ot(t){if(!t._oTable){return}var e=st(t);if(!e){e=rt(t)}if(t._bMobileTable){if(t._oTable.getInfoToolbar()!==e){t._oTable.setInfoToolbar(e)}}else if(t._oTable.indexOfExtension(e)===-1){t._oTable.insertExtension(e,1)}var i=nt(t);t._oTable.addAriaLabelledBy(i.getId())}function nt(t){if(!t){return null}if(!t._oFilterInfoBarInvisibleText){t._oFilterInfoBarInvisibleText=(new w).toStatic()}return t._oFilterInfoBarInvisibleText}function rt(t){var e=t.getId()+"-filterInfoBar";var i=J(t).oFilterInfoBar;if(i&&!i.bIsDestroyed){i.destroy()}i=new g({id:e,active:true,design:W.Info,visible:false,content:[new l({id:e+"-text",wrapping:false})],press:[pt,t]});i.focus=function(){if(this.getDomRef()){g.prototype.focus.apply(this,arguments)}else{t.focus()}};J(t).oFilterInfoBar=i;it(t);return i}function st(t){var e=J(t).oFilterInfoBar;if(e&&(e.bIsDestroyed||e.bIsBeingDestroyed)){return null}return J(t).oFilterInfoBar}function at(t){var e=st(t);return e?e.getContent()[0]:null}Z.prototype.setThreshold=function(t){this.setProperty("threshold",t,true);if(!this._oTable){return this}t=this.getThreshold()>-1?this.getThreshold():undefined;if(this._bMobileTable){this._oTable.setGrowingThreshold(t)}else{this._oTable.setThreshold(t)}return this};Z.prototype._onFilterProvided=function(t){this._updateInnerTableNoDataText()};Z.prototype._onFilterRemoved=function(t){this._updateInnerTableNoDataText()};Z.prototype._onFiltersChanged=function(t){if(this.isTableBound()&&t.getParameter("conditionsBased")){this._oTable.setShowOverlay(true)}};Z.prototype._onFilterSearch=function(t){this._bIgnoreChange=true;this._bAnnounceTableUpdate=true};Z.prototype.setNoDataText=function(t){this.setProperty("noDataText",t,true);this._updateInnerTableNoDataText();return this};Z.prototype._updateInnerTableNoDataText=function(){if(!this._oTable){return}var t=this._getNoDataText();if(this._bMobileTable){this._oTable.setNoDataText(t)}else{this._oTable.setNoData(t)}};Z.prototype._getNoDataText=function(){var t=this.getNoDataText();if(t){return t}var e=b.getLibraryResourceBundle("sap.ui.mdc");if(!this.isTableBound()){if(this.getFilter()){return e.getText("table.NO_DATA_WITH_FILTERBAR")}return e.getText("table.NO_DATA")}var i=b.byId(this.getFilter());if(this.isFilteringEnabled()&&lt(this).length>0||i&&lt(i).length>0){return e.getText("table.NO_RESULTS")}return e.getText("table.NO_DATA")};Z.prototype._updateRowAction=function(){if(!this._oTable){return}var t=this._bMobileTable?n:o;t.updateRowActions(this,this.getRowSettings(),this._bMobileTable?this._onResponsiveRowActionPress:this._onRowActionPress)};Z.prototype._initializeContent=function(){var t,e=this._getStringType();if(this._isOfType(U.ResponsiveTable)){t=n}else{t=o}var i=[this.awaitControlDelegate(),t.loadTableModules()];if(this.isFilteringEnabled()){i.push(this.retrieveInbuiltFilter())}Promise.all(i).then(function(){if(this.bIsDestroyed){return}var t=this.getControlDelegate();this._aSupportedP13nModes=t.getSupportedP13nModes(this);this._updateAdaptation();if(t.preInit){this._pDelegatePreInit=t.preInit(this)}if(!this._bTableExists&&e===this._getStringType()){this._bMobileTable=e==="ResponsiveTable";this._createContent();this._bTableExists=true}}.bind(this)).catch(function(t){this._onAfterTableCreated();throw t}.bind(this))};Z.prototype._doOneTimeOperations=function(){if(!this.bColumnsOrdered){this.bColumnsOrdered=true;this._orderColumns()}};Z.prototype._onAfterTableCreated=function(t){this._oTableReady[t?"resolve":"reject"](this)};Z.prototype._onAfterFullInitialization=function(t){this._oFullInitialize[t?"resolve":"reject"](this)};Z.prototype._createContent=function(){this._createToolbar();this._createTable();this._updateColumnResizer();this._updateRowAction();this.getColumns().forEach(this._insertInnerColumn,this);this.setAggregation("_content",this._oTable);this._onAfterTableCreated(true);var t=this.initialized().then(function(){this.initPropertyHelper();var t=this.getCreationRow();if(t){t.update()}if(this.getAutoBindOnInit()){this.rebind()}return this.awaitPropertyHelper()}.bind(this));Promise.all([t,this._pDelegatePreInit]).then(function(){delete this._pDelegatePreInit;this._bFullyInitialized=true;this._onAfterFullInitialization(true)}.bind(this)).catch(function(t){this._onAfterFullInitialization();throw t}.bind(this))};Z.prototype.setHeader=function(t){this.setProperty("header",t,true);this._updateHeaderText();this._updateExportState(true);return this};Z.prototype.setHeaderVisible=function(t){this.setProperty("headerVisible",t,true);if(this._oTitle){this._oTitle.setWidth(this.getHeaderVisible()?undefined:"0px")}return this};Z.prototype.setShowRowCount=function(t){this.setProperty("showRowCount",t,true);this._updateHeaderText();return this};Z.prototype.setEnableExport=function(t){if(t!==this.getEnableExport()){this.setProperty("enableExport",t,true);if(t&&!this._oExportButton&&this._oToolbar){this._oToolbar.addEnd(this._getExportButton())}else if(this._oExportButton){this._oExportButton.setVisible(t)}}return this};Z.prototype.setShowPasteButton=function(t){if((t=!!t)==this.getShowPasteButton()){return this}this.setProperty("showPasteButton",t,true);if(t&&!this._oPasteButton&&this._oToolbar){this._oToolbar.insertEnd(this._getPasteButton(),0);this._oPasteButton.setEnabled(this.getEnablePaste())}else if(this._oPasteButton){this._oPasteButton.setVisible(t);this._oPasteButton.setEnabled(this.getEnablePaste())}return this};Z.prototype.setEnablePaste=function(t){this.setProperty("enablePaste",t,true);if(this._oPasteButton){this._oPasteButton.setEnabled(this.getEnablePaste())}return this};Z.prototype._createToolbar=function(){if(this.isDestroyStarted()||this.isDestroyed()){return}if(!this._oToolbar){this._oTitle=new u(this.getId()+"-title",{text:this.getHeader(),width:this.getHeaderVisible()?undefined:"0px",level:this.getHeaderLevel()});this._oToolbar=new e(this.getId()+"-toolbar",{design:W.Transparent,begin:[this._oTitle],end:[this._getPasteButton(),this._getP13nButtons(),this._getExportButton()]})}this._oToolbar.setStyle(this._bMobileTable?q.Standard:q.Clear);return this._oToolbar};Z.prototype._getVisibleProperties=function(){var t=[],e;this.getColumns().forEach(function(i,o){e=i&&i.getDataProperty();if(e){t.push({name:e})}});return t};Z.prototype.getConditions=function(){return this.getInbuiltFilter()?this.getInbuiltFilter().getConditions():[]};Z.prototype._getSortedProperties=function(){return this.getSortConditions()?this.getSortConditions().sorters:[]};Z.prototype._getGroupedProperties=function(){return this.getGroupConditions()?this.getGroupConditions().groupLevels:[]};Z.prototype._getAggregatedProperties=function(){return this.getAggregateConditions()?this.getAggregateConditions():{}};Z.prototype._getXConfig=function(){return this.getEngine().readXConfig(this)};function lt(t){var e=t.getFilterConditions();return Object.keys(e).filter(function(t){return e[t].length>0})}Z.prototype.getCurrentState=function(){var t={};var e=this.getActiveP13nModes();if(e.indexOf("Column")>-1){t.items=this._getVisibleProperties()}if(this.isSortingEnabled()){t.sorters=this._getSortedProperties()}if(this.isFilteringEnabled()){t.filter=this.getFilterConditions()}if(this.isGroupingEnabled()){t.groupLevels=this._getGroupedProperties()}if(this.isAggregationEnabled()){t.aggregations=this._getAggregatedProperties()}if(this.getEnableColumnResize()){t.xConfig=this._getXConfig()}return t};Z.prototype.isFilteringEnabled=function(){return this.getActiveP13nModes().includes(j.Filter)};Z.prototype.isSortingEnabled=function(){return this.getActiveP13nModes().includes(j.Sort)};Z.prototype.isGroupingEnabled=function(){return this.getActiveP13nModes().includes(j.Group)};Z.prototype.isAggregationEnabled=function(){return this.getActiveP13nModes().includes(j.Aggregate)};Z.prototype.getSupportedP13nModes=function(){return this._aSupportedP13nModes||[]};Z.prototype.getActiveP13nModes=function(){var t=this.getP13nMode();var e=this.getSupportedP13nModes();t=t.filter(function(t){return e.includes(t)});return t};Z.prototype._getP13nButtons=function(){var t=this.getActiveP13nModes();var e=[];var o=t.length===1&&t[0]==="Aggregate";if(t.length>0&&!o){e.push(i.createSettingsButton(this.getId(),[ht,this]))}return e};Z.prototype._getPasteButton=function(){if(this.getShowPasteButton()){if(!this._oPasteButton){this._oPasteButton=i.createPasteButton(this.getId())}return this._oPasteButton}};Z.prototype._getExportButton=function(){if(!this.getEnableExport()){return null}if(!this._oExportButton){this._oExportButton=i.createExportButton(this.getId(),{default:[function(){this._onExport()},this],exportAs:[function(){this._onExport(true)},this]})}this._updateExportState();return this._oExportButton};Z.prototype._updateExportState=function(t){if(this._oExportButton){this._oExportButton.setEnabled(this._getRowCount(false)>0);if(t&&this._cachedExportSettings){this._cachedExportSettings.fileName=this.getHeader()}}};Z.prototype._createExportColumnConfiguration=function(){var t=this.getColumns();return this._fullyInitialized().then(function(){var e=this.getPropertyHelper();var i=[];t.forEach(function(t){var o=e.getColumnExportSettings(t);i=i.concat(o)},this);return i}.bind(this))};Z.prototype._getColumnLabel=function(t){var e=this.getPropertyHelper();var i=e.getProperty(t);return i&&i.label};Z.prototype._onExport=function(t){var e=this;return this._createExportColumnConfiguration().then(function(i){if(!i||!i.length){sap.ui.require(["sap/m/MessageBox"],function(t){t.error(b.getLibraryResourceBundle("sap.ui.mdc").getText("table.NO_COLS_EXPORT"),{styleClass:this.$()&&this.$().closest(".sapUiSizeCompact").length?"sapUiSizeCompact":""})}.bind(e));return}var o=e._getRowBinding();var n=e._getColumnLabel.bind(e);var r={workbook:{columns:i,context:{title:e.getHeader()}},dataSource:o,fileName:e.getHeader()};e._loadExportLibrary().then(function(){sap.ui.require(["sap/ui/export/ExportHandler"],function(i){var o;e.getControlDelegate().fetchExportCapabilities(e).then(function(s){if(!e._oExportHandler){o=new i(s);o.attachBeforeExport(function(t){e.fireBeforeExport({exportSettings:t.getParameter("exportSettings"),userExportSettings:t.getParameter("userExportSettings")})});e._oExportHandler=o}if(t){e._oExportHandler.exportAs(r,n)}else{e._oExportHandler.export(r,n)}})})})})};Z.prototype._loadExportLibrary=function(){if(!this._oExportLibLoadPromise){this._oExportLibLoadPromise=b.loadLibrary("sap.ui.export",true)}return this._oExportLibLoadPromise};Z.prototype.onkeydown=function(t){if(t.isMarked()){return}if((t.metaKey||t.ctrlKey)&&t.shiftKey&&t.which===v.E){if(this.getEnableExport()&&this._oExportButton&&this._oExportButton.getEnabled()){this._onExport(true);t.setMarked();t.preventDefault()}}if((t.metaKey||t.ctrlKey)&&t.which===v.COMMA){var e=b.byId(this.getId()+"-settings");if(e&&e.getEnabled()&&e.getVisible()){e.firePress();t.setMarked();t.preventDefault()}}};Z.prototype._createTable=function(){var t=this.getThreshold()>-1?this.getThreshold():undefined;var e=this.getRowSettings()?this.getRowSettings().getAllSettings():{};if(this._bMobileTable){this._oTable=n.createTable(this.getId()+"-innerTable",{autoPopinMode:true,contextualWidth:"Auto",growing:true,sticky:["ColumnHeaders","HeaderToolbar","InfoToolbar"],itemPress:[this._onItemPress,this],selectionChange:[this._onSelectionChange,this],growingThreshold:t,noDataText:this._getNoDataText(),headerToolbar:this._oToolbar,ariaLabelledBy:[this._oTitle]});this._oTemplate=n.createTemplate(this.getId()+"-innerTableRow",e);this._sAggregation="items";this._oTable.bindRows=this._oTable.bindItems;this._oTable.bActiveHeaders=true;this._oTable.attachEvent("columnPress",this._onResponsiveTableColumnPress,this)}else{this._oTable=o.createTable(this.getId()+"-innerTable",{enableBusyIndicator:true,enableColumnReordering:false,threshold:t,cellClick:[this._onCellClick,this],noData:this._getNoDataText(),extension:[this._oToolbar],ariaLabelledBy:[this._oTitle],plugins:[o.createMultiSelectionPlugin(this,[this._onRowSelectionChange,this])],columnSelect:[this._onGridTableColumnPress,this],rowSettingsTemplate:e});this._sAggregation="rows"}this._updateTypeSettings();this._updateSelectionBehavior();this._updateMultiSelectMode();var i=new m({sourceAggregation:"columns",targetAggregation:"columns",dropPosition:"Between",enabled:this.getActiveP13nModes().includes(j.Column),drop:[this._onColumnRearrange,this]});i.bIgnoreMetadataCheck=true;this._oTable.addDragDropConfig(i);this._oTable.setBusyIndicatorDelay(this.getBusyIndicatorDelay());this._oTable.attachPaste(this._onInnerTablePaste,this);if(this.isFilteringEnabled()){ot(this)}};Z.prototype._updateColumnResizer=function(){if(!this._oTable){return}var t=this.getEnableColumnResize();var e=this._bMobileTable?n:o;if(t){e.enableColumnResizer(this,this._oTable)}else{e.disableColumnResizer(this,this._oTable)}};Z.prototype._updateSelectionBehavior=function(){var t=this._bMobileTable?n:o;t.updateSelection(this)};Z.prototype._updateMultiSelectMode=function(){if(this._bMobileTable){n.updateMultiSelectMode(this)}};Z.prototype._onColumnRearrange=function(t){var e=t.getParameter("draggedControl");var o=t.getParameter("droppedControl");if(e===o){return}var n=t.getParameter("dropPosition");var r=this._oTable.indexOfColumn(e);var s=this._oTable.indexOfColumn(o);var a=s+(n=="Before"?0:1)+(r<s?-1:0);i.moveColumn(this,r,a)};Z.prototype._onColumnPress=function(t){if(this._bSuppressOpenMenu){return}var e=t.getParent(),i=e.indexOfColumn(t),o=this.getColumns()[i];this._fullyInitialized().then(function(){if(this._bUseColumnMenu){if(!this._oColumnHeaderMenu){this._oQuickActionContainer=new H({table:this});this._oItemContainer=new V({table:this});this._oColumnHeaderMenu=new f({_quickActions:[this._oQuickActionContainer],_items:[this._oItemContainer]})}this._oQuickActionContainer.setAssociation("column",o);Promise.all([this._oQuickActionContainer.initializeQuickActions(),this._oItemContainer.initializeItems()]).then(function(){if(this._oQuickActionContainer.hasQuickActions()||this._oItemContainer.hasItems()){this._oColumnHeaderMenu.openBy(t)}}.bind(this))}else{var e=b.getLibraryResourceBundle("sap.ui.mdc"),i=this._bMobileTable&&this.getEnableColumnResize();if(this._oPopover){this._oPopover.destroy();this._oPopover=null}if(this.isSortingEnabled()){var r=[],s=[];var a=this.getPropertyHelper().getProperty(o.getDataProperty()).getSortableProperties();a.forEach(function(t){r.push(new T({text:t.label,key:t.name}));s.push(new T({text:t.label,key:t.name}))});if(r.length>0){this._oPopover=new h({items:[new p({items:r,label:e.getText("table.SETTINGS_ASCENDING"),icon:"sap-icon://sort-ascending",action:[X.Ascending,this._onCustomSort,this]}),new p({items:s,label:e.getText("table.SETTINGS_DESCENDING"),icon:"sap-icon://sort-descending",action:[X.Descending,this._onCustomSort,this]})]});t.addDependent(this._oPopover)}}var l=[];var u=this.getControlDelegate();var d=u.addColumnMenuItems&&u.addColumnMenuItems(this,o)||[];this.getPropertyHelper().getFilterableProperties(o.getDataProperty()).forEach(function(t){l.push(new T({text:t.label,key:t.name}))});if(this.isFilteringEnabled()&&l.length){var g=new p({label:e.getText("table.SETTINGS_FILTER"),icon:"sap-icon://filter",action:[pt,this]});d.unshift(g)}if(i){var c=n.startColumnResize(this._oTable,t);c&&d.push(c)}d.forEach(function(e){this._createPopover(e,t)},this);this._oPopover&&this._oPopover.openBy(t)}}.bind(this))};Z.prototype._createPopover=function(t,e){if(this._oPopover){this._oPopover.addItem(t)}else{this._oPopover=new h({items:t});e.addDependent(this._oPopover)}};Z.prototype._onCustomSort=function(t,e){var o=t.getParameter("property");this.getCurrentState().sorters.forEach(function(t){if(t.name===o){if(t.descending&&e===X.Descending||!t.descending&&e===X.Ascending){e=X.None}}});i.createSort(this,o,e,true)};Z.prototype._onColumnResize=function(t){var e=t.getParameter("column");var o=t.getParameter("width");var n=this._oTable.indexOfColumn(e);var r=this.getColumns()[n];var s=r.getDataProperty();i.createColumnWidth(this,s,o)};Z.prototype._onCustomGroup=function(t){i.createGroup(this,t)};Z.prototype._onCustomAggregate=function(t){i.createAggregation(this,t)};Z.prototype._insertInnerColumn=function(t,e){if(!this._oTable){return}var i=t.getInnerColumn();this._setMobileColumnTemplate(t,e);this._bForceRebind=true;if(e===undefined){this._oTable.addColumn(i)}else{this._oTable.insertColumn(i,e)}};Z.prototype._orderColumns=function(){var t,e=[],i=this.getColumns();i.forEach(function(i){t=i.getInitialIndex();if(t>-1){e.push({index:t,column:this.removeColumn(i)})}},this);e.sort(function(t,e){return t-e});e.forEach(function(t){this.insertColumn(t.column,t.index)},this)};Z.prototype.moveColumn=function(t,e){t._bIsBeingMoved=true;this.removeAggregation("columns",t,true);this.insertAggregation("columns",t,e,true);delete t._bIsBeingMoved;if(this._oTable){var i=t.getInnerColumn();this._oTable.removeColumn(i);this._oTable.insertColumn(i,e);this._setMobileColumnOrder();this._updateMobileColumnTemplate(t,e)}};Z.prototype.removeColumn=function(t){t=this.removeAggregation("columns",t,true);this._updateMobileColumnTemplate(t,-1);return t};Z.prototype.addColumn=function(t){this.addAggregation("columns",t,true);this._insertInnerColumn(t);return this};Z.prototype.insertColumn=function(t,e){this.insertAggregation("columns",t,e,true);this._insertInnerColumn(t,e);return this};Z.prototype._setMobileColumnTemplate=function(t,e){if(!this._bMobileTable){return}var i=t.getTemplateClone();if(e>=0){this._oTemplate.insertCell(i,e);this._oTable.getItems().forEach(function(t){t.insertAggregation("cells",new w,e,true)})}else{this._oTemplate.addCell(i)}};Z.prototype._updateMobileColumnTemplate=function(t,e){if(!this._bMobileTable){return}var i,o;if(this._oTemplate){i=t.getTemplateClone();o=this._oTemplate.indexOfCell(i);ut(this._oTemplate,o,e)}if(o>-1){this._oTable.getItems().forEach(function(t){if(t.removeCell){ut(t,o,e)}})}};Z.prototype._setMobileColumnOrder=function(){if(!this._bMobileTable){return}this.getColumns().forEach(function(t){var e=t.getInnerColumn();if(!e){return}e.setOrder(this.indexOfColumn(t))},this);this._oTable.invalidate()};function ut(t,e,i){var o=t.removeCell(e);if(o){if(i>-1){t.insertCell(o,i)}else{o.destroy()}}}Z.prototype._onItemPress=function(t){this.fireRowPress({bindingContext:t.getParameter("listItem").getBindingContext()});n._onRowActionPress.apply(this,[t])};Z.prototype._onSelectionChange=function(t){var e=t.getParameter("selectAll");this.fireSelectionChange({bindingContext:t.getParameter("listItem").getBindingContext(),selected:t.getParameter("selected"),selectAll:e});if(e){var i=this.getRowBinding();if(i&&this._oTable){var o=i.getLength();var n=this._oTable.getItems().length;var r=i.isLengthFinal();if(n!=o||!r){Y("table.SELECTION_LIMIT_MESSAGE",[n])}}}};Z.prototype._onResponsiveTableColumnPress=function(t){this._onColumnPress(t.getParameter("column"))};Z.prototype._onCellClick=function(t){this.fireRowPress({bindingContext:t.getParameter("rowBindingContext")})};Z.prototype._onRowSelectionChange=function(t){if(!this._bSelectionChangedByAPI){this.fireSelectionChange({bindingContext:t.getParameter("rowContext"),selected:t.getSource().isIndexSelected(t.getParameter("rowIndex")),selectAll:t.getParameter("selectAll")})}};Z.prototype._onGridTableColumnPress=function(t){t.preventDefault();this._onColumnPress(t.getParameter("column"))};Z.prototype.getSelectedContexts=function(){if(this._oTable){if(this._bMobileTable){return this._oTable.getSelectedContexts()}var t=this._oTable.getPlugins()[0].getSelectedIndices();return t.map(function(t){return this._oTable.getContextByIndex(t)},this)}return[]};Z.prototype.clearSelection=function(){if(this._oTable){if(this._bMobileTable){this._oTable.removeSelections(true)}else{this._bSelectionChangedByAPI=true;this._oTable.getPlugins()[0].clearSelection();this._bSelectionChangedByAPI=false}}};Z.prototype._registerInnerFilter=function(t){t.attachSearch(function(){this._rebind()},this)};Z.prototype.isTableBound=function(){return this._oTable?this._oTable.isBound(this._bMobileTable?"items":"rows"):false};Z.prototype.bindRows=function(){if(!this.bDelegateInitialized||!this._oTable){return}var t={};this.getControlDelegate().updateBindingInfo(this,t);if(t.path){this._oTable.setShowOverlay(false);if(this._bMobileTable&&this._oTemplate){t.template=this._oTemplate}else{delete t.template}Z._addBindingListener(t,"dataRequested",this._onDataRequested.bind(this));Z._addBindingListener(t,"dataReceived",this._onDataReceived.bind(this));Z._addBindingListener(t,"change",this._onBindingChange.bind(this));this._updateColumnsBeforeBinding();this.getControlDelegate().updateBinding(this,t,this._bForceRebind?null:this.getRowBinding());this._updateInnerTableNoDataText();this._bForceRebind=false}};Z.prototype._onDataRequested=function(){this._bIgnoreChange=true};Z.prototype._onDataReceived=function(){this._bIgnoreChange=false;this._updateHeaderText();this._updateExportState()};Z.prototype._onBindingChange=function(){if(this._bIgnoreChange){return}this._updateHeaderText()};Z.prototype._updateHeaderText=function(){var t,e;if(!this._oNumberFormatInstance){this._oNumberFormatInstance=_.getFloatInstance()}if(this._oTitle&&this.getHeader()){t=this.getHeader();if(this.getShowRowCount()){e=this._getRowCount(true);if(e>0){var i=this._oNumberFormatInstance.format(e);t+=" ("+i+")"}}this._oTitle.setText(t)}if(!this._bIgnoreChange&&this._bAnnounceTableUpdate){this._bAnnounceTableUpdate=false;this._announceTableUpdate(e)}};Z.prototype._announceTableUpdate=function(t){var e=A.getInstance();if(e){var i=b.getLibraryResourceBundle("sap.ui.mdc");var o=this.getHeader();if(t===undefined&&this._getRowCount(false)>0){e.announce(i.getText("table.ANNOUNCEMENT_TABLE_UPDATED",[o]))}else if(t>1){e.announce(i.getText("table.ANNOUNCEMENT_TABLE_UPDATED_MULT",[o,t]))}else if(t===1){e.announce(i.getText("table.ANNOUNCEMENT_TABLE_UPDATED_SING",[o,t]))}else{e.announce(i.getText("table.ANNOUNCEMENT_TABLE_UPDATED_NOITEMS",[o]))}}};Z.prototype._updateColumnsBeforeBinding=function(){var t=this.getColumns();var e=this.getPropertyHelper();t.forEach(function(t){var i=t.getInnerColumn();var o=e.getProperty(t.getDataProperty());var n=o?o.getSortableProperties().map(function(t){return t.name}):[];var r=this._getSortedProperties().find(function(t){return n.includes(t.name)});var s=r&&r.descending?X.Descending:X.Ascending;if(this._bMobileTable){i.setSortIndicator(r?s:X.None)}else{i.setSorted(!!r).setSortOrder(s)}},this)};Z.prototype._getRowCount=function(t){var e=this._getRowBinding();if(!e){return t?undefined:0}var i;if(!t){i=e.getLength()}else if(typeof e.getCount==="function"){i=e.getCount()}else if(e.isLengthFinal()){i=e.getLength()}if(i<0||i==="0"){i=0}return i};Z.prototype.getRowBinding=function(){return this._getRowBinding()};Z.prototype._getRowBinding=function(){if(this._oTable){return this._oTable.getBinding(this._sAggregation)}};Z._addBindingListener=function(t,e,i){if(!t.events){t.events={}}if(!t.events[e]){t.events[e]=i}else{var o=t.events[e];t.events[e]=function(){i.apply(this,arguments);o.apply(this,arguments)}}};Z.prototype._rebind=function(){if(this._bFullyInitialized){this.bindRows()}else{this._fullyInitialized().then(this._rebind.bind(this))}};function ht(t){i.showPanel(this,"Columns",t.getSource())}function pt(t){i.showPanel(this,"Filter",t.getSource())}Z.prototype._getSorters=function(){var t=this.getSortConditions()?this.getSortConditions().sorters:[];var e=[],i=this.getPropertyHelper();t.forEach(function(t){if(i.hasProperty(t.name)){var o=i.getProperty(t.name).path;e.push(new P(o,t.descending))}});return e};Z.prototype._onInnerTablePaste=function(t){if(!this.getEnablePaste()){return}this.firePaste({data:t.getParameter("data")})};Z.prototype.exit=function(){if(this._oTemplate){this._oTemplate.destroy()}this._oTemplate=null;this._oTable=null;if(this._oToolbar&&!this._bTableExists){this._oToolbar.destroy()}this._oToolbar=null;this._oTitle=null;this._oNumberFormatInstance=null;tt.forEach(function(t){var e=I(t),i="_o"+e;this[i]=null},this);this._oTableReady=null;this._oFullInitialize=null;this._oPasteButton=null;if(this._oFilterInfoBarInvisibleText){this._oFilterInfoBarInvisibleText.destroy();this._oFilterInfoBarInvisibleText=null}t.prototype.exit.apply(this,arguments)};Z.prototype.addAction=function(e){if(e.getMetadata().getName()!=="sap.ui.mdc.actiontoolbar.ActionToolbarAction"){e=new L(e.getId()+"-action",{action:e})}return t.prototype.addAggregation.apply(this,["actions",e])};return Z});