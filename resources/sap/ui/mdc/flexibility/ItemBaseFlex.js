/*
 * ! OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/changeHandler/Base","sap/ui/mdc/p13n/Engine","sap/base/Log"],function(e,t,n){"use strict";var i={_bSupressFlickering:true,beforeAddItem:function(e,t,n,i){return e.addItem.call(e,t,n,i)},afterRemoveItem:function(e,t,n,i){return e.removeItem.call(e,t,n,i)},findItem:function(e,t,n){return Promise.resolve()},beforeApply:function(e,t,n){return},afterApply:function(e,t,n){return},determineAggregation:function(e,t){var n;return Promise.resolve().then(e.getControlMetadata.bind(e,t)).then(function(i){n=i.getDefaultAggregation().name;return e.getAggregation(t,n)}).then(function(e){return{name:n,items:e}})},_getExistingAggregationItem:function(e,t,n){var i=t.modifier;return this.determineAggregation(i,n).then(function(t){var n,r=t.items;if(r){n=this.findItem(i,r,e.name)}return n}.bind(this))},_getDelegate:function(e){return new Promise(function(t,n){sap.ui.require([e],t,n)})},_getOperationText:function(e){return e?"reverted ":"applied "},_getChangeTypeText:function(e){return e?"add":"remove"},_delayInvalidate:function(e){if(e&&e.isInvalidateSuppressed&&!e.isInvalidateSuppressed()){e.iSuppressInvalidate=1;t.getInstance().waitForChanges(e).then(function(){e.iSuppressInvalidate=0;e.invalidate()})}},_applyAdd:function(e,t,i,r){this.beforeApply(e.getChangeType(),t,r);if(this._bSupressFlickering){this._delayInvalidate(t)}var a=i.modifier,o=r?e.getRevertData():e.getContent();var g=o.name;var s;var h;var u;var d=this.determineAggregation(a,t).then(function(e){u=e;h=u.items;s=o.index>-1?o.index:h.length;return this._getExistingAggregationItem(o,i,t)}.bind(this)).then(function(e){if(e){return e}else{return a.getProperty(t,"delegate").then(function(e){return this._getDelegate(e.name)}.bind(this)).then(function(e){return this.beforeAddItem(e,g,t,i,o)}.bind(this)).then(function(e){return e})}}.bind(this)).then(function(e){if(!e){throw new Error("No item in"+u.name+"  created. Change to "+this._getChangeTypeText(!r)+"cannot be "+this._getOperationText(r)+"at this moment")}if(h.indexOf(e)<0){a.insertAggregation(t,u.name,e,s)}else{n.warning("The specified change is already existing - change appliance ignored")}return e}.bind(this)).then(function(){if(r){e.resetRevertData()}else{e.setRevertData({name:o.name,index:s})}this.afterApply(e.getChangeType(),t,r)}.bind(this));return d},_applyRemove:function(e,t,i,r){this.beforeApply(e.getChangeType(),t,r);if(this._bSupressFlickering){this._delayInvalidate(t)}var a=i.modifier,o=r?e.getRevertData():e.getContent();var g;var s;var h;var u=this.determineAggregation(a,t).then(function(e){g=e;return this._getExistingAggregationItem(o,i,t)}.bind(this)).then(function(e){h=e;if(!h){if(r){throw new Error("No item found in "+g.name+". Change to "+this._getChangeTypeText(r)+"cannot be "+this._getOperationText(r)+"at this moment")}else{n.warning("The specified change is already existing - change appliance ignored")}return-1}return a.findIndexInParentAggregation(h)}.bind(this)).then(function(e){s=e;return a.removeAggregation(t,g.name,h)}).then(function(){return a.getProperty(t,"delegate").then(function(e){return this._getDelegate(e.name)}.bind(this)).then(function(n){return this.afterRemoveItem(n,h,t,i).then(function(n){if(n&&h){a.destroy(h)}this.afterApply(e.getChangeType(),t,r)}.bind(this))}.bind(this))}.bind(this)).then(function(){if(r){e.resetRevertData()}else{e.setRevertData({name:o.name,index:s})}});return u},_applyMove:function(e,t,n,i){this.beforeApply(e.getChangeType(),t,i);if(this._bSupressFlickering){this._delayInvalidate(t)}var r=n.modifier;var a=i?e.getRevertData():e.getContent();var o;var g;var s;var h=this.determineAggregation(r,t).then(function(e){g=e;return this._getExistingAggregationItem(a,n,t)}.bind(this)).then(function(e){o=e}).then(function(){if(!o){throw new Error("No corresponding item in "+g.name+" found. Change to move item cannot be "+this._getOperationText(i)+"at this moment")}return r.findIndexInParentAggregation(o)}.bind(this)).then(function(e){s=e;if(t.moveColumn){return t.moveColumn(o,a.index)}else{return r.removeAggregation(t,g.name,o).then(function(){return r.insertAggregation(t,g.name,o,a.index)})}}).then(function(){if(i){e.resetRevertData()}else{e.setRevertData({name:a.name,index:s})}this.afterApply(e.getChangeType(),t,i)}.bind(this));return h},_removeIndexFromChange:function(e){delete e.getContent().index},createChangeHandler:function(e,t,n){return{changeHandler:{applyChange:function(t,n,i){return e(t,n,i)},completeChangeContent:function(e,n,i){t(e,n,i)},revertChange:function(e,t,i){return n(e,t,i,true)}},layers:{USER:true}}},createAddChangeHandler:function(){var e=this._applyAdd.bind(this);var t=function(){};var n=this._applyRemove.bind(this);return this.createChangeHandler(e,t,n)},createRemoveChangeHandler:function(){var e=this._applyRemove.bind(this);var t=this._removeIndexFromChange.bind(this);var n=this._applyAdd.bind(this);return this.createChangeHandler(e,t,n)},createMoveChangeHandler:function(){var e=this._applyMove.bind(this);var t=function(){};var n=e;return this.createChangeHandler(e,t,n)}};return i});