/*
 * ! OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/mdc/Element","sap/ui/mdc/condition/FilterOperatorUtil","sap/ui/mdc/condition/Operator","sap/ui/mdc/condition/Condition","sap/ui/mdc/enum/ConditionValidated","sap/base/Log","sap/base/util/merge","sap/ui/base/SyncPromise","sap/ui/model/FormatException","sap/ui/model/ParseException"],function(e,t,i,o,n,r,s,a,p,l){"use strict";var u;var h;var f=e.extend("sap.ui.mdc.field.FieldHelpBase",{metadata:{interfaces:["sap.ui.core.PopupInterface"],library:"sap.ui.mdc",properties:{conditions:{type:"object[]",defaultValue:[],byValue:true},delegate:{type:"object",group:"Data",defaultValue:{name:"sap/ui/mdc/field/FieldHelpBaseDelegate"}},filterValue:{type:"string",defaultValue:""},validateInput:{type:"boolean",defaultValue:true}},aggregations:{_popover:{type:"sap.m.Popover",multiple:false,visibility:"hidden"}},events:{select:{parameters:{conditions:{type:"object[]"},add:{type:"boolean"},close:{type:"boolean"}}},navigate:{parameters:{value:{type:"any"},key:{type:"any"},condition:{type:"object"},itemId:{type:"string"},leaveFocus:{type:"boolean"}}},dataUpdate:{},disconnect:{},open:{suggestion:{type:"boolean"}},afterClose:{},switchToValueHelp:{}},defaultProperty:"filterValue"}});f._init=function(){u=undefined;h=undefined};f.prototype.init=function(){e.prototype.init.apply(this,arguments);this._oTextOrKeyPromises={}};f.prototype.invalidate=function(e){if(e){var t=this.getAggregation("_popover");if(t&&e===t){if(e.bOutput&&!this._bIsBeingDestroyed){var i=this.getParent();if(i){i.invalidate(this)}}return}}};f.prototype.setFilterValue=function(e){this.setProperty("filterValue",e,true);return this};f.prototype.connect=function(e){if(this._oField&&this._oField!==e){var t=this.getAggregation("_popover");if(t){t._oPreviousFocus=null}this.close();this.setFilterValue("");this.setConditions([]);this.fireDisconnect()}this._oField=e;O.call(this,e);return this};f.prototype._getField=function(){if(this._oField){return this._oField}else{return this.getParent()}};f.prototype._getOperator=function(){if(!this._oOperator){this._oOperator=t.getEQOperator()}return this._oOperator};f.prototype._createCondition=function(e,t,r,s){var a=this._getOperator();var p=[e];if(a.valueTypes.length>1&&a.valueTypes[1]!==i.ValueType.Static&&t!==null&&t!==undefined){p.push(t)}return o.createCondition(a.name,p,r,s,n.Validated)};f.prototype._getControlForSuggestion=function(){var e=this._getField();if(e.getControlForSuggestion){return e.getControlForSuggestion()}else{return e}};f.prototype.getFieldPath=function(){var e="";if(this._oField&&this._oField.getFieldPath){e=this._oField.getFieldPath()}return e||"Help"};f.prototype.getDomRef=function(){var t=this.getAggregation("_popover");if(t){return t.getDomRef()}else{return e.prototype.getDomRef.apply(this,arguments)}};f.prototype.getContentId=function(){var e=this.getAggregation("_popover");if(e){var t=e._getAllContent();if(t.length===1){return t[0].getId()}}};f.prototype.getAriaHasPopup=function(){return"listbox"};f.prototype.getRoleDescription=function(e){return null};f.prototype.getValueHelpEnabled=function(){return true};f.prototype.open=function(e){var t=this._getField();if(t){var i=this._getPopover();if(i&&!this._bOpenAfterPromise){delete this._bOpen;delete this._bSuggestion;if(!i.isOpen()){if(!this.isFocusInHelp()){i.setInitialFocus(this._getControlForSuggestion())}i.setFieldGroupIds(t.getFieldGroupIds());var o=function(){if(this._bOpenAfterPromise){delete this._bOpenAfterPromise;this.open(e)}}.bind(this);var n=this._fireOpen(!!e,o);if(n){if(i._getAllContent().length>0){i.openBy(this._getControlForSuggestion())}else{this._bOpenIfContent=true}}else{this._bOpenAfterPromise=true}}}else{this._bOpen=true;this._bSuggestion=e}}else{r.warning("FieldHelp not assigned to field -> can not be opened.",this)}};f.prototype.close=function(){var e=this.getAggregation("_popover");if(e&&e.isOpen()){var t=e.oPopup.getOpenState();if(t!=="CLOSED"&&t!=="CLOSING"){this._bClosing=true;e.close()}}else{delete this._bOpen;delete this._bSuggestion;delete this._bOpenIfContent;delete this._bOpenAfterPromise}this._bReopen=false};f.prototype.toggleOpen=function(e){var t=this.getAggregation("_popover");if(t){if(t.isOpen()){var i=t.oPopup.getOpenState();if(i!=="CLOSED"&&i!=="CLOSING"){this.close()}else{this._bReopen=true}}else{this.open(e)}}else if(this._bOpen||this._bOpenIfContent||this._bOpenAfterPromise){delete this._bOpen;delete this._bSuggestion;delete this._bOpenIfContent;delete this._bOpenAfterPromise}else{this.open(e)}};f.prototype.isOpen=function(e){if(e&&this._bClosing){return false}var t=false;var i=this.getAggregation("_popover");if(i){t=i.isOpen()}return t};f.prototype.skipOpening=function(){if(this._bOpenIfContent){delete this._bOpenIfContent}if(this._bOpenAfterPromise){delete this._bOpenAfterPromise}};f.prototype.initBeforeOpen=function(e){if(this._bOpenAfterPromise){return}var t=function(){this._bBeforeOpenPending=false;if(this._bOpenAfterPromise){delete this._bOpenAfterPromise;this.open(e)}}.bind(this);var i=this._callContentRequest(e,t);if(!i){this._bBeforeOpenPending=true}};f.prototype._createPopover=function(){var e;if((!u||!h)&&!this._bPopoverRequested){u=sap.ui.require("sap/m/Popover");h=sap.ui.require("sap/m/library");if(!u||!h){sap.ui.require(["sap/m/Popover","sap/m/library"],d.bind(this));this._bPopoverRequested=true}}if(u&&h&&!this._bPopoverRequested){e=new u(this.getId()+"-pop",{contentHeight:"auto",placement:h.PlacementType.VerticalPreferredBottom,showHeader:false,showArrow:false,afterOpen:this._handleAfterOpen.bind(this),afterClose:this._handleAfterClose.bind(this)}).addStyleClass("sapMComboBoxBasePicker").addStyleClass("sapMComboBoxBasePicker-CTX");e.isPopupAdaptationAllowed=function(){return false};this.setAggregation("_popover",e,true);if(this._oContent){this._setContent(this._oContent)}}return e};function d(e,t){u=e;h=t;this._bPopoverRequested=false;if(!this._bIsBeingDestroyed){this._createPopover();if(this._bOpen){this.open(this._bSuggestion)}}}f.prototype._getPopover=function(){var e=this.getAggregation("_popover");if(!e){e=this._createPopover()}return e};f.prototype._handleAfterOpen=function(e){};f.prototype._handleAfterClose=function(e){this._bClosing=false;if(this._bReopen){this._bReopen=false;this.open()}this.fireAfterClose()};f.prototype.openByTyping=function(){return false};f.prototype.openByClick=function(){return false};f.prototype.isFocusInHelp=function(){return!this.openByTyping()};f.prototype.removeFocus=function(){};f.prototype.navigate=function(e){};f.prototype.getTextForKey=function(e,t,i,o,n,r){return c.call(this,e,o,t,i,false,n,r,true)};function c(e,t,i,o,n,r,s,a){return _.call(this,true,e,t,i,o,n,r,s,undefined,false,a)}f.prototype.getKeyForText=function(e,t,i,o){return g.call(this,e,t,false,i,o,true)};function g(e,t,i,o,n,r){return _.call(this,false,e,t,undefined,undefined,i,o,n,undefined,false,r)}f.prototype._getTextOrKey=function(e,t,i,o,n,r,s,a,p,l,u){if(t){return""}else{return undefined}};f.prototype._isTextOrKeyRequestSupported=function(){return false};f.prototype.isValidationSupported=function(){return this.isUsableForValidation()};f.prototype.getItemForValue=function(e,t,i,o,n,r,s,a,p,l){if(typeof e!=="object"||!e.hasOwnProperty("value")){e={value:e,parsedValue:t,inParameters:i,outParameters:o,bindingContext:n,checkKeyFirst:r,checkKey:s,checkDescription:a,conditionModel:p,conditionModelName:l}}if(e&&typeof e==="object"&&e.hasOwnProperty("value")){return y.call(this,e.value,e.parsedValue,e.inParameters,e.outParameters,e.bindingContext,e.checkKeyFirst&&e.checkKey,e.checkKey,e.checkDescription,e.conditionModel,e.conditionModelName)}else{return y.call(this,e,t,i,o,n,r&&s,s,a,p,l)}};function y(e,t,i,o,n,r,s,p,l,u){return a.resolve().then(function(){if(s&&p){return _.call(this,true,e,n,i,o,false,l,u,t,true,false)}else if(s){return c.call(this,t,n,i,o,false,l,u,false)}else if(p){return g.call(this,e,n,false,l,u,false)}}.bind(this)).then(function(i){if(i){if(typeof i==="object"){return i}else if(s){return{key:t,description:i}}else{return{key:i,description:e}}}else{return undefined}}).catch(function(e){throw e}).unwrap()}f.prototype.isUsableForValidation=function(){return true};f.prototype.onFieldChange=function(){};f.prototype._setContent=function(e){var t=this.getAggregation("_popover");if(t){t.removeAllContent();t.addContent(e);this._oContent=undefined;if(this._bOpenIfContent){var i=this._getField();if(i){t.openBy(this._getControlForSuggestion())}this._bOpenIfContent=false}}else{this._oContent=e}return this};f.prototype.getIcon=function(){return"sap-icon://slim-arrow-down"};f.prototype.getUIArea=function(){var t=e.prototype.getUIArea.apply(this,arguments);if(!t){if(this._oField){t=this._oField.getUIArea()}}return t};f.prototype.getScrollDelegate=function(){var e=this.getAggregation("_popover");if(e){return e.getScrollDelegate()}else{return undefined}};f.prototype._fireOpen=function(e,t){if(this._bBeforeOpenPending){return false}var i=this._callContentRequest(e,t);if(i){this.fireOpen({suggestion:e})}return i};f.prototype._callContentRequest=function(e,t){if(!this._bNoContentRequest){if(this._oContentRequestPromise){this._oContentRequestPromise.then(function(){this._bNoContentRequest=true;t();this._bNoContentRequest=false}.bind(this));return false}if(!this.bDelegateInitialized&&!this.bDelegateLoading){this.initControlDelegate()}if(this.bDelegateInitialized){var i=this._getContenRequestProperties(e);var o=this.getControlDelegate().contentRequest(this.getPayload(),this,e,i);if(o instanceof Promise){this._oContentRequestPromise=o;o.then(function(){this._oContentRequestPromise=undefined;this._bNoContentRequest=true;t();this._bNoContentRequest=false}.bind(this));return false}}else{this.awaitControlDelegate().then(function(){if(this._callContentRequest(e,t)){t()}}.bind(this));return false}}return true};f.prototype._getContenRequestProperties=function(e){return null};function _(e,t,i,o,n,r,a,p,l,u,h){var f=JSON.stringify(o);var d=i&&i.getPath();if(this._oTextOrKeyPromises[e]&&this._oTextOrKeyPromises[e][t]&&this._oTextOrKeyPromises[e][t][f]&&this._oTextOrKeyPromises[e][t][f][d]){return this._oTextOrKeyPromises[e][t][f][d].promise}var c=function(){v.call(this)}.bind(this);var g=this._callContentRequest(true,c);if(!g){if(!this._oTextOrKeyPromises[e]){this._oTextOrKeyPromises[e]={}}if(!this._oTextOrKeyPromises[e][t]){this._oTextOrKeyPromises[e][t]={}}if(!this._oTextOrKeyPromises[e][t][f]){this._oTextOrKeyPromises[e][t][f]={}}if(!this._oTextOrKeyPromises[e][t][f][d]){this._oTextOrKeyPromises[e][t][f][d]={}}this._oTextOrKeyPromises[e][t][f][d].promise=new Promise(function(c,g){this._oTextOrKeyPromises[e][t][f][d].resolve=c;this._oTextOrKeyPromises[e][t][f][d].reject=g;this._oTextOrKeyPromises[e][t][f][d].key=e;this._oTextOrKeyPromises[e][t][f][d].value=t;this._oTextOrKeyPromises[e][t][f][d].inParameters=o?s({},o):undefined;this._oTextOrKeyPromises[e][t][f][d].outParameters=n?s({},n):undefined;this._oTextOrKeyPromises[e][t][f][d].bindingContext=i;this._oTextOrKeyPromises[e][t][f][d].noRequest=r;this._oTextOrKeyPromises[e][t][f][d].conditionModel=a;this._oTextOrKeyPromises[e][t][f][d].conditionModelName=p;this._oTextOrKeyPromises[e][t][f][d].parsedValue=l;this._oTextOrKeyPromises[e][t][f][d].keyAndDescription=u;this._oTextOrKeyPromises[e][t][f][d].caseSensitive=h}.bind(this));return this._oTextOrKeyPromises[e][t][f][d].promise}return this._getTextOrKey(t,e,i,o,n,r,a,p,l,u,h)}function v(){for(var e in this._oTextOrKeyPromises){for(var t in this._oTextOrKeyPromises[e]){for(var i in this._oTextOrKeyPromises[e][t]){for(var o in this._oTextOrKeyPromises[e][t][i]){m.call(this,this._oTextOrKeyPromises[e][t][i][o]);delete this._oTextOrKeyPromises[e][t][i][o]}}}}}function m(e){var t=e.value;var i=e.key;var o=e.inParameters;var n=e.outParameters;var r=e.bindingContext;var s=e.noRequest;var p=e.resolve;var l=e.reject;var u=e.conditionModel;var h=e.conditionModelName;var f=e.parsedValue;var d=e.keyAndDescription;var c=e.caseSensitive;a.resolve().then(function(){return this._getTextOrKey(t,i,r,o,n,s,u,h,f,d,c)}.bind(this)).then(function(e){p(e)}).catch(function(e){l(e)}).unwrap()}function O(e){this._oOperator=undefined;if(e&&e._getOperators){this._oOperator=t.getEQOperator(e._getOperators())}}f.prototype.isTypeaheadSupported=function(){return this.openByTyping()};f.prototype.shouldOpenOnClick=function(){return this.openByClick()};f.prototype.onControlChange=function(){return this.onFieldChange()};f.prototype.getAriaAttributes=function(e){return{contentId:this.getContentId(),ariaHasPopup:this.getAriaHasPopup(),role:"combobox",roleDescription:this.getRoleDescription(e),valueHelpEnabled:this.getValueHelpEnabled()}};f.prototype.attachEvent=function(t,i,o,n){if(t==="navigated"){return e.prototype.attachEvent.apply(this,["navigate",i,o,n])}else{return e.prototype.attachEvent.apply(this,arguments)}};f.prototype.detachEvent=function(t,i,o){if(t==="navigated"){return e.prototype.detachEvent.apply(this,["navigate",i,o])}else{return e.prototype.detachEvent.apply(this,arguments)}};return f});