/*
 * ! OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/mdc/field/FieldValueHelpTableWrapperBase","sap/ui/model/ChangeReason","sap/base/strings/capitalize","sap/ui/table/library","sap/ui/thirdparty/jquery"],function(e,t,i,a,n){"use strict";var s=a.VisibleRowCountMode;var r=a.SelectionMode;var o=a.SelectionBehavior;var l=e.extend("sap.ui.mdc.field.FieldValueHelpUITableWrapper",{metadata:{library:"sap.ui.mdc",aggregations:{table:{type:"sap.ui.table.Table",multiple:false}},defaultAggregation:"table"}});l.prototype.fieldHelpOpen=function(t){e.prototype.fieldHelpOpen.apply(this,arguments);var i=this._getWrappedTable();if(i&&t){var a=this._getTableItems(true);var n=a&&a[0];this._handleScrolling(n)}return this};l.prototype.getListBinding=function(){var e=this._getWrappedTable();return e&&e.getBinding("rows")};l.prototype.isSuspended=function(){var e=this.getListBinding();if(!e){return true}return e.isSuspended()};var d=function(e){e=e||this._getWrappedTable();var t=e.getPlugins().find(function(e){return e.isA("sap.ui.table.plugins.SelectionPlugin")});return t||e};var h=function(e){if(e){this._handleModelContextChange();return true}};l.prototype._handleTableChanged=function(t,i){if(t==="insert"){this._adjustTable(true);var a=h.call(this,this.getListBinding());this._oObserver.observe(i,{aggregations:["plugins"],bindings:[!a&&"rows"]});var n=d.call(this,i);if(n&&n!==i){n.attachEvent("selectionChange",this._handleSelectionChange,this)}}else{this._oObserver.unobserve(i)}e.prototype._handleTableChanged.call(this,t,i)};l.prototype._observeChanges=function(t,i){if(t.name==="rows"&&t.mutation==="ready"){h.call(this,t.bindingInfo.binding)}if(!i&&t.name==="plugins"&&t.child.isA("sap.ui.table.plugins.SelectionPlugin")){var a=(t.mutation==="insert"?t.child.attachEvent:t.child.detachEvent).bind(t.child);a("selectionChange",this._handleSelectionChange,this)}e.prototype._observeChanges.apply(this,arguments)};l.prototype._handleEvents=function(e){var t=this._getWrappedTable();if(t){var i=(e?t.attachEvent:t.detachEvent).bind(t);i("cellClick",this._handleItemPress,this);i("rowSelectionChange",this._handleSelectionChange,this);i("rowsUpdated",this._handleUpdateFinished,this);i("busyStateChanged",this._handleBusyStateChanged,this);var a=this.getListBinding();if(a){var n=(e?a.attachEvent:a.detachEvent).bind(a);n("change",this._handleUpdateFinished,this)}}};l.prototype._adjustTable=function(t){e.prototype._adjustTable.apply(this,arguments);var i=this._getWrappedTable();var a=this.getParent();if(i){var n=i.getRowMode();if(!n){i.setVisibleRowCountMode(t?s.Fixed:s.Auto);i.setMinAutoRowCount(3)}else if(n.isA("sap.ui.table.rowmodes.AutoRowMode")){n.setMinRowCount(3)}if(a){var l=d.call(this);var h=function(e,t){i.setSelectionBehavior(t);l.setSelectionMode(e)};var p=this._getMaxConditions()===1;var u=p?r.Single:r.MultiToggle;var g=p?o.RowOnly:o.Row;h(u,g)}}};l.prototype._handleSelectionChange=function(e){var t=e.getParameter("userInteraction");if(t||this._bSuggestion&&this._getMaxConditions()!==1){this._fireSelectionChange.call(this,false)}};l.prototype._handleUpdateFinished=function(e){if(!this.getParent()){return}this._updateSelectedItems();if(this._bNavigate){this._bNavigate=false;this.navigate(this._iStep)}if(!e||e.getParameter("reason")!==i(t.Filter)){this.fireDataUpdate({contentChange:false})}};function p(e){var t=d.call(this,e);var i=t.getSelectedIndices();return i.reduce(function(t,i){var a=e.getContextByIndex(i);return a?t.concat(a):t},[])}l.prototype._getTableItems=function(e,t){var i=[];var a=this._getWrappedTable();if(a){if(!t){if(e){i=p.call(this,a)}else{var n=a.getBinding();i=n&&n.getAllCurrentContexts()||[]}}else{i=a.getRows().filter(function(e){var t=e.getBindingContext();return t&&t.getObject()});if(e){i=i.filter(function(e){return p.call(this,a).indexOf(e.getBindingContext())>=0})}}}return i};l.prototype._modifyTableSelection=function(e,t,i,a,n){a=typeof a!=="undefined"?a:e.indexOf(t);if(a>=0){var s=d.call(this);var r=s.getSelectedIndices().indexOf(a)>=0;if(i&&!r){return this._getMaxConditions()===1?s.setSelectedIndex(a):s.addSelectionInterval(a,a)}else if(!i&&r){return s.removeSelectionInterval(a,a)}}};l.prototype._handleTableEvent=function(e){if(!this._bSuggestion){return}var t=n(e.target).control(0);switch(e.type){case"sapprevious":if(t.isA("sap.ui.table.Row")){if(this._getTableItems(false,true).indexOf(t)===0){this.fireNavigate({key:undefined,description:undefined,leave:true});e.preventDefault();e.stopPropagation();e.stopImmediatePropagation(true)}}break;case"sapnext":if(t.isA("sap.ui.table.Column")&&this._getMaxConditions()===1){t=this._getTableItems(false,true)[0];if(t){var i=this._getDataFromItem(t);if(i){this.fireNavigate({key:i.key,description:i.description,inParameters:i.inParameters,outParameters:i.outParameters,itemId:t.getId()});e.preventDefault();e.stopPropagation();e.stopImmediatePropagation(true)}}}break;default:break}};l.prototype._handleScrolling=function(e){var t=this._getWrappedTable();var i=!isNaN(e)&&e;var a=t.getFirstVisibleRow();if(!i&&e){var n=e.isA("sap.ui.table.Row")&&e.getBindingContext();if(!n&&e.isA("sap.ui.model.Context")){n=e}i=this._getTableItems().indexOf(n)}if(typeof i==="undefined"||i<0){i=a-1}if(i>=0&&i!=a){t.setFirstVisibleRow(i);return Promise.resolve()}};l.prototype._handleItemPress=function(e){};return l});