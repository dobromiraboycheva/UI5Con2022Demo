/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/model/SimpleType","sap/ui/model/FormatException","sap/ui/model/ParseException","sap/ui/model/ValidateException","sap/ui/model/type/String","sap/ui/mdc/enum/FieldDisplay","sap/ui/mdc/condition/FilterOperatorUtil","sap/ui/mdc/condition/Operator","sap/ui/mdc/condition/Condition","sap/ui/mdc/enum/BaseType","sap/ui/mdc/enum/ConditionValidated","sap/base/util/merge","sap/base/strings/whitespaceReplacer","sap/ui/base/SyncPromise"],function(e,t,a,i,r,n,o,s,l,u,c,f,d,h){"use strict";var p=e.extend("sap.ui.mdc.field.ConditionType",{constructor:function(t,a){e.apply(this,arguments);this.sName="Condition";this._oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");this._oCalls={active:0,last:0,condition:undefined,exception:undefined}}});p.prototype.destroy=function(){e.prototype.destroy.apply(this,arguments);if(this._oDefaultType){this._oDefaultType.destroy();delete this._oDefaultType}this._bDestroyed=true};p.prototype.formatValue=function(e,a){if(e==undefined||e==null||this._bDestroyed){return null}if(typeof e!=="object"||!e.operator||!e.values||!Array.isArray(e.values)){throw new t("No valid condition provided")}if(!a){a="string"}var i=_.call(this);var r=N(i);var s=this.oFormatOptions.preventGetDescription;E.call(this,e,i);switch(this.getPrimitiveType(a)){case"string":case"any":var l=V.call(this);var u=P.call(this);var d=o.getEQOperator(u);if(!this.oFormatOptions.maxConditions||this.oFormatOptions.maxConditions===1){this._oCalls.active++;this._oCalls.last++}var p=this._oCalls.last;if(!s&&l!==n.Value&&e.validated===c.Validated&&(r||e.operator===d.name&&!e.values[1])){var v=this.oFormatOptions.bindingContext;var g=this.oFormatOptions.conditionModel;var y=this.oFormatOptions.conditionModelName;var O=r?e.values[0][1]:e.values[0];return h.resolve().then(function(){return U.call(this,O,e,v,g,y)}.bind(this)).then(function(t){if(t){e=f({},e);if(r){i=w.call(this);e.operator=d.name;if(typeof t!=="object"){t={key:O,description:t}}}if(typeof t==="object"){e=S.call(this,e,t)}else if(e.values.length===1){e.values.push(t)}else{e.values[1]=t}}return m.call(this,e,undefined,p,true,i)}.bind(this)).catch(function(a){var r;if(!(a instanceof t)||!Q.call(this)){r=a}return m.call(this,e,r,p,true,i)}.bind(this)).unwrap()}return m.call(this,e,undefined,p,true,i);default:if(i&&e.values.length>=1){return i.formatValue(e.values[0],a)}throw new t("Don't know how to format Condition to "+a)}};function v(e,a){var i=V.call(this);var r=N(a);if(r&&e.values.length>1&&e.values[0][1]===e.values[1][1]){e=f({},e);e.operator="EQ";e.values.splice(1)}var s=this.oFormatOptions.hideOperator&&e.values.length===1||r;var l=o.getOperator(e.operator);var c=D.call(this);if(!l){throw new t("No valid condition provided, Operator wrong.")}var h=l.format(e,a,i,s,c);var p=this.oFormatOptions.convertWhitespaces;if(p&&(I.call(this,a)===u.String||i!==n.Value)){h=d(h)}return h}function m(e,t,a,i,r){if(this._oCalls.active>0){this._oCalls.active--}if(a<this._oCalls.last&&(this._oCalls.condition!==undefined||this._oCalls.exception!==undefined)){e=this._oCalls.condition;t=this._oCalls.exception}if(a===this._oCalls.last&&this._oCalls.active>0){this._oCalls.condition=f({},e);this._oCalls.exception=t}else if(this._oCalls.active===0&&this._oCalls.last>0){this._oCalls={active:0,last:0,condition:undefined,exception:undefined}}if(t){throw t}var n;if(i){n=v.call(this,e,r)}else{n=g.call(this,e,r)}return n}p.prototype.parseValue=function(e,t){if(this._bDestroyed){return null}if(!t){t="string"}else if(t==="any"&&typeof e==="string"){t="string"}var i=this.oFormatOptions.navigateCondition;if(i){var r=this.formatValue(i,t);if(r===e){return f({},i)}}var n=V.call(this);var s=k.call(this);var u=_.call(this);var d=F.call(this);var h=P.call(this);var p=N(u);var v;if(e===null||e===undefined||e===""&&!s){if(!x.call(this,u)){return null}}M.call(this,u);switch(this.getPrimitiveType(t)){case"string":var g;var O=false;var C=false;if(h.length===1){g=o.getOperator(h[0]);C=true}else{var w=o.getMatchingOperators(h,e);if(w.length===0){g=R.call(this,h,u);if(s&&!x.call(this,u)){var T=o.getEQOperator(h);if(h.indexOf(T.name)>=0){O=!!g&&g.name!==T.name;g=T}}C=true}else{var b=w.filter(function(e){return e.valueTypes.length===0});if(b.length>=1){g=b[0]}else{g=w[0]}}}if(g){if(p&&g!==o.getEQOperator(h)){throw new a("unsupported operator")}var E;var S=x.call(this,u);var I=D.call(this);this._oCalls.active++;this._oCalls.last++;var Q=this._oCalls.last;if((!S||p)&&g.validateInput&&s){E=y.call(this,g,e,u,C,O,h,n,true);if(E instanceof Promise){return A.call(this,E)}else{return E}}else{try{if(e===""&&S&&C){E=l.createCondition(g.name,[u.parseValue(e,"string",u._aCurrentValue)],undefined,undefined,c.NotValidated)}else{E=g.getCondition(e,u,n,C,I)}}catch(t){var B=t;if(B instanceof a&&d){try{d.parseValue(e,"string",d._aCurrentValue)}catch(e){B=e}}return m.call(this,undefined,B,Q,false,u)}}if(E){return m.call(this,E,undefined,Q,false,u)}}throw new a("Cannot parse value "+e);default:if(u){if(h.length===1){v=h[0]}else{v=R.call(this,h,u).name;if(h.indexOf(v)<0){v=undefined}}if(v){return l.createCondition(v,[u.parseValue(e,t)],undefined,undefined,c.NotValidated)}}throw new a("Don't know how to parse Condition from "+t)}};function g(e,t){var a=N(t);var i=x.call(this,t);if(e&&!a&&i){var r=F.call(this)||t;var n=r.getMetadata().getName();var o=r.getFormatOptions();var s=r.getConstraints();var l=this.oFormatOptions.delegate;var c=this.oFormatOptions.payload;var f=l&&l.getTypeUtil(c).getBaseType(n,o,s);if((f===u.Unit||f===u.DateTime)&&!e.values[0][1]&&t._aCurrentValue){var d=t._aCurrentValue[1]?t._aCurrentValue[1]:null;e.values[0][1]=d;if(e.operator==="BT"){e.values[1][1]=d}}}E.call(this,e,t);return e}function y(e,r,o,u,f,d,p,v){var g;var V;var _=true;var w=true;var F=false;var T;var P;var b=this.oFormatOptions.bindingContext;var x=this.oFormatOptions.conditionModel;var D=this.oFormatOptions.conditionModelName;var E;if(r===""){E=[];g=r;T=r}else{E=e.getValues(r,p,u);g=v?E[0]:E[1];V=v?E[1]:E[0];F=p!==n.Value;w=p===n.Value||p===n.ValueDescription;T=w?g||V:V||g}var M=function(i){if(i&&!(i instanceof a)&&!(i instanceof t)){throw i}if(!i._bNotUnique){if(r===""){return null}if(v&&E[0]&&E[1]){return y.call(this,e,r,o,u,f,d,p,false)}if(f){return O.call(this,o,d,r,p)}}if(Q.call(this)){return C.call(this,o,d,r,p)}throw new a(i.message)};var S=function(t){if(t){var i=[t.key];if(e.valueTypes.length>1&&e.valueTypes[1]!==s.ValueType.Static){i.push(t.description)}return l.createCondition(e.name,i,t.inParameters,t.outParameters,c.Validated,t.payload)}else if(r===""){return null}else{return M.call(this,new a(this._oResourceBundle.getText("valuehelp.VALUE_NOT_EXIST",[r])))}};var A=this._oCalls.last;var I=function(t,i){var n;var s;try{n=i.call(this,t);if(N(o)){if(n){if(n.operator!=="EQ"){throw new a("unsupported operator")}var u=o._aCurrentValue&&o._aCurrentValue[0]!==undefined?o._aCurrentValue[0]:null;var f=n.values[0];n.values=[[u,f]]}else if(r===""){n=l.createCondition(e.name,[o.parseValue(r,"string",o._aCurrentValue)],undefined,undefined,c.NotValidated)}}}catch(e){s=e}return m.call(this,n,s,A,false,o)};try{if(N(o)){P=o.parseValue(T,"string",o._aCurrentValue);o.validateValue(P);P=P[1]}else{P=o.parseValue(T,"string");o.validateValue(P)}}catch(e){if(e&&!(F&&(e instanceof a||e instanceof i))){throw e}_=false;w=false;P=undefined}return h.resolve().then(function(){return B.call(this,T,P,b,w,_,F,x,D)}.bind(this)).then(function(e){return I.call(this,e,S)}.bind(this)).catch(function(e){return I.call(this,e,M)}.bind(this)).unwrap()}function O(e,t,a,i){var r=R.call(this,t,e);var o;if(r&&t.indexOf(r.name)>=0){o=r.getCondition(a,e,n.Value,true);o.validated=c.NotValidated}return o}function C(e,t,i,r){var s;if(N(e)){s=o.getEQOperator("EQ")}else if(t.length===1){s=o.getOperator(t[0])}else{s=o.getEQOperator(t);if(t.indexOf(s.name)<0){s=undefined}}if(!s){throw new a("Cannot parse value "+i)}var l=s.getCondition(i,e,n.Value,true);if(l){l.validated=c.NotValidated;if(N(e)&&Array.isArray(l.values[0])){l.values[0]=l.values[0][1]}}return l}p.prototype.validateValue=function(e){var t=_.call(this);var a=F.call(this);var r=P.call(this);var n=N(t);var s=D.call(this);if(e===undefined||this._bDestroyed){return null}else if(e===null){if(o.onlyEQ(r)){try{if(t.hasOwnProperty("_sParsedEmptyString")&&t._sParsedEmptyString!==null){t.validateValue(t._sParsedEmptyString)}else{t.validateValue(null)}}catch(e){if(e instanceof i){throw e}else{return null}}}return null}if(typeof e!=="object"||!e.operator||!e.values||!Array.isArray(e.values)){throw new i(this._oResourceBundle.getText("field.VALUE_NOT_VALID"))}var l=o.getOperator(e.operator);if(n){l=o.getEQOperator()}if(!l||r.indexOf(l.name)===-1){throw new i("No valid condition provided, Operator wrong.")}try{l.validate(e.values,t,s)}catch(t){if(t instanceof i&&a){l.validate(e.values,a,s)}throw t}};function V(){var e=this.oFormatOptions.display;if(!e){e=n.Value}return e}function _(){var e=this.oFormatOptions.valueType;if(!e){e=w.call(this)}return e}function w(){if(!this._oDefaultType){this._oDefaultType=new r}return this._oDefaultType}function F(){return this.oFormatOptions.originalDateType}function T(){return this.oFormatOptions.additionalType}function P(){var e=this.oFormatOptions.operators;if(!e||e.length===0){e=o.getOperatorsForType(u.String)}return e}function b(){var e=this.oFormatOptions.fieldHelpID;if(e){var t=sap.ui.getCore().byId(e);if(t&&t.isValidationSupported()){return t}}return null}function x(e){return e&&e.isA("sap.ui.model.CompositeType")}function D(){return this.oFormatOptions.compositeTypes}function N(e){if(x(e)){var t=e.getFormatOptions();var a=!t||!t.hasOwnProperty("showMeasure")||t.showMeasure;var i=!t||!t.hasOwnProperty("showNumber")||t.showNumber;var r=!t||!t.hasOwnProperty("showTimezone")||t.showTimezone;var n=!t||!t.hasOwnProperty("showDate")||t.showDate;var o=!t||!t.hasOwnProperty("showTime")||t.showTime;if(a&&!i||r&&!n&&!o){return true}}return false}function E(e,t){if(x.call(this,t)&&e&&e.values[0]){t._aCurrentValue=f([],e.values[0]);var a=T.call(this);if(x.call(this,a)){a._aCurrentValue=f([],e.values[0])}var i=F.call(this);if(x.call(this,i)){i._aCurrentValue=f([],e.values[0])}}}function M(e){if(x.call(this,e)){var t=T.call(this);if(x.call(this,t)){if(!t._aCurrentValue){t._aCurrentValue=[]}e._aCurrentValue=t._aCurrentValue}}}function S(e,t){e.values=[t.key,t.description];if(t.inParameters){e.inParameters=t.inParameters}if(t.outParameters){e.outParameters=t.outParameters}return e}function A(e){if(this.oFormatOptions.asyncParsing){this.oFormatOptions.asyncParsing(e)}return e}function I(e){var t=e.getMetadata().getName();var a=e.getFormatOptions();var i=e.getConstraints();var r=this.oFormatOptions.delegate;var n=this.oFormatOptions.payload;var o=r?r.getTypeUtil(n).getBaseType(t,a,i):u.String;if(o===u.Unit){o=u.Numeric}return o}function k(){var e=b.call(this);var t=this.oFormatOptions.delegate;var a=this.oFormatOptions.payload;if(t){return t.isInputValidationEnabled(a,e)}else{return!!e}}function Q(){var e=b.call(this);var t=this.oFormatOptions.delegate;var a=this.oFormatOptions.payload;if(t){return t.isInvalidInputAllowed(a,e)}else if(e){return!e.getValidateInput()}else{return true}}function B(e,t,i,r,n,o,s,l){var u=b.call(this);var c=this.oFormatOptions.delegate;var f=this.oFormatOptions.payload;var d=this.oFormatOptions.control;var h={value:e,parsedValue:t,inParameters:undefined,outParameters:undefined,bindingContext:i,checkKeyFirst:r,checkKey:n,checkDescription:o,conditionModel:s,conditionModelName:l,exception:a,control:d};if(c){return c.getItemForValue(f,u,h)}else if(u){return u.getItemForValue(h)}}function U(e,a,i,r,n){var o=b.call(this);var s=this.oFormatOptions.delegate;var l=this.oFormatOptions.payload;var u=this.oFormatOptions.control;if(s){return s.getDescription(l,o,e,a.inParameters,a.outParameters,i,r,n,a.payload,u)}else if(o){if(o.isA("sap.ui.mdc.ValueHelp")){var c={value:e,parsedValue:e,context:{inParameters:a.inParameters,outParameters:a.outParameters,payload:a.payload},bindingContext:i,conditionModel:r,conditionModelName:n,checkKey:true,checkDescription:false,caseSensitive:true,exception:t,control:u};return o.getItemForValue(c)}else{return o.getTextForKey(e,a.inParameters,a.outParameters,i,r,n)}}}function R(e,t){var a=this.oFormatOptions.defaultOperatorName;var i;if(a){i=o.getOperator(a)}else{i=o.getDefaultOperator(I.call(this,t))}if(i&&e.indexOf(i.name)<0){for(var r=0;r<e.length;r++){i=o.getOperator(e[r]);if(i.exclude||!i.hasRequiredValues()){i=undefined}else{break}}}return i}return p});