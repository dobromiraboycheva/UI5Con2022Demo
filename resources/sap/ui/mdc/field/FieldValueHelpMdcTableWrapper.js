/*
 * ! OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/mdc/field/FieldValueHelpTableWrapperBase","sap/ui/mdc/util/loadModules","sap/base/util/deepEqual","sap/ui/mdc/library","sap/ui/mdc/enum/PersistenceMode","sap/ui/mdc/p13n/Engine","sap/ui/mdc/condition/FilterConverter","sap/ui/thirdparty/jquery"],function(e,t,r,i,n,a,s,p){"use strict";var l=i.SelectionMode;var o={Table:"sap/ui/mdc/field/FieldValueHelpUITableWrapper",ResponsiveTable:"sap/ui/mdc/field/FieldValueHelpMTableWrapper"};var h=e.extend("sap.ui.mdc.field.FieldValueHelpMdcTableWrapper",{metadata:{library:"sap.ui.mdc",aggregations:{table:{type:"sap.ui.mdc.Table",multiple:false}},defaultAggregation:"table"}});h.prototype.init=function(){e.prototype.init.apply(this,arguments);this.OInnerWrapperClass=null};h.prototype.setParent=function(t,r){if(t){a.getInstance().defaultProviderRegistry.attach(t,n.Transient)}e.prototype.setParent.apply(this,arguments)};h.prototype._getStringType=function(){var e=this.getTable();var t,r=t=e&&e.getType();if(!r){t="Table"}else if(typeof r==="object"){if(r.isA("sap.ui.mdc.table.ResponsiveTableType")){t="ResponsiveTable"}else{t="Table"}}return t};h.prototype.fieldHelpOpen=function(e){var t=this.getTable();if(t){if(this.OInnerWrapperClass){return this.OInnerWrapperClass.prototype.fieldHelpOpen.call(this,e)}}return this};h.prototype.fieldHelpClose=function(){this._bSearchTriggered=false;e.prototype.fieldHelpClose.apply(this,arguments);return this};h.prototype._updateInnerWrapperClass=function(){var e=this._getStringType();var r=o[e];if(r&&this._sInnerWrapperType!==e){this._sInnerWrapperType=e;if(this.OInnerWrapperClass){this.OInnerWrapperClass.prototype.dispose.apply(this);this.OInnerWrapperClass=null}this._oInnerWrapperClassPromise=t(r).then(function(e){this.OInnerWrapperClass=e[0];this.OInnerWrapperClass.prototype.initialize.apply(this)}.bind(this))}};h.prototype._adjustTable=function(e){var t=this.getTable();if(t){var r=this.getParent();if(r){t.setHeight("100%");t.setSelectionMode(this._getMaxConditions()===1?l.Single:l.Multi);var i=this._getFieldHelp();var n=i._getFilterBar();var a=n&&t.getFilter()!==n.getId();if(a){t.setFilter(n)}}if(this.OInnerWrapperClass){this.OInnerWrapperClass.prototype._adjustTable.call(this,e)}}};h.prototype.exit=function(){var t=this.getParent();if(t){a.getInstance().defaultProviderRegistry.detach(t)}this._oCurrentConditions=null;this._bSuggestion=null;if(this._oInnerWrapperClassPromise){this._oInnerWrapperClassPromise=null}if(this.OInnerWrapperClass){this.OInnerWrapperClass.prototype.dispose.apply(this);this.OInnerWrapperClass=null}this._sInnerWrapperType=null;this._bSearchTriggered=null;e.prototype.exit.apply(this,arguments)};h.prototype.isSuspended=function(){var e=this.getTable();var t=this.getListBinding();return t?t.isSuspended():e&&!e.getAutoBindOnInit()};h.prototype.getListBinding=function(){var e=this.getTable();return e&&e.getRowBinding()};var d={onmouseover:function(e){var t=p(e.target).control(0);if(t&&t.isA("sap.m.ColumnListItem")){t.setType("Active")}}};var u=function(e,t){if(t){e.addDelegate(d,true,this);return}e.removeDelegate(d)};h.prototype._handleTableChanged=function(e,t){var r;if(e==="insert"){this._updateInnerWrapperClass();u.call(this,t,true);r=this._getWrappedTable();if(r){this._handleInnerTableChanged("insert",r)}this._oObserver.observe(t,{aggregations:["_content"]})}else{u.call(this,t);r=t._oTable;if(r){this._handleInnerTableChanged(e,r)}this._oObserver.unobserve(t)}};h.prototype._handleToolbarExtensions=function(e){if(e.mAggregations["extension"]&&e.mAggregations["extension"].length){e.getAggregation("extension").forEach(function(e){e.setVisible(false)})}if(e.mAggregations["headerToolbar"]){var t=e.getAggregation("headerToolbar");t.setVisible(false)}};h.prototype._handleInnerTableChanged=function(e,t){if(e==="insert"){this._updateInnerWrapperClass();this._handleToolbarExtensions(t);this._oObserver.observe(t,{bindings:["rows"]})}this._oInnerWrapperClassPromise.then(function(){this.OInnerWrapperClass.prototype._handleTableChanged.call(this,e,t);this.getTable().initialized().then(function(){this.fireDataUpdate({contentChange:true})}.bind(this))}.bind(this))};h.prototype.applyFilters=function(e,t,i){var n=this.getTable();if(n&&i){var a=this.getListBinding();var p=a&&a.isSuspended();var l=this._getFieldHelp();if(a&&!p&&!this._bSearchTriggered){var o=i.getSearch()||"";var h=a.mParameters.$search||"";var d=i.getConditions();var u=l._getTypesForConditions(d);var g=d&&u&&s.createFilters(d,u,undefined,l.getCaseSensitive());var f=g?[].concat(g):[];var c=a.aApplicationFilters.reduce(function(e,t){return e.concat(t._bMultiFilter?t.aFilters:t)},[]);var y=!r(f,c);var b=o!==h;var _=n._oTable&&n._oTable.getShowOverlay&&n._oTable.getShowOverlay();if(y||b||_){this._handleScrolling();i.triggerSearch();this._bSearchTriggered=true}}if(p){a.resume()}if(!a&&n.getAutoBindOnInit()){this._oTablePromise.then(function(){if(!this._bIsBeingDestroyed){this.applyFilters(e,t,i)}}.bind(this))}}};h.prototype._observeChanges=function(t,r){if(t.name==="_content"){this._handleInnerTableChanged(t.mutation,t.child)}if(this.OInnerWrapperClass){this.OInnerWrapperClass.prototype._observeChanges.call(this,t,true)}else{e.prototype._observeChanges.call(this,t,true)}};h.prototype._handleUpdateFinished=function(e){this._bSearchTriggered=false;return this.OInnerWrapperClass.prototype._handleUpdateFinished.apply(this,arguments)};h.prototype._handleEvents=function(e){if(this.OInnerWrapperClass){return this.OInnerWrapperClass.prototype._handleEvents.apply(this,arguments)}};h.prototype._handleItemPress=function(e){return this.OInnerWrapperClass.prototype._handleItemPress.apply(this,arguments)};h.prototype._handleSelectionChange=function(e){var t=this._isTableReady();return this._iRunningTableSelectionUpdates||!t||this._bBusy?undefined:this._fireSelectionChange.call(this,false)};h.prototype._getTableItems=function(e,t){return this.OInnerWrapperClass.prototype._getTableItems.apply(this,arguments)};h.prototype._modifyTableSelection=function(e,t,r,i){return this.OInnerWrapperClass.prototype._modifyTableSelection.apply(this,arguments)};h.prototype._getDataFromItem=function(e,t,r){return this.OInnerWrapperClass.prototype._getDataFromItem.apply(this,arguments)};h.prototype._handleTableEvent=function(e){return this.OInnerWrapperClass.prototype._handleTableEvent.apply(this,arguments)};h.prototype._isTableReady=function(){var t=this._getWrappedTable();if(t&&t._bInvalid){return false}return e.prototype._isTableReady.apply(this,arguments)};h.prototype._getWrappedTable=function(){var e=this.getTable();return e&&e._oTable};h.prototype._handleScrolling=function(){return this.OInnerWrapperClass.prototype._handleScrolling.apply(this,arguments)};h.prototype.getDialogContent=function(){if(this.OInnerWrapperClass){return this.OInnerWrapperClass.prototype.getDialogContent.apply(this,arguments)}};h.prototype.initialize=function(){if(this.OInnerWrapperClass){return this.OInnerWrapperClass.prototype.initialize.apply(this,arguments)}};h.prototype.getSuggestionContent=function(){return this.getTable()};return h});