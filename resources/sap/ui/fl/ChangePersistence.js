/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_union","sap/base/util/includes","sap/base/util/merge","sap/base/util/UriParameters","sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Component","sap/ui/fl/apply/_internal/changes/Applier","sap/ui/fl/apply/_internal/changes/Utils","sap/ui/fl/apply/_internal/flexState/changes/DependencyHandler","sap/ui/fl/apply/_internal/flexState/controlVariants/VariantManagementState","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/initial/_internal/StorageUtils","sap/ui/fl/registry/Settings","sap/ui/fl/write/_internal/condenser/Condenser","sap/ui/fl/write/_internal/Storage","sap/ui/fl/write/api/Version","sap/ui/fl/Cache","sap/ui/fl/Change","sap/ui/fl/LayerUtils","sap/ui/fl/Layer","sap/ui/fl/Utils","sap/ui/fl/Variant","sap/ui/model/json/JSONModel","sap/ui/performance/Measurement"],function(e,t,n,a,r,i,s,o,h,g,c,l,p,u,f,d,C,m,y,_,v,D,S,b,E){"use strict";var M=function(e){this._mComponent=e;this._mChanges=g.createEmptyDependencyMap();this._bChangesMapCreated=false;this._mChangesInitial=n({},this._mChanges);if(!this._mComponent||!this._mComponent.name){r.error("The Control does not belong to an SAPUI5 component. Personalization and changes for this control might not work as expected.");throw new Error("Missing component name.")}this._aDirtyChanges=[];this._oMessagebundle=undefined;this._mChangesEntries={};this._bHasChangesOverMaxLayer=false;this.HIGHER_LAYER_CHANGES_EXIST="higher_layer_changes_exist"};function I(e,t){var n;if(t instanceof y){n=t;this._mChangesEntries[n.getFileName()]=n}else{if(!this._mChangesEntries[t.fileName]){this._mChangesEntries[t.fileName]=new y(t)}n=this._mChangesEntries[t.fileName];n.setState(y.states.PERSISTED)}return n}M.prototype.getComponentName=function(){return this._mComponent.name};M.prototype.getCacheKey=function(e){return m.getCacheKey(this._mComponent,e)};function L(e){var t=e instanceof y?e.getDefinition():e;var n=false;if(t.fileType==="ctrl_variant"||t.fileType==="ctrl_variant_change"||t.fileType==="ctrl_variant_management_change"){n=t.variantManagementReference||t.variantReference||t.selector&&t.selector.id}return t.fileType==="change"||n}M.prototype.getChangesForComponent=function(e,t){return D.getUShellService("URLParsing").then(function(n){this._oUShellURLParsingService=n;return m.getChangesFillingCache(this._mComponent,e,t)}.bind(this)).then(function(e,t){var a=n({},t);var r=e&&e.component&&D.getAppComponentForControl(e.component);var i=p.isStorageResponseFilled(a.changes);if(!i){return[]}var s=a.changes.changes;if(!this._oMessagebundle&&a.messagebundle&&r){if(!r.getModel("i18nFlexVendor")){if(s.some(function(e){return e.layer===v.VENDOR})){this._oMessagebundle=a.messagebundle;var o=new b(this._oMessagebundle);r.setModel(o,"i18nFlexVendor")}}}var h=e&&e.currentLayer;var g=!(e&&e.ignoreMaxLayerParameter);var c=function(){return true};if(h){s=_.filterChangeOrChangeDefinitionsByCurrentLayer(s,h)}else if(_.isLayerFilteringRequired(this._oUShellURLParsingService)&&g){c=F.bind(this);s=s.filter(c)}else if(this._bHasChangesOverMaxLayer&&!g){this._bHasChangesOverMaxLayer=false;return this.HIGHER_LAYER_CHANGES_EXIST}var l=a.changes&&e&&e.includeCtrlVariants;var u=this._getAllCtrlVariantChanges(a,l,c);s=s.concat(u);return this._checkAndGetChangeInstances(s,a)}.bind(this,e))};M.prototype._checkAndGetChangeInstances=function(e,t){return e.filter(L).map(I.bind(this,t))};function F(e){if(_.isOverMaxLayer(O(e),this._oUShellURLParsingService)){if(!this._bHasChangesOverMaxLayer){this._bHasChangesOverMaxLayer=true}return false}return true}function O(e){var t;if(e instanceof S||e instanceof y){t=e.getLayer()}else{t=e.layer}return t}M.prototype._getAllCtrlVariantChanges=function(e,t,n){if(!t){return c.getInitialChanges({reference:this._mComponent.name})}return["variants","variantChanges","variantDependentControlChanges","variantManagementChanges"].reduce(function(t,n){if(e.changes[n]){return t.concat(e.changes[n])}return t},[]).filter(n)};M.prototype.loadChangesMapForComponent=function(e){return this.getChangesForComponent({component:e}).then(t.bind(this));function t(t){E.start("fl.createDependencyMap","Measurement of creating initial dependency map");this._mChanges=g.createEmptyDependencyMap();t.forEach(this.addChangeAndUpdateDependencies.bind(this,e));this._mChangesInitial=n({},this._mChanges);E.end("fl.createDependencyMap","Measurement of creating initial dependency map");this._bChangesMapCreated=true;return this.getChangesMapForComponent.bind(this)}};M.prototype.checkForOpenDependenciesForControl=function(e,t){return g.checkForOpenDependenciesForControl(this._mChanges,i.getControlIdBySelector(e,t),t)};function x(e){var t=n({},this._mChangesInitial.mDependencies);return t[e.getId()]}function U(e,n,a,r){var s;var o=[];e.controlsDependencies.forEach(function(e){if(!i.bySelector(e,a)){s=i.getControlIdBySelector(e,a);o.push(e);this._mChanges.mControlsWithDependencies[s]=this._mChanges.mControlsWithDependencies[s]||[];if(!t(this._mChanges.mControlsWithDependencies[s],r.getId())){this._mChanges.mControlsWithDependencies[s].push(r.getId())}}}.bind(this));e.dependencies=n;e.controlsDependencies=o;if(n.length||o.length){this._mChanges.mDependencies[r.getId()]=e}}M.prototype.copyDependenciesFromInitialChangesMapSync=function(e,t,n){var a=x.call(this,e);if(a){var r=[];a.dependencies.forEach(function(n){if(t(n)){this._mChanges.mDependentChangesOnMe[n]=this._mChanges.mDependentChangesOnMe[n]||[];this._mChanges.mDependentChangesOnMe[n].push(e.getId());r.push(n)}}.bind(this));U.call(this,a,r,n,e)}return this._mChanges};M.prototype.copyDependenciesFromInitialChangesMap=function(e,t,n){var a=x.call(this,e);if(a){var r=[];return a.dependencies.reduce(function(n,a){return n.then(function(){return t(a)}).then(function(t){if(t){this._mChanges.mDependentChangesOnMe[a]=this._mChanges.mDependentChangesOnMe[a]||[];this._mChanges.mDependentChangesOnMe[a].push(e.getId());r.push(a)}}.bind(this))}.bind(this),Promise.resolve()).then(function(){U.call(this,a,r,n,e);return this._mChanges}.bind(this))}return Promise.resolve(this._mChanges)};M.prototype.addChangeAndUpdateDependencies=function(e,t,n){t.setInitialApplyState();if(n){g.insertChange(t,this._mChanges,n)}g.addChangeAndUpdateDependencies(t,e,this._mChanges)};M.prototype._addRunTimeCreatedChangeAndUpdateDependencies=function(e,t){g.addRuntimeChangeAndUpdateDependencies(t,e,this._mChanges,this._mChangesInitial)};M.prototype.getChangesMapForComponent=function(){return this._mChanges};M.prototype.getAllUIChanges=function(t){var n=e(this.getChangesMapForComponent().aChanges,t.includeDirtyChanges&&this.getDirtyChanges()).filter(function(e){return Boolean(e)&&e.getFileType()==="change"&&_.compareAgainstCurrentLayer(e.getLayer(),t.layer)===0});return n};M.prototype.isChangeMapCreated=function(){return this._bChangesMapCreated};M.prototype.getChangesForView=function(e){return this.getChangesForComponent(e).then(function(t){return t.filter(h.filterChangeByView.bind(undefined,e))})};M.prototype.addChange=function(e,t){var n=this.addDirtyChange(e);this._addRunTimeCreatedChangeAndUpdateDependencies(t,n);this._mChangesEntries[n.getFileName()]=n;this._addPropagationListener(t);return n};M.prototype.addDirtyChange=function(e){var t;if(e instanceof y||e instanceof S){t=e}else{t=new y(e)}if(this._aDirtyChanges.indexOf(t)===-1){this._aDirtyChanges.push(t)}return t};M.prototype._addPropagationListener=function(e){var t=D.getAppComponentForControl(e);if(t instanceof s){var n=function(e){return!e._bIsSapUiFlFlexControllerApplyChangesOnControl};var a=t.getPropagationListeners().every(n);if(a){var r=sap.ui.require("sap/ui/fl/FlexControllerFactory");var i=r.create(this.getComponentName());var h=o.applyAllChangesForControl.bind(o,this.getChangesMapForComponent.bind(this),t,i);h._bIsSapUiFlFlexControllerApplyChangesOnControl=true;t.addPropagationListener(h)}}};M.prototype._deleteNotSavedChanges=function(e,t,n){e.filter(function(e){return!t.some(function(t){return e.getId()===t.getId()})}).forEach(function(e){if(n){this.removeChange(e);m.deleteChange(this._mComponent,e.getDefinition())}else{this.deleteChange(e)}}.bind(this))};function A(e,t){var n=e.map(function(e){return e[t]()});var a=n.filter(function(e,t,n){return n.indexOf(e)===t});return a.length===1}function R(e,t){var n=false;if(!e||t.length<2||!A(t,"getLayer")){return false}var r=t[0].getLayer();if([v.CUSTOMER,v.USER].includes(r)){n=true}var i=a.fromURL(window.location.href);if(i.has("sap-ui-xx-condense-changes")){n=i.get("sap-ui-xx-condense-changes")==="true"}return n}function N(e){var t=u.getInstanceOrUndef()&&u.getInstanceOrUndef().isCondensingEnabled();if(t&&!A(e,"getNamespace")){t=false}return t}function T(e,t,n,a){this._massUpdateCacheAndDirtyState(t,n);this._deleteNotSavedChanges(e,t,a)}function P(e,t){if(!e.length){return[]}var n=e[0].getLayer();var a=this._mChanges.aChanges.filter(function(e){if(n===v.CUSTOMER&&t){return e.getState()===y.states.PERSISTED&&t.includes(e.getFileName())}return e.getState()===y.states.PERSISTED&&_.compareAgainstCurrentLayer(e.getLayer(),n)===0});return a.concat(e)}M.prototype.saveDirtyChanges=function(e,t,n,a,r){var i=n||this._aDirtyChanges;var s=P.call(this,i,r);var o=N(s)&&R(e,s);var h=o?s:i;var g=h.slice(0);var c=i.slice(0);var l=w(i);var p=H(i);if(p.length===1&&l.length===1&&p[0]===y.states.NEW){var u=Promise.resolve(g);if(R(e,g)){u=f.condense(e,g)}return u.then(function(e){var n=l[0];var r=i[0].getDefinition().layer;if(o){return d.condense({allChanges:h,condensedChanges:e,layer:r,transport:n,isLegacyVariant:false,parentVersion:a}).then(function(n){T.call(this,h,e,t,true);return n}.bind(this))}if(e.length){return d.write({layer:r,flexObjects:k(e),transport:n,isLegacyVariant:false,parentVersion:a}).then(function(n){T.call(this,h,e,t);return n}.bind(this))}this._deleteNotSavedChanges(h,e)}.bind(this))}return this.saveSequenceOfDirtyChanges(c,t,a)};M.prototype.saveSequenceOfDirtyChanges=function(e,t,n){var a;if(n){var r=e.filter(function(e){return e.getState()===y.states.NEW});a=[].concat(r).shift()}return e.reduce(function(e,r){return e.then(V.bind(undefined,r,a,n)).then(this._updateCacheAndDirtyState.bind(this,r,t))}.bind(this),Promise.resolve())};function V(e,t,n){switch(e.getState()){case y.states.NEW:if(n!==undefined){n=e===t?n:C.Number.Draft}return d.write({layer:e.getLayer(),flexObjects:[e.getDefinition()],transport:e.getRequest(),parentVersion:n});case y.states.DELETED:return d.remove({flexObject:e.getDefinition(),layer:e.getLayer(),transport:e.getRequest(),parentVersion:n});default:}}M.prototype._updateCacheAndDirtyState=function(e,t){this._aDirtyChanges=this._aDirtyChanges.filter(function(t){return e.getId()!==t.getId()});if(!t){if(D.isChangeRelatedToVariants(e)){c.updateVariantsState({reference:this._mComponent.name,changeToBeAddedOrDeleted:e})}else{switch(e.getState()){case y.states.NEW:e.setState(y.states.PERSISTED);m.addChange(this._mComponent,e.getDefinition());break;case y.states.DELETED:m.deleteChange(this._mComponent,e.getDefinition());break;case y.states.DIRTY:e.setState(y.states.PERSISTED);m.updateChange(this._mComponent,e.getDefinition());break}}}};M.prototype._massUpdateCacheAndDirtyState=function(e,t){e.forEach(function(e){this._updateCacheAndDirtyState(e,t)},this)};function w(e){var t=[];e.forEach(function(e){var n=e.getRequest();if(t.indexOf(n)===-1){t.push(n)}});return t}function H(e){var t=[];e.forEach(function(e){var n=e.getState();if(t.indexOf(n)===-1){t.push(n)}});return t}function k(e){var t=[];e.forEach(function(e){t.push(e.getDefinition())});return t}M.prototype.getDirtyChanges=function(){return this._aDirtyChanges};M.prototype.deleteChange=function(e,t){var n=this._aDirtyChanges.indexOf(e);if(n>-1){if(e.getState()===y.states.DELETED){return}this._aDirtyChanges.splice(n,1);this._deleteChangeInMap(e,t);return}e.markForDeletion();this.addDirtyChange(e);this._deleteChangeInMap(e,t)};M.prototype.removeChange=function(e){var t=this._aDirtyChanges.indexOf(e);if(t>-1){this._aDirtyChanges.splice(t,1)}this._deleteChangeInMap(e)};M.prototype._deleteChangeInMap=function(e,t){var n=e.getId();g.removeChangeFromMap(this._mChanges,n);g.removeChangeFromDependencies(t?this._mChangesInitial:this._mChanges,n)};function q(e,t){return(t.getRequest()==="$TMP"||t.getRequest()==="")&&t.getLayer()===e}function B(e,t){return t.getState()===y.states.PERSISTED&&t.getLayer()===e}function W(){var e=[];var t=l.getCompVariantsMap(this.getComponentName());for(var n in t){for(var a in t[n].byId){e.push(t[n].byId[a])}}return e}M.prototype.transportAllUIChanges=function(e,t,n,a){return this.getChangesForComponent({currentLayer:n,includeCtrlVariants:true}).then(function(r){var i=W.call(this);r=r.concat(i.filter(q.bind(this,n)));return d.publish({transportDialogSettings:{rootControl:e,styleClass:t},layer:n,reference:this.getComponentName(),localChanges:r,appVariantDescriptors:a})}.bind(this))};M.prototype._getChangesFromMapByNames=function(e){return this._mChanges.aChanges.filter(function(t){return e.indexOf(t.getFileName())!==-1})};M.prototype.removeDirtyChanges=function(e,t,n,a,r){var s=[].concat(e||[]);var o=this._aDirtyChanges;var h=o.filter(function(e){var o=true;if(s.length&&!s.includes(e.getLayer())){return false}if(a&&e.getDefinition().support.generator!==a){return false}if(n){var h=e.getSelector();o=n.getId()===i.getControlIdBySelector(h,t)}if(r){o=o&&r.indexOf(e.getChangeType())!==-1}return o});h.forEach(function(e){var t=o.indexOf(e);o.splice(t,1)});return Promise.resolve(h)};M.prototype.resetChanges=function(e,t,n,a){var r=n&&n.length>0;var i=a&&a.length>0;var s=u.getInstanceOrUndef()&&u.getInstanceOrUndef().isPublicLayerAvailable();var o=t===undefined&&n===undefined&&a===undefined;var h=[];if(s&&o){h=W.call(this).filter(B.bind(this,e))}return this.getChangesForComponent({currentLayer:e,includeCtrlVariants:true}).then(function(s){s=s.concat(h);var o={reference:this.getComponentName(),layer:e,changes:s};if(t){o.generator=t}if(r){o.selectorIds=n}if(i){o.changeTypes=a}return d.reset(o)}.bind(this)).then(function(e){var t=[];if(n||a){var r=[];if(e&&e.response&&e.response.length>0){e.response.forEach(function(e){r.push(e.fileName)})}m.removeChanges(this._mComponent,r);t=this._getChangesFromMapByNames(r)}return t}.bind(this))};return M});