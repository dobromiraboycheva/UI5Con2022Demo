/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/changeHandler/condenser/Classification","sap/ui/fl/changeHandler/Base","sap/ui/fl/apply/api/DelegateMediatorAPI","sap/base/util/merge","sap/base/util/ObjectPath"],function(e,t,n,r,o){"use strict";function i(e){return typeof e==="function"}function a(e){if(e.modelType){return e.modelType}else if(e.oDataServiceVersion){return"sap.ui.model.odata.v2.ODataModel"}}var l={createAddViaDelegateChangeHandler:function(l){function c(e){return e+l.fieldSuffix}function d(e,t){if(i(l[t])){return!!l[t]({changeDefinition:e})}return!!l[t]}function u(e){return d(e,"skipCreateLabel")}function f(e){return d(e,"skipCreateLayout")}function g(e,t){var r=t.modifier.bySelector(e.getSelector(),t.appComponent);var o=a(e.getDefinition().content);return n.getDelegateForControl({control:r,modifier:t.modifier,modelType:o,supportsDefault:l.supportsDefault}).then(function(t){var n=!i(t.instance.createLayout);return n||f(e.getDefinition())})}function p(e,t,n){var o=r({},t);o.fieldSelector.id=c(o.fieldSelector.id);return n.createControlForProperty(o).then(function(r){if(u(e)){return r}var o=t.modifier.getId(r.control);t.labelFor=o;return n.createLabel(t).then(function(e){return{label:e,control:r.control,valueHelp:r.valueHelp}})})}function s(e,t,n){var a=r({aggregationName:l.aggregationName,payload:t.payload||{},parentSelector:e.content.parentId},n);var c=t.instance;return Promise.resolve().then(function(){if(i(c.createLayout)&&!f(e)){return c.createLayout(a)}}).then(function(t){if(o.get("control",t)){t.layoutControl=true;return t}return p(e,a,c)})}return{applyChange:function(e,o,i){var c=e.getDefinition();var d=i.appComponent;var u=c.content;var f=u.newFieldSelector;var g={appComponent:i.appComponent,view:i.view,fieldSelector:f,bindingPath:u.bindingPath,modifier:i.modifier,element:o};if(i.modifier.bySelector(f,d,i.view)){return t.markAsNotApplicable("Control to be created already exists:"+(f.id||f),true)}var p={newFieldSelector:f};e.setRevertData(p);var v=a(u);return n.getDelegateForControl({control:o,modifier:i.modifier,modelType:v,supportsDefault:l.supportsDefault}).then(function(e){return s(c,e,g)}).then(function(t){var n=r({},{control:o,innerControls:t,change:e},i);return Promise.resolve().then(function(){return l.addProperty(n)}).then(function(){if(t.valueHelp){var e=i.modifier.getSelector(i.modifier.getId(t.valueHelp),d);p.valueHelpSelector=e}})})},revertChange:function(e,t,n){var o=n.appComponent;var a=n.modifier;var c=e.getRevertData().newFieldSelector;var d=e.getRevertData().valueHelpSelector;var u=a.bySelector(c,o);var f=e.getDependentControl(l.parentAlias,n)||t;return Promise.resolve().then(a.removeAggregation.bind(a,f,l.aggregationName,u)).then(a.destroy.bind(a,u)).then(function(){if(d){var e=a.bySelector(d,o);return Promise.resolve().then(a.removeAggregation.bind(a,f,"dependents",e)).then(a.destroy.bind(a,e))}}).then(function(){var o=r({},{control:t,change:e},n);if(i(l.revertAdditionalControls)){return Promise.resolve().then(function(){return l.revertAdditionalControls(o)}).then(function(){e.resetRevertData()})}})},completeChangeContent:function(e,t,n){var r=n.appComponent;var o=e.getDefinition();if(!o.content){o.content={}}if(t.parentId){if(i(l.mapParentIdIntoChange)){l.mapParentIdIntoChange(e,t,n)}else{e.addDependentControl(t.parentId,l.parentAlias,n)}try{o.content.parentId=n.modifier.getSelector(t.parentId,r)}catch(e){}}else{throw new Error("mSpecificChangeInfo.parentId attribute required")}if(t.bindingPath){o.content.bindingPath=t.bindingPath}else{throw new Error("mSpecificChangeInfo.bindingPath attribute required")}if(t.newControlId){o.content.newFieldSelector=n.modifier.getSelector(t.newControlId,r)}else{throw new Error("mSpecificChangeInfo.newControlId attribute required")}if(t.index===undefined){throw new Error("mSpecificChangeInfo.targetIndex attribute required")}else{o.content.newFieldIndex=t.index}if(t.oDataServiceVersion){o.content.oDataServiceVersion=t.oDataServiceVersion}if(t.modelType&&l.supportsDefault){o.content.modelType=t.modelType}},getChangeVisualizationInfo:function(e){var t=e.getRevertData();if(t&&t.labelSelector){return{affectedControls:[t.labelSelector]}}return{affectedControls:[e.getContent().newFieldSelector]}},getCondenserInfo:function(t,n){return g(t,n).then(function(n){if(!n){return undefined}if(!t.getContent().newFieldSelector||!t.getContent().parentId||!l.aggregationName){return undefined}return{affectedControl:t.getContent().newFieldSelector,classification:e.Create,targetContainer:t.getContent().parentId,targetAggregation:l.aggregationName,setTargetIndex:function(e,t){e.getContent().newFieldIndex=t},getTargetIndex:function(e){return e.getContent().newFieldIndex}}})}}}};return l});