/*
 * ! OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/initial/_internal/StorageUtils","sap/ui/fl/write/_internal/StorageFeaturesMerger","sap/ui/fl/apply/_internal/flexObjects/States","sap/base/util/ObjectPath"],function(e,n,t,r){"use strict";var i="sap/ui/fl/write/_internal/connectors/";function a(){return e.getConnectors(i,false)}function o(e,n){var t=n.filter(function(n){return n.layers.indexOf("ALL")!==-1||n.layers.indexOf(e)!==-1});if(t.length===1){return t[0]}if(t.length===0){throw new Error("No Connector configuration could be found to write into layer: "+e)}if(t.length>1){throw new Error("sap.ui.core.Configuration 'flexibilityServices' has a misconfiguration: Multiple Connector configurations were found to write into layer: "+e)}}function u(n){var t=n.map(function(n){return n.writeConnectorModule.loadFeatures({url:n.url}).then(function(e){return{features:e,layers:n.layers}}).catch(e.logAndResolveDefault.bind(null,{features:{},layers:n.layers},n,"loadFeatures"))});return Promise.all(t)}function s(e){if(!e){return Promise.reject("No layer was provided")}return a().then(o.bind(this,e))}function l(e){if(e.draft){return new Promise(function(n,t){sap.ui.require(["sap/ui/fl/write/api/FeaturesAPI"],function(r){r.isVersioningEnabled(e.layer).then(function(r){if(r){n()}else{t("Draft is not supported for the given layer: "+e.layer)}})})})}return Promise.resolve()}function c(e){var n;if(e.allChanges&&e.allChanges.length&&e.condensedChanges){n={namespace:e.allChanges[0].getDefinition().namespace,layer:e.layer,delete:{change:[]},update:{change:[]},reorder:{change:[]},create:{change:[],ctrl_variant_change:[],ctrl_variant_management_change:[]}};var r=0;var i=false;e.allChanges.forEach(function(a,o){if(a.getFileType()==="ctrl_variant"){return}var u=n.create[a.getFileType()].length;if(a.condenserState){var s=false;if(a.condenserState==="delete"){if(a.getState()===t.PERSISTED){n.delete.change.push(a.getFileName())}r++}else if(e.condensedChanges.length){s=e.allChanges[o].getFileName()!==e.condensedChanges[o-r].getFileName()}if((a.condenserState==="select"||a.condenserState==="update")&&s&&!i){var l=e.condensedChanges.slice(o-r).map(function(e){return e.getFileName()});n.reorder.change=l;i=true}if(a.condenserState==="select"&&a.getState()===t.NEW){n.create.change[u]={};n.create.change[u][a.getFileName()]=a.getDefinition()}else if(a.condenserState==="update"){var c=n.update.change.length;n.update.change[c]={};n.update.change[c][a.getFileName()]={content:a.getContent()}}delete a.condenserState}else if(a.getState()===t.NEW){n.create[a.getFileType()][u]={};n.create[a.getFileType()][u][a.getId()]=a.getDefinition()}})}return n}function f(e,n){return l(n).then(s.bind(undefined,n.layer)).then(function(t){n.url=t.url;var i=r.get(e,t.writeConnectorModule);return i.call(t.writeConnectorModule,n)})}var d={};d.write=function(e){return f("write",e)};d.condense=function(e){e.flexObjects=c(e);if(!e.flexObjects){return Promise.reject("No changes were provided")}return f("condense",e)};d.remove=function(e){return f("remove",e)};d.update=function(e){return f("update",e)};d.reset=function(e){return f("reset",e)};d.getFlexInfo=function(e){return f("getFlexInfo",e)};d.getContexts=function(e){return f("getContexts",e)};d.loadContextDescriptions=function(e){return f("loadContextDescriptions",e)};d.isContextSharingEnabled=function(e){return f("isContextSharingEnabled",e)};d.loadFeatures=function(){return a().then(u).then(n.mergeResults)};d.publish=function(e){return f("publish",e)};d.versions={load:function(e){return a().then(f.bind(undefined,"versions.load",e))},activate:function(e){return a().then(f.bind(undefined,"versions.activate",e))},discardDraft:function(e){return a().then(f.bind(undefined,"versions.discardDraft",e))},publish:function(e){return a().then(f.bind(undefined,"versions.publish",e))}};d.translation={getSourceLanguages:function(e){return a().then(f.bind(undefined,"translation.getSourceLanguages",e))},getTexts:function(e){return a().then(f.bind(undefined,"translation.getTexts",e))},postTranslationTexts:function(e){return a().then(f.bind(undefined,"translation.postTranslationTexts",e))}};return d});