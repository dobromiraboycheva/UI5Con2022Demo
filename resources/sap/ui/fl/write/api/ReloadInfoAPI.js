/*
 * ! OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/LayerUtils","sap/ui/fl/Layer","sap/ui/fl/Utils","sap/ui/fl/write/api/Version","sap/ui/fl/apply/_internal/flexState/ManifestUtils","sap/ui/fl/write/api/VersionsAPI","sap/ui/fl/write/api/FeaturesAPI","sap/ui/fl/write/api/PersistenceWriteAPI","sap/base/util/UriParameters"],function(e,r,a,t,i,s,n,l){"use strict";function o(e){var r=!!a.getParameter(t.UrlParameter,e.URLParsingService);if(r){return Promise.resolve(false)}return n.isVersioningEnabled(e.layer).then(function(r){return r&&s.isDraftAvailable({control:e.selector,layer:e.layer})})}function u(e){var a=this.hasMaxLayerParameterWithValue({value:e.layer},e.URLParsingService);var t=e.layer===r.USER;if(t||a){return Promise.resolve(false)}return l.hasHigherLayerChanges({selector:e.selector,ignoreMaxLayerParameter:e.ignoreMaxLayerParameter,upToLayer:e.layer,includeCtrlVariants:e.includeCtrlVariants,includeDirtyChanges:true})}function f(e){var r=c(e.selector);if(r!==null){return false}var a={selector:e.selector,layer:e.layer};return l.getResetAndPublishInfo(a).then(function(r){v(r,e.selector);return!r.allContextsProvided})}function c(e){var r=i.getFlexReferenceForControl(e);var a=r||"true";var t=JSON.parse(window.sessionStorage.getItem("sap.ui.fl.info."+a));return t&&!t.allContextsProvided}function v(e,r){var a=i.getFlexReferenceForControl(r);var t=a||"true";window.sessionStorage.setItem("sap.ui.fl.info."+t,JSON.stringify(e))}var h={getReloadReasonsForStart:function(e){return Promise.all([u.call(this,e),o(e),f(e)]).then(function(r){e.hasHigherLayerChanges=r[0];e.isDraftAvailable=r[1];e.allContexts=r[2];return e})},removeInfoSessionStorage:function(e){var r=i.getFlexReferenceForControl(e);var a=r||"true";window.sessionStorage.removeItem("sap.ui.fl.info."+a)},hasVersionParameterWithValue:function(e,r){return a.hasParameterAndValue(t.UrlParameter,e.value,r)},hasMaxLayerParameterWithValue:function(r,t){var i=e.FL_MAX_LAYER_PARAM;return a.hasParameterAndValue(i,r.value,t)},handleUrlParametersForStandalone:function(r){if(r.hasHigherLayerChanges){r.parameters=a.handleUrlParameters(r.parameters,e.FL_MAX_LAYER_PARAM,r.layer,r.URLParsingService)}var i=new RegExp("&*"+t.UrlParameter+"=-?\\d*&?","g");r.parameters=r.parameters.replace(i,"");if(r.isDraftAvailable&&!r.onExit){r.parameters=a.handleUrlParameters(r.parameters,t.UrlParameter,t.Number.Draft,r.URLParsingService)}if(r.versionSwitch){r.parameters=a.handleUrlParameters(r.parameters,t.UrlParameter,r.version,r.URLParsingService)}if(r.parameters==="?"){r.parameters=""}return r.parameters},handleParametersOnStart:function(r){var i=a.getParsedURLHash(r.URLParsingService);i.params=i.params||{};if(r.hasHigherLayerChanges){i.params[e.FL_MAX_LAYER_PARAM]=[r.layer]}if(r.isDraftAvailable){i.params[t.UrlParameter]=[t.Number.Draft]}return i},initialDraftGotActivated:function(e){if(e.versioningEnabled){var r=this.hasVersionParameterWithValue({value:t.Number.Draft},e.URLParsingService);return!s.isDraftAvailable({control:e.selector,layer:e.layer})&&r}return false},getReloadMethod:function(e){var r={NOT_NEEDED:"NO_RELOAD",RELOAD_PAGE:"HARD_RELOAD",VIA_HASH:"CROSS_APP_NAVIGATION"};e.reloadMethod=r.NOT_NEEDED;e.isDraftAvailable=e.isDraftAvailable||h.hasVersionParameterWithValue({value:t.Number.Draft},e.URLParsingService);e.hasVersionUrlParameter=!!a.getParameter(t.UrlParameter,e.URLParsingService);if(e.activeVersion!==t.Number.Original){e.activeVersionNotSelected=e.activeVersion&&!h.hasVersionParameterWithValue({value:e.activeVersion},e.URLParsingService)}e.hasHigherLayerChanges=h.hasMaxLayerParameterWithValue({value:e.layer},e.URLParsingService);e.initialDraftGotActivated=h.initialDraftGotActivated(e);if(e.initialDraftGotActivated){e.isDraftAvailable=false}e.allContexts=c(e.selector);if(e.changesNeedReload||e.isDraftAvailable||e.hasHigherLayerChanges||e.initialDraftGotActivated||e.activeVersionNotSelected||e.allContexts){e.reloadMethod=r.RELOAD_PAGE;if(!e.changesNeedReload&&a.getUshellContainer()){e.reloadMethod=r.VIA_HASH}}this.removeInfoSessionStorage(e.selector);return e}};return h});