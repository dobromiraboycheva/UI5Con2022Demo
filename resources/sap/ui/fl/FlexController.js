/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/initial/_internal/changeHandlers/ChangeHandlerStorage","sap/ui/fl/write/api/Version","sap/ui/fl/Utils","sap/ui/fl/Layer","sap/ui/fl/Change","sap/ui/fl/ChangePersistenceFactory","sap/ui/fl/write/_internal/Versions","sap/ui/fl/apply/_internal/changes/Applier","sap/ui/fl/apply/_internal/changes/Reverter","sap/ui/fl/apply/_internal/controlVariants/URLHandler","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/util/reflection/XmlTreeModifier","sap/ui/core/Component","sap/base/Log"],function(e,n,t,r,o,i,a,s,h,p,c,u,l,g){"use strict";function f(e,n,r){return Promise.resolve().then(function(){if(r.length!==0){r.reverse();return h.revertMultipleChanges(r,{appComponent:e,modifier:c,flexController:this})}}.bind(this)).then(function(){if(e){var o=e.getModel(t.VARIANT_MODEL_NAME);if(o){r.forEach(function(e){var n=e.getVariantReference();if(n){o.removeChange(e)}});if(!n){p.update({parameters:[],updateURL:true,updateHashEntry:true,model:o})}}}return r})}var C=function(e){this._oChangePersistence=undefined;this._sComponentName=e||"";if(this._sComponentName){this._oChangePersistence=i.getChangePersistenceForComponent(this.getComponentName())}};C.prototype.getComponentName=function(){return this._sComponentName};C.prototype.setVariantSwitchPromise=function(e){this._oVariantSwitchPromise=e};C.prototype.waitForVariantSwitch=function(){if(!this._oVariantSwitchPromise){this._oVariantSwitchPromise=Promise.resolve()}return this._oVariantSwitchPromise};C.prototype.createBaseChange=function(e,n){var t;var r;if(!n){throw new Error("No application component found. To offer flexibility a valid relation to its owning component must be present.")}e.reference=this.getComponentName();e.packageName="$TMP";t=o.createInitialFileContent(e);r=new o(t);if(e.variantReference){r.setVariantReference(e.variantReference)}return r};C.prototype._createChange=function(n,r,o){var i=o&&(o.controlType||t.getControlType(o));var a=this.createBaseChange(n,r);return e.getChangeHandler(a.getChangeType(),i,o,c,a.getLayer()).then(function(e){if(e){return e.completeChangeContent(a,n,{modifier:c,appComponent:r,view:t.getViewForControl(o)})}throw new Error("Change handler could not be retrieved for change "+JSON.stringify(n)+".")}).then(function(){return a}).catch(function(e){return Promise.reject(e)})};C.prototype.createChangeWithExtensionPointSelector=function(e,n){return Promise.resolve().then(function(){if(!n){throw new Error("A flexibility change on extension point cannot be created without a valid extension point reference.")}var r=n.view;var o=t.getAppComponentForControl(r);e.selector={name:n.name,viewSelector:c.getSelector(r.getId(),o)};return o}).then(function(n){return this._createChange(e,n)}.bind(this))};C.prototype.createChangeWithControlSelector=function(e,n){var r;return(new t.FakePromise).then(function(){if(!n){throw new Error("A flexibility change cannot be created without a targeted control.")}var o=n.id||n.getId();if(!e.selector){e.selector={}}r=n.appComponent||t.getAppComponentForControl(n);if(!r){throw new Error("No application component found. To offer flexibility, the control with the ID '"+o+"' has to have a valid relation to its owning application component.")}Object.assign(e.selector,c.getSelector(o,r));return r}).then(function(t){return this._createChange(e,t,n)}.bind(this))};C.prototype.addChange=function(e,n){return this.createChangeWithControlSelector(e,n).then(function(e){var r=t.getAppComponentForControl(n);e._ignoreOnce=true;this.addPreparedChange(e,r);e.setQueuedForApply();return e}.bind(this))};C.prototype.addPreparedChange=function(e,n){if(e.getVariantReference()){var r=n.getModel(t.VARIANT_MODEL_NAME);r.addChange(e)}this._oChangePersistence.addChange(e,n);return e};C.prototype.deleteChange=function(e,n){this._oChangePersistence.deleteChange(e);if(e.getVariantReference()){n.getModel(t.VARIANT_MODEL_NAME).removeChange(e)}};C.prototype.applyChange=function(e,n){var r={modifier:c,appComponent:t.getAppComponentForControl(n),view:t.getViewForControl(n)};return s.applyChangeOnControl(e,n,r).then(function(n){if(!n.success){var t=n.error||new Error("The change could not be applied.");this._oChangePersistence.deleteChange(e,true);throw t}return e}.bind(this))};function d(e,n,r,o,i){var a=m(e,o);if(!a){return[]}i.push(e);var s=e.getId();var h=n[s]&&n[s].dependencies||[];for(var p=0,c=h.length;p<c;p++){var u=t.getChangeFromChangesMap(r,h[p]);a=d(u,n,r,o,i);if(a.length===0){i=[];break}delete n[s]}return i}function m(e,n){var t=e.getDependentControlSelectorList();t.push(e.getSelector());return!t.some(function(e){return!c.bySelector(e,n)})}C.prototype.waitForChangesToBeApplied=function(e){var n=e.map(function(e){return this._waitForChangesToBeApplied(e)}.bind(this));return Promise.all(n).then(function(){return undefined})};C.prototype._waitForChangesToBeApplied=function(e){function n(n){return!n.isCurrentProcessFinished()&&(e.changeTypes.length===0||e.changeTypes.includes(n.getChangeType()))}e.changeTypes=e.changeTypes||[];var r=e.selector.id&&sap.ui.getCore().byId(e.selector.id)||e.selector;var o=this._oChangePersistence.getChangesMapForComponent();var i=[];var a=Object.assign({},o.mDependencies);var s=o.mChanges;var h=s[r.getId()]||[];var p=h.filter(n);var c=e.selector.appComponent||t.getAppComponentForControl(r);var u=[];p.forEach(function(e){var n=d(e,a,o.mChanges,c,[]);n.forEach(function(e){if(u.indexOf(e)===-1){u.push(e)}})});u.forEach(function(e){i=i.concat(e.addChangeProcessingPromises())},this);i.push(this.waitForVariantSwitch());return Promise.all(i)};C.prototype._removeOtherLayerChanges=function(e,n,t){if(t&&n){var o=Object.values(r).filter(function(e){return e!==n});return this.removeDirtyChanges(o,e,undefined,undefined,undefined,true)}return Promise.resolve()};C.prototype.saveAll=function(e,n,o,i,s){var h;var p;if(o){var c=a.getVersionsModel({reference:t.normalizeReference(this._sComponentName),layer:r.CUSTOMER});h=c.getProperty("/persistedVersion");p=c.getProperty("/draftFilenames")}return this._removeOtherLayerChanges(e,i,s).then(this._oChangePersistence.saveDirtyChanges.bind(this._oChangePersistence,e,n,undefined,h,p)).then(function(e){if(o&&e&&e.response){var n=e.response;if(Array.isArray(n)){n=n[0]}a.onAllChangesSaved({reference:n.reference,layer:n.layer})}return e})};C.prototype.processXmlView=function(e,n){var r=l.get(n.componentId);var o=t.getAppComponentForControl(r);n.appComponent=o;n.modifier=u;n.view=e;return this._oChangePersistence.getChangesForView(n).then(s.applyAllChangesForXMLView.bind(s,n)).catch(v.bind(this,n.view))};function v(e,n){g.error("Error processing view "+n+".");return e}C.prototype.getComponentChanges=function(e,n){return this._oChangePersistence.getChangesForComponent(e,n)};C.prototype.checkForOpenDependenciesForControl=function(e,n){return this._oChangePersistence.checkForOpenDependenciesForControl(e,n)};C.prototype.resetChanges=function(e,n,t,r,o){return this._oChangePersistence.resetChanges(e,n,r,o).then(f.bind(this,t,undefined))};C.prototype.removeDirtyChanges=function(e,n,t,r,o,i){return this._oChangePersistence.removeDirtyChanges(e,n,t,r,o).then(f.bind(this,n,i))};C.prototype.applyVariantChanges=function(e,n){var r;return e.reduce(function(e,t){return e.then(function(){var e={modifier:c,appComponent:n};this._oChangePersistence._addRunTimeCreatedChangeAndUpdateDependencies(n,t);r=e.modifier.bySelector(t.getSelector(),n);if(r){return s.applyChangeOnControl(t,r,e)}g.error("A flexibility change tries to change a nonexistent control.")}.bind(this))}.bind(this),new t.FakePromise)};C.prototype.saveSequenceOfDirtyChanges=function(e,n){return this._oChangePersistence.saveDirtyChanges(n,false,e)};return C});