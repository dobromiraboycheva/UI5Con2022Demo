/*
 * ! SAPUI5
 * (c) Copyright 2009-2022 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/comp/library","sap/ui/base/EventProvider","sap/ui/comp/odata/ODataType","sap/ui/comp/odata/MetadataAnalyser","sap/ui/comp/util/FormatUtil","sap/ui/comp/util/DateTimeUtil","sap/base/Log","sap/m/Token","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(t,e,i,a,s,o,n,r,l,h,d){"use strict";var u=e.smartfilterbar.DisplayBehaviour;var f=e.ANALYTICAL_PARAMETER_PREFIX;var p=i.extend("sap.ui.comp.providers.BaseValueListProvider",{constructor:function(t){i.call(this);this.sFieldName=t.fieldName;this.oControl=t.control;this.oODataModel=t.model;this.oFilterModel=t.filterModel;this.oFilterProvider=t.filterProvider;this.sDisplayFormat=t.displayFormat;this._oDateFormatSettings=t.dateFormatSettings;this._aValidationPromises=[];this.sContext=t.context;this.fnAsyncWritePromise=t.fnAsyncWritePromise;this._selectedODataRowHandler=t.selectedODataRowHandler;if(!this._oDateFormatSettings){this._oDateFormatSettings={}}if(!this._oDateFormatSettings.hasOwnProperty("UTC")){this._oDateFormatSettings["UTC"]=true}this._fieldViewMetadata=t.fieldViewMetadata;this.sValueListEntitySetName=null;this.bResolveInOutParams=t.resolveInOutParams===false?false:true;this.sDisplayBehaviour=t.displayBehaviour;this.sDDLBDisplayBehaviour=this.sDisplayBehaviour;if(!this.sDDLBDisplayBehaviour||this.sDDLBDisplayBehaviour===u.auto){this.sDDLBDisplayBehaviour=this.oFilterProvider?this.oFilterProvider.sDefaultDropDownDisplayBehaviour:u.descriptionOnly}this._sType=t.type;this._sMaxLength=t.maxLength;this.sPropertyTypePath="";if(this.bResolveInOutParams&&!this.oFilterModel&&!this.oFilterProvider){this._resolvePropertyPath()}if(t.loadAnnotation&&t.fullyQualifiedFieldName){this._oMetadataAnalyser=t.metadataAnalyser;this._sFullyQualifiedFieldName=t.fullyQualifiedFieldName;this._attachAnnotationLoadOnRender()}else{if(t.loadAnnotation){r.error("BaseValueListProvider","loadAnnotation is true, but no fullyQualifiedFieldName set for field '"+(this._sFullyQualifiedFieldName||this.sFieldName)+"'! Please check your annotations")}this._onAnnotationLoad({primaryValueListAnnotation:t.annotation,additionalAnnotations:t.additionalAnnotations})}}});p.prototype._attachAnnotationLoadOnRender=function(){this.oBeforeRenderingEventDelegate={onBeforeRendering:function(){this.oControl.removeEventDelegate(this.oBeforeRenderingEventDelegate,this);delete this.oBeforeRenderingEventDelegate;if(!this._bValueListRequested){if(this.bInitialised){if(this._onMetadataInitialised&&this.sAggregationName&&!this.bTypeAheadEnabled&&this.oControl.$()){this._onMetadataInitialised()}}else{this._loadAnnotation()}}}};this.oControl.addEventDelegate(this.oBeforeRenderingEventDelegate,this)};p.prototype.loadAnnotation=function(){if(this.oBeforeRenderingEventDelegate){this.oControl.removeEventDelegate(this.oBeforeRenderingEventDelegate,this);delete this.oBeforeRenderingEventDelegate}if(this.oAfterRenderingEventDelegate){this.oControl.removeEventDelegate(this.oAfterRenderingEventDelegate,this);delete this.oAfterRenderingEventDelegate}return this._loadAnnotation()};p.prototype._loadAnnotation=function(){if(!this._bValueListRequested){this._bValueListRequested=true;if(!this._oMetadataAnalyser){this._oMetadataAnalyser=new s(this.oODataModel);this._bCleanupMetadataAnalyser=true}return this.getValueListAnnotation().then(this._onAnnotationLoad.bind(this),function(t){this._oError=t;this.bInitialised=true;r.debug(t)}.bind(this))}return Promise.resolve()};p.prototype.getValueListAnnotation=function(){var t;if(s.hasValueListRelevantQualifiers(this._fieldViewMetadata)){t=this.oControl.getBindingContext()&&this.oControl.getBindingContext().getPath()}return this._oMetadataAnalyser.getValueListAnnotationLazy(this._sFullyQualifiedFieldName,t)};p.prototype.attachValueListChanged=function(t,e){this.attachEvent("valueListChanged",t,e)};p.prototype.detachValueListChanged=function(t,e){this.detachEvent("valueListChanged",t,e)};p.prototype._onAnnotationLoad=function(t){var e={};this.oPrimaryValueListAnnotation=t.primaryValueListAnnotation;this.additionalAnnotations=t.additionalAnnotations;this._resolveAnnotationData(this.oPrimaryValueListAnnotation);this.bInitialised=true;if(this._fBaseValueListProviderResolve){this._fBaseValueListProviderResolve()}if(this._onMetadataInitialised&&this.sAggregationName&&!this.bTypeAheadEnabled&&this.oControl.$()){this._onMetadataInitialised()}if(t.primaryValueListAnnotation&&t.primaryValueListAnnotation.annotation||t.primaryValueListAnnotationWithPVQualifier&&t.primaryValueListAnnotationWithPVQualifier.annotation){e.primaryValueListAnnotation=t.primaryValueListAnnotation||t.primaryValueListAnnotationWithPVQualifier}if(Array.isArray(t.additionalAnnotations)&&t.additionalAnnotations.length>0){e.additionalAnnotations=t.additionalAnnotations}if(Array.isArray(t.additionalAnnotationsWithPVQualifier)&&t.additionalAnnotationsWithPVQualifier.length>0){if(Array.isArray(e.additionalAnnotations)){e.additionalAnnotations=e.additionalAnnotations.concat(t.additionalAnnotationsWithPVQualifier)}else{e.additionalAnnotations=t.additionalAnnotationsWithPVQualifier}}return e};p.prototype._resolvePropertyPath=function(){var t=this.oControl.getBindingInfo("value"),e,i,a;if(t&&t.parts){e=t.parts[0]?t.parts[0].path:""}if(e){a=e.split("/");if(a.length>1){i=a[a.length-1];this.sPropertyTypePath=e.replace("/"+i,"")}}};p.prototype._resolveAnnotationData=function(t){var e=0,i=0,a,s,o;if(this.oODataModel&&t){this.bSupportBasicSearch=t.isSearchSupported;this.sValueListTitle=t.valueListTitle||t.qualifier;this.sKey=t.keyField;this._aKeys=t.keys;this.sValueListEntitySetName=t.valueListEntitySetName;this.mInParams=t.inParams;this.mOutParams=t.outParams;this.mConstParams=t.constParams;this.sTokenDisplayBehaviour=this.sDisplayBehaviour;if(!this.sTokenDisplayBehaviour||this.sTokenDisplayBehaviour===u.auto){this.sTokenDisplayBehaviour=this.oFilterProvider?this.oFilterProvider.sDefaultTokenDisplayBehaviour:u.descriptionAndId}this.sSingleFieldDisplayBehaviour=this.sDisplayBehaviour;if(!this.sSingleFieldDisplayBehaviour||this.sSingleFieldDisplayBehaviour===u.auto){this.sSingleFieldDisplayBehaviour=this.oFilterProvider?this.oFilterProvider.sDefaultSingleFieldDisplayBehaviour:u.descriptionAndId}if(!t.descriptionField){this.sTokenDisplayBehaviour=u.idOnly;this.sSingleFieldDisplayBehaviour=u.idOnly}this.sDescription=t.descriptionField||this.sKey;if(this.sValueListEntitySetName&&this.sKey){this._aCols=[];this.aSelect=[];a=t.valueListFields;o=t.aHighImportanceFields;if(o&&o.length){this._aHighImportanceCols=[]}e=a.length;for(i=0;i<e;i++){s=a[i];if(s.visible){if(o&&o.indexOf(s)!==-1){this._aHighImportanceCols.push(this._getColumnConfigFromField(s))}this._aCols.push(this._getColumnConfigFromField(s))}this.aSelect.push(s.name)}if(t.descriptionField){this.aSelect.push(t.descriptionField)}if(t.deprecationCodeField){this.aSelect.push(t.deprecationCodeField)}}else{if(!this.sKey){r.error("BaseValueListProvider","key for ValueListEntitySetName '"+this.sValueListEntitySetName+"' missing! Please check your annotations")}}}};p.prototype._getColumnConfigFromField=function(t){var e=null,i=null,s,n;if(t.type==="Edm.Boolean"){e="boolean"}else if(t.type==="Edm.DateTime"&&t.displayFormat==="Date"){e="date";n=this._oDateFormatSettings;s={displayFormat:"Date"}}else if(t.type==="Edm.Decimal"){e="decimal";s={precision:t.precision,scale:t.scale}}else if(t.type==="Edm.String"){if(t.isCalendarDate){e="stringdate"}else{e="string"}}i=a.getType(t.type,n,s,t.isCalendarDate);return{description:t.description,label:t.fieldLabel,tooltip:t.quickInfo||t.fieldLabel,type:e,oType:i,width:o.getWidth(t,15),template:t.name,sort:t.sortable?t.name:undefined,sorted:t.sortable&&t.name===this.sKey,sortOrder:"Ascending"}};p.prototype._getFilterData=function(){var t,e={};if(this.oFilterProvider&&this.oFilterProvider._oSmartFilter){t=this.oFilterProvider._oSmartFilter.getFilterData();if(this.sFieldName&&this.sFieldName.indexOf(f)===0){Object.keys(t).forEach(function(i){var a=i.split(f);e[a[a.length-1]]=t[i]});return e}}return t};p.prototype._setFilterData=function(t){var e=t,i={};if(this.oFilterProvider){if(this.sFieldName&&this.sFieldName.indexOf(f)===0){Object.keys(t).forEach(function(e){i[f+e]=t[e]});e=i}this.oFilterProvider.setFilterData(e)}};p.prototype._adaptPropertyValue=function(t,e){var i=e;if((e instanceof Date||typeof e==="string"&&!isNaN(e))&&this.oPrimaryValueListAnnotation&&this.oPrimaryValueListAnnotation.fields){var a=null;this.oPrimaryValueListAnnotation.fields.some(function(e){if(e.name===t){a=e}return a!==null});if(a&&a.type==="Edm.DateTime"&&a.displayFormat==="Date"){i=n.utcToLocal(e)}if(a&&a.isDigitSequence){var s=new RegExp("^[0]*$");if(s.test(e)){i=null}}}return i};p.prototype._calculateFilterInputData=function(){var t,e,i=null,a,s;delete this.mFilterInputData;this.mFilterInputData={};this.aFilterField=[];if(this.oFilterProvider&&this.oFilterProvider._oSmartFilter){i=this._getFilterData()}else if(this.oFilterModel){i=this.oFilterModel.getData()}if(this.mInParams&&i){for(t in this.mInParams){if(t){e=this.mInParams[t];e=e.replace("/",".");if(e!==this.sKey){if(this.sContext==="SmartFilterBar"&&this._isFieldHiddenInFilterBar(this.oFilterProvider._oSmartFilter,t)){continue}if(i[t]){this.mFilterInputData[e]=i[t];if(typeof this.mFilterInputData[e]==="object"){if(this.mFilterInputData[e].ranges&&this.mFilterInputData[e].ranges.length>0){for(var o=0;o<this.mFilterInputData[e].ranges.length;o++){this.mFilterInputData[e].ranges[o].keyField=e}}}this.aFilterField.push(e)}}}}}else if(this.oODataModel&&this.bResolveInOutParams){a=this.oControl.getBindingContext();if(this.mInParams&&a){for(t in this.mInParams){if(t){e=this.mInParams[t];e=e.replace("/",".");if(e!==this.sKey){var n=this.sPropertyTypePath?this.sPropertyTypePath+"/"+t:t;var r=a.getProperty(n);if(r||r===false){r=this._adaptPropertyValue(e,r);this.mFilterInputData[e]=r;this.aFilterField.push(e)}}}}}}if(this.mConstParams){for(s in this.mConstParams){this.mFilterInputData[s]=this.mConstParams[s];this.aFilterField.push(s)}}};p.prototype._isFieldHiddenInFilterBar=function(t,e){var i=t._getFilterItemByName(e)||t._getFilterItemByName(f+e);return!i||!i.getVisibleInAdvancedArea()};p.prototype._calculateAndSetFilterOutputData=function(e){var i,a,s,r=null,l,h,d,u,f,p,m;if(this.mOutParams&&e&&(this.oFilterProvider||this.oFilterModel)){r={};f=function(t){return t.key===d.key};p=function(t){if(d.value1 instanceof Date&&t.value1 instanceof Date){return t.operation==="EQ"&&d.value1.getTime()===t.value1.getTime()}return t.operation==="EQ"&&d.value1===t.value1};m=function(t){return t.operation==="EQ"&&d.key===t.value1};for(i in this.mOutParams){if(i){if(!this.oFilterProvider&&Object.keys(this.mOutParams).length>1){if(i!==this.sFieldName){continue}}var y=this.oFilterProvider&&this.oFilterProvider._getFieldMetadata(i);s=this.mOutParams[i];if(e.length>0){for(var u=0;u<this._aCols.length;u++){if(this._aCols[u].template===s){var g=this._aCols[u].description;a=e[0][g]}}}if(s!==this.sKey){h=null;u=e.length;while(u--){l=e[u];if(this.sContext==="SmartFilterBar"&&this._isFieldHiddenInFilterBar(this.oFilterProvider._oSmartFilter,i)){continue}if(l[s]){var v=l[s];var c=y&&(y.type==="Edm.DateTime"||!y.hasValueListAnnotation);if(c){if(y.type==="Edm.DateTime"&&this._oDateFormatSettings.UTC==true){v=n.utcToLocal(v)}d={exclude:false,operation:"EQ",keyField:i,value1:v,value2:null}}else{d={key:v,text:o.getFormattedExpressionFromDisplayBehaviour(this.sTokenDisplayBehaviour,v,a)}}if(!r[i]){if(!h&&this.oFilterModel){h=this.oFilterModel.getData()}if(h&&h[i]&&h[i].items){r[i]=h[i];if(!r[i].ranges){r[i].ranges=[]}}else{r[i]={items:[],ranges:[]}}}var F=r[i];if(c){if(F.ranges.filter(p).length<=0){F.ranges.push(d)}}else if(F.items.filter(f).length<=0){if(!F.ranges||F.ranges.filter(m).length<=0){F.items.push(d)}}}}}}}if(r){if(this.oFilterProvider){this._setFilterData(r);if(!t.isEmptyObject(r)){this.fireEvent("valueListChanged",{changes:Object.keys(r)})}}else if(this.oFilterModel){this.oFilterModel.setData(r,true)}}}else if(this.oODataModel&&this.bResolveInOutParams){this._calculateAndSetODataModelOutputData(e[0])}};p.prototype._calculateAndSetODataModelOutputData=function(e){var i,a,s,o,n,r={};if(e&&this.mOutParams){i=this.oControl.getBindingContext();for(a in this.mOutParams){if(a){s=this.mOutParams[a];if(s!==this.sKey){n=e[s];r[a]=n;o=this.sPropertyTypePath?this.sPropertyTypePath+"/"+a:a;this.oODataModel.setProperty(o,n,i,true)}}}if(r&&!t.isEmptyObject(r)){this.fireEvent("valueListChanged",{changes:r})}}};p.prototype._handleRowsSelect=function(t){var e,i,a,s,n,r=[],h,d;if(!(this.oControl&&this.oControl.addToken)){return}h=this.oControl.getTokens();for(e=0;e<t.length;e++){a=t[e][this.sKey];s=t[e][this.sDescription];if(a||a===""){s=o.getFormattedExpressionFromDisplayBehaviour(this.sTokenDisplayBehaviour,a,s);n=new l({key:a,text:s,tooltip:s});n.data("row",t[e]);r.push(n);for(i=0;i<h.length;i++){d=h[i];var u=d.getKey();if(u||u===""&&u===a){break}else if(d.data("range")&&!d.data("range").exclude&&d.data("range").operation==="EQ"&&d.data("range").value1==a){break}}if(i<h.length){h.splice(i,1)}}}if(r.length){this.oControl.setTokens(h.concat(r))}};p.prototype.readData=function(t){var e=[],i;this._oReadPromise=new Promise(function(t){this._fBaseValueListProviderResolve=t}.bind(this));if(this.bInitialised){this._fBaseValueListProviderResolve()}this._oReadPromise.then(function(){this._fBaseValueListProviderResolve=null;for(var a=0;a<t.length;a++){i=this.sDisplayFormat==="UpperCase"?t[a].toUpperCase():t[a];e.push(new h(this.sKey,d.EQ,i))}if(!this.sValueListEntitySetName){return}this.oODataModel.read("/"+this.sValueListEntitySetName,{filters:e,success:function(e,i){if(e){if(e.results&&e.results.length!==t.length){r.error("Expecting "+t.length+" result rows, but received "+e.results.length+" rows...");return}var a=e.results;if(this.oControl&&this.oControl.isA("sap.m.MultiInput")&&this.oControl.getTokens().length!==t.length){a=this._getUpdatedDataModelRows(a)}this._handleRowsSelect(a)}}.bind(this),error:function(t){r.error("Error occured reading /"+this.sValueListEntitySetName)}.bind(this)})}.bind(this))};p.prototype._getUpdatedDataModelRows=function(t){var e=this.oControl.getTokens(),i=[];for(var a=0;a<e.length;a++){var s=e[a];var o=s.getKey();if(o){i.push(o)}else if(s.data("range")&&s.data("range").value1){i.push(s.data("range").value1)}}var n=[];for(var a=0;a<t.length;a++){var r=t[a][this.sKey];if(i.indexOf(r)!==-1){n.push(t[a])}}return n};p.prototype._addValidationPromise=function(t){var e,i,a,s=false;for(e=0;e<this._aValidationPromises.length;e++){a=this._aValidationPromises[e];if(a===null){this._aValidationPromises[e]=t;i=e;s=true;break}}if(!s){this._aValidationPromises.push(t);i=this._aValidationPromises.length-1}t.finally(function(){this._removeValidationPromise(i)}.bind(this))};p.prototype._removeValidationPromise=function(t){this._aValidationPromises[t]=null};p.prototype._getCurrentValidationPromises=function(){var t,e,i=[];for(t=0;t<this._aValidationPromises.length;t++){e=this._aValidationPromises[t];this._removeValidationPromise(t);i.push(e)}return i};p.prototype.destroy=function(){i.prototype.destroy.apply(this,arguments);if(this._bCleanupMetadataAnalyser&&this._oMetadataAnalyser){this._oMetadataAnalyser.destroy()}this._oMetadataAnalyser=null;if(this.oBeforeRenderingEventDelegate){this.oControl.removeEventDelegate(this.oBeforeRenderingEventDelegate);delete this.oBeforeRenderingEventDelegate}if(this.oAfterRenderingEventDelegate){this.oControl.removeEventDelegate(this.oAfterRenderingEventDelegate);delete this.oAfterRenderingEventDelegate}this.oControl=null;this.sFieldName=null;this.mFilterInputData=null;this.aFilterField=null;this.sValueListEntitySetName=null;this.oODataModel=null;this.oFilterModel=null;this.oFilterProvider=null;this.oPrimaryValueListAnnotation=null;this.additionalAnnotations=null;this.sDisplayFormat=null;this.bSupportBasicSearch=null;this.bInitialised=null;this._oError=null;this.sValueListTitle=null;this.sKey=null;this._aKeys=null;this.mInParams=null;this.mOutParams=null;this.sDescription=null;this.aSelect=null;this._aCols=null;this._aHighImportanceCols=null;this.sDDLBDisplayBehaviour=null;this.sTokenDisplayBehaviour=null;this._oDateFormatSettings=null;this._fieldViewMetadata=null;this._oReadPromise=null;this._fBaseValueListProviderResolve=null;this.bIsDestroyed=true;this._aValidationPromises=null};return p});