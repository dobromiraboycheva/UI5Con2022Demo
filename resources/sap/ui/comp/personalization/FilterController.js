/*
 * ! SAPUI5
 * (c) Copyright 2009-2022 SAP SE. All rights reserved.
 */
sap.ui.define(["./BaseController","sap/m/library","sap/ui/comp/library","./Util","sap/ui/comp/filterbar/VariantConverterTo","sap/ui/comp/filterbar/VariantConverterFrom","sap/base/util/merge"],function(e,t,a,r,i,l,n){"use strict";var o=e.extend("sap.ui.comp.personalization.FilterController",{constructor:function(a,r){e.apply(this,arguments);this.setType(t.P13nPanelType.filter);this.setItemType(t.P13nPanelType.filter+"Items");this._aDropdownFields=[]},metadata:{events:{afterFilterModelDataChange:{}}}});o.prototype.setTable=function(t){e.prototype.setTable.apply(this,arguments)};o.prototype.getColumn2Json=function(e,t,i){if(this.getTableType()!==a.personalization.TableType.AnalyticalTable&&this.getTableType()!==a.personalization.TableType.Table&&this.getTableType()!==a.personalization.TableType.TreeTable){return null}if(!r.isFilterable(e)){return null}if(!e.getFiltered||e.getFiltered&&!e.getFiltered()){return null}return{columnKey:t,exclude:false,operation:e.getFilterOperator(),value1:e.getFilterValue(),value2:""}};o.prototype.getColumn2JsonTransient=function(e,t,i,l){if(!r.isFilterable(e)){return null}var n;if(this.getTableType()===a.personalization.TableType.AnalyticalTable||this.getTableType()===a.personalization.TableType.Table||this.getTableType()===a.personalization.TableType.TreeTable){if(r.getColumnType(e)==="boolean"){n=r._getCustomProperty(e,"values")}return{columnKey:t,text:i,tooltip:l!==i?l:undefined,maxLength:r._getCustomProperty(e,"maxLength"),precision:r._getCustomProperty(e,"precision"),scale:r._getCustomProperty(e,"scale"),type:r.getColumnType(e),typeInstance:r._getCustomProperty(e,"typeInstance"),values:n,nullable:r._getCustomProperty(e,"nullable")}}if(this.getTableType()===a.personalization.TableType.ResponsiveTable){if(r.getColumnType(e)==="boolean"){n=r._getCustomProperty(e,"values")}return{columnKey:t,text:i,tooltip:l!==i?l:undefined,maxLength:r._getCustomProperty(e,"maxLength"),precision:r._getCustomProperty(e,"precision"),scale:r._getCustomProperty(e,"scale"),type:r.getColumnType(e),typeInstance:r._getCustomProperty(e,"typeInstance"),values:n,nullable:r._getCustomProperty(e,"nullable")}}if(this.getTableType()===a.personalization.TableType.ChartWrapper){return{columnKey:t,text:i,tooltip:l!==i?l:undefined,maxLength:r._getCustomProperty(e,"maxLength"),precision:r._getCustomProperty(e,"precision"),scale:r._getCustomProperty(e,"scale"),type:r.getColumnType(e),typeInstance:r._getCustomProperty(e,"typeInstance"),values:n,nullable:r._getCustomProperty(e,"nullable")}}};o.prototype.handleIgnore=function(e,t){e.sort.sortItems.splice(t,1)};o.prototype.syncJson2Table=function(e){var t=this.getColumnMap();var r=n({},t);this.fireBeforePotentialTableChange();if(this.getTableType()===a.personalization.TableType.AnalyticalTable||this.getTableType()===a.personalization.TableType.Table||this.getTableType()===a.personalization.TableType.TreeTable){e.filter.filterItems.forEach(function(e){var a=t[e.columnKey];if(a){if(!a.getFiltered()){a.setFiltered(true)}delete r[e.columnKey]}});for(var i in r){var l=r[i];if(l&&l.getFiltered()){l.setFiltered(false)}}}this.fireAfterPotentialTableChange()};o.prototype.getDataSuiteFormat2Json=function(e){var t=this.createControlDataStructure();if(!e.SelectOptions||!e.SelectOptions.length){return t}t.filter.filterItems=e.SelectOptions.map(function(e){var t=l.convertOption(e.Ranges[0].Option,e.Ranges[0].Low);return{columnKey:e.PropertyName,exclude:e.Ranges[0].Sign==="E",operation:t.op,value1:t.v,value2:e.Ranges[0].High}});return t};o.prototype.getDataSuiteFormatSnapshot=function(e){var t=this.getUnionData(this.getControlDataInitial(),this.getControlData());if(!t.filter||!t.filter.filterItems||!t.filter.filterItems.length){return}t.filter.filterItems.forEach(function(t){var a=i.addRangeEntry(e,t.columnKey);i.addRanges(a,[t])})};o.prototype.getPanel=function(e){if(!r.hasFilterableColumns(this.getColumnMap())){return null}if(e&&e.column){var t=r.getColumnKey(e.column);if(t){var a=this.getTransientData();a.filter.filterItems.forEach(function(e){e["isDefault"]=e.columnKey===t})}}var i=this.getTable(),l=this._getSmartFilterBar();if(l&&l._oFilterProvider){this._aDropdownFields=l._oFilterProvider._aFilterBarDropdownFieldMetadata}else if(i&&i.oParent&&i.oParent._oTableProvider&&i.oParent._oTableProvider._aTableViewMetadata){this._aDropdownFields=i.oParent._oTableProvider._aTableViewMetadata.filter(function(e){return e.hasFixedValues})}return new Promise(function(e){sap.ui.require(["sap/ui/comp/p13n/P13nFilterPanel","sap/m/P13nItem","sap/m/P13nAnyFilterItem","sap/ui/comp/providers/ValueListProvider"],function(t,a,i,l){var n=this.getColumnMap(true),o=new t({containerQuery:true,enableEmptyOperations:true,items:{path:"$sapmP13nPanel>/transientData/filter/filterItems",template:new a({columnKey:"{$sapmP13nPanel>columnKey}",text:"{$sapmP13nPanel>text}",tooltip:"{$sapmP13nPanel>tooltip}",maxLength:"{$sapmP13nPanel>maxLength}",precision:"{$sapmP13nPanel>precision}",scale:"{$sapmP13nPanel>scale}",type:"{$sapmP13nPanel>type}",typeInstance:"{$sapmP13nPanel>typeInstance}",isDefault:"{$sapmP13nPanel>isDefault}",values:"{$sapmP13nPanel>values}",nullable:"{$sapmP13nPanel>nullable}"})},filterItems:{path:"$sapmP13nPanel>/controlDataReduce/filter/filterItems",template:new i({key:"{$sapmP13nPanel>key}",columnKey:"{$sapmP13nPanel>columnKey}",exclude:"{$sapmP13nPanel>exclude}",operation:"{$sapmP13nPanel>operation}",value1:"{$sapmP13nPanel>value1}",value2:"{$sapmP13nPanel>value2}"})},messageStrip:this.getMessageStrip(),beforeNavigationTo:this.setModelFunction(),filterItemChanged:function(e){var t=e.getParameter("reason");var a=e.getParameter("index");var r=e.getParameter("itemData");var i=this.getControlDataReduce();if(r&&t==="added"){if(a>-1){i.filter.filterItems.splice(a,0,r)}else{i.filter.filterItems.push(r)}}if(t==="removed"&&a>-1){i[this.getType()][this.getItemType()].splice(a,1)}this.setControlDataReduce2Model(i);this.fireAfterPotentialModelChange({json:i})}.bind(this)});if(this._aDropdownFields&&this._aDropdownFields.length>0){this._aDropdownFields=this._aDropdownFields.filter(function(e){var t=n[e.name];return!!r._getCustomProperty(t,"fullName")})}o._oConditionPanel.data("dropdownFields",this._aDropdownFields);var s=function(e,t){var a=this.getColumnMap(true),i=a[t],n=r._getCustomProperty(i,"fullName"),o=this._getSmartFilterBar(),s,p=this._getSmartTable(),u,f=o&&o.getControlConfiguration(),m,g,y,c,d;if(e.isA("sap.m.ComboBox")||e.isA("sap.m.MultiComboBox")){m="items";g=false;if(o&&o._oFilterProvider){s=o._oFilterProvider;y=s._sTextArrangementDisplayBehaviour||"idOnly"}else if(p&&p._oTableProvider){s=p._oTableProvider;y=s._oDefaultDropDownDisplayBehaviour||"idOnly"}this._aDropdownFields.forEach(function(e){if(e.name===t){u=e["com.sap.vocabularies.Common.v1.Text"];if(u){y=s._oMetadataAnalyser.getTextArrangementValue(u)}else if(e["com.sap.vocabularies.UI.v1.TextArrangement"]){y=s._oMetadataAnalyser.getTextArrangementValue(e)}}});if(Array.isArray(f)&&f.length>0){for(d=0;d<f.length;d++){c=f[d];if(c.getKey()===t){y=c.getDisplayBehaviour();break}}}}else{m="suggestionRows";g=true}if(n){e.setShowSuggestion&&e.setShowSuggestion(true);e.setFilterSuggests&&e.setFilterSuggests(false);e.setModel(this.getTable().getModel());return new l({fieldName:t,control:e,model:this.getTable().getModel(),maxLength:r._getCustomProperty(i,"maxLength"),displayBehaviour:y,resolveInOutParams:false,loadAnnotation:true,fullyQualifiedFieldName:n,aggregation:m,typeAheadEnabled:g,enableShowTableSuggestionValueHelp:false})}}.bind(this);o._oConditionPanel._fSuggestCallback=s;o._enableEnhancedExcludeOperations();o.addStyleClass("sapUiSmallMarginTop");return e(o)}.bind(this))}.bind(this))};o.prototype.getChangeType=function(e,t){if(!t||!t.filter||!t.filter.filterItems){return a.personalization.ChangeType.Unchanged}if(t&&t.filter&&t.filter.filterItems){t.filter.filterItems.forEach(function(e){delete e.key;delete e.source})}if(e&&e.filter&&e.filter.filterItems){e.filter.filterItems.forEach(function(e){delete e.key;delete e.source})}var r=JSON.stringify(e.filter.filterItems)!==JSON.stringify(t.filter.filterItems);return r?a.personalization.ChangeType.ModelChanged:a.personalization.ChangeType.Unchanged};o.prototype.getChangeData=function(e,t){if(!e||!e.filter||!e.filter.filterItems){return this.createControlDataStructure()}if(t&&t.filter&&t.filter.filterItems){t.filter.filterItems.forEach(function(e){delete e.key;delete e.source})}if(e&&e.filter&&e.filter.filterItems){e.filter.filterItems.forEach(function(e){delete e.key;delete e.source})}if(!t||!t.filter||!t.filter.filterItems){return{filter:r.copy(e.filter)}}if(JSON.stringify(e.filter.filterItems)!==JSON.stringify(t.filter.filterItems)){return{filter:r.copy(e.filter)}}return null};o.prototype.getUnionData=function(e,t){if(!t||!t.filter||!t.filter.filterItems){return{filter:r.copy(e.filter)}}return{filter:r.copy(t.filter)}};o.prototype._getSmartFilterBar=function(){var e,t=this.getTable();if(t){e=t.oParent&&t.oParent._oSmartFilter}if(!e&&t&&this.getTableType()===a.personalization.TableType.ChartWrapper){e=t.getChartObject()&&t.getChartObject().oParent&&t.getChartObject().oParent._oSmartFilter}return e?e:null};o.prototype._getSmartTable=function(){return this.getTable()&&this.getTable().getParent()};o.prototype.exit=function(){e.prototype.exit.apply(this,arguments);this._aDropdownFields=null};return o});