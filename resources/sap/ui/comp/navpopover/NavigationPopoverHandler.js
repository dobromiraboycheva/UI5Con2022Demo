/*
 * ! SAPUI5
 * (c) Copyright 2009-2022 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/comp/library","sap/ui/base/ManagedObject","./SemanticObjectController","sap/ui/model/json/JSONModel","sap/ui/model/BindingMode","sap/ui/core/Control","./Factory","./NavigationPopover","./Util","sap/m/VBox","./LinkData","sap/m/MessageBox","sap/ui/comp/personalization/Controller","sap/ui/comp/personalization/Util","./NavigationContainer","./ContactDetailsController","./Log","sap/ui/core/InvisibleText","sap/ui/core/CustomData","sap/base/Log","sap/base/util/isPlainObject","sap/ui/core/Component","sap/base/util/merge","sap/base/strings/whitespaceReplacer"],function(t,e,i,n,a,o,r,s,l,c,p,u,g,v,d,f,m,b,h,y,P,N,C,A,S){"use strict";var _=i.extend("sap.ui.comp.navpopover.NavigationPopoverHandler",{metadata:{library:"sap.ui.comp",properties:{semanticObject:{type:"string",defaultValue:null},additionalSemanticObjects:{type:"string[]",defaultValue:[]},semanticObjectController:{type:"any",defaultValue:null},fieldName:{type:"string",defaultValue:null},semanticObjectLabel:{type:"string",defaultValue:null},mapFieldToSemanticObject:{type:"boolean",defaultValue:true},contactAnnotationPath:{type:"string",defaultValue:undefined},enableAvailableActionsPersonalization:{type:"boolean",defaultValue:true},beforeNavigationCallback:{type:"function"}},aggregations:{_popover:{type:"sap.ui.comp.navpopover.NavigationPopover",multiple:false,visibility:"hidden"}},associations:{control:{type:"sap.ui.core.Control",multiple:false}},events:{beforePopoverOpens:{parameters:{semanticObject:{type:"string"},semanticAttributes:{type:"object"},semanticAttributesOfSemanticObjects:{type:"object"},setSemanticAttributes:{type:"function"},setAppStateKey:{type:"function"},originalId:{type:"string"},open:{type:"function"}}},navigationTargetsObtained:{parameters:{mainNavigation:{type:"sap.ui.comp.navpopover.LinkData"},actions:{type:"sap.ui.comp.navpopover.LinkData[]"},ownNavigation:{type:"sap.ui.comp.navpopover.LinkData"},popoverForms:{type:"sap.ui.layout.form.SimpleForm[]"},semanticObject:{type:"string"},semanticAttributes:{type:"object"},originalId:{type:"string"},show:{type:"function"}}},innerNavigate:{parameters:{text:{type:"string"},href:{type:"string"},semanticObject:{type:"string"},semanticAttributes:{type:"object"},originalId:{type:"string"}}}}}});_.prototype.init=function(){this._oPopover=null;this._oContactDetailsController=new m;var t=new a({semanticObject:undefined,semanticAttributes:undefined,appStateKey:undefined,mainNavigationId:undefined,navigationTarget:{mainNavigation:undefined,enableAvailableActionsPersonalization:undefined,extraContent:undefined},availableActions:[]});t.setDefaultBindingMode(o.TwoWay);t.setSizeLimit(1e3);this.setModel(t,"$sapuicompNavigationPopoverHandler");this._oLog=P.getLevel()>=P.Level.INFO?new b:undefined};_.prototype.applySettings=function(t){i.prototype.applySettings.apply(this,arguments);this._setSemanticAttributes(this._calculateSemanticAttributes(null))};_.prototype.openPopover=function(t){var e=this;return this._getPopover().then(function(i){var n=i.getDirectLink();if(n){e._fireInnerNavigate({text:n.getText(),href:n.getHref(),internalHref:n.data("internalHref")});e._destroyPopover();return}i.show(t)})};_.prototype.getSemanticObjectValue=function(){var t=this._getSemanticAttributes();if(t){return t[this.getSemanticObject()][this.getSemanticObject()]}return undefined};_.prototype.getNavigationPopoverStableId=function(){var t=sap.ui.getCore().byId(this.getControl());if(!t){P.error("NavigationPopoverHandler: Stable ID could not be determined because the control is undefined");return undefined}var e=this._getComponent(t);if(!e){P.error("NavigationPopoverHandler: Stable ID could not be determined because the app component is not defined for control '"+t.getId()+"'");return undefined}var i=this.getModel("$sapuicompNavigationPopoverHandler").getProperty("/semanticObject");if(!i){P.error("NavigationPopoverHandler: Stable ID could not be determined because no default semantic object is defined");return undefined}var n=[i].concat(this.getAdditionalSemanticObjects());c.sortArrayAlphabetical(n);var a=n.join("--");return e.createId("sapuicompnavpopoverNavigationPopover---"+a)};_.prototype.updateBindingContext=function(){var t=this.getBindingContext("$sapuicompNavigationPopoverHandler");r.prototype.updateBindingContext.apply(this,arguments);var e=this.getBindingContext("$sapuicompNavigationPopoverHandler");if(e&&e!==t){this._setSemanticAttributes(this._calculateSemanticAttributes(null));this._destroyPopover()}};_.prototype.setSemanticObject=function(t){this._destroyPopover();this.setProperty("semanticObject",t);this.getModel("$sapuicompNavigationPopoverHandler").setProperty("/semanticObject",t);this._setSemanticAttributes(this._calculateSemanticAttributes(null));return this};_.prototype._setSemanticAttributes=function(t){this.getModel("$sapuicompNavigationPopoverHandler").setProperty("/semanticAttributes",t)};_.prototype._getSemanticAttributes=function(){return this.getModel("$sapuicompNavigationPopoverHandler").getProperty("/semanticAttributes")};_.prototype.setEnableAvailableActionsPersonalization=function(t){this.setProperty("enableAvailableActionsPersonalization",t);this.getModel("$sapuicompNavigationPopoverHandler").setProperty("/navigationTarget/enableAvailableActionsPersonalization",t);return this};_.prototype.setFieldName=function(t){this.setProperty("fieldName",t);this._setSemanticAttributes(this._calculateSemanticAttributes(null));return this};_.prototype.setControl=function(t){this.setAssociation("control",t);this.setModel(t.getModel());this._destroyPopover();this._updateSemanticObjectController();this._setSemanticAttributes(this._calculateSemanticAttributes(null));return this};_.prototype.setMapFieldToSemanticObject=function(t){this.setProperty("mapFieldToSemanticObject",t);this._setSemanticAttributes(this._calculateSemanticAttributes(null));return this};_.prototype.setSemanticObjectController=function(t){this._updateSemanticObjectController(t);this._setSemanticAttributes(this._calculateSemanticAttributes(null));return this};_.prototype.exit=function(){this._oContactDetailsController.destroy();this._destroyPopover();if(this.getSemanticObjectController()){this.getSemanticObjectController().unregisterControl(this)}if(this.getModel("$sapuicompNavigationPopoverHandler")){this.getModel("$sapuicompNavigationPopoverHandler").destroy()}};_.prototype._initModel=function(){var t=this;var e;var i=this.getSemanticObject();var n=this.getAdditionalSemanticObjects();var a=c.getContactAnnotationPath(this,this.getSemanticObjectController());var o=sap.ui.getCore().byId(this.getControl());if(!o){P.error("sap.ui.comp.navpopover.NavigationPopoverHandler: No control provided, popover cannot be attached.")}var r=o&&o.getBindingContext()?o.getBindingContext().getPath():null;if(!r){P.warning("sap.ui.comp.navpopover.NavigationPopoverHandler: Binding Context is null. Please be aware that without binding context no semantic attributes can be calculated. Without semantic attributes no URL parameters can be created.")}var s=this.getModel();var l=this._getComponent(o);var p=o&&o.getId();var g,v,d;if(this._oLog){this._oLog.reset()}return sap.ui.getCore().loadLibrary("sap.ui.fl",{async:true}).then(function(){return c.retrieveSemanticObjectMapping(t.getFieldName(),s,r)}).then(function(n){t._setSemanticAttributes(t._calculateSemanticAttributes(n,t._oLog));e=t._getSemanticAttributes();return t._fireBeforePopoverOpens(e,i,p,t._oLog)}).then(function(a){e=a.semanticAttributes;t._setSemanticAttributes(e);v=t.getSemanticObjectValue();g=o&&o._getTextOfDom&&o._getTextOfDom()||t.getSemanticObjectValue();t.getModel("$sapuicompNavigationPopoverHandler").setProperty("/appStateKey",a.appStateKey);return c.retrieveNavigationTargets(i,n,a.appStateKey,l,e,g,t.getFieldName(),s,r,t._oLog)}).then(function(e){d=e;t._oContactDetailsController.setModel(s);return t._oContactDetailsController.getBindingPath4ContactAnnotation(r,a,v)}).then(function(n){var a=t._oContactDetailsController.getContactDetailsContainers(n);return t._fireNavigationTargetsObtained(g,i,e,p,a,d,t._oLog)}).then(function(e){e.availableActions.forEach(function(e){if(e.getHref()){e.setInternalHref(e.getHref());e.setHref(t._convertToExternal(e.getHref()))}if(e.getText()){e.setText(S(e.getText()))}});if(e.mainNavigationId){e.mainNavigationId=S(e.mainNavigationId)}if(e.mainNavigation){if(!e.mainNavigation.getDescription()){e.mainNavigation.setDescription(t.getSemanticObjectLabel())}else{e.mainNavigation.setDescription(S(e.mainNavigation.getDescription()))}if(e.mainNavigation.getText()){e.mainNavigation.setText(S(e.mainNavigation.getText()))}}if(e.mainNavigation&&e.mainNavigation.getHref()){e.mainNavigation.setInternalHref(e.mainNavigation.getHref());e.mainNavigation.setHref(t._convertToExternal(e.mainNavigation.getHref()))}var i=t.getModel("$sapuicompNavigationPopoverHandler");i.setProperty("/mainNavigationId",e.mainNavigationId);i.setProperty("/navigationTarget/mainNavigation",e.mainNavigation);i.setProperty("/navigationTarget/extraContent",e.extraContent);i.setProperty("/availableActions",t._updateVisibilityOfAvailableActions(u.convert2Json(e.availableActions)));i.setProperty("/navigationTarget/enableAvailableActionsPersonalization",t._getEnableAvailableActionsPersonalization(i.getProperty("/availableActions")));if(P.getLevel()>=P.Level.TRACE){P.info("sap.ui.comp.NavigationPopoverHandler: calculation of semantic attributes\n---------------------------------------------\nBelow you can see detailed information regarding semantic attributes which have been calculated for one or more semantic objects defined in a SmartLink control. Semantic attributes are used to create the URL parameters. Additionally you can see all links containing the URL parameters.\n"+t._getLogFormattedText())}})};_.prototype._initPopover=function(){var t=this;return this._initModel().then(function(){var e=t.getModel("$sapuicompNavigationPopoverHandler");var i=t._createPopover();i.setModel(e,"$sapuicompNavigationPopoverHandler");var n=sap.ui.getCore().byId(t.getControl());if(n){n.addDependent(i)}return i})};_.prototype._initNavigationContainer=function(){var t=this;return this._initModel().then(function(){var e=t.getModel("$sapuicompNavigationPopoverHandler");var i=t._createNavigationContainer();i.setModel(e,"$sapuicompNavigationPopoverHandler");var n=sap.ui.getCore().byId(t.getControl());if(n){n.addDependent(i)}return i})};_.prototype._getPopover=function(){if(!this._oPopover){return this._initPopover()}else{return Promise.resolve(this._oPopover)}};_.prototype._getNavigationContainer=function(){return this._initNavigationContainer().then(function(t){return t})};_.prototype._destroyPopover=function(){if(this._oPopover){this._oPopover.destroy();this._oPopover=null}};_.prototype._createPopover=function(){if(this._oPopover){return this._oPopover}var t=this._createNavigationContainer();var e=new h({text:"{$sapuicompNavigationPopoverHandler>/mainNavigationId}"});this._oPopover=new l({customData:new y({key:"useExternalContent"}),content:[t,e],ariaLabelledBy:e,semanticObjectName:"{$sapuicompNavigationPopoverHandler>/semanticObject}",semanticAttributes:"{$sapuicompNavigationPopoverHandler>/semanticAttributes}",appStateKey:"{$sapuicompNavigationPopoverHandler>/appStateKey}",source:this.getControl(),beforeClose:function(){this.removeAllContent().forEach(function(t){t.destroy()})},afterClose:this._destroyPopover.bind(this)});this.setAggregation("_popover",this._oPopover);return this._oPopover};_.prototype._createNavigationContainer=function(){var t=this.getNavigationPopoverStableId();if(!t){P.error("NavigationPopoverHandler: Due to undefined stable ID the button of action personalization is set to disabled")}if(sap.ui.getCore().byId(t)){P.error("Duplicate ID '"+t+"'. The instance of NavigationContainer should be destroyed first in order to avoid duplicate creation of NavigationContainer with stable ID.");throw"Duplicate ID"}var e=this.getModel("$sapuicompNavigationPopoverHandler");return new f(t,{mainNavigationId:"{$sapuicompNavigationPopoverHandler>/mainNavigationId}",mainNavigation:e.getProperty("/navigationTarget/mainNavigation"),availableActions:{path:"$sapuicompNavigationPopoverHandler>/availableActions",templateShareable:false,template:new u({key:"{$sapuicompNavigationPopoverHandler>key}",href:"{$sapuicompNavigationPopoverHandler>href}",internalHref:"{$sapuicompNavigationPopoverHandler>internalHref}",text:"{$sapuicompNavigationPopoverHandler>text}",target:"{$sapuicompNavigationPopoverHandler>target}",description:"{$sapuicompNavigationPopoverHandler>description}",visible:"{$sapuicompNavigationPopoverHandler>visible}"})},extraContent:e.getProperty("/navigationTarget/extraContent")?e.getProperty("/navigationTarget/extraContent").getId():undefined,component:this._getComponent(sap.ui.getCore().byId(this.getControl())),enableAvailableActionsPersonalization:"{$sapuicompNavigationPopoverHandler>/navigationTarget/enableAvailableActionsPersonalization}",beforePopoverOpen:function(){if(this._oPopover){this._oPopover.setModal(true)}}.bind(this),afterPopoverClose:function(){if(this._oPopover){this._oPopover.setModal(false)}}.bind(this),navigate:this._onNavigate.bind(this),control:this.getControl()})};_.prototype._convertToExternal=function(t){var e=s.getService("CrossApplicationNavigation");if(!e){return t}return e.hrefForExternal({target:{shellHash:t}},this._getComponent())};_.prototype._fireBeforePopoverOpens=function(e,i,n,a){var o=this;return new Promise(function(r){var s={semanticAttributes:e,appStateKey:undefined};if(!o.hasListeners("beforePopoverOpens")){r(s);return}var l=function(e){var i=Object.keys(e).filter(function(i){return!t.isEmptyObject(e[i])});return!!i.length};o.fireBeforePopoverOpens({originalId:n,semanticObject:i,semanticAttributes:!t.isEmptyObject(e[i])?e[i]:null,semanticAttributesOfSemanticObjects:l(e)?e:null,setSemanticAttributes:function(t,e){e=e||i;s.semanticAttributes=s.semanticAttributes||{};if(a){a.updateSemanticObjectAttributes(e,s.semanticAttributes[e],t)}s.semanticAttributes[e]=t},setAppStateKey:function(t){s.appStateKey=t},open:function(){return r(s)}})})};_.prototype._fireNavigationTargetsObtained=function(t,e,i,n,a,o,r){var s=this;return new Promise(function(l){var c={mainNavigationId:t,mainNavigation:o.mainNavigation,availableActions:o.availableActions,ownNavigation:o.ownNavigation,extraContent:a.length?new p({items:a}):undefined};if(!s.hasListeners("navigationTargetsObtained")){l(c);return}s.fireNavigationTargetsObtained({mainNavigation:o.mainNavigation,actions:o.availableActions,ownNavigation:o.ownNavigation,popoverForms:a,semanticObject:e,semanticAttributes:i?i[e]:i,originalId:n,show:function(t,e,i,n){if(arguments.length>0&&!(typeof t==="string"||e instanceof u||Array.isArray(i))&&n===undefined){n=i;i=e;e=t;t=undefined}if(t!==undefined&&t!==null){c.mainNavigationId=t}if(e!==undefined){c.mainNavigation=e;if(r&&e){r.addIntent({text:e.getText(),intent:e.getHref()})}}if(i){i.forEach(function(t){if(t.getKey()===undefined){P.error("'key' attribute of 'availableAction' '"+t.getText()+"' is undefined. Links without 'key' can not be persisted.");P.warning("The 'visible' attribute of 'availableAction' '"+t.getText()+"' is set to 'true'");t.setVisible(true)}if(r&&t){r.addIntent({text:t.getText(),intent:t.getHref()})}});c.availableActions=i}if(n){c.extraContent=n}return l(c)}})})};_.prototype._onNavigate=function(t){var e=t.getParameters();this._fireInnerNavigate({text:e.text,href:e.href,internalHref:e.internalHref})};_.prototype._fireInnerNavigate=function(t){var e=sap.ui.getCore().byId(this.getControl());var i=this.getSemanticObject();var n=this._getSemanticAttributes();if(this.getAdditionalSemanticObjects().length>0){var a=this.getAdditionalSemanticObjects().find(function(e){return t.href.includes(e)});if(a){i=a}}var o={text:t.text,href:t.href,originalId:e?e.getId():undefined,semanticObject:i,semanticAttributes:n?n[i]:n};if(this.getBeforeNavigationCallback()){this.getBeforeNavigationCallback()(A({},o)).then(function(e){if(e===true){o.internalHref=t.internalHref;this.fireInnerNavigate(o);if(!this.getSemanticObjectController()){if(t.internalHref){c.navigate(t.internalHref)}else{c.navigate(t.href)}}}}.bind(this))}else{o.internalHref=t.internalHref;this.fireInnerNavigate(o);if(!this.getSemanticObjectController()){if(t.internalHref){c.navigate(t.internalHref)}else{c.navigate(t.href)}}}};_.prototype._getComponent=function(t){if(!t){return null}var e=t.getParent();while(e){if(e instanceof C){if(e&&e.getAppComponent){e=e.getAppComponent()}return e}e=e.getParent()}return C.get(C.getOwnerIdFor(t))};_.prototype.getAppComponent=function(){return this._getComponent(sap.ui.getCore().byId(this.getControl()))};_.prototype._getBindingContextObject=function(){var t=sap.ui.getCore().byId(this.getControl());var e=this.getBindingContext()||t&&t.getBindingContext();return e?e.getObject(e.getPath()):null};_.prototype._getLogFormattedText=function(){return this._oLog?this._oLog.getFormattedText():"No logging data available"};_.prototype._calculateSemanticAttributes=function(t,e){var i=this._getBindingContextObject();var n=this.getFieldName();var a=this;var o=["",this.getSemanticObject()].concat(this.getAdditionalSemanticObjects());var r={};o.forEach(function(o){r[o]={};var s=a._getMappingRules(o,t,i);for(var l in i){var c=null,p=null;if(e&&o){c={transformations:[]};e.addSemanticObjectAttribute(o,l,c)}if(i[l]===undefined||i[l]===null){if(c){c.transformations.push({value:i[l],description:"ℹ Undefined and null values have been removed in NavigationPopoverHandler."})}continue}if(N(i[l])){if(c){c.transformations.push({value:i[l],description:"ℹ Plain objects has been removed in NavigationPopoverHandler."})}continue}var u=s[l];if(c&&l!==u){p=t?{value:undefined,description:"ℹ The attribute "+l+" has been renamed to "+u+" in NavigationPopoverHandler.",reason:"🔴 A com.sap.vocabularies.Common.v1.SemanticObjectMapping annotation is defined for semantic object "+o+" with source attribute "+l+" and target attribute "+u+". You can modify the annotation if the mapping result is not what you expected."}:{value:undefined,description:"ℹ The attribute "+l+" has been renamed to "+u+" in NavigationPopoverHandler.",reason:"🔴 The property mapFieldToSemanticObject is set to true. Attribute "+l+" is mapped to "+u+". (semantic object is "+a.getSemanticObject()+", field name is "+a.getFieldName()+"). If this is not what you expected, you can set the property to false or define a com.sap.vocabularies.Common.v1.SemanticObjectMapping annotation."}}var g=i[l];if(r[o][u]){if(i[n]){if(u===s[a.getFieldName()]){g=i[n]}else{P.error("The attribute "+l+" can not be renamed to the attribute "+u+" due to a clash situation. This can lead to wrong navigation later on.")}}}r[o][u]=g;if(c){c.transformations.push({value:i[l],description:"ℹ The attribute "+l+" with the value "+i[l]+" is taken from the binding context in NavigationPopoverHandler."});if(p){c.transformations.push(p);e.addSemanticObjectAttribute(o,u,{transformations:[{value:g,description:"ℹ The attribute "+u+" with the value "+g+" has been added due to a mapping rule regarding the attribute "+l+" in NavigationPopoverHandler."}]})}}}});return r};_.prototype._getMappingRules=function(t,e,i){var n=this.getMapFieldToSemanticObject();if(this.getSemanticObjectController()&&this.getSemanticObjectController().getMapFieldToSemanticObject()!==undefined){n=this.getSemanticObjectController().getMapFieldToSemanticObject()}var a;var o={};if(e){for(a in e[t]){if(typeof e[t][a]==="string"){o[a]=e[t][a]}}}else if(n){if(this.getSemanticObjectController()){var r=this.getSemanticObjectController().getFieldSemanticObjectMap();for(a in r){o[a]=r[a]}}if(this.getFieldName()&&this.getSemanticObject()){o[this.getFieldName()]=this.getSemanticObject()}}for(a in i){if(!o.hasOwnProperty(a)){o[a]=a}}return o};_.prototype._updateSemanticObjectController=function(t){var e=this.getProperty("semanticObjectController");var i=sap.ui.getCore().byId(this.getControl());t=t||this.getSemanticObjectController()||this._getSemanticObjectControllerOfControl(i);if(t&&i&&t.isControlRegistered(i)){t.unregisterControl(this)}if(t!==e&&e){e.unregisterControl(this)}this.setProperty("semanticObjectController",t);if(t&&!t.isControlRegistered(i)){t.registerControl(this)}};_.prototype._getSemanticObjectControllerOfControl=function(t){if(!t){return undefined}var e;var i=t.getParent();while(i){if(i.getSemanticObjectController){e=i.getSemanticObjectController();if(e){this.setSemanticObjectController(e);break}}i=i.getParent()}return e};_.prototype._updateVisibilityOfAvailableActions=function(t){if(!this._getEnableAvailableActionsPersonalization(t)){return t}var e=c.getStorableAvailableActions(t);var i=e.some(function(t){return!!t.isSuperiorAction});e.forEach(function(e){if(t.length>10){e.visible=false}if(i){e.visible=false}if(e.isSuperiorAction){e.visible=true}});if(t.every(function(t){return!t.visible})){if(t[0]){t[0].visible=true}if(t[1]){t[1].visible=true}if(t[2]){t[2].visible=true}}return t};_.prototype._getEnableAvailableActionsPersonalization=function(t){var e=c.getStorableAvailableActions(t);if(e.length===0){return false}var i=this.getEnableAvailableActionsPersonalization();if(this.getSemanticObjectController()&&this.getSemanticObjectController().getEnableAvailableActionsPersonalization()&&this.getSemanticObjectController().getEnableAvailableActionsPersonalization()[this.getFieldName()]!==undefined){i=this.getSemanticObjectController().getEnableAvailableActionsPersonalization()[this.getFieldName()]}return i};return _});