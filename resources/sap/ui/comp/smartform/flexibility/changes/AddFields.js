/*!
 * SAPUI5
 * (c) Copyright 2009-2022 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/fl/changeHandler/Base","sap/ui/fl/apply/api/DelegateMediatorAPI","sap/ui/core/util/reflection/JsControlTreeModifier","sap/base/util/merge","sap/base/util/ObjectPath"],function(e,t,n,r,o){"use strict";function i(e){return typeof e==="function"}function a(e,t){return e+"-element"+t}function l(e){var t=false;t=e.content.field&&(e.content.field.selector||e.content.field.id)&&e.content.field.jsTypes&&e.content.field.value&&e.content.field.valueProperty;if(!t){throw new Error("Change does not contain sufficient information to be applied: ["+e.layer+"]"+e.namespace+"/"+e.fileName+"."+e.fileType)}}function f(e,t){var n=r({},e);n.fieldSelector.id=a(n.fieldSelector.id,0);return t.createControlForProperty(n).then(function(n){var r=e.modifier.getId(n.control);e.labelFor=r;return t.createLabel(e).then(function(e){return{label:e,control:n.control}})})}function u(e,t){var n=r({aggregationName:"formElements",payload:e.payload||{}},t);var a=e.instance;return Promise.resolve().then(function(){if(i(a.createLayout)){return a.createLayout(n)}}).then(function(e){if(o.get("control",e)){e.layoutControl=true;return e}return f(n,a)})}var d={};d.applyChange=function(t,n,r){var o=t.getDefinition();var i=t.getContent();var a=r.modifier;var f=r.appComponent;var u=i.field.selector;var c=r.view;var s=i.field.id;if(a.bySelector(u||s,f,c)){return e.markAsNotApplicable("Control to be created already exists:"+u||s,true)}var g=i.field.index;var p=t.getDependentControl("form",r);var v=p&&a.getFlexDelegate(p);if(!v){l(o);var h;return Promise.resolve().then(a.createControl.bind(a,"sap.ui.comp.smartform.GroupElement",f,c,u||s)).then(function(e){h=e;if(!u){u=a.getSelector(s,f)}t.setRevertData({newFieldSelector:u});return i.field.jsTypes.reduce(function(e,t,n){var r=i.field.valueProperty[n];var o=i.field.value[n];var l=i.field.entitySet;return e.then(this.addElementIntoGroupElement.bind(this,a,c,h,t,r,o,l,n,f))}.bind(this),Promise.resolve())}.bind(this)).then(function(){return a.insertAggregation(n,"groupElements",h,g)})}return d._addFieldFromDelegate(p,n,u,s,g,i.field.value[0],t,a,c,f)};d._addFieldFromDelegate=function(e,n,r,o,i,a,l,f,d,c){var s;var g;return t.getDelegateForControl({control:e,modifier:f}).then(function(t){var n={appComponent:c,view:d,fieldSelector:r||o,bindingPath:a,modifier:f,element:e};return u(t,n)}).then(function(e){g=e;if(!g.layoutControl){return Promise.resolve().then(f.createControl.bind(f,"sap.ui.comp.smartform.GroupElement",c,d,r||o)).then(function(e){s=e;return Promise.resolve().then(f.insertAggregation.bind(f,s,"label",g.label,0,d)).then(f.insertAggregation.bind(f,s,"fields",g.control,0,d)).then(function(){return s})})}return g.control}).then(function(e){return f.insertAggregation(n,"groupElements",e,i,d)}).then(function(){if(g.valueHelp){return f.insertAggregation(e,"dependents",g.valueHelp,0,d)}}).then(function(){if(!r){r=f.getSelector(o,c)}l.setRevertData({newFieldSelector:r,valueHelpSelector:g.valueHelp&&f.getSelector(g.valueHelp,c)})})};d.addElementIntoGroupElement=function(t,n,r,o,i,l,f,u,d){var c;var s=t.getId(r);var g=a(s,u);return Promise.resolve().then(t.createControl.bind(t,o,d,n,g)).then(function(e){c=e;t.bindProperty(c,i,l);t.setProperty(c,"expandNavigationProperties",true);return t.insertAggregation(r,"elements",c,u,n,true)}).then(function(){if(f){t.setProperty(c,"entitySet",f)}}).catch(function(t){return e.markAsNotApplicable(t&&t.message||"Control couldn't be created",true)})};d.completeChangeContent=function(e,t,r){var o=r.appComponent;var i=e.getDefinition();if(!i.content){i.content={}}if(!i.content.field){i.content.field={}}if(t.fieldValues){i.content.field.value=t.fieldValues}else if(t.bindingPath){i.content.field.value=[t.bindingPath]}else{throw new Error("oSpecificChangeInfo.fieldValue or bindingPath attribute required")}if(t.valueProperty){i.content.field.valueProperty=t.valueProperty}else if(t.bindingPath){i.content.field.valueProperty=["value"]}else{throw new Error("oSpecificChangeInfo.valueProperty or bindingPath attribute required")}if(t.newControlId){i.content.field.selector=n.getSelector(t.newControlId,o)}else{throw new Error("oSpecificChangeInfo.newControlId attribute required")}if(t.jsTypes){i.content.field.jsTypes=t.jsTypes}else if(t.bindingPath){i.content.field.jsTypes=["sap.ui.comp.smartfield.SmartField"]}else{throw new Error("oSpecificChangeInfo.jsTypes or bindingPath attribute required")}if(t.index===undefined){throw new Error("oSpecificChangeInfo.index attribute required")}else{i.content.field.index=t.index}if(t.entitySet){i.content.field.entitySet=t.entitySet}if(t.relevantContainerId){e.addDependentControl(t.relevantContainerId,"form",r)}};d.revertChange=function(e,t,n){var r=n.appComponent;var o=n.view;var i=n.modifier;var a=e.getRevertData();var l=a.newFieldSelector;var f=i.bySelector(l,r,o);return Promise.resolve().then(i.removeAggregation.bind(i,t,"groupElements",f)).then(function(){i.destroy(f);var t=a.valueHelpSelector;if(t){var l=i.bySelector(t,r,o);var u=e.getDependentControl("form",n);return Promise.resolve().then(i.removeAggregation.bind(i,u,"dependents",l)).then(function(){i.destroy(l)})}}).then(function(){e.resetRevertData()})};d.getCondenserInfo=function(e){return{affectedControl:e.getContent().field.selector,classification:sap.ui.fl.condenser.Classification.Create,targetContainer:e.getSelector(),targetAggregation:"groupElements",setTargetIndex:function(e,t){e.getContent().field.index=t},getTargetIndex:function(e){return e.getContent().field.index}}};d.getChangeVisualizationInfo=function(e){return{affectedControls:[e.getContent().field.selector]}};return d},true);