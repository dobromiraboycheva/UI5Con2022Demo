/*!
 * SAPUI5
 * (c) Copyright 2009-2022 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/fl/changeHandler/Base","sap/ui/comp/smartform/flexibility/changes/RenameField"],function(e,n){"use strict";var t={};function r(e,n,t){return Promise.all(n.map(function(n){if(!t.found){t.index++;return e.getProperty(n,"mandatory").then(function(e){t.found=t.found||e})}return undefined}))}function o(e,n){var t={found:false,index:-1};return n.reduce(function(n,o){return n.then(e.getAggregation.bind(e,o,"fields")).then(function(n){if(!t.found){return r(e,n,t)}return undefined})},Promise.resolve()).then(function(){return t.found?t.index:-1})}t._getPreviousLabelPropertyOnControl=function(e,n,t){return Promise.resolve().then(n.getProperty.bind(n,e,t)).then(function(r){if(r&&typeof r!=="string"){t="text";e=r}return n.getPropertyBindingOrProperty(e,t)}).then(function(e){return e?e:"$$Handled_Internally$$"})};function i(e){return!!e.content.newElementId}function l(e,n,t){var r=e.modifier;var o=e.appComponent;var l=e.view;if(i(n)){return r.getAggregation(t,"dependents").then(function(i){var u=i.find(function(e){return r.bySelector(n.content.newElementId,o,l)});if(u){return r.removeAggregation(t,"dependents",u).then(function(){return u})}return r.createControl("sap.ui.comp.smartform.GroupElement",e.appComponent,e.view,n.content.newElementId)})}return Promise.resolve(r.bySelector(n.content.sourceSelector,o,l))}function u(e,n,t,r){return r.getAggregation(e,"groupElements").then(function(e){var r=e.indexOf(n);return t.reduce(function(n,t){var o=e.indexOf(t);if(o>-1&&o<r){n=n-1}return n},r)})}function a(e,n,t,r,o,i,l){if(o.content.newElementId||e!==n){var u=t.getParent(e);return l.reduce(function(o,l,u){return o.then(t.removeAggregation.bind(t,e,"elements",l)).then(t.insertAggregation.bind(t,n,"elements",l,i+u,r))},Promise.resolve()).then(t.removeAggregation.bind(t,u,"groupElements",e)).then(t.insertAggregation.bind(t,u,"dependents",e,0,r)).then(function(){return i+(l.length||0)})}return Promise.resolve(0)}t.applyChange=function(e,t,r){var c=e.getDefinition();var g=r.modifier;var f=r.appComponent;var s=r.view;var d=g.bySelector(c.content.sourceSelector,f,s);var m=g.getParent(d);var v=[];var p;var h;var b;var S;var P=c.content.combineFieldSelectors.map(function(e){return g.bySelector(e,f,s)});return l(r,c,m).then(function(e){if(e){return u(m,d,P,g).then(function(n){if(n>-1){S=n;d=e}}).then(this._collectRevertDataForElements.bind(this,g,P,f,e,m))}return this._collectRevertDataForElements(g,P,f)}.bind(this)).then(function(e){b=e}).then(function(){return o(g,P).then(function(e){if(e>0){g.setProperty(d,"elementForLabel",e)}})}).then(function(){var e=sap.ui.getCore().getConfiguration().getRTL();var n=0;return P.reduce(function(t,r,o){return t.then(function(t){n=n+t;var i="fieldLabel"+o.toString();h=c.texts[i];if(h&&h.value!==p&&h.value.length>0){if(e){v.unshift(h.value)}else{v.push(h.value)}p=h.value}return g.getAggregation(r,"elements")}).then(function(e){return a(r,d,g,s,c,n,e)})},Promise.resolve(0))}).then(function(){return n.setLabelPropertyOnControl(d,v.join("/"),g,"label")}).then(function(){if(i(c)){return g.insertAggregation(m,"groupElements",d,S,s)}return undefined}).then(function(){e.setRevertData(b)})};t._collectRevertDataForElements=function(e,n,t,r,o){var i={elementStates:[]};var l=0;var u=0;var a=[];if(r){a.push(r);a=a.concat(n)}return Promise.all(a.map(function(n){var r=e.getParent(n)||o;return Promise.all([e.getAggregation(n,"elements"),e.getAggregation(r,"groupElements"),this._getPreviousLabelPropertyOnControl(n,e,"label"),e.getProperty(n,"elementForLabel")]).then(function(o){u=l+o[0].length-1;i.elementStates.push({groupElementSelector:e.getSelector(e.getId(n),t),parentSelector:e.getSelector(e.getId(r),t),groupElementIndex:o[1].indexOf(n),firstFieldIndex:l,lastFieldIndex:u,label:o[2],elementForLabel:o[3]});l=u+1})}.bind(this))).then(function(){return i})};t.revertChange=function(e,t,r){var o=e.getRevertData();var l=r.modifier;var u=r.appComponent;var a=[];o.elementStates=o.elementStates.sort(function(e,n){return e.groupElementIndex-n.groupElementIndex});return o.elementStates.reduce(function(n,t){var r=l.bySelector(t.parentSelector,u);var o=l.bySelector(t.groupElementSelector,u);return n.then(l.getAggregation.bind(l,r,"groupElements")).then(function(n){if(n.indexOf(o)===-1){return Promise.resolve().then(l.removeAggregation.bind(l,r,"dependents",o)).then(l.insertAggregation.bind(l,r,"groupElements",o,t.groupElementIndex))}else{return Promise.resolve().then(l.getAggregation.bind(l,o,"elements")).then(function(e){a=e;return l.removeAllAggregation(o,"elements")}).then(function(){if(i(e.getDefinition())){return l.removeAggregation(r,"groupElements",o).then(l.insertAggregation.bind(l,r,"dependents",o))}return undefined})}})},Promise.resolve()).then(function(){return o.elementStates.reduce(function(e,t){var r;var o;return e.then(function(){r=l.bySelector(t.groupElementSelector,u);var e=[];for(var n=t.firstFieldIndex;n<=t.lastFieldIndex;n++){e.push(l.insertAggregation(r,"elements",a[n],a.length))}return Promise.all(e)}).then(function(){o=t.label;if(o==="$$Handled_Internally$$"){o=undefined;return l.getAggregation(r,"fields")}return undefined}).then(function(e){if(e&&e.length){var i=e[t.elementForLabel];l.setProperty(i,"textLabel",undefined)}l.setProperty(r,"elementForLabel",t.elementForLabel);return n.setLabelPropertyOnControl(r,o,l,"label")})},Promise.resolve())}).then(e.resetRevertData.bind(e))};t.completeChangeContent=function(n,t,r){var o=r.modifier;var i=r.view;var l=r.appComponent;var u=n.getDefinition();if(t.newElementId){u.content.newElementId=t.newElementId}var a=t.combineElementIds;if(a&&a.length>=2){u.content.combineFieldSelectors=a.map(function(e){return o.getSelector(e,l)});n.addDependentControl(a,"combinedFields",r)}else{throw new Error("oSpecificChangeInfo.combineElementIds attribute required")}if(t.sourceControlId){u.content.sourceSelector=o.getSelector(t.sourceControlId,l);n.addDependentControl(t.sourceControlId,"sourceControl",r)}else{throw new Error("oSpecificChangeInfo.sourceControlId attribute required")}var c;var g;var f;for(var s=0;s<u.content.combineFieldSelectors.length;s++){var d=u.content.combineFieldSelectors[s];f=o.bySelector(d,l,i);c=f.getLabelText();if(c){g="fieldLabel"+s;e.setTextInChange(u,g,c,"XFLD")}}};t.getChangeVisualizationInfo=function(e){return{affectedControls:[e.getDefinition().content.sourceSelector]}};return t},true);