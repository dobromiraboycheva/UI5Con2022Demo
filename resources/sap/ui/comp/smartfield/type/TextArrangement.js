/*
 * SAPUI5
 * (c) Copyright 2009-2022 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/core/Core","sap/ui/model/CompositeType","sap/ui/comp/util/FormatUtil","sap/ui/model/ParseException","sap/ui/model/ValidateException","sap/base/util/isPlainObject","sap/base/assert"],function(t,e,i,r,n,a,s){"use strict";var o=e.extend("sap.ui.comp.smartfield.type.TextArrangement",{constructor:function(t,i,r){this.getPrimaryType().call(this,t,i);e.call(this,t,i);this.init(t,i,r);s(r.keyField!==undefined,"Missing value for the keyField. - "+this.getName());s(r.descriptionField!==undefined,"Missing value for the descriptionField. - "+this.getName())},metadata:{abstract:true}});o.prototype.init=function(t,e,i){this.sName="TextArrangement";this.bParseWithValues=true;this.async=true;var r={textArrangement:"idOnly"};var n={onBeforeValidateValue:function(){}};this.oSettings=Object.assign(n,i);this.oFormatOptions=Object.assign(r,t);this.fnParser=this.getValidator({textArrangement:this.oFormatOptions.textArrangement,prefix:"parse"});this.fnValidator=this.getValidator({textArrangement:this.oFormatOptions.textArrangement,prefix:"validate"});this.bValueListNoValidation=i.valueListNoValidation};o.prototype.parseValue=function(t,e,i){var r,n=this.oFormatOptions.textArrangement;if(typeof t==="string"){t=t.replace(/\s+$/,"")}if(t===""||n==="idOnly"){r=this.parseIDOnly(t,e)}else{r=this.fnParser(t,e,i,this.oFormatOptions,this.oSettings)}if(r[0]&&r[0].toUpperCase&&this.oFormatOptions.displayFormat==="UpperCase"){r[0]=r[0].toUpperCase()}return r};o.prototype.parseIDOnly=function(t,e){t=this.getPrimaryType().prototype.parseValue.call(this,t,e);return[t,undefined]};o.prototype.parseIDAndDescription=function(t,e,i,r){var n;if(r&&r.textArrangement==="idAndDescription"){n=/^([\S\s]+?)\s\([\S\s]+\)$/.exec(t)}else{n=/^[\S\s]+\s\(([\S\s]+?)\)$/.exec(t)}if(Array.isArray(n)&&n[1]){t=n[1]}return this.parseIDOnly(t,e)};o.prototype.parseDescriptionOnly=function(t,e,i,r,a){return new Promise(function(i,r){if(t===null||t===""){return i([t,""])}if(t&&t.toUpperCase&&this.oFormatOptions.displayFormat==="UpperCase"){t=t.toUpperCase()}function s(s){var o,p=a.keyField,u=a.descriptionField;var d=l(t,{key:u,value:p,data:s});var f=d.length;if(f===1){o=this.getPrimaryType().prototype.parseValue.call(this,d[0],e);i([o,undefined]);return}if(f===0){d=l(t,{key:p,value:u,data:s});f=d.length}if(!this.bValueListNoValidation){if(f===0){r(new n(this.getResourceBundleText("SMARTFIELD_NOT_FOUND")));return}if(f>1){r(new n(this.getResourceBundleText("SMARTFIELD_DUPLICATE_VALUES")));return}}o=this.getPrimaryType().prototype.parseValue.call(this,t,e);i([o,undefined])}function o(t){r(new n(this.getResourceBundleText("SMARTFIELD_INVALID_ENTRY")))}var p={filterFields:this.getFilterFields(),success:s.bind(this),error:o.bind(this)};this.onBeforeValidateValue(t,p)}.bind(this))};o.prototype.validateValue=function(t,e){this.validateIDOnly(t);var i=t[0];if(i===null){return}if(this.oFormatOptions.textArrangement==="descriptionOnly"){this.validateDescriptionOnly(t,this.oSettings);return}if(this.oFormatOptions.textArrangement==="idOnly"){this.validateIDOnly(t,this.oSettings);return}var r=new Promise(function(r,a){function s(e){var i=Object.assign({},this.oSettings,{data:e,reject:a});var n=this.fnValidator(t,i);if(n){r(t)}}function o(t){a(new n(this.getResourceBundleText("SMARTFIELD_INVALID_ENTRY")))}var l={filterFields:this.getFilterFields(),success:s.bind(this),error:o.bind(this),bCheckValuesValidity:e};this.onBeforeValidateValue(i,l)}.bind(this));if(this.bValueListNoValidation){return}else{return r}};o.prototype.validateIDOnly=function(t){this.getPrimaryType().prototype.validateValue.call(this,t[0])};o.prototype.validateIDAndDescription=function(t,e){var i={key:e.keyField,value:e.descriptionField,data:e.data};if(this.oFormatOptions&&this.oFormatOptions.displayFormat){i.displayFormat=this.oFormatOptions.displayFormat}var r=l(t[0],i);var a=e.reject;if(!this.bValueListNoValidation){if(r.length===0){a(new n(this.getResourceBundleText("SMARTFIELD_NOT_FOUND")));return false}if(r.length>1){a(new n(this.getResourceBundleText("SMARTFIELD_DUPLICATE_VALUES")));return false}}return true};o.prototype.validateDescriptionOnly=function(t,e){};o.prototype.formatValue=function(t,e){var r;if(!Array.isArray(t)){return t}if(this.bValueListNoValidation&&t[1]===undefined){t.splice(1,1)}r=this.getPrimaryType().prototype.formatValue.call(this,t[0],e);if(r===""||r===null){return r}if(r&&this.oFormatOptions.displayFormat==="UpperCase"){r=r.toUpperCase()}var n=t[1];if(n===""&&this.oFormatOptions.textArrangement!=="idOnly"&&this.oSettings.delegate){this.oSettings.delegate._sTextArrangementLastReadValue=null}if(!n&&this.oFormatOptions.textArrangement==="descriptionOnly"){return r}if(a(n)){n=""}return i.getFormattedExpressionFromDisplayBehaviour(this.oFormatOptions.textArrangement,r,n)};o.prototype.destroy=function(){this.oFormatOptions=null;this.oSettings=null;this.fnParser=null;this.fnValidator=null};o.prototype.getName=function(){return"sap.ui.comp.smartfield.type.TextArrangement"};o.prototype.onBeforeValidateValue=function(t,e){this.oSettings.onBeforeValidateValue(t,e)};o.prototype.getResourceBundleText=function(e,i){return t.getLibraryResourceBundle("sap.ui.comp").getText(e,i)};o.prototype.getPrimaryType=function(){};o.prototype.getValidator=function(t){switch(t.textArrangement){case"idAndDescription":case"descriptionAndId":return this[t.prefix+"IDAndDescription"];case"descriptionOnly":return this[t.prefix+"DescriptionOnly"];default:return this[t.prefix+"IDOnly"]}};o.prototype.getFilterFields=function(t){return["keyField"]};function l(t,e){var i=[];if(e.displayFormat==="UpperCase"){t=t.toLowerCase()}e.data.forEach(function(r,n,a){var s=e.displayFormat==="UpperCase"?r[e.key].toLowerCase():r[e.key];if(s===t){i.push(r[e.value])}});return i}return o});