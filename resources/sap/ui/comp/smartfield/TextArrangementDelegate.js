/*!
 * SAPUI5
 * (c) Copyright 2009-2022 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/comp/library","sap/ui/base/Object","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/base/assert"],function(t,e,i,r,a){"use strict";var o=t.smartfield.TextInEditModeSource;var n=e.extend("sap.ui.comp.smartfield.TextArrangementDelegate",{constructor:function(t){e.apply(this,arguments);this.oTextArrangementType=null;this.oFactory=t;this.oSmartField=t._oParent;this.bValidMetadata=false;this.sBindingContextPath="";this._mOneTimeDescriptionCache=new Map}});n.prototype.setValue=function(t,e){var i=this.oSmartField,r=i._oControl;if(this.bValidMetadata&&t!==e&&r){var a=r[r.current],n=a&&a.getBinding("value");if(!n){return}var s=i.isPropertyBeingUpdatedByModel("value");switch(i._getComputedTextInEditModeSource()){case o.NavigationProperty:var l=!!i.getModel().getData(n.getBindings()[1].getPath(),i.getBindingContext(),true);if(s&&!l||!s){a.setValue(t)}return;case o.ValueList:case o.ValueListNoValidation:if(!s){a.setValue(t)}else if(this._sTextArrangementLastReadValue!==t){this.fetchIDAndDescriptionCollectionIfRequired()}return}}};n.getPaths=function(t,e){var i=e.property&&e.property.valueListAnnotation;switch(t){case o.NavigationProperty:var r=e.annotations.text;if(!r){return{}}return{keyField:r.entityType.key.propertyRef[0].name,descriptionField:r.property.typePath,entitySetName:r.entitySet.name};case o.ValueList:if(!i){return{}}return{keyField:i.keyField,descriptionField:i.descriptionField,entitySetName:e.property.valueListEntitySet&&e.property.valueListEntitySet.name};case o.ValueListNoValidation:if(!i){return{}}return{valueListNoValidation:true,keyField:i.keyField,descriptionField:i.descriptionField,entitySetName:e.property.valueListEntitySet.name}}};n.prototype.getBindingInfo=function(t){var e,i=t.valueListNoValidation,r={},a=this.oSmartField,s=this.oFactory,l=s._oMetaData;this.oTextArrangementType=t&&t.type;if(!this.oTextArrangementType){var d=a.getBindingInfo("value");this.oTextArrangementType=d&&d.type||{};var u=n.getPaths(s._bTextInDisplayModeValueList?o.ValueList:a._getComputedTextInEditModeSource(),l);this.oTextArrangementType=s._oTypes.getType(l.property,Object.assign(r,this.oTextArrangementType.oFormatOptions),this.oTextArrangementType.oConstraints,{composite:true,keyField:u.keyField,descriptionField:u.descriptionField,valueListNoValidation:i,delegate:this})}var p=this.oSmartField.getBinding("value").getValue(),y=a._getComputedTextInEditModeSource(),c=n.getPaths(this.oFactory._bTextInDisplayModeValueList?o.ValueList:y,l);var h=this.getTextAnnotationPropertyPath({entitySet:{name:c.entitySetName},entityID:p});if(h===""||h.indexOf("undefined")!==-1){h="__$$SmartFieldNotExistingBindingPath"}e={model:l.model,type:this.oTextArrangementType,parts:[{path:l.path},{path:h}]};return e};n.prototype.getTextAnnotationPropertyPath=function(t){t=t||{};var e=t.textInEditModeSource||this.oSmartField._getComputedTextInEditModeSource(),i=this.oFactory,r=i._oMetaData;if(i._bTextInDisplayModeValueList){e=o.ValueList}switch(e){case o.NavigationProperty:var a=t.textAnnotation||r.annotations.text;return i._oHelper.getTextAnnotationPropertyPath(a);case o.ValueList:var n=t.edmValueListKeyProperty||r.property.valueListKeyProperty,s=t.bindingContextPath||this.sBindingContextPath;return i._oHelper.getAbsolutePropertyPathToValueListEntity({property:n,bindingContextPath:s,entitySet:t.entitySet,entityID:t.entityID});case o.ValueListNoValidation:var n=t&&t.edmValueListKeyProperty||r.property.valueListKeyProperty,s=t&&t.bindingContextPath||this.sBindingContextPath,a=t&&t.textAnnotation||r&&r.annotations&&r.annotations.text;if(a&&s!=="/undefined"&&this.oSmartField._isValueInitial()){var l=i._oHelper.getTextAnnotationPropertyPath(a);if(l&&l!==this.oFactory.getMetaData().path){return l}}return i._oHelper.getAbsolutePropertyPathToValueListEntity({property:n,bindingContextPath:s,entitySet:t.entitySet,entityID:t.entityID});case o.None:return"";default:return""}};n.prototype.checkRequiredMetadata=function(t,e){var i=this.oFactory,r=i._oMetaData;switch(t){case o.None:return false;case o.NavigationProperty:var a=r.annotations.text,n;if(a){n=a.entityType}var s={propertyName:r.property&&r.property.property&&r.property.property.name,entityType:r.entityType,entityTypeOfNavigationProperty:n,textAnnotation:r.property&&r.property.property&&r.property.property["com.sap.vocabularies.Common.v1.Text"]};if(e){return i._oHelper.checkNavigationPropertyRequiredMetadataNoAsserts(s)}else{return i._oHelper.checkNavigationPropertyRequiredMetadata(s)}case o.ValueList:case o.ValueListNoValidation:var l={propertyName:r.property&&r.property.property&&r.property.property.name,entityType:r.entityType,valueListAnnotation:r.property&&r.property.valueListAnnotation};if(e){return i._oHelper.checkValueListRequiredMetadataForTextArrangmentNoAsserts(l)}else{return i._oHelper.checkValueListRequiredMetadataForTextArrangment(l)}default:return false}};n.prototype.onBeforeValidateValue=function(t,e){var i=this.oSmartField;if(!i.getBindingContext()){return}var r=this.onFetchIDAndDescriptionCollectionSuccess.bind(this,{success:e.success});var a=this.onFetchIDAndDescriptionCollectionError.bind(this,{error:e.error});var o={value:t,success:r,error:a,filterFields:e.filterFields,bCheckValuesValidity:e.bCheckValuesValidity};this.fetchIDAndDescriptionCollection(o);var n=i._oControl.edit;if(n&&t){n.setBusyIndicatorDelay(300);n.setBusy(true)}};n.prototype.fetchIDAndDescriptionCollectionIfRequired=function(t){var e=this.oSmartField;var i=e.getMode();var r=e._getComputedTextInEditModeSource();var a=this.oFactory&&this.oFactory.getMetaData();var n=a&&a.annotations&&a.annotations.text;if(n&&(a&&n.path===a.path||this.sBindingContextPath==="/undefined"||!e._isValueInitial())){n=null}if(r===o.ValueList||!n&&r===o.ValueListNoValidation&&this.oFactory._getDisplayBehaviourConfiguration()!=="idOnly"||this.oFactory._bTextInDisplayModeValueList){var s="value",l=e.getModel(),d=e.getBindingContext(),u=e.getBinding(s).getPath(),p=l&&d&&u&&l.getProperty(u,d),y=p==null||p==="";if(!y&&(this._sTextArrangementLastReadValue!==p||!this.oTextArrangementType||t)){var c=["keyField"];var h={value:p,oldValue:p,updateBusyIndicator:false,initialRendering:true,mode:i};this.fetchIDAndDescriptionCollection({value:p,filterFields:c,success:this.onFetchIDAndDescriptionCollectionSuccess.bind(this,h)})}}};n.prototype.fetchIDAndDescriptionCollection=function(t){var e=t.value;if(e==null||e===""){return}if(t.bCheckValuesValidity){t.filterFields=["keyField"]}this.readODataModel(t)};n.prototype.readODataModel=function(t){var e=this.oSmartField,i,r,a,s=e._getComputedTextInEditModeSource(),l=e.getControlFactory().getMetaData(),d=n.getPaths(this.oFactory._bTextInDisplayModeValueList?o.ValueList:s,l),u="/"+d.entitySetName,p=l&&l.annotations&&l.annotations.valueListData||null,y=d.keyField,c=d.descriptionField,h=this.oFactory&&this.oFactory.getValueListProvider(),f=p&&p.valueListEntitySetName===d.entitySetName,g=f&&p&&p.outParams?Object.values(p.outParams):[];if(!c){return}this._sTextArrangementLastReadValue=t.value;a=this.getDataForNextDescriptionRequest(t.value);if(a&&a.hasOwnProperty(c)&&h&&h._shouldHaveHistory&&!h._shouldHaveHistory()){setTimeout(t.success.bind(this,{results:[a]}));return}r=this.getAdditionalFiltersData(e,l,a);var F={keyFieldPath:y,descriptionFieldPath:c,aFilterFields:t.filterFields};for(i in r){t.filterFields.push(i)}F.additionalFilters=r;var v=this.getFilters(t.value,F);var m=this.getUrlParameters({keyField:y,descriptionField:c,outParams:g});var D={filters:v,urlParameters:m};e._getTextArrangementRead().read(e.getModel(),u,D).then(t.success).catch(t.error)};n.prototype.getAdditionalFiltersData=function(t,e,i){var r,a,o,n,s,l={};if(typeof i==="undefined"){i={}}if(e&&e.annotations&&e.annotations.valueListData){a=e.annotations.valueListData.inParams;r=e.annotations.valueListData.constParams}if(r){for(o in r){l[o]=r[o]}}if(a){for(n in a){s=a[n];if(s!==e.annotations.valueListData.keyField){l[s]=i[s]!==undefined?i[s]:t.getBindingContext().getProperty(n)}}}return l};n.prototype._setBindingPath=function(t,e,i,r){var o=t.getModel(),n=t.getTextInEditModeSource()==="ValueListNoValidation"||t._getComputedTextInEditModeSource()==="ValueListNoValidation",s;a(Array.isArray(e.results)," - "+this.getMetadata().getName());if(o){if(e&&Array.isArray(e.results)&&e.results.length===1){s=o.getKey(e.results[0])}if(n&&e.results.length!==1){this.sBindingContextPath="/"+s;this.bindPropertyForValueList(i,r,true)}else if(typeof s==="string"){this.sBindingContextPath="/"+s;this.bindPropertyForValueList(i,r,false,n)}}};n.prototype.onFetchIDAndDescriptionCollectionSuccess=function(t,e,i){var r=this.oSmartField,a=e&&Array.isArray(e.results)&&e.results.length===1?e.results[0]:null,o=r&&r.getControlFactory()&&r.getControlFactory().getValueListProvider()||null;t=Object.assign({updateBusyIndicator:true},t);if(!r){return}var n=r._oControl.edit,s=n&&n.getBinding("value"),l=r._oControl.display||r._oControl.display_uom,d=t.mode||r.getMode();if(a&&o){o._calculateAndSetODataModelOutputData(a)}if(n&&t.updateBusyIndicator){n.setBusyIndicatorDelay(0);n.setBusy(false)}if(typeof t.success==="function"){t.success(e.results)}if((d==="display"||d==="display_uom")&&t.initialRendering){this._setBindingPath(r,e,"text",l)}if(s&&d==="edit"&&r.isTextInEditModeSourceNotNone()){this._setBindingPath(r,e,"value",n)}};n.prototype.onFetchIDAndDescriptionCollectionError=function(t,e){var i=this.oSmartField._oControl.edit;if(i){i.setBusyIndicatorDelay(0);i.setBusy(false)}if(typeof t.error==="function"){t.error(e)}};n.prototype.bindPropertyForValueList=function(t,e,i,r){var a=this.oSmartField,n={},s,l,d,u=a._getComputedTextInEditModeSource();if(u===o.ValueList||u===o.ValueListNoValidation||this.oFactory._bTextInDisplayModeValueList){l=e&&e.getBinding(t);if(this.oFactory&&l){d=l.getType();if((!d||!d.isA("sap.ui.comp.smartfield.type.TextArrangement"))&&this.oFactory._getTextArrangementType){s=this.oFactory._getTextArrangementType();if(s){d=s}}if(d){n={type:d}}n.skipValidation=i;n.bValueListNoValidation=r;e.bindProperty(t,this.getBindingInfo(n))}}};n.prototype.getUrlParameters=function(t){var e=[t.keyField,t.descriptionField];t.outParams.forEach(function(t){if(e.indexOf(t)===-1){e.push(t)}});return{$select:e.join(","),$top:2}};n.prototype.getFilters=function(t,e){this.destroyFilters();var r=e.aFilterFields,a;if(r.length===1){switch(r[0]){case"keyField":this.oIDFilter=s(t,e);return[this.oIDFilter];case"descriptionField":this.oDescriptionFilter=l(t,e);return[this.oDescriptionFilter]}}this.oIDFilter=s(t,e);a=this._getAdditionalFilters(e);this.oFilters=new i({and:true,filters:[new i({and:false,filters:[this.oIDFilter]})]});if(a.aFilters.length>0){this.oFilters.aFilters.push(a)}return[this.oFilters]};n.prototype.setDataForNextDescriptionRequest=function(t,e){this._mOneTimeDescriptionCache.set(t,e)};n.prototype.getDataForNextDescriptionRequest=function(t){var e=this._mOneTimeDescriptionCache.get(t);this._mOneTimeDescriptionCache.delete(t);return e};function s(t,e){return new i({value1:t,path:e.keyFieldPath,operator:r.EQ})}function l(t,e){return new i({value1:t,path:e.descriptionFieldPath,operator:r.Contains})}n.prototype._getAdditionalFilters=function(t){var e=[],r=this.oSmartField.getControlFactory().getMetaData(),a=r.annotations&&r.annotations.valueListData,o=a&&a.fields;Object.keys(t.additionalFilters).forEach(function(i){var r=t.additionalFilters[i],n=o.find(function(t){return t.name===i}),s=a.aInitialValueIsSignificantFields.indexOf(i)!==-1,l=this._generateFiltersForField(r,i,n,s);if(l){e.push(l)}}.bind(this));return new i({and:true,filters:e})};n.prototype._generateFiltersForField=function(t,e,a,o){if(t===null||t===undefined||t===""){if(o){return this._generateFiltersForEmptyField(e,a&&a.nullable==="false")}}else{return new i({value1:t,path:e,operator:r.EQ})}};n.prototype._generateFiltersForEmptyField=function(t,e){if(e){return new i({value1:"",path:t,operator:r.EQ})}return new i([new i({value1:"",path:t,operator:r.EQ}),new i({value1:null,path:t,operator:r.EQ})],false)};n.prototype.destroyFilters=function(){if(this.oIDFilter){this.oIDFilter.destroy();this.oIDFilter=null}if(this.oDescriptionFilter){this.oDescriptionFilter.destroy();this.oDescriptionFilter=null}if(this.oFilters){this.oFilters.destroy();this.oFilters=null}};n.prototype.destroy=function(){this.oSmartField=null;this.bValidMetadata=false;this.sBindingContextPath="";this._mOneTimeDescriptionCache=null;this.destroyFilters()};return n});