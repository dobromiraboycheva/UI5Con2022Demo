/*
 * SAPUI5
 * (c) Copyright 2009-2022 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/comp/library","sap/ui/comp/odata/MetadataAnalyser","sap/ui/comp/smartfield/AnnotationHelper","sap/base/Log","sap/ui/model/odata/_ODataMetaModelUtils","sap/ui/model/odata/ODataUtils","sap/base/assert"],function(t,e,n,i,a,o,r){"use strict";var p=t.TextArrangementType;var s=function(t,e,i){if(t){this.oMeta=t.getMetaModel()}if(i){this.oMeta=i}this._oModel=t;this._oUtil=e;this.oAnnotation=new n};s.prototype.getAnalyzer=function(t){if(!this._oAnalyzer){this._oAnalyzer=new e(this._oModel||t)}return this._oAnalyzer};s.prototype.checkNavigationProperty=function(t,e){var n,i,a,o;if(e&&t){n=this._oUtil.getNavigationProperties(e);a=n.paths.length;while(a--){i=n.paths.shift();i=this._oUtil.correctPath(i);if(i===""||i===t.entitySet.name){continue}o=this.getNavigationProperty(t.entityType,i);if(o.entitySet){t.entitySet=o.entitySet;t.entityType=o.entityType}}}};s.prototype.getNavigationProperty=function(t,e){var n=this._getNamedProperty(e,"navigationProperty",t),i,a,o={};if(n){i=this.oMeta.getODataAssociationSetEnd(t,n.name);if(i===null){return}a=this.getAssociation(t,n.name);if(a){o.toRoleAssociationEndMultiplicity=this.getToRoleAssociationEndMultiplicity(a.end,n.toRole)}o.entitySet=this.oMeta.getODataEntitySet(i.entitySet);if(o.entitySet){o.entityType=this.oMeta.getODataEntityType(o.entitySet.entityType)}}return o};s.prototype.startWithNavigationProperty=function(t,e){var n=t.split("/"),i;if(n&&n.length>1){i=this._getNamedProperty(n.shift(),"navigationProperty",e.entityType)}if(i){return i.name}return null};s.prototype.getProperty=function(t){var e=[],n,i,a,o,r,p={entityType:t.entityType,entitySet:t.entitySet};if(t){i=t.path.split("/");n=i.length;if(p&&n>1){while(p&&p.entityType){o=i[0];p=this.getNavigationProperty(p.entityType,o);if(p&&p.entityType){t.entityType=p.entityType;t.entitySet=p.entitySet;t.toRoleAssociationEndMultiplicity=p.toRoleAssociationEndMultiplicity;e.push(i.shift());n--}}}t.navigationPath=e.join("/");if(n>1){a=this.oMeta.getODataProperty(t.entityType,i[0]);if(a){t.property=this._getComplex(a,i,n)}return}if(t.navigationPath){r=t.path.replace(t.navigationPath+"/","")}else{r=t.path}a=this.oMeta.getODataProperty(t.entityType,r);t.property={property:a,typePath:t.path,valueListAnnotation:null,valueListKeyProperty:null,valueListEntitySet:null,valueListEntityType:null}}};s.prototype._getComplex=function(t,e,n){var i=t,a,o=[];while(n--){if(i){if(n===0){a=i.name;i=this._getNamedProperty(e[0],"property",i);return{typePath:a+"/"+e[0],property:i,complex:true,parents:o}}i=this.oMeta.getODataComplexType(i.type);if(i){o.push(i)}}e.shift()}};s.prototype._getNamedProperty=function(t,e,n){var i;if(n[e]){for(var a=0;a<n[e].length;a++){if(n[e][a].name===t){i=n[e][a];break}}}return i};s.prototype.getTextProperty2=function(t){var e,n;e=this.oAnnotation.getText(t.property.property);if(e){n=this._preprocAnnotation(e,t);this.getProperty(n);this._postprocAnnotation(n,t)}return n};s.prototype.getUnitOfMeasure2=function(t){var e,n;e=this.oAnnotation.getUnit(t.property.property);if(e){n=this._preprocAnnotation(e,t);this.getProperty(n);this._postprocAnnotation(n,t)}return n};s.prototype._preprocAnnotation=function(t,e){var n,i;i=this.traverseNavigationProperties(t,e.entityType);if(!i.navigationPath){i.entitySet=e.entitySet}if(e.navigationPath){i.path=e.path.replace(e.navigationPath+"/","")}else{i.path=e.path}if(i.navigationPath){n=t.replace(i.navigationPath+"/","")}else{n=t}i.path=i.path.replace(e.property.property.name,n);if(i.navigationPath){i.navigationPathHelp=i.navigationPath}return i};s.prototype._postprocAnnotation=function(t,e){var n;if(t.navigationPathHelp){t.navigationPath=t.navigationPathHelp}if(t.navigationPath){n=t.navigationPath}else{n=""}if(e.navigationPath){if(n){n=e.navigationPath+"/"+n}else{n=e.navigationPath}}t.navigationPath=n;if(t.navigationPath){t.path=t.navigationPath+"/"+t.path}};s.prototype.traverseNavigationProperties=function(t,e){var n={},i={},a,o,r;a=t.split("/");r=a.length;n.entityType=e;i.entityType=e;while(r--){o=a.shift();if(o===""){continue}i=this.getNavigationProperty(n.entityType,o);if(!i.entitySet){break}n.entityType=i.entityType;n.entitySet=i.entitySet;if(n.navigationPath){n.navigationPath=n.navigationPath+"/"+o}else{n.navigationPath=o}}return n};s.prototype.getValueListAnnotationPath=function(t){var e,n,i=this.getEdmProperty(t),a=i?i.name:"";if(t&&t.property&&t.property.complex){n=t.property.parents.length-1;e=t.property.parents[n].namespace;e=e+"."+t.property.typePath}else if(t&&t.entitySet&&i){e=t.entitySet.entityType+"/"+a}return e};s.prototype.getUOMValueListAnnotationPath=function(t){var e;if(t.annotations.uom){e=this.getValueListAnnotationPath(t.annotations.uom)}if(e){t.annotations.valuelistuom=e}};s.prototype.getUOMTextAnnotation=function(t){if(t&&t.annotations&&t.annotations.uom){t.annotations.textuom=this.getTextProperty2(t.annotations.uom)}};s.prototype.geValueListEntitySet=function(t){if(t&&t.annotations&&t.annotations.valuelist){if(t.annotations.valuelist.primaryValueListAnnotation&&t.annotations.valuelist.primaryValueListAnnotation.valueListEntitySetName){t.annotations.valuelistentityset=this.oMeta.getODataEntitySet(t.annotations.valuelist.primaryValueListAnnotation.valueListEntitySetName)}}};s.prototype.getEdmProperty=function(t){var e=t.property;return e&&e.property||null};s.prototype.getValueListData=function(t){var n=this.getEdmProperty(t),i=t.annotations;if(e.isValueList(n)){i.valuelist=this.getValueListAnnotationPath(t);var a=e.getValueListMode(n);if(a){i.valuelistType=a}else{i.valuelistType=this.getAnalyzer().getValueListSemantics(n["com.sap.vocabularies.Common.v1.ValueList"])}}};s.prototype.findProperty=function(t,e){return a.findObject(t,e)};s.prototype.getAssociation=function(t,e){var n;if(t){n=this.findProperty(t.navigationProperty,e)}if(n&&this.oMeta.oModel){return a.getObject(this.oMeta.oModel,"association",n.relationship)}return null};s.prototype.getToRoleAssociationEnd=function(t,e){if(Array.isArray(t)){for(var n=0;n<t.length;n++){var i=t[n];if(i.role===e){return i}}}return null};s.prototype.getToRoleAssociationEndMultiplicity=function(t,e){var n=this.getToRoleAssociationEnd(t,e);return n?n.multiplicity:""};s.prototype.checkNavigationPropertyRequiredMetadata=function(t){var e=t.propertyName,n=t.textAnnotation,a=n?n.Path:"",o=t.entityType,s=o.namespace+"."+o.name,l="sap.ui.comp.smartfield.ODataHelper",y="com.sap.vocabularies.Common.v1.Text";if(!n){i.info('Missing "'+y+'" annotation for "'+e+'" EDM property of "'+s+'" entity type.',l);return false}if(a===undefined){r(false,'Missing "Path" attribute of "'+y+'" annotation for "'+e+'" EDM property of "'+s+'" entity type. - '+l);return false}if(a===""){r(false,'Missing URL path name of "'+y+'" annotation for "'+e+'" EDM property of "'+s+'" entity type. - '+l);return false}var f="com.sap.vocabularies.UI.v1.TextArrangement",u=n[f];if(!u){i.info('Missing "'+f+'" annotation for "'+e+'" EDM property of "'+s+'" entity type.',l);return false}var h=u.EnumMember;if(h===undefined){r(false,'Missing "EnumMember" attribute of "'+f+'" annotation for "'+e+'" EDM property of "'+s+'" entity type. - '+l);return false}if(!(h.split("/")[1]in p)){r(false,'Invalid "'+h+'" Text annotation enumeration member for "'+e+'" EDM property of "'+s+'" entity type. - '+l);return false}if(u.EnumMember===p.TextSeparate){return false}if(a.indexOf("/")===-1){r(false,'Invalid navigation property URL path name specified in the "'+y+'" annotation of the "'+e+'" EDM property of the "'+s+'" entity type. - '+l);return false}var c=a.split("/")[0],g=this.findProperty(o.navigationProperty,c);if(!g){r(false,'The navigation property URL path name "'+c+'" (specified in the Text annotation of the "'+e+'" EDM property) was not found in the "'+s+'" entity type of the service metadata document. - '+l);return false}var v=this.getAssociation(o,c);if(!v){r(false,'Missing "'+g.relationship+'" association for "'+g.name+'" EDM navigation property of the "'+s+'" entity type. - '+l);return false}var d=v.referentialConstraint;if(!d){r(false,'Missing referential constraint for "'+g.relationship+'" association in the service metadata document. - '+l);return false}if(!Array.isArray(v.end)||!(v.end.length>0)){r(false,'Missing association end for "'+g.relationship+'" association in the service metadata document. - '+l);return false}var m=this.getToRoleAssociationEndMultiplicity(v.end,g.toRole);if(m!=="1"){r(false,'Expected multiplicity of 1 for "'+g.toRole+'" association end of the "'+g.relationship+'" association in the service metadata document. - '+l);return false}if(d.principal.propertyRef.length!==1||d.dependent.propertyRef.length!==1){r(false,'Expected the single "'+e+'" foreign key EDM property as '+'referential constraint in the "'+g.relationship+'" association. - '+l);return false}var P=t.entityTypeOfNavigationProperty||this.getNavigationProperty(o,c).entityType;if(P.key.propertyRef.length!==1){r(false,'Expected a single key property in the lookup "'+P.namespace+"."+P.name+'" entity type. - '+l);return false}var A=d.principal.propertyRef[0].name;if(A!==P.key.propertyRef[0].name){r(false,'Expected a property named "'+A+'" to be the single key property in the lookup "'+P.namespace+"."+P.name+'" entity type. - '+l);return false}return true};s.prototype.checkNavigationPropertyRequiredMetadataNoAsserts=function(t){var e=t.textAnnotation,n=e?e.Path:"",i=t.entityType;if(!e){return false}if(n===undefined){return false}if(n===""){return false}var a="com.sap.vocabularies.UI.v1.TextArrangement",o=e[a];if(!o){return false}var r=o.EnumMember;if(r===undefined){return false}if(!(r.split("/")[1]in p)){return false}if(o.EnumMember===p.TextSeparate){return false}if(n.indexOf("/")===-1){return false}var s=n.split("/")[0],l=this.findProperty(i.navigationProperty,s);if(!l){return false}var y=this.getAssociation(i,s);if(!y){return false}var f=y.referentialConstraint;if(!f){return false}if(!Array.isArray(y.end)||!(y.end.length>0)){return false}var u=this.getToRoleAssociationEndMultiplicity(y.end,l.toRole);if(u!=="1"){return false}if(f.principal.propertyRef.length!==1||f.dependent.propertyRef.length!==1){return false}var h=t.entityTypeOfNavigationProperty||this.getNavigationProperty(i,s).entityType;if(h.key.propertyRef.length!==1){return false}var c=f.principal.propertyRef[0].name;if(c!==h.key.propertyRef[0].name){return false}return true};s.prototype.checkValueListRequiredMetadataForTextArrangmentNoAsserts=function(t){var e=t.valueListAnnotation;if(!e){return false}if(!Array.isArray(e.fields)){return false}var n=e.descriptionField,i=this.findProperty(e.fields,n);if(!i){return false}if(i["sap:filterable"]==="false"){return false}return true};s.prototype.checkValueListRequiredMetadataForTextArrangment=function(t){var e=t.valueListAnnotation,n="sap.ui.comp.smartfield.ODataHelper";if(!e){var i=t.entityType,a=i.namespace+"."+i.name;r(false,'Missing "ValueList" annotation for "'+t.propertyName+'" EDM property of "'+a+'" entity type. - '+n);return false}if(!Array.isArray(e.fields)){r(false,'Missing fields for "'+e.valueListEntityName+'" entity. - '+n);return false}var o=e.descriptionField,p=this.findProperty(e.fields,o);if(!p){r(false,'The "'+o+'" description field was not found '+"in the service metadata document. - "+n);return false}if(p["sap:filterable"]==="false"){r(false,'Expected the "'+p.fullName+'" field to be filterable. - '+n);return false}return true};s.prototype.getEdmDisplayPath=function(t){var e=t.annotations.text;if(e){return e.path}return t.path};s.prototype.getTextAnnotationPropertyPath=function(t){return t?t.path:""};s.prototype.getAbsolutePropertyPathToValueListEntity=function(t){var e=t.property,n=e&&e["com.sap.vocabularies.Common.v1.Text"],i=t.bindingContextPath;if(typeof i==="string"&&i!==""){return i+"/"+n.Path}var a=t.entitySet,r=t.entityID,p;if(r==null||r===""){return""}if(n&&a){if(t.property.type=="Edm.Guid"){p=t.entityID.toLowerCase()}else{p=t.entityID}p=o.formatValue(p,t.property.type,true);return"/"+a.name+"("+p+")"+"/"+n.Path}return""};s.prototype.getODataValueListKeyProperty=function(t){for(var e=0;e<t.fields.length;e++){var n=t.fields[e];if(n.name===t.keyField){return n}}};s.prototype.getUOMPath=function(t){if(t&&t.annotations&&t.annotations.uom){return t.annotations.uom.path}return null};s.prototype.getUOMTypePath=function(t){if(t.property.complex){return t.property.typePath.replace(t.property.property.name,t.annotations.uom.property.name)}return t.annotations.uom.property.name};s.prototype.getSelectionChangeHandler=function(t){return function(e){var n="";try{var a=e.getParameter("selectedItem");if(a){n=a.getKey()}t.fireChange({value:n,newValue:n,selectionChange:true})}catch(t){i.warning(t)}}};s.prototype.destroy=function(){if(this._oAnalyzer){this._oAnalyzer.destroy()}if(this.oAnnotation){this.oAnnotation.destroy()}this._oUtil=null;this.oMeta=null;this.oAnalyzer=null;this.oAnnotation=null};s.prototype.getAutoExpandProperties=function(t){var e=[],n=[];for(var i in t){switch(i){case"com.sap.vocabularies.Common.v1.Text":case"Org.OData.Measures.V1.Unit":case"Org.OData.Measures.V1.ISOCurrency":case"com.sap.vocabularies.Common.v1.FieldControl":if(t[i].Path){n=t[i].Path.split("/")}break}if(n.length>1&&e.indexOf(n[0])<0){e.push(n[0])}}return e.join(",")};s.prototype.loadValueListAnnotation=function(t,e){var n=this.getAnalyzer().getValueListAnnotationLazy(t,e);n.catch(function(){i.error("The value list annotation could not be loaded.",undefined,"sap.ui.comp.smartfield.ODataHelper.loadValueListAnnotation")});return n};return s},true);