/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/commons/library","sap/ui/commons/Carousel","sap/ui/commons/Button","sap/ui/commons/ListBox","sap/ui/commons/SearchField","sap/ui/core/Control","sap/suite/ui/commons/NoteTakerCard","sap/suite/ui/commons/NoteTakerFeeder","sap/ui/core/ListItem","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/Sorter","sap/ui/events/KeyCodes","./NoteTakerRenderer"],function(t,e,i,r,a,s,o,n,l,h,d,u,p,g,m){"use strict";var T=o.extend("sap.suite.ui.commons.NoteTaker",{metadata:{deprecated:true,library:"sap.suite.ui.commons",properties:{visibleNotes:{type:"int",group:"Misc",defaultValue:2},cardViewAllTrigger:{type:"int",group:"Misc",defaultValue:1800},filterCriteria:{type:"object",group:"Misc",defaultValue:null},attachmentUploadUrl:{type:"string",group:"Misc",defaultValue:null},attachmentName:{type:"string",group:"Misc",defaultValue:"attachment"}},aggregations:{cards:{type:"sap.suite.ui.commons.NoteTakerCard",multiple:true,singularName:"card"},carousel:{type:"sap.ui.commons.Carousel",multiple:false,visibility:"hidden"}},events:{addCard:{parameters:{title:{type:"string"},body:{type:"string"},timestamp:{type:"object"},viewAllTrigger:{type:"int"},thumbUp:{type:"boolean"},thumbDown:{type:"boolean"},attachmentFilename:{type:"string"},uid:{type:"string"},attachmentUrl:{type:"string"},card:{type:"sap.suite.ui.commons.NoteTakerCard"}}},deleteCard:{parameters:{title:{type:"string"},body:{type:"string"},timestamp:{type:"string"},uid:{type:"string"},thumbUp:{type:"boolean"},thumbDown:{type:"boolean"}}},editCard:{parameters:{title:{type:"string"},body:{type:"string"},timestamp:{type:"string"},uid:{type:"string"},thumbUp:{type:"boolean"},thumbDown:{type:"boolean"},tags:{type:"object"}}},attachmentSelect:{parameters:{filename:{type:"string"}}},attachmentUploadComplete:{parameters:{response:{type:"string"},uid:{type:"string"}}},attachmentDelete:{parameters:{filename:{type:"string"},uid:{type:"string"}}},attachmentClick:{parameters:{uid:{type:"string"},isCardAttachment:{type:"string"},filename:{type:"string"}}}}}});T.prototype.init=function(){this._rb=sap.ui.getCore().getLibraryResourceBundle("sap.suite.ui.commons");this._bFilterTagPopupOpen=false;this._bSearchPopupOpen=false;this._carousel=new i({id:this.getId()+"-carousel",height:"540px"});this.setAggregation("carousel",this._carousel);this._carousel.addContent(this._createFeederAndAddToThis());this._notFilteredCards=[];this._oHomeButton=new r({id:this.getId()+"-home-button",tooltip:this._rb.getText("NOTETAKER_BUTTON_HOME_TOOLTIP"),press:[this._handleHomeButton,this]});this._oHomeButton.addStyleClass("sapSuiteUiCommonsNoteTakerHomeButton");this._oFilterTagButton=new r({id:this.getId()+"-filterTag-button",tooltip:this._rb.getText("NOTETAKER_BUTTON_FILTER_TAG_TOOLTIP"),press:[this._toggleFilterTagPopup,this]});this._oFilterTagButton.addStyleClass("sapSuiteUiCommonsNoteTakerFilterTagButton");this._oFilterThumbUpButton=new r({id:this.getId()+"-filter-thumb-up-button",tooltip:this._rb.getText("NOTETAKER_BUTTON_FILTER_THUMB_UP_TOOLTIP"),press:[this._handleFilteringByThumbUp,this]});this._oFilterThumbUpButton.addStyleClass("sapSuiteUiCommonsNoteTakerFilterThumbUpButton");this._oFilterThumbDownButton=new r({id:this.getId()+"-filter-thumb-down-button",tooltip:this._rb.getText("NOTETAKER_BUTTON_FILTER_THUMB_DOWN_TOOLTIP"),press:[this._handleFilteringByThumbDown,this]});this._oFilterThumbDownButton.addStyleClass("sapSuiteUiCommonsNoteTakerFilterThumbDownButton");this._oFilterAllButton=new r({id:this.getId()+"-filterAll-button",text:this._rb.getText("NOTETAKER_BUTTON_FILTER_ALL_TEXT"),tooltip:this._rb.getText("NOTETAKER_BUTTON_FILTER_ALL_TOOLTIP"),press:[this._handleResetFilters,this]});this._oFilterAllButton.addStyleClass("sapSuiteUiCommonsNoteTakerFilterAllButton");this._oSearchButton=new r({id:this.getId()+"-filter-search-button",tooltip:this._rb.getText("NOTETAKER_BUTTON_SEARCH_TOOLTIP"),press:[this._handleSearchPopup,this]});this._oSearchButton.addStyleClass("sapSuiteUiCommonsNoteTakerSearchBtn");this._oFilterSearchField=new s({id:this.getId()+"-filter-searchField",tooltip:this._rb.getText("NOTETAKER_BUTTON_SEARCH_TOOLTIP"),showListExpander:false,enableFilterMode:true,enableListSuggest:false,search:[this._handleSearchingByText,this]});this._oFilterSearchField.addStyleClass("suiteUiNtFilterSearchField");this._oFilterTagList=new a({id:this.getId()+"-filterTag-listBox",allowMultiSelect:true,visibleItems:10,width:"100%",height:"194px"});this._oCancelFilterTagButton=new r({id:this.getId()+"-cancel-filterTags-button",text:this._rb.getText("NOTETAKERFEEDER_BUTTON_CANCEL_TAGS"),tooltip:this._rb.getText("NOTETAKERFEEDER_BUTTON_CANCEL_TAGS_TOOLTIP"),press:[this._toggleFilterTagPopup,this]});this._oCancelFilterTagButton.addStyleClass("sapSuiteUiCommonsNoteTakerCancelFilterTagButton");this._oCancelFilterTagButton.onfocusout=function(t){this._oFilterTagList.focus()}.bind(this);this._oApplyFilterTagButton=new r({id:this.getId()+"-apply-filterTags-button",text:this._rb.getText("NOTETAKER_BUTTON_FILTER_TAG_APPLY_TEXT"),tooltip:this._rb.getText("NOTETAKER_BUTTON_FILTER_TAG_APPLY_TOOLTIP"),press:[this._toggleFilterTagPopup,this]})};T.prototype.onBeforeRendering=function(){this._carousel.setVisibleItems(this.getVisibleNotes());this._adjustFilteringButtonsStyle();this._feeder.setAttachmentName(this.getAttachmentName())};T.prototype.onAfterRendering=function(){this._adjustPopupState();if(!this.getAttachmentUploadUrl()){t(document.getElementById(this._feeder._oAddAttachButton.getId())).hide()}t(document.getElementById(this._oFilterThumbUpButton.getId())).attr("aria-pressed",this.getFilterCriteria()&&this.getFilterCriteria().thumbUp);t(document.getElementById(this._oFilterThumbDownButton.getId())).attr("aria-pressed",this.getFilterCriteria()&&this.getFilterCriteria().thumbDown)};T.prototype.exit=function(){this.destroyAggregation("carousel",true);this._carousel=null;this._oHomeButton.destroy();this._oHomeButton=null;this._oFilterTagButton.destroy();this._oFilterTagButton=null;this._oFilterThumbUpButton.destroy();this._oFilterThumbUpButton=null;this._oFilterThumbDownButton.destroy();this._oFilterThumbDownButton=null;this._oFilterAllButton.destroy();this._oFilterAllButton=null;this._oFilterTagList.destroy();this._oFilterTagList=null;this._oCancelFilterTagButton.destroy();this._oCancelFilterTagButton=null;this._oApplyFilterTagButton.destroy();this._oApplyFilterTagButton=null;this._oFilterSearchField.destroy();this._oFilterSearchField=null;this._oSearchButton.destroy();this._oSearchButton=null};T.prototype._handleAddNote=function(t){var e=t.getParameter("title");var i=t.getParameter("body");var r=t.getParameter("timestamp");var a=t.getParameter("tags");var s=t.getParameter("thumbUp");var o=t.getParameter("thumbDown");var l=t.getParameter("attachmentFilename");var h={};h.title=e;h.body=i;h.timestamp=r;h.viewAllTrigger=this.getCardViewAllTrigger();h.tags=a;h.thumbUp=s;h.thumbDown=o;h.attachmentFilename=l;h.uid=this._nextCardUid;h.attachmentUrl=this._nextCardAttachmentUrl;var d=this.getBinding("cards");if(d){this.fireAddCard(h);var u=new p("timestamp",true);d.sort(u)}else{var g=new n;g.setBody(i);g.setHeader(e);g.setTimestamp(r);g.setViewAllTrigger(this.getCardViewAllTrigger());g.setTags(a);g.setThumbUp(s);g.setThumbDown(o);g.setAttachmentFilename(l);g.setUid(this._nextCardUid);g.setAttachmentUrl(this._nextCardAttachmentUrl);this.insertCard(g,0);h.card=g;this.fireAddCard(h)}this._nextCardUid=null;this._nextCardAttachmentUrl=null;this._filter()};T.prototype.addCard=function(t){this._addDeleteDelegate(t);this._addEditDelegate(t);this._addAttachmentDelegate(t);this.getNotFilteredCards().push(t);this._carousel.addContent(t);this._sortIfNeeded();this._spreadTagList();return this};T.prototype.getCards=function(){return this._carousel.getContent().slice(1)};T.prototype.insertCard=function(t,e){this._addDeleteDelegate(t);this._addEditDelegate(t);this._addAttachmentDelegate(t);this.getNotFilteredCards().push(t);this._carousel.insertContent(t,++e);this._spreadTagList();return this};T.prototype.removeCard=function(t){this._spreadTagList();return this._carousel.removeContent(t)};T.prototype.removeAllCards=function(){var t=this._carousel.removeAllContent();this._feeder.setTags([]);this._carousel.addContent(this._feeder);return t.slice(1)};T.prototype.indexOfCard=function(t){var e=this._carousel.indexOfContent(t);return e>0?--e:-1};T.prototype.destroyCards=function(){this._carousel.destroyContent();this._carousel.addContent(this._createFeederAndAddToThis());return this};T.prototype._createFeederAndAddToThis=function(){var t=this;this._feeder=new l({id:this.getId()+"-feeder",attachmentName:this.getAttachmentName(),addNote:[this._handleAddNote,this],attachmentUploadUrl:this.getAttachmentUploadUrl(),attachmentSelect:function(t){var e={filename:t.getParameter("filename")};this.fireAttachmentSelect(e)}.bind(this),attachmentUploadComplete:function(e){var i={response:e.getParameter("response"),uid:t._nextCardUid};t.fireAttachmentUploadComplete(i);this._oAttachmentLink.setHref(t._nextCardAttachmentUrl);this._oAttachmentLink.rerender()},attachmentDelete:function(t){var e={filename:t.getParameter("filename"),uid:this._nextCardUid};this.fireAttachmentDelete(e)}.bind(this),attachmentClick:function(t){var e={filename:t.getParameter("filename"),uid:this._nextCardUid,isCardAttachment:false};this.fireAttachmentClick(e)}.bind(this)});this._spreadTagList();return this._feeder};T.prototype._sortIfNeeded=function(){var t=this.getBinding();if(t===undefined){var e=this.getCards();e.sort(function(t,e){return e.getTimestamp().getTime()-t.getTimestamp().getTime()});this.removeAllCards();for(var i=0;i<e.length;i++){this._carousel.addContent(e[i])}}};T.prototype.getAllTags=function(){var t=this.getBinding("cards");var e=t?this.getCards():this.getNotFilteredCards();var i={};var r=[];for(var a=0;a<e.length;a++){var s=e[a].getTags();for(var o=0;o<s.length;o++){if(s[o]!==""){i[s[o]]=true}}}for(var n in i){r.push(n)}return r.sort()};T.prototype._handleDeleteNote=function(t){var e=this.getBinding("cards");var i={};i.title=t.getParameter("title");i.timestamp=t.getParameter("timestamp");i.body=t.getParameter("body");i.uid=t.getParameter("uid");i.thumbUp=t.getParameter("thumbUp");i.thumbDown=t.getParameter("thumbDown");if(e){this.fireDeleteCard(i)}else{var r=t.getParameter("cardId");var a=this.getNotFilteredCards();for(var s=0;s<a.length;s++){if(a[s].getId()===r){a.splice(s,1)}}this.removeCard(r);this.fireDeleteCard(i)}};T.prototype._handleEditNote=function(t){var e={};e.title=t.getParameter("title");e.timestamp=t.getParameter("timestamp");e.body=t.getParameter("body");e.uid=t.getParameter("uid");e.thumbUp=t.getParameter("thumbUp");e.thumbDown=t.getParameter("thumbDown");e.tags=t.getParameter("tags");this.fireEditCard(e);this._sortIfNeeded();this._spreadTagList()};T.prototype._addDeleteDelegate=function(t){t.attachDeleteNote(function(t){this._handleDeleteNote(t)},this)};T.prototype._addEditDelegate=function(t){t.attachEditNote(function(t){this._handleEditNote(t)},this)};T.prototype._handleHomeButton=function(){this._carousel.setFirstVisibleIndex(0);this._feeder._focusDefaultControl()};T.prototype.setFilterCriteria=function(t){this.setProperty("filterCriteria",t);this._filter();return this};T.prototype._toggleFilterTagPopup=function(){if(this._bFilterTagPopupOpen){t(document.getElementById(this.getId()+"-filterTag-panel")).slideToggle();this._bFilterTagPopupOpen=false}else{this._addTagsToFilterListBox(this.getAllTags());t(document.getElementById(this.getId()+"-filterTag-panel")).slideToggle();this._oFilterTagList.focus();this._bFilterTagPopupOpen=true}setTimeout(function(){this._handleFilteringByTags()}.bind(this),400)};T.prototype._addTagsToFilterListBox=function(e){var i=[];var r=this._getFilterTags();var a=t.map(e,function(t,e){if(r.indexOf){if(r.indexOf(t)>=0){i.push(e)}}else{for(var a in r){if(r[a]===t){i.push(e);break}}}return new h({text:t})});this._oFilterTagList.setItems(a,true);this._oFilterTagList.setSelectedIndices(i);this._oFilterTagList.rerender()};T.prototype._cloneFilterCriteria=function(){var t=this.getFilterCriteria();var e={};if(t){for(var i in t){e[i]=t[i]}}return e};T.prototype._handleFilteringByTags=function(){var t=this._cloneFilterCriteria();var e=this._oFilterTagList.getSelectedItems();var i=[];for(var r in e){i.push(e[r].getText())}t.tags=i;this.setFilterCriteria(t)};T.prototype._handleFilteringByThumbUp=function(){var t=this._cloneFilterCriteria();t.thumbUp=!t.thumbUp;this.setFilterCriteria(t)};T.prototype._handleFilteringByThumbDown=function(){var t=this._cloneFilterCriteria();t.thumbDown=!t.thumbDown;this.setFilterCriteria(t)};T.prototype._handleResetFilters=function(){var t=this.getFilterCriteria();var e=null;if(t&&t.search&&t.search.length>0){e={};e.search=t.search}this.setFilterCriteria(e)};T.prototype._handleSearchingByText=function(t){var e=t.getParameter("query");var i=this._cloneFilterCriteria();var r=[];var a=e.split(new RegExp("\\s+"));for(var s=0;s<a.length;s++){if(a[s].length>0){r.push(a[s])}}i.search=r;this.setFilterCriteria(i)};T.prototype._adjustFilterTagButton=function(){var t=this._getFilterTags();if(t.length){this._oFilterTagButton.setTooltip(this._rb.getText("NOTETAKER_BUTTON_FILTER_TAG_APPLY_SELECTED_TOOLTIP")+": "+t.join(" "));this._oFilterTagButton.addStyleClass("sapSuiteUiCommonsNoteTakerFilterButtonSelected")}else{this._oFilterTagButton.setTooltip(this._rb.getText("NOTETAKER_BUTTON_FILTER_TAG_TOOLTIP"));this._oFilterTagButton.removeStyleClass("sapSuiteUiCommonsNoteTakerFilterButtonSelected")}};T.prototype._handleSearchPopup=function(){if(this._bSearchPopupOpen){t(document.getElementById(this.getId()+"-search-panel")).slideToggle();this._bSearchPopupOpen=false}else{var e=t(document.getElementById(this.getId()+"-filter-search-button")).position();t(document.getElementById(this.getId()+"-search-panel")).css("right",e.right-20+"px").slideToggle();this._oFilterSearchField.focus();this._bSearchPopupOpen=true}};T.prototype._adjustSearchButton=function(){var t=this._oFilterSearchField.getValue();if(t.length){this._oSearchButton.setTooltip(this._rb.getText("NOTETAKER_BUTTON_SEARCHED_BY_TOOLTIP")+": "+t);this._oFilterSearchField.setTooltip(this._rb.getText("NOTETAKER_BUTTON_SEARCHED_BY_TOOLTIP")+": "+t);this._oSearchButton.addStyleClass("sapSuiteUiCommonsNoteTakerFilterButtonSelected")}else{this._oSearchButton.setTooltip(this._rb.getText("NOTETAKER_BUTTON_SEARCH_TOOLTIP"));this._oFilterSearchField.setTooltip(this._rb.getText("NOTETAKER_BUTTON_SEARCH_TOOLTIP"));this._oSearchButton.removeStyleClass("sapSuiteUiCommonsNoteTakerFilterButtonSelected")}};T.prototype._getFilterTags=function(){var t=this.getFilterCriteria();if(t&&t.tags&&t.tags.length){return t.tags}else{return[]}};T.prototype._adjustPopupState=function(){var e=t(document.getElementById(this.getId()+"-filterTag-button")).position();t(document.getElementById(this.getId()+"-filterTag-panel")).css("left",e.left-20+"px");if(this._bFilterTagPopupOpen){t(document.getElementById(this.getId()+"-filterTag-panel")).show()}if(this._bSearchPopupOpen){t(document.getElementById(this.getId()+"-search-panel")).show()}};T.prototype._adjustFilteringButtonsStyle=function(){this._adjustFilterTagButton();this._adjustFilteringByThumbUpButtonStyle();this._adjustFilteringByThumbDownButtonStyle();this._adjustSearchButton()};T.prototype._adjustFilteringByThumbUpButtonStyle=function(){if(this.getFilterCriteria()&&this.getFilterCriteria().thumbUp){this._oFilterThumbUpButton.addStyleClass("sapSuiteUiCommonsNoteTakerFilterButtonSelected")}else{this._oFilterThumbUpButton.removeStyleClass("sapSuiteUiCommonsNoteTakerFilterButtonSelected")}};T.prototype._adjustFilteringByThumbDownButtonStyle=function(){if(this.getFilterCriteria()&&this.getFilterCriteria().thumbDown){this._oFilterThumbDownButton.addStyleClass("sapSuiteUiCommonsNoteTakerFilterButtonSelected")}else{this._oFilterThumbDownButton.removeStyleClass("sapSuiteUiCommonsNoteTakerFilterButtonSelected")}};T.prototype.getNotFilteredCards=function(){if(!this._notFilteredCards){this._notFilteredCards=[]}return this._notFilteredCards};T.prototype._spreadTagList=function(){var t=this.getAllTags();this._feeder.setTags(t);var e=this.getCards();for(var i=0;i<e.length;i++){e[i].setAllTags(t)}};T.prototype._filter=function(){var t=this.getBinding("cards");var e;var i;if(t){var r=this.getModel().oData["cards"];for(i=0;i<r.length;i++){e=r[i];e.isFiltered=this._applyFilters(e)}this.getModel().updateBindings();t.filter([new d("isFiltered",u.EQ,false)])}else{var a=this.getNotFilteredCards();var s=this.getCards();if(a.length===0&&s.length>0){this.setNotFilteredCards(s);a=s}for(i=0;i<a.length;i++){e=a[i];e.setIsFiltered(this._applyFilters(e));if(e.getIsFiltered()){this.removeCard(e)}else if(this.indexOfCard(e)<0){this.addCard(e)}}}};T.prototype._applyFilters=function(t){var e=true;if(this.getFilterCriteria()){for(var i=0;i<this._filters.length&&e;i++){var r=this._filters[i];e=r.call(this,t)}}return!e};T.prototype._validateCardByThumbsFilter=function(t){if(t.getThumbUp&&t.getThumbDown){return this._applyThumbsFilter(t.getThumbUp(),t.getThumbDown())}else{return this._applyThumbsFilter(t.thumbUp,t.thumbDown)}};T.prototype._validateCardByTagsFilter=function(t){if(t.getTags){return this._applyTagsFilter(t.getTags())}else{return this._applyTagsFilter(t.tags)}};T.prototype._validateCardByTextSearch=function(t){if(t.getBody){return this._applyTextSearch(t.getBody(),t.getHeader())}else{return this._applyTextSearch(t.body,t.header)}};T.prototype._applyThumbsFilter=function(t,e){var i=true;var r=this.getFilterCriteria();if(r.thumbUp&&r.thumbDown){i=t||e}else if(r.thumbUp){i=t}else if(r.thumbDown){i=e}return i};T.prototype._applyTagsFilter=function(t){var e=true;var i=this.getFilterCriteria();if(i.tags&&i.tags.length>0){var r,a;var s=i.tags;e=false;for(r=0;r<s.length&&!e;r++){for(a=0;t&&a<t.length;a++){if(s[r]===t[a]){e=true;break}}}}return e};T.prototype._applyTextSearch=function(t,e){var i=true;var r=this.getFilterCriteria();if(r.search&&r.search.length>0){var a=r.search;i=false;t=t.toLowerCase();e=e?e.toLowerCase():null;for(var s=0;s<a.length;s++){var o=a[s].toLowerCase();if(t.indexOf(o)>=0||e&&e.indexOf(o)>=0){i=true;break}}}return i};T.prototype.setAttachmentUploadUrl=function(t){this.setProperty("attachmentUploadUrl",t,true);this._feeder.setAttachmentUploadUrl(t);return this};T.prototype._filters=[T.prototype._validateCardByThumbsFilter,T.prototype._validateCardByTagsFilter,T.prototype._validateCardByTextSearch];T.prototype.setNextCardUid=function(t){this._nextCardUid=t;return this};T.prototype._addAttachmentDelegate=function(t){t.attachAttachmentClick(function(t){this._handleCardAttachmentClick(t)},this)};T.prototype._handleCardAttachmentClick=function(t){var e={filename:t.getParameter("filename"),uid:t.getParameter("uid"),isCardAttachment:true};this.fireAttachmentClick(e)};T.prototype.uploadAttachment=function(){this._feeder._oFileUploader.upload()};T.prototype.setAttachmentData=function(t){this._feeder._oFileUploader.setAdditionalData(t);return this};T.prototype.handleAttachmentUploadFail=function(){this._feeder._handleDeleteAttachUI();return this};T.prototype.setNextCardAttachmentUrl=function(t){this._nextCardAttachmentUrl=t;return this};T.prototype.onkeyup=function(t){if(t.which===g.ESCAPE){if(this._feeder._bTagPopupOpen){this._feeder._toggleTagPopup();this._feeder._oTagButton.focus()}if(this._bFilterTagPopupOpen){this._toggleFilterTagPopup();this._oFilterTagButton.focus()}}};return T});