/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","../library","sap/suite/ui/commons/statusindicator/ShapeGroup","sap/suite/ui/commons/statusindicator/Shape","sap/suite/ui/commons/statusindicator/Path","sap/suite/ui/commons/statusindicator/Circle","sap/suite/ui/commons/statusindicator/Rectangle","sap/suite/ui/commons/util/HtmlElement","sap/base/Log","./CustomShapeRenderer"],function(e,t,i,r,a,o,s,n,p,l){"use strict";var u=t.statusindicator.FillingType;var h=r.extend("sap.suite.ui.commons.statusindicator.CustomShape",{metadata:{library:"sap.suite.ui.commons",properties:{x:{type:"int",defaultValue:0},y:{type:"int",defaultValue:0},width:{type:"sap.ui.core.CSSSize",defaultValue:"100%"},height:{type:"sap.ui.core.CSSSize",defaultValue:"100%"},strokeColor:{type:"sap.m.ValueCSSColor",defaultValue:"Neutral"},strokeWidth:{type:"float",defaultValue:.25},definition:{type:"string",defaultValue:null}},defaultAggregation:"shapes",aggregations:{shapes:{type:"sap.suite.ui.commons.statusindicator.SimpleShape",multiple:true,defaultValue:null},fillingOptions:{type:"sap.suite.ui.commons.statusindicator.FillingOption",multiple:true,defaultValue:null}}}});h.prototype.init=function(){if(r.prototype.init){r.prototype.init.apply(this,arguments)}this._iDisplayedValue=0;this._initShapeState()};h.prototype.onBeforeRendering=function(){this._refreshInternalStructure()};h.prototype.onAfterRendering=function(){this._updateDom(this.getDisplayedValue())};h.prototype.addFillingOption=function(e){var t=typeof e.getOrder()==="undefined";if(t){p.fatal("The passed FillingOption has to have set its order property.");return this}var i=this.getFillingOptions().length>0&&this.getFillingOptions().filter(function(t){return t.getOrder()===e.getOrder()}).length>0;if(i){p.fatal("The property 'order' has to be unique within the FillingOptions aggregation, but option"+" with order: "+e.getOrder()+" is already inserted. No FillingOption added.");return this}return this.addAggregation("fillingOptions",e,true)};h.prototype._initShapeState=function(){this._aFillableSubShapes=[];this.oDefinition=[];this._sViewBox=null;this.destroyShapes()};h.prototype._refreshInternalStructure=function(){this._initShapeState();this._aFillableSubShapes.forEach(function(e){if(e.fillingOption){e.fillingOption.destroy()}e.shape.destroy()});if(!this.getDefinition()){if(!this.isA("sap.suite.ui.commons.statusindicator.LibraryShape")){p.fatal("Definition has to be specified.")}return}var t=e(this.getDefinition());this._sViewBox=t[0].getAttribute("viewBox");e.map(t.children(),this._preprocessNode.bind(this))};h.prototype._preprocessNode=function(t){var i=e(t),r=i.prop("tagName"),a=this;switch(r){case"g":e.map(i.children(),function(t){return a._preprocessLeafNode.call(a,e(t))});break;default:this._preprocessLeafNode(i)}};h.prototype._preprocessLeafNode=function(e){var t=e.prop("tagName");switch(t){case"path":this._preprocessPathNode(e);break;case"circle":this._preprocessCircleNode(e);break;case"rect":this._preprocessRectangleNode(e);break;case"defs":this._preprocessDefinitionsNode(e[0]);break;default:p.fatal("Unsupported node tag name ('"+t+"')")}};h.prototype._preprocessPathNode=function(e){var t=new a({d:e.attr("d")});this._prepareShape(t,e)};h.prototype._preprocessCircleNode=function(e){var t=new o({cx:Number(e.attr("cx")),cy:Number(e.attr("cy")),r:Number(e.attr("r"))});this._prepareShape(t,e)};h.prototype._preprocessRectangleNode=function(e){var t=new s({x:Number(e.attr("x")),y:Number(e.attr("y")),width:Number(e.attr("width")),height:Number(e.attr("height"))});this._prepareShape(t,e)};h.prototype._preprocessDefinitionsNode=function(e){var t=new n("defs");t.addChild(e.innerHTML);return t};h.prototype._setInitialValue=function(e){this._iDisplayedValue=e};h.prototype.getDisplayedValue=function(){return this._iDisplayedValue};h.prototype._prepareShape=function(e,t){e.setFillingAngle(this.getFillingAngle());e.setStrokeWidth(this.getStrokeWidth());e.setStrokeColor(this.getStrokeColor());this.addShape(e);e._injectAnimationPropertiesResolver(this._oAnimationPropertiesResolver);var i=t.attr("style");if(!i){e.setFillingDirection(this.getFillingDirection());e.setFillColor(this.getFillColor());e.setFillingType(this.getFillingType());var r=t.data("shape-id");var a={shape:e,fillingOption:r?this._getFillingOptionById(r):null};this._aFillableSubShapes.push(a);if(a.fillingOption){this._aFillableSubShapes.sort(function(e,t){var i=e.fillingOption;var r=t.fillingOption;if(!i){return-1}if(!r){return 1}return i.getOrder()-r.getOrder()})}}else{e.setFillingType(u.None);e._setStyle(i)}};h.prototype._updateDom=function(e,t){function i(e){var t=e.fillingOption;return t&&t.getWeight()!==0?t.getWeight():1}p.debug("Updating to "+e,null,this);if(this._aFillableSubShapes.length===0){p.info("Update of DOM skipped. No shape for update found");return}var r=this._aFillableSubShapes.reduce(function(e,t){return e+i(t)},0);try{var a=this;var o=t?e:this._oAnimationPropertiesResolver.getValue(this,e);this._aFillableSubShapes.forEach(function(s){var n=i(s);var l=n/r;var u;if(o===0){u=0}else if(o>=100*l){u=100}else{u=o/l}o-=u*l;if(!t){var h=s.shape.getRenderer();var d=a.getDisplayedFillColor(e);p.debug("Updating color to '"+d+"'",null,s.shape);h._updateDomColor(s.shape,d)}s.shape._updateDom(u,true)})}catch(e){p.fatal("Update of DOM failed. Reason: "+e.message);return}if(!t){this._oAnimationPropertiesResolver.propagateValueChange(this,e);this._oAnimationPropertiesResolver.propagateColorChange(this,e)}this._iDisplayedValue=e};h.prototype._getFillingOptionById=function(e){var t=null;this.getFillingOptions().some(function(i){if(i.getShapeId()===e){t=i;return true}return false});return t};h.prototype._getInternalViewBox=function(){return this._sViewBox};return h});