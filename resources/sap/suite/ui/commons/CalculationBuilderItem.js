sap.ui.define(["sap/ui/thirdparty/jquery","./library","sap/ui/core/Control","sap/m/MessageBox","sap/base/security/encodeXML","./Utils","sap/ui/thirdparty/jqueryui/jquery-ui-core","sap/ui/thirdparty/jqueryui/jquery-ui-widget","sap/ui/thirdparty/jqueryui/jquery-ui-mouse","sap/ui/thirdparty/jqueryui/jquery-ui-draggable"],function(t,e,i,r,n,s){"use strict";var a=e.CalculationBuilderItemType,o=e.CalculationBuilderOperatorType,u=e.CalculationBuilderLogicalOperatorType;var l=sap.ui.getCore().getLibraryResourceBundle("sap.suite.ui.commons");var p=i.extend("sap.suite.ui.commons.CalculationBuilderItem",{constructor:function(t,e){if(typeof t!=="string"&&t!==undefined){e=t}if(e&&e.key){e.key=this._sanitizeKey(e.key)}i.apply(this,arguments)},metadata:{library:"sap/suite/ui/commons",properties:{key:{type:"string",group:"Misc",defaultValue:null}}},renderer:function(t,e){t.write(e._render())}});p.prototype._innerRender=function(){var t="",e="",i=this._getLabel(),r={"!=":"NOT_EQUAL","-":"MINUS",",":"COMMA"};var s=function(){t+='<div class="sapCalculationBuilderItemFocusWrapper">';t+='<div class="sapCalculationBuilderItemFocus"></div>';t+="</div>"};var a=function(){t+='<div class="sapCalculationBuilderItemExpandButtonWrapper" title="'+l.getText("CALCULATION_BUILDER_EXPAND_BUTTON_TITLE")+'">';t+='<div id="'+this.getId()+'-expandbutton" class="sapCalculationBuilderItemExpandButton '+(this._bReadOnly?"sapMBtnDisabled":"")+'" tabindex="-1">';if(!this._bReadOnly){t+='<div class="sapCalculationBuilderItemExpandButtonFocus"></div>'}o("");t+="</div></div>"}.bind(this);var o=function(e){t+='<span aria-hidden="true" data-sap-ui-icon-content="'+e+'" class="sapCalculationBuilderEmptyItemIcon sapUiIcon sapUiIconMirrorInRTL sapCalculationBuilderExpressionSAPFont"></span>'};var u=function(t){return' aria-label="'+l.getText(t)+'" '};if(this._bIsNew||this._isEmpty()){e=' title="'+l.getText("CALCULATION_BUILDER_NEW_ITEM_TITLE")+'" '}else if(r[i]){e=u("CALCULATION_BUILDER_"+r[i]+"_ARIA_LABEL")}t+='<div class="sapCalculationBuilderItemContentWrapper">';t+='<div id="'+this.getId()+'-content" class="sapCalculationBuilderItemContent"'+e+'" aria-haspopup="dialog">';s();if(this._isEmpty()){o("");t+="</div>"}else if(this._bIsNew){o("");t+="</div>"}else if(this._isFunction()){var p=this._getFunction();t+='<span class="sapCalculationBuilderItemLabel sapCalculationBuilderItemFunctionLabel">';t+=n(p.title||this.getKey());t+="</span>";t+='<span class="sapCalculationBuilderItemLabel sapCalculationBuilderItemFunctionBracket">';t+="&nbsp;(";t+="</span>";t+="</div>"}else{t+='<span class="sapCalculationBuilderItemLabel">';t+=n(i);t+="</span>";t+="</div>"}t+="</div>";if(this._isVariable()&&this.isExpandable()){a()}return t};p.prototype._getClass=function(t){var e="",i=this._isEmpty();e+=this._bIsNew?"sapCalculationBuilderNewItem  sapCalculationBuilderCancelSelectable":"sapCalculationBuilderItem";if(i){e+=" sapCalculationBuilderNewItem "}if(this._isBracket()){e+=" sapCalculationBuilderItemBracket "}else if(this._isOperator()){e+=" sapCalculationBuilderItemOperator sapCalculationBuilderItemOperatorLength-"+this._getLabel().length+" ";if(this._isLogicalOperator()){e+=" sapCalculationBuilderItemLogicalOperator "}}else if(this._isCustomOperator()){e+=" sapCalculationBuilderItemOperator sapCalculationBuilderItemCustomOperator "}else if(this._isFunction()){e+=" sapCalculationBuilderItemFunction "}else if(this._isLiteral()){e+=" sapCalculationBuilderItemLiteral "}else if(this._isVariable()){e+=" sapCalculationBuilderItemVariable ";if(this.isExpandable()){e+=" sapCalculationBuilderItemVariableSeparator "}}else{e+=" sapCalculationBuilderUnknownItem "}if(t){e+=" sapCalculationBuilderItemErrorSyntax "}return e};p.prototype._render=function(){if(!this.getParent()){return}var t=this._hasCorrectParent(),e=this._getItemError(),i=this._getTooltip(),r=i?'title="'+i+'"':"",n=this._bIsNew?'role="button"':"",s="";s+='<div class="'+this._getClass(!!e)+'" id="'+this.getId()+'" tabindex="'+(t?"-1":"0")+'"'+r+n+">";s+=this._innerRender();s+="</div>";return s};p.prototype.init=function(){this._bIsNew=false};p.prototype.onBeforeRendering=function(){this._oVariable=this.getVariable()};p.prototype.onAfterRendering=function(){this._afterRendering()};p.prototype._afterRendering=function(){var t=this.getParent();if(!t){return}this._setEvents();if(!this._bIsNew&&!this._bReadOnly){this._setupDraggable()}if(this._hasCorrectParent(t)){if(!t._bIsCalculationBuilderRendering){t._setupKeyboard();t.getParent()._enableOrDisableExpandAllButton()}}};p.prototype._setEvents=function(){if(this.isExpandable()){this.$("expandbutton").on("click",this._expandButtonPress.bind(this));this.$("expandbutton").on("mousedown",function(t){t.stopPropagation()})}if(!this._bReadOnly){this.$("content").on("click",this._buttonPress.bind(this))}if(this._isBracket()||this._isFunction()){this._setBracketHover()}};p.prototype._buttonPress=function(t){var e=this.getParent();if(this._hasCorrectParent(e)&&!e._bDragging){if(t.ctrlKey){e._selectItem(this.$())}else if(t.shiftKey){e._selectItemsTo(this.$())}else{e._deselect();e._openDialog({opener:this,currentItem:this})}}};p.prototype._expandButtonPress=function(t){if(!this._bReadOnly){this._openExpandConfirmMessageBox()}};p.prototype.isExpandable=function(){var t=this._oVariable?this._oVariable:this.getVariable();return t&&t.getItems().length>0};p.prototype.getVariable=function(){var t=this.getParent();return this._hasCorrectParent(t)&&t._getVariableByKey(this.getKey())};p.prototype.getType=function(){return this._getType()};p.prototype._setupDraggable=function(){var e=this.getParent(),i=e.$(),r=this.$();r.draggable({revert:"invalid",axis:"x",delay:100,cursor:"move",helper:function(t){var e=r.clone();e.addClass("sapCalculationBuilderDragging");e.css("pointer-events","none");return e},scope:e.getId()+"-scope",start:function(){i.find(".sapCalculationBuilderBracket").removeClass("sapCalculationBuilderBracket");i.find(".sapCalculationBuilderItemContent").css("cursor","move");t(this).addClass("sapCalculationBuilderDragging");e._bDragging=true;if(!t(this).hasClass("ui-selected")){e._deselect()}},stop:function(){t(this).removeClass("sapCalculationBuilderDragging");i.find(".sapCalculationBuilderItemContent").css("cursor","pointer");e._bDragging=false}});s._setupMobileDraggable(r)};p.prototype._setBracketHover=function(){var t=this.$("content"),e=this._isFunction()?o["("]:this.getKey(),i=e===o[")"],r=i?o["("]:o[")"],n;t.mouseenter(function(t){var s,a,o=0,u=this._hasCorrectParent()&&this.getParent().getItems()||[],l=i?u.length:0;for(;i?l>=0:l<u.length;i?l--:l++){s=u[l];if(s===this){a=true}if(a){if(s.getKey()===r||s._isFunction()&&i){o--;if(o===0){n=s;break}}else if(s.getKey()===e||s._isFunction()&&!i){o++}}}if(n){this.$().addClass("sapCalculationBuilderBracket");n.$().addClass("sapCalculationBuilderBracket")}}.bind(this));t.on("mouseleave",function(t){this.$().removeClass("sapCalculationBuilderBracket");if(n){n.$().removeClass("sapCalculationBuilderBracket")}}.bind(this))};p.prototype._expandVariable=function(t){var e=this.getParent(),i,r;if(e){i=e.getItems().indexOf(this);r=e._getVariableByKey(this.getKey());e.insertItem(new p({key:"("}),i++);r.getItems().forEach(function(t){e.insertItem(t._cloneItem(),i++)});e.insertItem(new p({key:")"}),i++);e.removeItem(this);if(t){e._aErrors=e._validateSyntax();e._fireChange()}}};p.prototype._cloneItem=function(){return new p({key:this.getKey()})};p.prototype._openExpandConfirmMessageBox=function(){r.show(l.getText("CALCULATION_BUILDER_EXPAND_MESSAGE_TEXT",this._getLabel()),{icon:r.Icon.WARNING,title:l.getText("CALCULATION_BUILDER_EXPAND_MESSAGE_TITLE"),actions:[r.Action.OK,r.Action.CANCEL],onClose:function(t){var e;if(t===r.Action.OK){this._expandVariable(true)}else{e=this.getParent();if(e){e._setCorrectFocus()}}}.bind(this)})};p.prototype._getItemError=function(){var e=this.getParent(),i;if(this._hasCorrectParent(e)){i=t.grep(e._aErrors,function(t){return t.index===this._iIndex}.bind(this))[0]}return i};p.prototype._getLabel=function(){var t=function(){var t=this._getItem();if(!t){return this.getKey()}if(t.title){return t.title}if(t._getLabel){return t._getLabel()}return t.getText()||t.getKey()}.bind(this);if(!this._sLabel){this._sLabel=t();if(this._isFunction()){this._sLabel+=" ("}}return this._sLabel};p.prototype._sanitizeKey=function(t){if(!t||typeof t!=="string"){return t}t=t.replace(/{/g,"&#125;");t=t.replace(/}/g,"&#123;");return t};p.prototype._reset=function(){this._sType="";this._sLabel="";this._oVariable=""};p.prototype.setKey=function(t,e){this._reset();this.setProperty("key",this._sanitizeKey(t),e);var i=this.getParent();if(i&&i._bRendered){i.getParent()&&i.getParent()._expressionChanged()}return this};p.prototype.getKey=function(){var t=this.getProperty("key");t=t.replace(/&#125;/g,"{");t=t.replace(/&#123;/g,"}");return t};p.prototype._getType=function(){var t=this.getParent();if(!this._sType&&t){this._sType=t._getType(this.getKey())}return this._sType};p.prototype._isEmpty=function(){return!this._bIsNew&&!this.getKey()};p.prototype._isOperator=function(){return this._getType()===a.Operator};p.prototype._isSecondaryOperator=function(){var t=this._getType();if(this._getType()===a.Operator){return["+","-","/","*","(",")",","].indexOf(this.getKey())===-1}return t===a.CustomOperator};p.prototype._isCustomOperator=function(){return this._getType()===a.CustomOperator};p.prototype._isVariable=function(){return this._getType()===a.Variable};p.prototype._isLiteral=function(){return this._getType()===a.Literal};p.prototype._isFunction=function(){var t=this._getType();return t===a.Function||t===a.CustomFunction};p.prototype._getFunction=function(){var t=this._getType();if(t===a.Function||t===a.CustomFunction){var e=this.getParent().getParent();return e._createFunctionObject(e._getFunctionDefinition(this.getKey()))}return null};p.prototype._getItemInstance=function(e,i){if(this._getType()===e){var r=this.getKey(),n=this.getParent()[i]();return t.grep(n,function(t){return t.getKey().toLowerCase()===r.toLowerCase()})[0]}return null};p.prototype._getItem=function(){var t=this._getType();switch(t){case a.Variable:return this._getVariable();case a.CustomFunction:return this._getCustomFunction();case a.CustomOperator:return this._getCustomOperator()}return null};p.prototype._getTooltip=function(){var t=this._getItem();return t&&t.getTooltip_AsString?t.getTooltip_AsString():""};p.prototype._getVariable=function(){return this._getItemInstance(a.Variable,"getVariables")};p.prototype._getCustomFunction=function(){return this._getItemInstance(a.CustomFunction,"getFunctions")};p.prototype._getCustomOperator=function(){return this._getItemInstance(a.CustomOperator,"getOperators")};p.prototype._isBracket=function(){return this._isOperator()&&(this.getKey()==="("||this.getKey()===")")};p.prototype._isAddition=function(){return this._isOperator()&&this.getKey()==="+"};p.prototype._isSubtraction=function(){return this._isOperator()&&this.getKey()==="-"};p.prototype._isDivision=function(){return this._isOperator()&&this.getKey()==="/"};p.prototype._isMultiplication=function(){return this._isOperator()&&this.getKey()==="*"};p.prototype._isComma=function(){return this._isOperator()&&this.getKey()===","};p.prototype._isLogicalOperator=function(){return this._isOperator()&&!!u[this.getKey()]};p.prototype._hasCorrectParent=function(t){t=t||this.getParent();return t instanceof sap.suite.ui.commons.CalculationBuilderExpression};return p});