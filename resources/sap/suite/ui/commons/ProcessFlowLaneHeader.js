/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/m/Image","./library","sap/ui/core/Control","sap/ui/core/IconPool","sap/ui/Device","sap/ui/core/Icon","./ProcessFlowLaneHeaderRenderer"],function(e,t,o,s,r,i,n,a){"use strict";var l=s.extend("sap.suite.ui.commons.ProcessFlowLaneHeader",{metadata:{library:"sap.suite.ui.commons",properties:{text:{type:"string",group:"Misc",defaultValue:null},iconSrc:{type:"sap.ui.core.URI",group:"Misc",defaultValue:null},position:{type:"int",group:"Misc",defaultValue:null},laneId:{type:"string",group:"Misc",defaultValue:null},state:{type:"object",group:"Misc",defaultValue:null},zoomLevel:{type:"sap.suite.ui.commons.ProcessFlowZoomLevel",group:"Misc",defaultValue:null}},events:{press:{parameters:{oEvent:{type:"object"}}}}}});l.prototype._oResBundle=null;l.prototype._mergedLanePosition=null;l.symbolType={startSymbol:"startSymbol",endSymbol:"endSymbol",processSymbol:"processSymbol",standardType:"standardType"};l._constants={halfGapSize:.0241,minPercentage:.025,ringThickness:5,ringInnerRadius:23,positionX:32,positionY:32,outerCircleRadius:31,outerCircleStrokeColor:"OuterCircleStrikeColor",outerCircleStrokeWidth:1,sectorPositiveColor:"suiteUiCommonsProcessFlowHeaderPositiveColor",sectorNegativeColor:"suiteUiCommonsProcessFlowHeaderNegativeColor",sectorNeutralColor:"suiteUiCommonsProcessFlowHeaderNeutralColor",sectorCriticalColor:"suiteUiCommonsProcessFlowHeaderCriticalColor",sectorPlannedColor:"suiteUiCommonsProcessFlowHeaderPlannedColor",ellipsis:"...",ellipsisLength:3};l.prototype.init=function(){this._virtualTableSpan=1;if(!this._oResBundle){this._oResBundle=sap.ui.getCore().getLibraryResourceBundle("sap.suite.ui.commons")}};l.prototype.exit=function(){this._destroyImage();this.$().off("click",this.ontouchend)};l.prototype.onBeforeRendering=function(){this.$("lh-icon").off("click",e.proxy(this.ontouchend,this));this.$().off("click",this.ontouchend)};l.prototype.onAfterRendering=function(){var t=this.$();var o=this.$("lh-icon");var s="click";if(i.support.touch){s="touchend"}if(o.length>0){o.on(s,e.proxy(this.ontouchend,this));o.css("cursor","inherit")}this.$().on("click",e.proxy(this.ontouchend,this));if(this._isHeaderMode()){t.addClass("suiteUiProcessFlowLaneHeaderPointer")}else{t.removeClass("suiteUiProcessFlowLaneHeaderPointer")}if(i.browser.mozilla){this.$("lh-text").css("word-break","break-all")}if(!this._ellipsisDisabled&&!l._hasNativeLineClamp){this._clampText()}};l.prototype.ontouchend=function(e){if(e&&!e.isDefaultPrevented()){e.preventDefault()}if(this){this.firePress(this)}if(e&&!e.isPropagationStopped()){e.stopPropagation()}if(e&&!e.isImmediatePropagationStopped()){e.stopImmediatePropagation()}};l.prototype._setMergedPosition=function(e){this._mergedLanePosition=e};l.prototype._getSymbolType=function(){return this._oSymbolType?this._oSymbolType:l.symbolType.standardType};l.prototype._setSymbolType=function(e,t){t._oSymbolType=e};l.prototype._getImage=function(e,o){this._destroyImage();if(this._oImageControl){this._oImageControl.setSrc(o)}else{this._oImageControl=r.createControlByURI(o,t);this._oImageControl.sId=e;this._oImageControl.setParent(this,null,true)}if(this._oImageControl instanceof n){this._oImageControl.setUseIconTooltip(false)}return this._oImageControl};l.prototype._setHeaderMode=function(e){this._bHeaderMode=e};l._setVirtualTableSpan=function(e){this._virtualTableSpan=e};l._getVirtualTableSpan=function(){return this._virtualTableSpan};l.prototype._isHeaderMode=function(){return this._bHeaderMode};l.prototype._clampValues=function(e,t,o){var s=e.length-1,r=false,i;while(s>=0){i=e[s];if(i<t){e[s]=o;r=true}s--}return r};l.prototype._rescaleToUnit=function(e,t){var o,s,r,i,n,a;if(!t){t=0}s=e.length-1;o=0;r=i=0;while(s>=0){n=e[s];if(n>0){if(n<=t){i++}else{o+=e[s]}r++}s--}o-=(r-i)*t;a=(1-r*t)/o;s=e.length-1;while(s>=0){n=e[s];if(n>0){if(n<=t){e[s]=t}else{e[s]=(n-t)*a+t}}s--}};l.prototype._countGaps=function(e){var t=e.length-1,o=0;while(t>=0){if(e[t]>0){o++}t--}if(o===1){o=0}return o};l.prototype._rescaleByFactor=function(e,t){var o=e.length-1;while(o>=0){e[o]*=t;o--}};l.prototype._colorMap=[l._constants.sectorPositiveColor,l._constants.sectorNegativeColor,l._constants.sectorNeutralColor,l._constants.sectorPlannedColor,l._constants.sectorCriticalColor];l.prototype._calculateSectorRangeDefinitions=function(e,t){var o=[],s=-Math.PI/2,r,i=e.length,n=0;while(n<i){if(e[n]>0){r=s+2*Math.PI*e[n];o.push({start:s,end:r,color:this._colorMap[n]});s=r+t}n++}return o};l.prototype._renderDonutPercentages=function(e){var t=this.getState(),s=0,r,i=[0,0,0,0],n,a,c=l._constants.halfGapSize,u=l._constants.ringInnerRadius,p=l._constants.ringThickness,d=l._constants.ringInnerRadius+p,h=l._constants.outerCircleStrokeColor,_=l._constants.outerCircleStrokeWidth,y=l._constants.outerCircleRadius,f=l._constants.positionX,g=l._constants.positionY,m=l._constants.minPercentage;if(t&&Object.prototype.toString.call(t)==="[object Array]"&&t.length>0){t.forEach(function(e){switch(e.state){case o.ProcessFlowNodeState.Positive:i[0]=e.value;break;case o.ProcessFlowNodeState.Negative:i[1]=e.value;break;case o.ProcessFlowNodeState.Neutral:i[2]=e.value;break;case o.ProcessFlowNodeState.Planned:i[3]=e.value;break;case o.ProcessFlowNodeState.Critical:i[4]=e.value;break;default:i[3]=e.value}});this._clampValues(i,0,0);this._rescaleToUnit(i);this._rescaleToUnit(i,m);s=this._countGaps(i);n=1-s*c/Math.PI;this._rescaleByFactor(i,n);this._renderCircle(e,h,_,f,g,y);if(s>0){r=this._calculateSectorRangeDefinitions(i,2*c);this._renderDonutSectors(e,r,f,g,u,d)}else{a=this._selectColor(i);this._renderCircle(e,a,p,f,g,u+p/2,true)}}else{this._renderCircle(e,h,_,f,g,y)}};l.prototype._renderCircle=function(e,t,o,s,r,i,n){e.openStart("circle");var a=n?this.getId()+"-donut-circle-inner":this.getId()+"-donut-circle";e.attr("id",a);if(t!==l._constants.outerCircleStrokeColor){e.class("suiteUiCommonsProcessFlowHeaderIconFill").class(t)}else{e.class("suiteUiCommonsProcessFlowHeaderIconFill")}e.attr("stroke-width",o);e.attr("cx",s);e.attr("cy",r);e.attr("r",i);e.openEnd().close("circle")};l.prototype._renderDonutSectors=function(e,t,o,s,r,i){var n=0,a=t.length,l,c;while(n<a){l=t[n];c=this._getDonutSectorPath(o,s,l.start,l.end,r,i);e.openStart("path");e.attr("id",this.getId()+"-donut-segment-"+n);e.attr("d",c);e.attr("class",l.color);e.attr("opacity","1");e.openEnd().close("path");n++}};l.prototype._selectColor=function(e){var t;if(e[0]){t=l._constants.sectorPositiveColor}else if(e[1]){t=l._constants.sectorNegativeColor}else if(e[2]){t=l._constants.sectorNeutralColor}else if(e[3]){t=l._constants.sectorPlannedColor}else if(e[4]){t=l._constants.sectorCriticalColor}else{t=l._constants.sectorNeutralColor}return t};l.prototype._getDonutSectorPath=function(e,t,o,s,r,i){var n=0,a,l,c,u,p,d,h,_,y;if((s-o)%(Math.PI*2)>Math.PI){n=1}d=Math.cos(o);h=Math.cos(s);_=Math.sin(o);y=Math.sin(s);a=(e+r*d).toFixed(3)+","+(t+r*_).toFixed(3);l=(e+i*d).toFixed(3)+","+(t+i*_).toFixed(3);c=(e+i*h).toFixed(3)+","+(t+i*y).toFixed(3);u=(e+r*h).toFixed(3)+","+(t+r*y).toFixed(3);p="M"+a+"L"+l+"A"+i+","+i+" 0 "+n+" 1 "+c+"L"+u+"A"+r+","+r+" 0 "+n+" 0 "+a+"z";return p};l.prototype._destroyImage=function(){if(this._oImageControl){this._oImageControl.destroy()}this._oImageControl=null};l.prototype._clampText=function(){var e=this.$("lh-text").length?this.$("lh-text"):null,t=this.getText(),o="",s=l._constants.ellipsis,r=l._constants.ellipsisLength,i=r+1,n,a=t.length,c,u;if(e){c=parseInt(e.css("height").slice(0,-2),10);if(e[0].scrollHeight>c){u=e.css("visibility");e.css("visibility","hidden");o=t;do{n=i+a>>1;e.textContent=t.slice(0,n-r)+s;if(e.scrollHeight>c){a=n}else{i=n;o=e.textContent}}while(a-i>1);e.css("visibility",u)}if(e.scrollHeight>c){e.textContent=o}}};l._hasNativeLineClamp=function(){return document.documentElement.style.webkitLineClamp!==undefined}();l.prototype._getAriaTextForStatusValue=function(e){switch(e){case o.ProcessFlowNodeState.Positive:return this._oResBundle.getText("PF_ARIA_STATUS_POSITIVE");case o.ProcessFlowNodeState.Negative:return this._oResBundle.getText("PF_ARIA_STATUS_NEGATIVE");case o.ProcessFlowNodeState.Critical:return this._oResBundle.getText("PF_ARIA_STATUS_CRITICAL");case o.ProcessFlowNodeState.Planned:return this._oResBundle.getText("PF_ARIA_STATUS_PLANNED");case o.ProcessFlowNodeState.PlannedNegative:return this._oResBundle.getText("PF_ARIA_STATUS_PLNNEGATIVE");case o.ProcessFlowNodeState.Neutral:default:return this._oResBundle.getText("PF_ARIA_STATUS_NEUTRAL")}};l.prototype._getAriaText=function(){var e=this.getText();var t=this.getState();if(t){var o=[];for(var s in t){o.push(t[s].value)}this._clampValues(o,0,0);this._rescaleToUnit(o);var r=this._oResBundle.getText("PF_ARIA_STATUS");var i=false;for(var n in t){if(t[n].value!==0){var a=this._getAriaTextForStatusValue(t[n].state);var l=" "+Math.round(o[n]*100)+"% "+a+",";r=r.concat(l);i=true}}if(i){if(e==""){e=r.slice(0,-1)}else{e=e+", "+r.slice(0,-1)}}}return e};l.prototype._getSymbolAriaText=function(){var e="";switch(this._getSymbolType()){case l.symbolType.startSymbol:e=this._oResBundle.getText("PF_ARIA_SYMBOL_LANE_START");break;case l.symbolType.endSymbol:e=this._oResBundle.getText("PF_ARIA_SYMBOL_LANE_END");break;case l.symbolType.processSymbol:e=this._oResBundle.getText("PF_ARIA_SYMBOL_LANE_PROCESS");break;default:}return e};l.createNewStartSymbol=function(e){var t=new l({laneId:"processFlowLaneStart"});t._setSymbolType(l.symbolType.startSymbol,t);t._setHeaderMode(e);return t};l.createNewEndSymbol=function(e){var t=new l({laneId:"processFlowLaneEnd"});t._setSymbolType(l.symbolType.endSymbol,t);t._setHeaderMode(e);return t};l.createNewProcessSymbol=function(e){var t=new l({laneId:"processFlowLaneProcess",iconSrc:"sap-icon://process"});t._setSymbolType(l.symbolType.processSymbol,t);t._setHeaderMode(e);return t};l.enableEllipsisSupportForText=function(e){this._ellipsisDisabled=!e};l.prototype.getPosition=function(){if(this._mergedLanePosition){return this._mergedLanePosition}else{return this.getProperty("position")}};return l});