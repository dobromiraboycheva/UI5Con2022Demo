/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","./library","sap/ui/commons/library","sap/ui/commons/RowRepeater","sap/ui/commons/SegmentedButton","sap/ui/commons/SearchField","sap/ui/commons/Button","sap/ui/base/ManagedObject","sap/ui/core/ResizeHandler","./ViewRepeaterRenderer"],function(e,t,i,r,s,o,n,a,h,g){"use strict";var u=r.extend("sap.suite.ui.commons.ViewRepeater",{metadata:{deprecated:true,library:"sap.suite.ui.commons",properties:{itemMinWidth:{type:"int",group:"Misc",defaultValue:null},responsive:{type:"boolean",group:"Misc",defaultValue:false},defaultViewIndex:{type:"int",group:"Misc",defaultValue:0},showSearchField:{type:"boolean",group:"Misc",defaultValue:true},showViews:{type:"boolean",group:"Misc",defaultValue:true},external:{type:"boolean",group:"Misc",defaultValue:false},itemHeight:{type:"int",group:"Misc",defaultValue:null},height:{type:"sap.ui.core.CSSSize",group:"Misc",defaultValue:"100%"}},aggregations:{views:{type:"sap.suite.ui.commons.RepeaterViewConfiguration",multiple:true,singularName:"view"}},associations:{externalRepresentation:{type:"sap.ui.core.Control",multiple:false}},events:{search:{parameters:{query:{type:"string"}}},changeView:{parameters:{oldViewIndex:{type:"int"},newViewIndex:{type:"int"},filterId:{type:"string"},sorterId:{type:"string"},page:{type:"int"}}}}}});u.prototype.init=function(){this._rb=sap.ui.getCore().getLibraryResourceBundle("sap.suite.ui.commons");this.addStyleClass("suiteUiVr");r.prototype.init.call(this);this._oSegBtn=new s({id:this.getId()+"-segBtn"});this._repopulateViewSelector();this._oSearchField=new o({id:this.getId()+"-searchFld",enableFilterMode:true,enableListSuggest:false,search:function(e){this.fireSearch({query:e.getParameter("query")})}.bind(this)});this.attachFilter(function(e){this._currentFilterId=e.getParameter("filterId")});this.attachSort(function(e){this._currentSorterId=e.getParameter("sorterId")})};u.prototype.setDefaultViewIndex=function(e){this.setProperty("defaultViewIndex",e);this._selectDefaultView();return this};u.prototype._selectDefaultView=function(){var e=this.getDefaultViewIndex();if(e===this._currentViewIndex){return}var t=this.getViews()||[];if(t.length>0){if(e>=t.length){e=t.length-1}this.selectView(e);var i=this.getId()+"-"+t[e].getId()+"-triggerBtn";this._oSegBtn.setSelectedButton(i)}};u.prototype._repopulateViewSelector=function(){var t=this;var i=t._oSegBtn.removeAllAggregation("buttons",true);e.each(i,function(e,t){t.destroy()});var r=this.getViews()||[];for(var s=0;s<r.length;s++){var o=r[s];if(o.getExternal()){var a=o.getExternalRepresentation();if(!a.getModel()){a.setModel(this.getModel())}}var h=new n({id:this.getId()+"-"+o.getId()+"-triggerBtn",text:o.getTitle()||(o.getIcon()?undefined:this._rb.getText("VIEWREPEATER_TAB_DEFAULT_NAME",[s+1])),icon:o.getIcon(),iconHovered:o.getIconHovered(),iconSelected:o.getIconSelected(),tooltip:o.getTooltip(),lite:true});t._oSegBtn.addButton(h);h.attachPress(o,function(e,i){t.selectView(i);t._oSegBtn.rerender()})}this._selectDefaultView()};u.prototype.setModel=function(e,t){a.prototype.setModel.call(this,e,t);this._repopulateViewSelector();return this};u.prototype.addView=function(e){this.addAggregation("views",e);this._repopulateViewSelector();return this};u.prototype.removeAllViews=function(){var e=this.removeAllAggregation("views");this._repopulateViewSelector();return e};u.prototype.insertView=function(e,t){this.insertAggregation("views",e,t);this._repopulateViewSelector();return this};u.prototype.removeView=function(e){var t=this.removeAggregation("views",e);this._repopulateViewSelector();return t};u.prototype.selectView=function(e){var t,i=0;switch(typeof e){case"number":{t=this.getViews()[e];i=e;break}case"object":{var r=this.getViews().length;for(var s=0;s<r;s++){if(e.getId()===this.getViews()[s].getId()){t=e;i=s;break}}}default:break}if(!t){return}var o=t.getResponsive();if(typeof o==="boolean"){this.setResponsive(o)}var n=t.getItemMinWidth();if(typeof n==="number"&&n>0&&n!==this.setItemMinWidth()){this.setItemMinWidth(n)}var a=t.getItemHeight();if(a!==this.getItemHeight()&&a>0){this.setItemHeight(a)}if(t.getNumberOfTiles()>0&&t.getNumberOfTiles()!==this.setNumberOfRows()){this.setNumberOfRows(t.getNumberOfTiles())}var h=t.getExternal();if(h===true){this.setExternal(true);this.setExternalRepresentation(t.getExternalRepresentation())}else{this.setExternal(false);this.setExternalRepresentation(null)}var g=this.getCurrentPage();var u=t.getPath();var d=t.getTemplate();if(u&&d){this.bindRows(u,d);this._applyFilter(this._currentFilterId);this._applySorter(this._currentSorterId)}if(this._currentViewIndex||i!==this._currentViewIndex){this.fireChangeView({newViewIndex:i,oldViewIndex:this._currentViewIndex,filterId:this._currentFilterId,sorterId:this._currentSorterId,page:g})}this._currentViewIndex=i;this._oView=t};u.prototype._applyFilter=function(e,t){if(e){if(!t){t=this.getBinding("rows")}var i=this.getFilters();var r;var s=i.length;for(var o=0;o<s;o++){if(i[o].getId()===e){r=i[o];break}}if(r){t.filter(r.getFilters())}}};u.prototype._applySorter=function(e,t){if(e){if(!t){t=this.getBinding("rows")}var i;var r=this.getSorters();var s=r.length;for(var o=0;o<s;o++){if(r[o].getId()===e){i=r[o];break}}if(i){t.sort(i.getSorter())}}};u.prototype.onBeforeRendering=function(){if(this.getResponsive()&&this.getShowMoreSteps()===0){if(!this._bInit){this.setNumberOfRows(0)}}else if(this._oView&&this._oView.getNumberOfTiles()>0&&this._oView.getNumberOfTiles()!==this.getNumberOfRows()&&!this.getResponsive()){this.setNumberOfRows(this._oView.getNumberOfTiles())}this._bInit=false};u.prototype._updateBodyPosition=function(){var t=e("#"+this.getId()+">div.suiteUiVrViewSwHolder").outerHeight();var i=e("#"+this.getId()+">div.sapUiRrPtb").outerHeight();var r=e("#"+this.getId()+">div.sapUiRrStb").outerHeight();var s=e("#"+this.getId()+">div.sapUiRrFtr").outerHeight();var o=e(document.getElementById(this.getId()+"-body"));o.css("top",t+i+r+3+"px");o.css("bottom",s+"px")};u.prototype.onAfterRendering=function(){this._computeWidths(true);h.deregister(this._sResizeListenerId);if(this.getResponsive()){if(this.getShowMoreSteps()===0){e("#"+this.getId()+">div.sapUiRrFtr").hide()}setTimeout(function(){this._sResizeListenerId=h.register(this.getId()+"-body"?window.document.getElementById(this.getId()+"-body"):null,e.proxy(this._handleResize,this));if(this.getShowMoreSteps()===0){this._updateBodyPosition()}}.bind(this),100)}};u.prototype._handleResize=function(){if(!this.getDomRef()){return}this._computeWidths();if(this.getResponsive()&&this.getShowMoreSteps()===0){var t=e(document.getElementById(this.getId()+"-body"));var i=t.height();var r=this._itemsPerRow;var s=Math.floor(i/(this.getItemHeight()+3));var o=s*r;if(o!==this.getNumberOfRows()){this._bInit=true;this.setNumberOfRows(o)}else{e("#"+this.getId()+">div.sapUiRrFtr").show()}}};u.prototype._computeWidths=function(t){var i=this;var r=this.$();var s=i.getItemMinWidth();var o=this.getResponsive()===true?Math.floor(r.width()/s):1;var n=Math.floor(100/o);if(r.width()*n/100<s){o--;n=Math.floor(100/o)}if(t||i._height!==r.height()||i._itemsPerRow!==o){e("#"+this.getId()+" .sapUiRrBody").css("width","100%");var a=100-o*n;var h;e("#"+this.getId()+" .sapUiRrBody li").each(function(t){h=n;if(t%o<a){h++}e(this).css("width",h+"%");e(this).css("margin","0")});i._height=r.height();i._itemsPerRow=o;i._percentWidth=n}};u.prototype.startPagingAnimation=function(){h.deregister(this._sResizeListenerId);var t=sap.ui.getCore(),i=t.getRenderManager(),r=this.getId(),s=this.iPreviousPage,o=this.getCurrentPage(),n=this.getNumberOfRows(),a=(o-1)*n,g=this.getRows(),u=this._getRowCount()>n*o?n:this._getRowCount()-n*(o-1),d,l,p,c=this.getBinding("rows");var f,w=e(r+"-page_"+s?window.document.getElementById(r+"-page_"+s):null),m=r+"-body"?window.document.getElementById(r+"-body"):null,v=e(m);v.css("height",v.outerHeight()+"px");var y;if(sap.ui.getCore()&&sap.ui.getCore().getConfiguration()&&sap.ui.getCore().getConfiguration().getRTL()){y=o<s?"left":"right"}else{y=o<s?"right":"left"}if(c){this._bSecondPage=!this._bSecondPage;this.updateRows(true);g=this.getRows();a=(this._bSecondPage?1:0)*n}e('<ul id="'+r+"-page_"+o+'" class="sapUiRrPage"></ul>').css("top",w.outerHeight(true)+"px").css(y,w.outerWidth(true)+"px").appendTo(m);var _=m.lastChild;var I=e(_);var R=100-this._itemsPerRow*this._percentWidth;for(d=a,l=0;d<a+u;d++,l++){p=this._percentWidth;if(l%this._itemsPerRow<R){p++}e('<li id="'+r+"-row_"+d+'" class="sapUiRrRow"></li>').css("width",p+"%").appendTo(_);f=_.lastChild;i.render(g[d],f)}if(y==="right"){w.animate({right:-w.outerWidth(true)},"slow");I.animate({right:0},"slow")}else{w.animate({left:-w.outerWidth(true)},"slow");I.animate({left:0},"slow")}v.animate({height:I.outerHeight(true)},"slow",e.proxy(this.endPagingAnimation,this))};u.prototype.endPagingAnimation=function(){r.prototype.endPagingAnimation.call(this);this._sResizeListenerId=h.register(this.getId()+"-body"?window.document.getElementById(this.getId()+"-body"):null,e.proxy(this._handleResize,this))};u.prototype.exit=function(){this._oSegBtn.destroy();this._oSearchField.destroy();h.deregister(this._sResizeListenerId)};return u});