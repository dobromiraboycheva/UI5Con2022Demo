/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/commons/library","sap/ui/core/Control","sap/ui/commons/Button","sap/ui/commons/Label","sap/ui/commons/ListBox","sap/ui/commons/TextField","sap/ui/commons/TextArea","sap/ui/commons/FileUploader","sap/suite/ui/commons/NoteTakerCard","sap/ui/commons/Link","sap/ui/core/ListItem","sap/base/util/deepEqual","sap/ui/events/KeyCodes","./NoteTakerFeederRenderer"],function(t,e,o,s,i,a,n,d,l,u,h,r,p,T,g){"use strict";var _=o.extend("sap.suite.ui.commons.NoteTakerFeeder",{metadata:{deprecated:true,library:"sap.suite.ui.commons",properties:{body:{type:"string",group:"Data",defaultValue:null},title:{type:"string",group:"Data",defaultValue:null},tags:{type:"object",group:"Misc",defaultValue:[]},thumbUp:{type:"boolean",group:"Misc",defaultValue:null},thumbDown:{type:"boolean",group:"Misc",defaultValue:null},attachmentUploadUrl:{type:"string",group:"Misc",defaultValue:null},attachmentName:{type:"string",group:"Misc",defaultValue:"attachment"}},aggregations:{bodyArea:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"},titleInput:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"},fileUploader:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"},tagInput:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"}},events:{addNote:{parameters:{title:{type:"string"},body:{type:"string"},timestamp:{type:"object"},thumbUp:{type:"boolean"},thumbDown:{type:"boolean"},attachmentFilename:{type:"string"}}},attachmentSelect:{parameters:{filename:{type:"string"}}},attachmentUploadComplete:{parameters:{response:{type:"string"}}},attachmentDelete:{parameters:{filename:{type:"string"}}},attachmentClick:{parameters:{filename:{type:"string"}}}}}});_.prototype.init=function(){this._rb=sap.ui.getCore().getLibraryResourceBundle("sap.suite.ui.commons");this._selectedTags=[];this._bTagPopupOpen=false;var e=this;this._oAddButton=new s({id:this.getId()+"-add-button",text:this._rb.getText("NOTETAKERFEEDER_BUTTON_ADD_TEXT"),tooltip:this._rb.getText("NOTETAKERFEEDER_BUTTON_ADD_TOOLTIP"),press:function(){e._handleAdd()}});this._oAddButton.addStyleClass("sapSuiteUiCommonsNoteTakerFeederHeaderAddButton");this._oTagList=new a({id:this.getId()+"-tagListBox",visibleItems:10,width:"100%",height:"194px",select:function(t){e._handleListSelect(t)}});this._oTagInput=new n({id:this.getId()+"-inputTag",liveChange:function(t){e._handleTagInputLive(t)}});this.setAggregation("tagInput",this._oTagInput);this._oTagInput.onsapdown=function(o){o.preventDefault();o.stopPropagation();t("#"+e.getId()+"-tagListBox li:eq(0)").focus()};this._oCancelTagButton=new s({id:this.getId()+"-cancel-tags-button",text:this._rb.getText("NOTETAKERFEEDER_BUTTON_CANCEL_TAGS"),tooltip:this._rb.getText("NOTETAKERFEEDER_BUTTON_CANCEL_TAGS_TOOLTIP"),press:function(){e._toggleTagPopup()}});this._oCancelTagButton.addStyleClass("sapSuiteUiCommonsNoteTakerFeederCancelTagButton");this._oCancelTagButton.onfocusout=function(t){e._oTagInput.focus()};this._oAddTagButton=new s({id:this.getId()+"-add-tags-button",text:this._rb.getText("NOTETAKERFEEDER_BUTTON_ADD_TAGS"),tooltip:this._rb.getText("NOTETAKERFEEDER_BUTTON_ADD_TAGS_TOOLTIP"),press:function(){e._handleAddTag(e._oTagInput.getValue());e._oTagButton.rerender();e._toggleTagPopup()}});this._oTagButton=new s({id:this.getId()+"-tag-button",tooltip:this._rb.getText("NOTETAKERFEEDER_BUTTON_TAG_TOOLTIP"),press:function(){e._toggleTagPopup()}});this._oTagButton.addStyleClass("sapSuiteUiCommonsNoteTakerFeederTagButton");this._oTitle=new n({id:this.getId()+"-title-field",placeholder:this._rb.getText("NOTETAKERFEEDER_PLACEHOLDER_HEADER")+"...",maxLength:50});this.setAggregation("titleInput",this._oTitle);this._oBody=new d({id:this.getId()+"-body-field",placeholder:this._rb.getText("NOTETAKERFEEDER_PLACEHOLDER_BODY")+"...",required:true,liveChange:function(t){e._setAddButtonEnabled(t.mParameters["liveValue"],null)}});this.setAggregation("bodyArea",this._oBody);this._oThumbUpButton=new s({id:this.getId()+"-thumb-up-button",press:function(t){e._handleThumbUpButtonPress()},tooltip:this._rb.getText("NOTETAKERFEEDER_BUTTON_THUMB_UP_TOOLTIP")});this._oThumbUpButton.addStyleClass("sapSuiteUiCommonsNoteTakerFeederThumbUpButton");this._oThumbDownButton=new s({id:this.getId()+"-thumb-down-button",press:function(t){e._handleThumbDownButtonPress()},tooltip:this._rb.getText("NOTETAKERFEEDER_BUTTON_THUMB_DOWN_TOOLTIP")});this._oThumbDownButton.addStyleClass("sapSuiteUiCommonsNoteTakerFeederThumbDownButton");this._oFileUploader=new l({id:this.getId()+"-attach",uploadOnChange:false,name:this.getAttachmentName(),change:function(t){e._disableAddAttachBtn();var o=t.getParameter("newValue");e._oAttachmentLink.setText(o);e._oAttachmentLink.rerender();e._handleAddAttachUI();var s={};s.filename=o;e.fireAttachmentSelect(s);e._oTitle.focus()},uploadComplete:function(t){e._handleUploadComplete(t)}});this._oFileUploader.onfocusin=function(t){e._oTitle.focus()};this._oFileUploader.oBrowse.setText("");this.setAggregation("fileUploader",this._oFileUploader);this._oAddAttachButton=new s({id:this.getId()+"-attach-button",press:function(t){(e._oFileUploader.getId()+"-fu"?window.document.getElementById(e._oFileUploader.getId()+"-fu"):null).click()},tooltip:e._rb.getText("NOTETAKER_BUTTON_ATTACH_TOOLTIP")});this._oAddAttachButton.addStyleClass("sapSuiteUiCommonsNtAttachIcon");this._oAttachmentLoadingLabel=new i({id:this.getId()+"-loading-label",text:this._rb.getText("NOTETAKERFEEDER_LABEL_ATTACHMENT_LOADING")+"..."});this._oDeleteAttachButton=new s({id:this.getId()+"-delete-attach-button",lite:true,press:function(t){e._handleDeleteAttachUI();var o={filename:e._oFileUploader.getName()};e.fireAttachmentDelete(o)},tooltip:this._rb.getText("NOTETAKERFEEDER_BUTTON_DELETE_ATTACHMENT")});this._oAttachmentLink=new h({id:this.getId()+"-attachmentLink",tooltip:this._rb.getText("NOTETAKERFEEDER_LINK_ATTACHMENT_TOOLTIP"),press:function(t){var o={filename:e._oFileUploader.getName()};e.fireAttachmentClick(o)},width:"200px"});this._oRequiredLbl=new i({required:true}).addStyleClass("sapSuiteRequiredLbl")};_.prototype.exit=function(){this._oAddButton.destroy();this._oTitle.destroy();this._oBody.destroy();this._oTagButton.destroy();this._oTagList.destroy();this._oTagInput.destroy();this._oCancelTagButton.destroy();this._oAddTagButton.destroy();this._oThumbUpButton.destroy();this._oThumbDownButton.destroy();this._oFileUploader.destroy();this._oAddAttachButton.destroy();this._oAttachmentLoadingLabel.destroy();this._oDeleteAttachButton.destroy();this._oAttachmentLink.destroy();this._oRequiredLbl.destroy()};_.prototype._handleAdd=function(){if(this.getBody()){var e={};e.title=this.getTitle();e.body=this.getBody();e.timestamp=this._getTimestamp();e.tags=this._selectedTags;e.thumbUp=this.getThumbUp();e.thumbDown=this.getThumbDown();e.attachmentFilename=this._oFileUploader.getValue();this.setTitle("");this.setBody("");this.setThumbDown(false);this.setThumbUp(false);this._oFileUploader.setValue("");this._enableAddAttachBtn();this.fireAddNote(e);t(this._oFileUploader.oFileUpload).show();this._handleClearTag()}else{this._setAddButtonEnabled(this.getBody())}};_.prototype._getTimestamp=function(){return new Date};_.prototype.setTitle=function(t){this._oTitle.setValue(t);return this};_.prototype.getTitle=function(){return t(document.getElementById(this.getId()+"-title-field")).hasClass("sapSuiteUiCommonsPlaceholder")?"":this._oTitle.getValue()};_.prototype.setBody=function(t){this._oBody.setValue(t);return this};_.prototype.getBody=function(){return this._isBodyPlaceholderActive()?"":this._oBody.getValue()};_.prototype._applyPlaceholder=function(){t("[data-placeholder]").focus(function(){var e=t(this);if(e.hasClass("sapSuiteUiCommonsPlaceholder")){e.val("");e.removeClass("sapSuiteUiCommonsPlaceholder")}}).blur(function(){var e=t(this);if(p(e.val(),"")||p(e.val(),e.attr("data-placeholder"))){e.addClass("sapSuiteUiCommonsPlaceholder");e.val(e.attr("data-placeholder"))}}).blur()};_.prototype._isBodyPlaceholderActive=function(){return t(document.getElementById(this.getId()+"-body-field")).hasClass("sapSuiteUiCommonsPlaceholder")};_.prototype._setAddButtonEnabled=function(t,e){var o=t!==null&&!this._isBodyPlaceholderActive()&&!/^\s*$/.test(t);if(o!==this._oAddButton.getEnabled()){this._oAddButton.setEnabled(o);if(!e){this._oAddButton.rerender()}}};_.prototype._adjustUploaderForIe=function(){this._oFileUploader.superOnkeydown=this._oFileUploader.onkeydown;this._oFileUploader.onkeydown=function(t){var e=t.keyCode,o=T;if(e!==o.SPACE&&e!==o.ENTER){this.superOnkeydown(t)}};t(this._oFileUploader.oFilePath.getDomRef()).hide();t(this._oFileUploader.oBrowse.getDomRef()).hide();t(this._oAddAttachButton.getDomRef()).attr("tabindex","-1");var e=this;t(this._oFileUploader.oFileUpload).attr("tabindex","0").attr("title",this._rb.getText("NOTETAKER_BUTTON_ATTACH_TOOLTIP")).on("focus",function(){this.hasFocus=true;t(e._oAddAttachButton.getDomRef()).addClass("sapUiBtnStdFocus")}).on("focusout",function(){this.hasFocus=false;t(e._oAddAttachButton.getDomRef()).removeClass("sapUiBtnStdFocus")}).on("hover",function(){t(e._oAddAttachButton.getDomRef()).addClass("sapUiBtnStdFocus")},function(){if(!this.hasFocus){t(e._oAddAttachButton.getDomRef()).removeClass("sapUiBtnStdFocus")}t(e._oAddAttachButton.getDomRef()).removeClass("sapSuiteUiCommonsNoteTakerFeederButtonSelected")}).on("mousedown",function(){t(e._oAddAttachButton.getDomRef()).addClass("sapSuiteUiCommonsNoteTakerFeederButtonSelected").addClass("sapUiBtnAct")}).on("mouseup",function(){t(e._oAddAttachButton.getDomRef()).removeClass("sapSuiteUiCommonsNoteTakerFeederButtonSelected")});t(this._oFileUploader.oFileUpload).keydown(function(t){var o=T;if(t.keyCode===o.TAB){if(t.shiftKey){e._oThumbDownButton.focus()}else{e._oTitle.focus()}t.preventDefault();t.stopPropagation()}})};_.prototype._setAriaInfo=function(){t(document.getElementById(this._oThumbUpButton.getId())).attr("aria-pressed",this.getThumbUp());t(document.getElementById(this._oThumbDownButton.getId())).attr("aria-pressed",this.getThumbDown());t(document.getElementById(this._oTitle.getId())).attr("aria-label",this._rb.getText("NOTETAKERFEEDER_PLACEHOLDER_HEADER"));t(document.getElementById(this._oBody.getId())).attr("aria-label",this._rb.getText("NOTETAKERFEEDER_PLACEHOLDER_BODY"));t(this._oFileUploader.oFileUpload).attr("aria-label",this._rb.getText("NOTETAKER_BUTTON_ATTACH_TOOLTIP"))};_.prototype.onAfterRendering=function(){this._applyPlaceholder();this._adjustPopupState();if(this._oFileUploader.getValue()){t(document.getElementById(this.getId()+"-attachment-panel")).show();t(document.getElementById(this.getId()+"-attachment-loading")).hide();t(document.getElementById(this.getId()+"-attachment-delete")).show()}t(document.getElementById(this._oFileUploader.getId())).addClass("sapSuiteUiCommonsNtfUploader");this._setAriaInfo();if(t.browser.msie){this._adjustUploaderForIe()}};_.prototype.onBeforeRendering=function(){this._setAddButtonEnabled(this.getBody(),true);this._setThumbButtonsView()};_.prototype.getFormattedTags=function(){return u.prototype._getFormattedTags()};_.prototype._adjustPopupState=function(){if(this._bTagPopupOpen){t(document.getElementById(this.getId()+"-selectTag-panel")).show()}};_.prototype._handleAddTag=function(t){this._selectedTags=[];var e=t.split(new RegExp("\\s+"));var o={};for(var s=0;s<e.length;s++){if(e[s].length!==0){o[e[s]]=0}}for(var i in o){this._selectedTags.push(i)}if(this._oTagButton){this._adjustTagButton()}};_.prototype._adjustTagButton=function(){if(this._selectedTags.length){this._oTagButton.setTooltip(this._rb.getText("NOTETAKERFEEDER_BUTTON_ADD_TAGS_SELECTED_TOOLTIP")+": "+this._selectedTags.join(" "));this._oTagButton.addStyleClass("sapSuiteUiCommonsNoteTakerFeederButtonSelected")}else{this._oTagButton.setTooltip(this._rb.getText("NOTETAKERFEEDER_BUTTON_TAG_TOOLTIP"));this._oTagButton.removeStyleClass("sapSuiteUiCommonsNoteTakerFeederButtonSelected")}};_.prototype._handleClearTag=function(){if(this._oTagInput){this._oTagInput.setValue("")}if(this._oTagList){this._oTagList.clearSelection()}this._selectedTags=[];if(this._oTagButton){this._adjustTagButton()}};_.prototype.setTags=function(t){this.setProperty("tags",t,true);return this};_.prototype._toggleTagPopup=function(){if(this._bTagPopupOpen){t(document.getElementById(this.getId()+"-selectTag-panel")).slideToggle();this._focusDefaultControl();this._bTagPopupOpen=false}else{this._addTagsToListBox(this.getTags());t(document.getElementById(this.getId()+"-selectTag-panel")).slideToggle();t(document.getElementById(this.getId()+"-inputTag")).val(this._selectedTags.length===0?"":this._selectedTags.join(" ")+" ");this._oTagInput.focus();this._bTagPopupOpen=true}};_.prototype._focusDefaultControl=function(){this._oTagButton.focus()};_.prototype._handleTagInputLive=function(t){var e=t.getParameter("liveValue");var o=e.split(" ");var s=o[o.length-1];this._filterListBox(s)};_.prototype._filterListBox=function(e){if(e.length===0){this._addTagsToListBox(this.getTags());return}var o=t.grep(this.getTags(),function(t){return t.indexOf(e)>=0});this._addTagsToListBox(o)};_.prototype._addTagsToListBox=function(e){var o=t.map(e,function(t,e){return new r({text:t})});this._oTagList.setItems(o,true);this._oTagList.rerender()};_.prototype._handleListSelect=function(t){var e=t.getParameter("selectedItem").getText();var o=this._oTagInput.getValue();var s=o.split(" ");s.pop();if(s.length===0){this._oTagInput.setValue(e+" ")}else{this._oTagInput.setValue(s.join(" ")+" "+e+" ")}this._oTagList.setSelectedIndex(-1);this._oTagInput.focus()};_.prototype._setThumbButtonsView=function(){if(this.getThumbUp()){this._oThumbUpButton.addStyleClass("sapSuiteUiCommonsNoteTakerFeederButtonSelected")}else{this._oThumbUpButton.removeStyleClass("sapSuiteUiCommonsNoteTakerFeederButtonSelected")}if(this.getThumbDown()){this._oThumbDownButton.addStyleClass("sapSuiteUiCommonsNoteTakerFeederButtonSelected")}else{this._oThumbDownButton.removeStyleClass("sapSuiteUiCommonsNoteTakerFeederButtonSelected")}};_.prototype._handleThumbUpButtonPress=function(){this.setThumbUp(!this.getThumbUp());if(this.getThumbUp()){this.setThumbDown(false)}};_.prototype._handleThumbDownButtonPress=function(){this.setThumbDown(!this.getThumbDown());if(this.getThumbDown()){this.setThumbUp(false)}};_.prototype._disableAddAttachBtn=function(){this._oAddAttachButton.setEnabled(false);this._oAddAttachButton.removeStyleClass("sapSuiteUiCommonsNtAttachIcon");this._oAddAttachButton.addStyleClass("sapSuiteUiCommonsNtDsblAttachIcon");this._oAddAttachButton.setTooltip("");this._oAddAttachButton.rerender()};_.prototype._enableAddAttachBtn=function(){this._oAddAttachButton.setEnabled(true);this._oAddAttachButton.removeStyleClass("sapSuiteUiCommonsNtDsblAttachIcon");this._oAddAttachButton.addStyleClass("sapSuiteUiCommonsNtAttachIcon");this._oAddAttachButton.setTooltip(this._rb.getText("NOTETAKER_BUTTON_ATTACH_TOOLTIP"));this._oAddAttachButton.rerender();if(t.browser.msie){t(document.getElementById(this._oAddAttachButton.getId())).attr("tabindex","-1")}};_.prototype._handleAddAttachUI=function(){t(this._oFileUploader.oFileUpload).hide();t(document.getElementById(this.getId()+"-attachment-loading")).show("fast");t(document.getElementById(this.getId()+"-body")).animate({height:"332px"},300);t(document.getElementById(this.getId()+"-attachment-panel")).slideDown({duration:300,queue:false})};_.prototype._handleDeleteAttachUI=function(){t(this._oFileUploader.oFileUpload).show();t(document.getElementById(this.getId()+"-body")).animate({height:"352px"},300);t(document.getElementById(this.getId()+"-attachment-delete")).hide("fast");t(document.getElementById(this.getId()+"-attachment-panel")).hide({duration:300,queue:false});this._enableAddAttachBtn();this._oFileUploader.setValue("");this._oFileUploader.addStyleClass("sapSuiteUiCommonsNtfUploader");this._oAttachmentLink.setText("");this._oAddAttachButton.focus()};_.prototype.handleUploadResponse=function(t){};_.prototype._handleUploadComplete=function(e){t(document.getElementById(this.getId()+"-attachment-loading")).hide("fast");t(document.getElementById(this.getId()+"-attachment-delete")).show("fast");var o={response:e.getParameter("response")};this.fireAttachmentUploadComplete(o)};_.prototype.setAttachmentUploadUrl=function(t){this._oFileUploader.setUploadUrl(t);return this};_.prototype.getAttachmentUploadUrl=function(){return this._oFileUploader.getUploadUrl()};return _});