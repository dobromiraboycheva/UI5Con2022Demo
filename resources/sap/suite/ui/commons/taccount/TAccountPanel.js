sap.ui.define(["sap/ui/thirdparty/jquery","sap/suite/ui/commons/library","sap/ui/core/Control","sap/ui/core/theming/Parameters","sap/m/Panel","sap/ui/model/json/JSONModel","sap/m/Dialog","sap/m/Button","sap/m/FlexBox","sap/m/Label","sap/ui/model/Filter","sap/m/SearchField","sap/m/List","sap/m/StandardListItem","sap/m/CheckBox","sap/m/Title","sap/m/Toolbar","sap/m/ToolbarSpacer","sap/m/Text","sap/m/SegmentedButton","sap/m/SegmentedButtonItem","sap/ui/model/FilterOperator","sap/base/security/encodeXML","sap/ui/core/format/NumberFormat","sap/ui/core/Core","sap/ui/core/Configuration","./TAccountUtils","./TAccountPanelRenderer","sap/m/library","sap/ui/thirdparty/bignumber"],function(e,t,o,i,s,a,r,n,l,p,u,c,h,m,d,g,T,_,y,f,S,C,b,v,A,P,w,x,B,I){"use strict";var L=B.ButtonType;var U=A.getLibraryResourceBundle("sap.suite.ui.commons");var O=t.taccount.TAccountPanelState;var D=s.extend("sap.suite.ui.commons.taccount.TAccountPanel",{metadata:{library:"sap.suite.ui.commons",properties:{title:{type:"string",group:"Misc",defaultValue:null},state:{type:"sap.suite.ui.commons.taccount.TAccountPanelState",group:"Misc",defaultValue:"Default"},showOverlay:{type:"boolean",group:"Misc",defaultValue:false},maxFractionDigits:{type:"int",group:"Misc",defaultValue:2}},aggregations:{properties:{type:"sap.suite.ui.commons.taccount.TAccountItemProperty",multiple:true,singularName:"property"},table:{type:"sap.ui.core.Control",multiple:false}},events:{stateChanged:{parameters:{state:"sap.suite.ui.commons.taccount.TAccountPanelState"}},settingsApplied:{parameters:{properties:"object"}}}}});D.prototype.init=function(){this._bDisplayLabels=true};D.prototype.onBeforeRendering=function(){this._oSum=null;this._bRendered=false;this._prepareProperties();this._createToolbar()};D.prototype.onAfterRendering=function(){var e=this.$();this._switchContent(this.getState()===O.Table);this._bRendered=true;e.attr("aria-label",this._getAriaLabelText());e.addClass("sapSuiteUiCommonsAccountPanel");this._setTotalBalanceTitle()};D.prototype.getSum=function(){var e=new I("0"),t="",o=true,i=this.getContent();if(!this._oSum){for(var s=0;s<i.length;s++){var a=i[s];if(a instanceof sap.suite.ui.commons.taccount.TAccountGroup){var r=a._getSum();if(t&&t!==r.measure||!r.correct){o=false;break}t=r.measure;e=e.plus(r.sum)}}this._oSum={measure:t,sum:e||0,correct:o}}return this._oSum};D.prototype.switchContent=function(e){var t=e?O.Table:O.Default;this._switchContent(e);this.setProperty("state",t,true)};D.prototype.getSettingsDialog=function(){return this._getPopover()};D.prototype.getToolbar=function(){return this._getToolbar()};D.prototype.openSettings=function(){this._oSelectAllCheckBox&&this._oSelectAllCheckBox.setText(this._getSelectAllText());this._getPopover().open()};D.prototype.reset=function(){this._oSum=null;if(this._oPopover){this._oPopover.destroy();this._oPopover=null}};D.prototype.setState=function(e){var t=e===O.Table;this._switchContent(t);this.setProperty("state",e,true);return this};D.prototype.updateBindingContext=function(){this.reset();return o.prototype.updateBindingContext.apply(this,arguments)};D.prototype._switchContent=function(e){var t=e?O.Table:O.Default;this.$("table")[e?"show":"hide"]();this.$("datacontent")[e?"hide":"show"]();if(this._oDisplaySwitcher){this._oDisplaySwitcher.setSelectedKey(t)}};D.prototype._prepareProperties=function(){this._mProperties={};this.getProperties().forEach(function(e){var t=e.getKey();if(t){this._mProperties[t]=e}}.bind(this))};D.prototype._setPropertiesVisibility=function(t){var o=this.$();Object.keys(t).forEach(function(i){var s=t[i],a=o.find(".sapSuiteUiCommonsAccountPropertyWrapper[key="+i+"]");a.each(function(t,o){var i=s.getVisible(),a=A.byId(o.id);if(a){a.setProperty("visible",i,true);a.getParent()._refreshAriaLabel()}e(o)[i?"show":"hide"]()})});o.find(".sapSuiteUiCommonsAccountItemLabel")[this._bDisplayLabels?"show":"hide"]()};D.prototype._getPopover=function(){if(!this._oPopover){this._createPopover()}return this._oPopover};D.prototype._getSelectAllText=function(e){var t=this.getProperties();if(!e&&e!==0){e=t.reduce(function(e,t){return e+(t.getVisible()?1:0)},0)}this._iSelectedCount=e;return U.getText("TACCOUNT_SELECTALL")+" ("+e+"/"+t.length+")"};D.prototype._createPopover=function(){var e=this,t=false;if(!this._oPopover){this._oPopover=new r({contentWidth:"450px",title:U.getText("TACCOUNT_DISPLAYOPTIONS"),afterOpen:function(){if(!t){var o=e._oPopover.$().height();e._oPopover.setProperty("contentHeight",o+"px",true);t=true}}})}this._oPopover.setEndButton(new n({text:U.getText("TACCOUNT_CANCEL"),press:function(t){e._oPopover.close()}}));this._oPopover.setBeginButton(new n({text:U.getText("TACCOUNT_OK"),type:L.Emphasized,press:function(t){var o=_.getSelectedContexts(true),s=_.getModel();var a={},r={};o.forEach(function(t){var o=s.getProperty(t.sPath);if(o){var i=e._mProperties[o.key];a[o.key]=1;if(i&&!i.getVisible()){i.setProperty("visible",true,true);r[o.key]=i}}});Object.keys(e._mProperties).forEach(function(t){var o=e._mProperties[t];if(o.getVisible()&&!a[t]){o.setProperty("visible",false,true);r[t]=o}});e._bDisplayLabels=i.getSelected();if(e.fireEvent("settingsApplied",{properties:r},true)){e._setPropertiesVisibility(r)}e._oPopover.close()}}));this._oPopover.removeAllContent();var o=new l({width:"100%",renderType:"Bare",direction:"Column"});this._oPopover.addContent(o);var i=new d({selected:this._bDisplayLabels}).addStyleClass("sapUiTinyMarginBegin");var s=new l({renderType:"Bare",alignItems:"Center",items:[i,new p({text:"Show labels"}).addStyleClass("sapUiTinyMarginBegin")]}).addStyleClass("sapUiTinyMarginBottom sapUiTinyMarginTop");o.addItem(s);var g=function(e){var t=[],o=e.getSource().getValue();if(o&&o.length>0){t.push(new u("title",C.Contains,o))}var i=_.getBinding("items");i.filter(t,"Application")};var T=new c({width:"100%",liveChange:g}).addStyleClass("sapSuiteUiCommonsAccountsPopupSearch");o.addItem(T);var _=new h({width:"100%",mode:"MultiSelect",includeItemInSelection:true,selectionChange:function(t){var o=t.getParameter("listItem").getSelected();e._oSelectAllCheckBox.setText(e._getSelectAllText(e._iSelectedCount+(o?1:-1)));e._oSelectAllCheckBox.setSelected(y.length===e._iSelectedCount)}}).addStyleClass("sapSuiteUiCommonsAccountsPopupList");_.bindAggregation("items",{path:"/items",template:new m({title:"{title}",selected:"{selected}"})});var y=this.getProperties(),f=this._getSelectAllText();this._oSelectAllCheckBox=new d({selected:y.length===e._iSelectedCount,text:f,select:function(t){var o=t.getSource().getSelected();e._oSelectAllCheckBox.setText(e._getSelectAllText(o?y.length:0));_.getItems().forEach(function(e){e.setSelected(o)})}}).addStyleClass("sapUiTinyMarginBegin sapUiTinyMarginEnd sapSuiteUiCommonsAccountsPopupSelectAll");var S=new l({renderType:"Bare",alignItems:"Center"}).addStyleClass("sapSuiteUiCommonsAccountsPopupSelectAllWrapper");S.addItem(this._oSelectAllCheckBox);o.addItem(S);o.addItem(_);var b=[];y.forEach(function(e){b.push({title:e._getLabel(),key:e.getKey(),selected:e.getVisible()})});_.setModel(new a({items:b}));return this._oPopover};D.prototype._getToolbar=function(){if(!this._oToolbar){this._createToolbar()}return this._oToolbar};D.prototype._createToolbar=function(){var e=this;if(this._oToolbar){return}this._oToolbar=new T;this._oToolbar.addContent(new g(this.getId()+"-toolbartitle",{text:this.getTitle()}));this._oToolbar.addContent(new _(this.getId()+"-toolbarspacer"));this._oToolbar.addContent(new y(this.getId()+"-toolbarbalancelabel",{wrapping:false,text:U.getText("TACCOUNT_TOTALBALANCE")+":"}).addStyleClass("sapSuiteUiCommonsAccountPanelLabel"));this._oToolbar.addContent(new y(this.getId()+"-toolbarsumtitle",{wrapping:false}).addStyleClass("sapSuiteUiCommonsAccountPanelSum"));this._oDisplaySwitcher=new f(this.getId()+"-toolbarswitcher",{selectionChange:function(t){var o=A.byId(e._oDisplaySwitcher.getSelectedItem());if(o){e.switchContent(o.getKey()===O.Table);e.fireStateChanged({state:o.getKey()})}},items:[new S({key:O.Default,tooltip:U.getText("TACCOUNT_DEFAULT"),icon:"sap-icon://screen-split-two"}),new S({key:O.Table,tooltip:U.getText("TACCOUNT_TABLE"),icon:"sap-icon://table-chart"})]});this._oToolbar.addContent(this._oDisplaySwitcher);this._oToolbar.addContent(new n(this.getId()+"-toolbarsettings",{icon:"sap-icon://action-settings",press:this.openSettings.bind(this)}));this.setHeaderToolbar(this._oToolbar)};D.prototype._getSumText=function(){var e=this.getSum();if(!e.correct){return" - "}return w.formatCurrency(Math.abs(e.sum),e.measure,this.getMaxFractionDigits())+" "+b(e.measure)};D.prototype._setTotalBalanceTitle=function(){var e=this.getSum(),t="";if(!e.correct||e.sum.isEqualTo(0)){t=U.getText("TACCOUNT_TOTALBALANCE")}else{t=e.sum.isGreaterThan(0)?U.getText("TACCOUNT_TOTALCREDIT"):U.getText("TACCOUNT_TOTALDEBIT")}this.$("toolbarbalancelabel").text(t+":");this.$("toolbarsumtitle").text(this._getSumText())};D.prototype._getAriaLabelText=function(){return"T account panel "+this.getTitle()+" "+this._getSumText()};D.prototype._recalculate=function(){this._oSum=null;this._oSum=this.getSum();this._setTotalBalanceTitle()};D.prototype._valueChanged=function(e,t){var o=this.getSum();if(o.correct){if(t){this._oSum.sum=this._oSum.sum.minus(e)}else{this._oSum.sum=this._oSum.sum.plus(e)}}this._setTotalBalanceTitle()};D.prototype.setShowOverlay=function(e){this.setProperty("showOverlay",e,true);this.$("overlay")[e?"addClass":"removeClass"]("sapSuiteUiCommonsAccountPanelOverlayVisible")};D.prototype._setInvalid=function(){if(this._oSum){this._oSum.correct=false;this._setTotalBalanceTitle()}};D.prototype.invalidate=function(){this._bRendered=false;o.prototype.invalidate.apply(this,arguments)};return D});