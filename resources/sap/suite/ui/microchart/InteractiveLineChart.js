/*!
 * SAPUI5
 * (c) Copyright 2009-2022 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","./library","sap/m/library","sap/ui/core/Control","sap/suite/ui/microchart/InteractiveLineChartPoint","sap/ui/Device","sap/ui/core/ResizeHandler","sap/m/FlexBox","sap/base/Log","sap/f/IllustratedMessage","sap/f/library","./InteractiveLineChartRenderer"],function(t,e,i,s,a,r,n,o,l,p,h){"use strict";var d=s.extend("sap.suite.ui.microchart.InteractiveLineChart",{metadata:{library:"sap.suite.ui.microchart",properties:{displayedPoints:{type:"int",group:"Appearance",defaultValue:6},precedingPoint:{type:"float",group:"Data",defaultValue:0},succeedingPoint:{type:"float",group:"Data",defaultValue:0},selectionEnabled:{type:"boolean",group:"Behavior",defaultValue:true},showError:{type:"boolean",group:"Appearance",defaultValue:false},errorMessageTitle:{type:"string",group:"Appearance"},errorMessage:{type:"string",group:"Appearance"}},defaultAggregation:"points",aggregations:{points:{type:"sap.suite.ui.microchart.InteractiveLineChartPoint",multiple:true,bindable:"bindable"}},events:{selectionChanged:{parameters:{selectedPoints:{type:"sap.suite.ui.microchart.InteractiveLineChartPoint[]"},point:{type:"sap.suite.ui.microchart.InteractiveLineChartPoint"},selected:{type:"boolean"}}},press:{}},associations:{ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"}}}});d.MAX_SCALED_CANVAS_VALUE=99;d.MIN_SCALED_CANVAS_VALUE=1;d.AREA_WIDTH_INTERACTIVE_MINVALUE=48;d.AREA_WIDTH_INTERACTIVE_MINVALUE_COMPACT=32;d.CHART_HEIGHT_MINVALUE=106;d.AREA_WIDTH_MINVALUE=24;d.LABEL_WIDTH_MINVALUE=32;d.AREA_WIDTH_SMALLFONT=36;d.prototype.init=function(){this._oRb=sap.ui.getCore().getLibraryResourceBundle("sap.suite.ui.microchart");this._aNormalizedValues=[];this._iAreaWidthInteractiveMinValue=d.AREA_WIDTH_INTERACTIVE_MINVALUE;this._bInteractiveMode=true;this._fNormalizedZero=0;this._bThemeApplied=true;this._oIllustratedMessageControl=new p({illustrationSize:h.IllustratedMessageSize.Base,illustrationType:h.IllustratedMessageType.NoData});if(!sap.ui.getCore().isInitialized()){this._bThemeApplied=false;sap.ui.getCore().attachInit(this._handleCoreInitialized.bind(this))}else{this._handleCoreInitialized()}};d.prototype._handleCoreInitialized=function(){this._bThemeApplied=sap.ui.getCore().isThemeApplied();sap.ui.getCore().attachThemeChanged(this._handleThemeApplied,this)};d.prototype.onBeforeRendering=function(){this._bCompact=this._isCompact();this._bInteractiveMode=true;var t=this.getPoints();this._errorMessage=this.getErrorMessage();this._errorMessageTitle=this.getErrorMessageTitle();this._oIllustratedMessageControl.setTitle(this._errorMessageTitle);this._oIllustratedMessageControl.setDescription(this._errorMessage);this._iVisiblePointsCount=Math.min(this.getDisplayedPoints(),t.length);this._setResponsivenessData();if(!this.data("_parentRenderingContext")&&typeof this.getParent==="function"){this.data("_parentRenderingContext",this.getParent())}this._updateNormalizedValues();this._deregisterResizeHandler();this._bSemanticTooltip=false;for(var e=0;e<this._iVisiblePointsCount;e++){if(t[e].getColor()!==i.ValueColor.Neutral){this._bSemanticTooltip=true;break}}};d.prototype.onAfterRendering=function(){this._adjustToParent();e._checkControlIsVisible(this,this._onControlIsVisible);this._bindMouseEnterLeaveHandler()};d.prototype._onControlIsVisible=function(){this._sResizeHandlerId=n.register(this,this._onResize.bind(this));this._onResize()};d.prototype.exit=function(){this._deregisterResizeHandler();this._oIllustratedMessageControl.destroy()};d.prototype.onclick=function(e){if(!this.getSelectionEnabled()){return}if(this._bInteractiveMode){var i=t(e.target).parent();var s,a=this.$().find(".sapSuiteILCInteractionArea");var n=this.$().find(".sapSuiteILCSection").index(i);if(n>=0){this._toggleSelected(n);s=a.index(this.$().find(".sapSuiteILCInteractionArea[tabindex='0']"));this._switchTabindex(s,n,a)}}else{this.firePress();if(r.browser.msie){this.$().trigger("focus");e.preventDefault()}}};d.prototype.onsapleft=function(t){var e=this.$().find(".sapSuiteILCInteractionArea");var i=e.index(t.target);if(e.length>0){this._switchTabindex(i,i-1,e)}t.preventDefault();t.stopImmediatePropagation()};d.prototype.onsapright=function(t){var e=this.$().find(".sapSuiteILCInteractionArea");var i=e.index(t.target);if(e.length>0){this._switchTabindex(i,i+1,e)}t.preventDefault();t.stopImmediatePropagation()};d.prototype.onsapup=d.prototype.onsapleft;d.prototype.onsapdown=d.prototype.onsapright;d.prototype.onsapenter=function(t){if(this._bInteractiveMode){var e=this.$().find(".sapSuiteILCInteractionArea").index(t.target);if(e!==-1){this._toggleSelected(e)}t.preventDefault();t.stopImmediatePropagation()}else{this.firePress()}};d.prototype.onsapspace=d.prototype.onsapenter;d.prototype.onsaphome=function(t){var e=this.$().find(".sapSuiteILCInteractionArea");var i=e.index(t.target);if(i!==0&&e.length>0){this._switchTabindex(i,0,e)}t.preventDefault();t.stopImmediatePropagation()};d.prototype.onsapend=function(t){var e=this.$().find(".sapSuiteILCInteractionArea");var i=e.index(t.target),s=e.length;if(i!==s-1&&s>0){this._switchTabindex(i,s-1,e)}t.preventDefault();t.stopImmediatePropagation()};d.prototype.getTooltip_AsString=function(t){if(this._isChartEnabled()){i=this._createTooltipText(t,true);if(!i&&e._isTooltipSuppressed(i)){i=null}}else{var i=this.getTooltip_Text();if(!i){i=this._createTooltipText()}else if(e._isTooltipSuppressed(i)){i=null}}return i};d.prototype.getSelectedPoints=function(){var t=[],e=this.getAggregation("points");for(var i=0;i<e.length;i++){if(e[i].getSelected()){t.push(e[i])}}return t};d.prototype.setSelectedPoints=function(t){var e=this.getAggregation("points"),i;this._deselectAllSelectedPoints();if(!t){return this}if(t instanceof a){t=[t]}if(Array.isArray(t)){for(var s=0;s<t.length;s++){i=this.indexOfAggregation("points",t[s]);if(i>=0){e[i].setProperty("selected",true,true)}else{l.warning("setSelectedPoints method called with invalid InteractiveLineChartPoint element")}}}this.invalidate();return this};d.prototype._fnIsNumber=function(t){return typeof t==="number"&&!isNaN(t)&&isFinite(t)};d.prototype._isCompact=function(){return t("body").hasClass("sapUiSizeCompact")||this.$().is(".sapUiSizeCompact")||this.$().closest(".sapUiSizeCompact").length>0};d.prototype._setResponsivenessData=function(){if(this._bCompact){this._iAreaWidthInteractiveMinValue=d.AREA_WIDTH_INTERACTIVE_MINVALUE_COMPACT}else{this._iAreaWidthInteractiveMinValue=d.AREA_WIDTH_INTERACTIVE_MINVALUE}};d.prototype._handleThemeApplied=function(){this._bThemeApplied=true;this._bCompact=this._isCompact()};d.prototype._deselectAllSelectedPoints=function(){var t=this.getPoints();for(var e=0;e<t.length;e++){if(t[e].getSelected()){t[e].setProperty("selected",false,true)}}};d.prototype._switchTabindex=function(t,e,i){if(t>=0&&t<i.length&&e>=0&&e<i.length){i.eq(t).removeAttr("tabindex");i.eq(e).attr("tabindex","0");i.eq(e).trigger("focus")}};d.prototype._toggleSelected=function(t){var e=this.getPoints()[t],i=this.$("point-area-"+t),s=this.$("point-"+t);if(e.getSelected()){i.add(s).removeClass("sapSuiteILCSelected");e.setProperty("selected",false,true)}else{i.add(s).addClass("sapSuiteILCSelected");e.setProperty("selected",true,true)}i.find(".sapSuiteILCInteractionArea").attr("aria-selected",e.getSelected());this.fireSelectionChanged({selectedPoints:this.getSelectedPoints(),point:e,selected:e.getSelected()})};d.prototype._updateNormalizedValues=function(){var t=this.getPoints(),e=t.length,i=0;this.nMax=-Number.MAX_VALUE;this.nMin=Number.MAX_VALUE;this._aNormalizedValues=[];for(i=0;i<e;i++){if(!t[i]._bNullValue){var s=t[i].getValue();this.nMax=Math.max(this.nMax,s);this.nMin=Math.min(this.nMin,s)}}var a=this.nMax!=-Number.MAX_VALUE&&this.nMin!==Number.MAX_VALUE?this.nMax-this.nMin:0;var r=function(t){if(typeof t!=="undefined"){var e=(t-this.nMin)/a;return d.MIN_SCALED_CANVAS_VALUE+e*(d.MAX_SCALED_CANVAS_VALUE-d.MIN_SCALED_CANVAS_VALUE)}return null}.bind(this);for(i=0;i<e;i++){if(t[i]._bNullValue){this._aNormalizedValues.push(0)}else{this._aNormalizedValues.push(a?r(t[i].getValue()):50)}}if(t.length>0){this._fNormalizedPrecedingPoint=this._bIsPrecedingPointSet&&!t[0]._bNullValue?r(this.getPrecedingPoint()):null;this._fNormalizedSucceedingPoint=this._bIsSucceedingPointSet&&!t[t.length-1]._bNullValue?r(this.getSucceedingPoint()):null}if(this.nMin<0&&this.nMax>0){this._fNormalizedZero=Math.max(0-this.nMin,0)/a*100}else{this._fNormalizedZero=null}};d.prototype._adjustToParent=function(){if(this.data("_parentRenderingContext")&&this.data("_parentRenderingContext")instanceof o){var t=this.data("_parentRenderingContext").$();var e=parseFloat(t.width())-2;var i=parseFloat(t.height())-2;this.$().outerWidth(e);this.$().outerHeight(i)}};d.prototype._isChartEnabled=function(){return this.getSelectionEnabled()&&this._bInteractiveMode};d.prototype._switchModeInteractive=function(t){var e=this.$(),i=false;if(t<this._iAreaWidthInteractiveMinValue){if(this._bInteractiveMode){this._bInteractiveMode=false;i=true;e.addClass("sapSuiteILCNonInteractive");if(this.getSelectionEnabled()){var s=e.find(".sapSuiteILCInteractionArea[tabindex='0']");this._iActiveElement=e.find(".sapSuiteILCInteractionArea").index(s);s.removeAttr("tabindex");e.attr("tabindex","0")}e.attr({role:"button","aria-multiselectable":"false","aria-disabled":!this._isChartEnabled()})}}else if(!this._bInteractiveMode){this._bInteractiveMode=true;i=true;e.removeClass("sapSuiteILCNonInteractive");if(this.getSelectionEnabled()){e.removeAttr("tabindex");if(!this._iActiveElement||this._iActiveElement<0){this._iActiveElement=0}e.find(".sapSuiteILCInteractionArea").eq(this._iActiveElement).attr("tabindex","0")}e.attr({role:"listbox","aria-multiselectable":"true","aria-disabled":!this._isChartEnabled()})}if(i){if(this._isChartEnabled()){e.removeAttr("title");this._addInteractionAreaTooltip()}else{e.find(".sapSuiteILCInteractionArea").removeAttr("title");e.attr("title",this.getTooltip_AsString())}}};d.prototype._addInteractionAreaTooltip=function(){var e=this.$().find(".sapSuiteILCInteractionArea"),i=this.getPoints();e.each(function(e,s){t(s).attr("title",i[e].getTooltip_AsString())})};d.prototype._onResize=function(){var t,e=false,i=this.$(),s=i.find(".sapSuiteILCToplabel"),a=i.find(".sapSuiteILCBottomText"),r=i.find(".sapSuiteILCInteractionArea"),n=i.height(),o=i.width(),l=this.getPoints().length,p=i.find(".sapSuiteILCSection:first-child .sapSuiteILCBottomText"),h=i.find(".sapSuiteILCSection:last-child .sapSuiteILCBottomText");if(r.length>0){t=r[0].getBoundingClientRect().width}if(t<d.AREA_WIDTH_MINVALUE||n<d.CHART_HEIGHT_MINVALUE){i.css("visibility","hidden");return}else{i.css("visibility","")}this._switchModeInteractive(t);if(t<=d.AREA_WIDTH_SMALLFONT){i.addClass("sapSuiteILCSmallFont")}else{i.removeClass("sapSuiteILCSmallFont")}i.removeClass("sapSuiteILCExpandedLabels");p.add(h).css("width","");for(var u=0;u<l;u++){if(s.eq(u).prop("offsetWidth")<s.eq(u).prop("scrollWidth")){s.eq(u).css("visibility","hidden")}else{s.eq(u).css("visibility","")}if(a.eq(u).prop("offsetWidth")<a.eq(u).prop("scrollWidth")){e=true}}if(t<d.LABEL_WIDTH_MINVALUE&&e){i.addClass("sapSuiteILCExpandedLabels");p.add(h).css("width",o/2-4+"px")}else{i.removeClass("sapSuiteILCExpandedLabels");p.add(h).css("width","")}};d.prototype._deregisterResizeHandler=function(){if(this._sResizeHandlerId){n.deregister(this._sResizeHandlerId);this._sResizeHandlerId=null}};d.prototype._createTooltipText=function(t,e){var i=true,s,a="",r=this.getPoints();for(var n=0;n<this._iVisiblePointsCount;n++){if(e){if(t&&t-1===n){s=r[n].getTooltip_AsString();if(s){a+=(i?"":"\n")+s;i=false;break}}}else{s=r[n]._getAreaTooltip();if(s){a+=(i?"":"\n")+s;i=false}}}return a};d.prototype.setPrecedingPoint=function(t){this._bIsPrecedingPointSet=this._fnIsNumber(t);return this.setProperty("precedingPoint",this._bIsPrecedingPointSet?t:NaN)};d.prototype.setSucceedingPoint=function(t){this._bIsSucceedingPointSet=this._fnIsNumber(t);return this.setProperty("succeedingPoint",this._bIsSucceedingPointSet?t:NaN)};d.prototype._bindMouseEnterLeaveHandler=function(){this.$().find(".sapSuiteILCInteractionArea").on("mouseenter.tooltip",this._addTitleAttribute.bind(this));this.$().find(".sapSuiteILCInteractionArea").on("mouseleave.tooltip",this._removeTitleAttribute.bind(this))};d.prototype._addTitleAttribute=function(t){var e=t.target.getAttribute("aria-posinset");var i=this.getDomRef().querySelectorAll(".sapSuiteILCInteractionArea");if(this._isChartEnabled()&&this._hasData()&&i[parseInt(e)-1]&&!i[parseInt(e)-1].getAttribute("title")){i[parseInt(e)-1].setAttribute("title",this.getTooltip_AsString(parseInt(e)))}};d.prototype._removeTitleAttribute=function(t){var e=t.target.getAttribute("aria-posinset");var i=this.getDomRef().querySelectorAll(".sapSuiteILCInteractionArea");if(i[parseInt(e)-1]&&i[parseInt(e)-1].getAttribute("title")){i[parseInt(e)-1].removeAttribute("title")}};d.prototype._hasData=function(){return this.getPoints().length>0};return d});