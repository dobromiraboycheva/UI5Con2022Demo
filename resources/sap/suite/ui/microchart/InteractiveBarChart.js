/*!
 * SAPUI5
 * (c) Copyright 2009-2022 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","./library","sap/m/library","sap/ui/core/Control","sap/ui/Device","sap/m/FlexBox","sap/ui/core/ResizeHandler","sap/base/Log","sap/f/IllustratedMessage","sap/f/library","./InteractiveBarChartRenderer"],function(t,e,i,a,s,r,n,l,o,h){"use strict";var p=a.extend("sap.suite.ui.microchart.InteractiveBarChart",{metadata:{library:"sap.suite.ui.microchart",properties:{displayedBars:{type:"int",group:"Appearance",defaultValue:3},labelWidth:{type:"sap.ui.core.Percentage",group:"Appearance",defaultValue:"40%"},selectionEnabled:{type:"boolean",group:"Behavior",defaultValue:true},min:{type:"float",group:"Appearance"},max:{type:"float",group:"Appearance"},showError:{type:"boolean",group:"Appearance",defaultValue:false},errorMessageTitle:{type:"string",group:"Appearance"},errorMessage:{type:"string",group:"Appearance"}},defaultAggregation:"bars",aggregations:{bars:{type:"sap.suite.ui.microchart.InteractiveBarChartBar",multiple:true,bindable:"bindable"}},events:{selectionChanged:{parameters:{selectedBars:{type:"sap.suite.ui.microchart.InteractiveBarChartBar[]"},bar:{type:"sap.suite.ui.microchart.InteractiveBarChartBar"},selected:{type:"boolean"}}},press:{}},associations:{ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"}}}});p.MIN_BAR_WIDTH_IN_PX=1;p.BAR_VALUE_PADDING_LEFT_IN_PX=4;p.BAR_VALUE_PADDING_RIGHT_IN_PX=4;p.SELECTION_AREA_BORDER_IN_PX=1;p.DIVIDER_WIDTH_IN_PX=1;p.AREA_HEIGHT_MINVALUE=18;p.BAR_HEIGHT_FONT_SMALLER=22;p.BAR_HEIGHT_MINVALUE=6;p.BAR_HEIGHT_LABEL_HIDE=16;p.CHART_WIDTH_FONT_SMALLER=288;p.LABEL_WIDTH_MINVALUE=80;p.CHART_WIDTH_MINVALUE=130;p.AREA_HEIGHT_INTERACTIVE_MINVALUE=48;p.AREA_HEIGHT_INTERACTIVE_MINVALUE_COMPACT=32;p.AREA_HEIGHT_PADDING_STAGE1=34;p.AREA_HEIGHT_PADDING_STAGE1_COMPACT=32;p.AREA_HEIGHT_PADDING_STAGE2=28;p.AREA_HEIGHT_PADDING_STAGE2_COMPACT=31;p.prototype.init=function(){this._iVisibleBars=0;this._bInteractiveMode=true;this._bMinMaxValid=null;this._fDividerPositionRight=0;this._oRb=sap.ui.getCore().getLibraryResourceBundle("sap.suite.ui.microchart");this._fMin=null;this._fMax=null;this._bThemeApplied=true;this._oIllustratedMessageControl=new o({illustrationSize:h.IllustratedMessageSize.Base,illustrationType:h.IllustratedMessageType.NoData});if(!sap.ui.getCore().isInitialized()){this._bThemeApplied=false;sap.ui.getCore().attachInit(this._handleCoreInitialized.bind(this))}else{this._handleCoreInitialized()}};p.prototype._handleCoreInitialized=function(){this._bThemeApplied=sap.ui.getCore().isThemeApplied();sap.ui.getCore().attachThemeChanged(this._handleThemeApplied,this)};p.prototype.onBeforeRendering=function(){this._bCompact=this._isCompact();this._bInteractiveMode=true;this._setResponsivenessData();this._setInternalMinMax();this._errorMessage=this.getErrorMessage();this._errorMessageTitle=this.getErrorMessageTitle();this._oIllustratedMessageControl.setTitle(this._errorMessageTitle);this._oIllustratedMessageControl.setDescription(this._errorMessage);this._bMinMaxValid=this._checkIfMinMaxValid();if(this.getAggregation("bars")&&this.getDisplayedBars()){this._iVisibleBars=Math.min(this.getAggregation("bars").length,this.getDisplayedBars())}if(!this.data("_parentRenderingContext")&&typeof this.getParent==="function"){this.data("_parentRenderingContext",this.getParent())}this._deregisterResizeHandler();this._updateUseSemanticTooltip()};p.prototype.onAfterRendering=function(){this._adjustToParent();e._checkControlIsVisible(this,this._onControlIsVisible);this._bindMouseEnterLeaveHandler()};p.prototype._updateUseSemanticTooltip=function(){var t=this.getBars();this._bUseSemanticTooltip=false;for(var e=0;e<this._iVisibleBars;e++){if(t[e].getColor()!==i.ValueColor.Neutral){this._bUseSemanticTooltip=true;return}}};p.prototype._onControlIsVisible=function(){this._sResizeHandlerId=n.register(this,this._onResize.bind(this));this._calcBarsWidth();this._onResize();if(this.$().length>0){var t=this._isCompact();if(t!==this._bCompact){this._bCompact=t;this.invalidate()}}};p.prototype.exit=function(){this._deregisterResizeHandler();this._oIllustratedMessageControl.destroy()};p.prototype.onclick=function(e){if(!this.getSelectionEnabled()){return}if(this._bInteractiveMode){var i=t(e.target).attr("id")||t(e.target).parents(".sapSuiteIBCBarInteractionArea").attr("id"),a=this.$().find(".sapSuiteIBCBarInteractionArea"),r,n;if(i){r=i.substring(i.lastIndexOf("-")+1);if(isNaN(r)){return}else{r=parseInt(r)}this._toggleSelected(r);n=a.index(this.$().find(".sapSuiteIBCBarInteractionArea[tabindex='0']"));this._switchTabindex(n,r,a)}}else{this.firePress();if(s.browser.msie){this.$().trigger("focus");e.preventDefault()}}};p.prototype.onsapenter=function(t){if(this._bInteractiveMode){var e=this.$().find(".sapSuiteIBCBarInteractionArea").index(t.target);if(e!==-1){this._toggleSelected(e)}t.preventDefault();t.stopImmediatePropagation()}else{this.firePress()}};p.prototype.onsapspace=p.prototype.onsapenter;p.prototype.onsapup=function(t){var e=this.$().find(".sapSuiteIBCBarInteractionArea");var i=e.index(t.target);if(e.length>0){this._switchTabindex(i,i-1,e)}t.preventDefault();t.stopImmediatePropagation()};p.prototype.onsapdown=function(t){var e=this.$().find(".sapSuiteIBCBarInteractionArea");var i=e.index(t.target);if(e.length>0){this._switchTabindex(i,i+1,e)}t.preventDefault();t.stopImmediatePropagation()};p.prototype.onsaphome=function(t){var e=this.$().find(".sapSuiteIBCBarInteractionArea");var i=e.index(t.target);if(i!==0&&e.length>0){this._switchTabindex(i,0,e)}t.preventDefault();t.stopImmediatePropagation()};p.prototype.onsapend=function(t){var e=this.$().find(".sapSuiteIBCBarInteractionArea"),i=e.index(t.target),a=e.length;if(i!==a-1&&a>0){this._switchTabindex(i,a-1,e)}t.preventDefault();t.stopImmediatePropagation()};p.prototype.onsapleft=p.prototype.onsapup;p.prototype.onsapright=p.prototype.onsapdown;p.prototype.getSelectedBars=function(){var t=this.getAggregation("bars"),e=[],i;for(i=0;i<t.length;i++){if(t[i].getSelected()){e.push(t[i])}}return e};p.prototype.setSelectedBars=function(t){var i=this.getAggregation("bars"),a,s;this._deselectAllSelectedBars();if(!t){return this}if(t instanceof e.InteractiveBarChartBar){t=[t]}if(Array.isArray(t)){for(a=0;a<t.length;a++){s=this.indexOfAggregation("bars",t[a]);if(s>=0){i[s].setProperty("selected",true,true)}else{l.warning("setSelectedBars method called with invalid InteractiveBarChartBar element")}}}this.invalidate();return this};p.prototype.getTooltip_AsString=function(t){if(this._isChartEnabled()){i=this._createTooltipText(t,true);if(!i&&e._isTooltipSuppressed(i)){i=null}}else{var i=this.getTooltip_Text();if(!i){i=this._createTooltipText()}else if(e._isTooltipSuppressed(i)){i=null}}return i};p.prototype._isCompact=function(){return t("body").hasClass("sapUiSizeCompact")||this.$().is(".sapUiSizeCompact")||this.$().closest(".sapUiSizeCompact").length>0};p.prototype._setResponsivenessData=function(){if(this._bCompact){this._iAreaHeightInteractiveMinValue=p.AREA_HEIGHT_INTERACTIVE_MINVALUE_COMPACT;this._iAreaHeightPaddingStage1=p.AREA_HEIGHT_PADDING_STAGE1_COMPACT;this._iAreaHeightPaddingStage2=p.AREA_HEIGHT_PADDING_STAGE2_COMPACT}else{this._iAreaHeightInteractiveMinValue=p.AREA_HEIGHT_INTERACTIVE_MINVALUE;this._iAreaHeightPaddingStage1=p.AREA_HEIGHT_PADDING_STAGE1;this._iAreaHeightPaddingStage2=p.AREA_HEIGHT_PADDING_STAGE2}};p.prototype._handleThemeApplied=function(){this._bThemeApplied=true;this._bCompact=this._isCompact()};p.prototype._adjustToParent=function(){var t=this.$();if(this.data("_parentRenderingContext")&&this.data("_parentRenderingContext")instanceof r){var e=this.data("_parentRenderingContext").$();var i=e.width()-2;var a=e.height()-2;t.outerWidth(i);t.outerHeight(a)}};p.prototype._calcBarsWidth=function(){var t=this.$(),e=t.find(".sapSuiteIBCBarLabel"),i=p.DIVIDER_WIDTH_IN_PX,a=parseFloat(this.getLabelWidth()),s,r,n,l,o,h,d,_,u,c,f=sap.ui.getCore().getConfiguration().getRTL();if(!this._bMinMaxValid){return this}if(this._bFullWidth){a=100;s=100}else{s=100-a}r=Math.abs(this._fMax-this._fMin);if(this._fMin>=0&&this._fMax>=0){n=0;l=1}else if(this._fMin<0&&this._fMax<0){n=1;l=0}else{n=Math.abs(this._fMin/r);l=Math.abs(this._fMax/r)}if(this._bFullWidth){if(l>=n){o=l*100;h=n*100}else{o=n*100;h=0}e.css("width",o+"%");e.css(f?"right":"left",h+"%")}else{e.css("width",a+"%");e.css(f?"right":"left","")}t.find(".sapSuiteIBCBarWrapper").css("width",s+"%");if(n>0){t.find(".sapSuiteIBCBarWrapperNegative").width("calc("+n*100+"% - "+i+"px)")}else{t.find(".sapSuiteIBCBarWrapperNegative").width("0%")}if(l>0){t.find(".sapSuiteIBCBarWrapperPositive").width("calc("+l*100+"% - "+i+"px)")}else{t.find(".sapSuiteIBCBarWrapperPositive").width("0%")}for(var g=0;g<this._iVisibleBars;g++){d=this.getBars()[g].getValue();u=this.$("bar-negative-"+g);c=this.$("bar-positive-"+g);if(this.getBars()[g]._bNullValue||d===0){c.add(u).css("min-width",0)}else if(!this.getBars()[g]._bNullValue){if(d>0){_=Math.min(Math.max(d,this._fMin),this._fMax);c.css({width:this._calcPercent(_,r,Math.max(0,this._fMin),l),"min-width":1});u.css("min-width",0)}else{_=Math.max(Math.min(d,this._fMax),this._fMin);u.css({width:this._calcPercent(_,r,Math.min(0,this._fMax),n),"min-width":1});c.css("min-width",0)}}}};p.prototype._calcPercent=function(t,e,i,a){return Math.abs((t-i)/(e*a)*100).toFixed(5)+"%"};p.prototype._deselectAllSelectedBars=function(){var t=this.getAggregation("bars"),e=t.length,i;for(i=0;i<e;i++){t[i].setProperty("selected",false,true)}};p.prototype._toggleSelected=function(t){var e=this.getAggregation("bars"),i=e[t];if(t<0||t>=e.length){return}var a=this.$("interactionArea-"+t);if(i.getSelected()){a.removeClass("sapSuiteIBCBarSelected");i.setProperty("selected",false,true)}else{a.addClass("sapSuiteIBCBarSelected");i.setProperty("selected",true,true)}a.attr("aria-selected",i.getSelected());this.fireSelectionChanged({selectedBars:this.getSelectedBars(),bar:i,selected:i.getSelected()})};p.prototype._showValueOutsideBar=function(){var t=this.$(),e,i,a,s,r,n,l,o,h=this.$("bar-positive-0").parent().width(),d=this.$("bar-negative-0").parent().width(),_=sap.ui.getCore().getConfiguration().getRTL();e=t.find(".sapSuiteIBCBarValue");if(e.length===0){return}for(var u=0;u<this._iVisibleBars;u++){s=this.getBars()[u].getValue();a=e.eq(u).width()+p.BAR_VALUE_PADDING_LEFT_IN_PX+p.BAR_VALUE_PADDING_RIGHT_IN_PX;r=this.$("bar-positive-"+u).width();n=this.$("bar-negative-"+u).width();l=h-r;o=d-n;if(s>0||(this.getBars()[u]._bNullValue||s===0)&&this._fMin+this._fMax>=0){if(a>r&&a>l){e.eq(u).css("visibility","hidden")}else{e.eq(u).css("visibility","inherit")}if(a>r){i=this.$("bar-positive-"+u).width()+p.BAR_VALUE_PADDING_LEFT_IN_PX+"px";e.eq(u).addClass("sapSuiteIBCBarValueOutside")}else{i="";e.eq(u).removeClass("sapSuiteIBCBarValueOutside")}if(_){e.eq(u).css({right:i})}else{e.eq(u).css({left:i})}}else{if(a>n&&a>o){e.eq(u).css("visibility","hidden")}else{e.eq(u).css("visibility","inherit")}if(a>n){i=this.$("bar-negative-"+u).width()+p.BAR_VALUE_PADDING_RIGHT_IN_PX+"px";e.eq(u).addClass("sapSuiteIBCBarValueOutside")}else{i="";e.eq(u).removeClass("sapSuiteIBCBarValueOutside")}if(_){e.eq(u).css({left:i})}else{e.eq(u).css({right:i})}}}};p.prototype._checkIfMinMaxValid=function(){if(this._fMin>this._fMax){l.warning("Min value for InteractiveBarChart is larger than Max value.");return false}return true};p.prototype._setInternalMinMax=function(){var e=null,i=null,a,s=this.getBars(),r=Math.min(this.getDisplayedBars(),s.length);for(var n=0;n<r;n++){if(!s[n]._bNullValue){a=s[n].getValue();e=Math.min(e,a);i=Math.max(i,a)}}this._fMin=this.getMin();this._fMax=this.getMax();if(!t.isNumeric(this._fMin)||!t.isNumeric(this._fMax)){if(e>=0&&i>=0){if(!t.isNumeric(this._fMin)){this._fMin=0}if(!t.isNumeric(this._fMax)){this._fMax=i}}else if(e<0&&i<0){if(!t.isNumeric(this._fMin)){this._fMin=e}if(!t.isNumeric(this._fMax)){this._fMax=0}}else{if(!t.isNumeric(this._fMin)){this._fMin=e}if(!t.isNumeric(this._fMax)){this._fMax=i}}}};p.prototype.validateProperty=function(t,e){if(t==="labelWidth"&&(e!==null||e!==undefined)){var i=parseFloat(e);if(i<0||i>100){l.warning("LabelWidth for InteractiveBarChart is not between 0 and 100.");e=null}}return a.prototype.validateProperty.apply(this,[t,e])};p.prototype._switchTabindex=function(t,e,i){if(t>=0&&t<i.length&&e>=0&&e<i.length){i.eq(t).removeAttr("tabindex");i.eq(e).attr("tabindex","0");i.eq(e).trigger("focus")}};p.prototype._isChartEnabled=function(){return this.getSelectionEnabled()&&this._bInteractiveMode};p.prototype._resizeVertically=function(t){var e,i,a,s=this.$(),r=false,n=s.find(".sapSuiteIBCBarInteractionArea"),l=s.height(),o=0,h=this._iVisibleBars;if(this._bInteractiveMode){o=1}i=parseInt(n.css("margin-bottom"))+parseInt(n.css("margin-top"));e=(l-(i+2*p.SELECTION_AREA_BORDER_IN_PX)*h)/h;if(e+o<this._iAreaHeightInteractiveMinValue){if(this._bInteractiveMode){this._bInteractiveMode=false;r=true;s.addClass("sapSuiteIBCNonInteractive");if(this.getSelectionEnabled()){var d=this.$().find(".sapSuiteIBCBarInteractionArea[tabindex='0']");this._iActiveElement=n.index(d);d.removeAttr("tabindex");this.$().attr("tabindex","0")}this.$().attr({role:"button","aria-multiselectable":"false","aria-disabled":!this._isChartEnabled()})}}else if(!this._bInteractiveMode){this._bInteractiveMode=true;r=true;s.removeClass("sapSuiteIBCNonInteractive");if(this.getSelectionEnabled()){this.$().removeAttr("tabindex");if(!this._iActiveElement||this._iActiveElement<0){this._iActiveElement=0}n.eq(this._iActiveElement).attr("tabindex","0")}this.$().attr({role:"listbox","aria-multiselectable":"true","aria-disabled":!this._isChartEnabled()})}if(r){if(this._isChartEnabled()){s.removeAttr("title");this._addInteractionAreaTooltip(n)}else{n.removeAttr("title");s.attr("title",this.getTooltip_AsString())}}n.height(e);if(e<=this._iAreaHeightPaddingStage2){s.addClass("sapSuiteIBCStage2")}else{s.removeClass("sapSuiteIBCStage2");if(e<=this._iAreaHeightPaddingStage1){s.addClass("sapSuiteIBCStage1")}else{s.removeClass("sapSuiteIBCStage1")}}var _=this.$().find(".sapSuiteIBCBar");if(_.length>0&&_[0].getBoundingClientRect()){a=_[0].getBoundingClientRect().height}if(a<=p.BAR_HEIGHT_FONT_SMALLER){s.addClass("sapSuiteIBCSmallFont")}if(a<=p.BAR_HEIGHT_LABEL_HIDE){s.find(".sapSuiteIBCBarValue").css("visibility","hidden");t.labelsVisible=false}else{s.find(".sapSuiteIBCBarValue").css("visibility","inherit")}if(e<p.AREA_HEIGHT_MINVALUE){s.css("visibility","hidden");t.labelsVisible=false;t.chartVisible=false}};p.prototype._resizeHorizontally=function(t){if(!t.chartVisible){return}var e=this.$(),i=e.find(".sapSuiteIBCBarInteractionArea"),a=e.find(".sapSuiteIBCBarLabel"),s=parseFloat(this.getLabelWidth())/100*i.eq(0).width(),r=0,n=e.width(),l,o=false;if(n<p.CHART_WIDTH_FONT_SMALLER){e.addClass("sapSuiteIBCSmallFont");s=parseFloat(this.getLabelWidth())/100*i.eq(0).width()}if(this._bFullWidth){r=6}for(var h=0;h<a.length;h++){a.eq(h).css("width",s+"px");if(a.eq(h).children(".sapSuiteIBCBarLabelText").prop("clientWidth")<a.eq(h).children(".sapSuiteIBCBarLabelText").prop("scrollWidth")-r){o=true}a.eq(h).css("width","100%")}if(s<p.LABEL_WIDTH_MINVALUE&&o){e.addClass("sapSuiteIBCFullWidth");this._bFullWidth=true;this._calcBarsWidth()}else{e.removeClass("sapSuiteIBCFullWidth");this._bFullWidth=false;this._calcBarsWidth()}var d=this.$().find(".sapSuiteIBCBar");if(d.length>0&&d[0].getBoundingClientRect()){l=d[0].getBoundingClientRect().height}if(n<p.CHART_WIDTH_MINVALUE||l<p.BAR_HEIGHT_MINVALUE){e.css("visibility","hidden");t.labelsVisible=false;t.chartVisible=false}else if(l<=p.BAR_HEIGHT_LABEL_HIDE){e.find(".sapSuiteIBCBarValue").css("visibility","hidden");t.labelsVisible=false}};p.prototype._onResize=function(){var t=this.$(),e={chartVisible:true,labelsVisible:true};t.css("visibility","visible");t.removeClass("sapSuiteIBCSmallFont");this._resizeVertically(e);this._resizeHorizontally(e);if(e.labelsVisible){this._showValueOutsideBar()}};p.prototype._deregisterResizeHandler=function(){if(this._sResizeHandlerId){n.deregister(this._sResizeHandlerId);this._sResizeHandlerId=null}};p.prototype._addInteractionAreaTooltip=function(e){var i=this.getBars(),a,s;e.each(function(e,r){a=t(r);s=parseInt(a.attr("data-sap-ui-ibc-selection-index"));a.attr("title",i[s].getTooltip_AsString())})};p.prototype._createTooltipText=function(t,e){var i=true,a=this.getBars(),s,r="";for(var n=0;n<this._iVisibleBars;n++){if(e){if(t&&t-1===n){s=a[n].getTooltip_AsString();if(s){r+=(i?"":"\n")+s;i=false;break}}}else{s=a[n]._getBarTooltip(this._bUseSemanticTooltip);if(s){r+=(i?"":"\n")+s;i=false}}}return r};p.prototype._bindMouseEnterLeaveHandler=function(){this.$().find(".sapSuiteIBCBarInteractionArea").on("mouseenter.tooltip",this._addTitleAttribute.bind(this));this.$().find(".sapSuiteIBCBarInteractionArea").on("mouseleave.tooltip",this._removeTitleAttribute.bind(this))};p.prototype._addTitleAttribute=function(t){if(this._isChartEnabled()&&this._hasData()){var e=this.getDomRef().querySelectorAll(".sapSuiteIBCBarInteractionArea");var i=t.target.getAttribute("aria-posinset");if(i&&e[parseInt(i)-1]&&!e[parseInt(i)-1].getAttribute("title")){e[parseInt(i)-1].setAttribute("title",this.getTooltip_AsString(parseInt(i)))}else{var a=t.target;var s=a.closest(".sapSuiteIBCBarInteractionArea");if(s&&!s.getAttribute("title")){s.setAttribute("title",this.getTooltip_AsString(parseInt(s.getAttribute("aria-posinset"))))}}}};p.prototype._removeTitleAttribute=function(t){var e=t.target.getAttribute("aria-posinset");var i=this.getDomRef().querySelectorAll(".sapSuiteIBCBarInteractionArea");if(e&&i[parseInt(e)-1]&&i[parseInt(e)-1].getAttribute("title")){i[parseInt(e)-1].removeAttribute("title")}else{var a=t.target;var s=a.closest(".sapSuiteIBCBarInteractionArea");if(s&&s.getAttribute("title")){s.removeAttribute("title")}}};p.prototype._hasData=function(){return this.getBars().length>0};return p});